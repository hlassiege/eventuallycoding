<!DOCTYPE html>
<html >
<head><meta charset="utf-8">
<title>Retour d'utilisation de Mongodb et pourquoi nous migrons vers Postgresql | EventuallyCoding</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="https://digianalytics.fr/js/script.js" data-host="https://digianalytics.fr" id="ZwSg9rf6GA" async="" defer="" type="text/javascript"></script>
<meta name="description" content="![](/images/af912-mongo.jpg)
Dans de précédents billets j'évoquais que nous utilisions Mongodb chez Malt mais j'ai évoqué dans certains meetups que n...">
<meta name="og:description" content="![](/images/af912-mongo.jpg)
Dans de précédents billets j'évoquais que nous utilisions Mongodb chez Malt mais j'ai évoqué dans certains meetups que n...">
<meta name="og:type" content="article">
<meta name="og:title" content="Retour d'utilisation de Mongodb et pourquoi nous migrons vers Postgresql">
<meta name="og:url" content="https://eventuallycoding.com/2019/07/03/mongodb-vers-postgresql">
<meta name="og:image" content="https://eventuallycoding.com/images/covers/cover2.jpg">
<meta name="og:image:alt" content="Retour d'utilisation de Mongodb et pourquoi nous migrons vers Postgresql">
<meta name="twitter:text:title" content="Retour d'utilisation de Mongodb et pourquoi nous migrons vers Postgresql">
<meta name="twitter:image" content="https://eventuallycoding.com/images/covers/cover2.jpg">
<meta name="twitter:card" content="summary">
<meta name="article:published_time" content="2019-07-03T00:00:00.000Z">
<meta name="article:article:modified_time" content="2019-07-03T00:00:00.000Z">
<meta name="article:article:tag" content="data,mongodb,postgresql">
<link rel="canonical" href="https://eventuallycoding.com/2019/07/03/mongodb-vers-postgresql">
<link rel="alternate" href="https://eventuallycoding.com/2019/07/03/mongodb-vers-postgresql" hreflang="fr"><link rel="modulepreload" href="/2019/07/03/mongodb-vers-postgresql/_payload.js"><link rel="modulepreload" as="script" crossorigin href="/_nuxt/entry.a0b073ce.js"><link rel="preload" as="style" href="/_nuxt/entry.cc839bdc.css"><link rel="modulepreload" as="script" crossorigin href="/_nuxt/default.5a13eb30.js"><link rel="preload" as="style" href="/_nuxt/TheHeader.3cfb9104.css"><link rel="modulepreload" as="script" crossorigin href="/_nuxt/nuxt-link.d82c4883.js"><link rel="modulepreload" as="script" crossorigin href="/_nuxt/siteMetaData.b87d0183.js"><link rel="modulepreload" as="script" crossorigin href="/_nuxt/_id_.73ebf3bb.js"><link rel="modulepreload" as="script" crossorigin href="/_nuxt/Dropdown.e816c1c5.js"><link rel="modulepreload" as="script" crossorigin href="/_nuxt/_commonjsHelpers.28e086c5.js"><link rel="modulepreload" as="script" crossorigin href="/_nuxt/ContentRenderer.1498c36a.js"><link rel="modulepreload" as="script" crossorigin href="/_nuxt/ContentRendererMarkdown.cad91e83.js"><link rel="modulepreload" as="script" crossorigin href="/_nuxt/index.a6ef77ff.js"><link rel="modulepreload" as="script" crossorigin href="/_nuxt/BlogCard.vue.bf9b784b.js"><link rel="modulepreload" as="script" crossorigin href="/_nuxt/query.7bf71998.js"><link rel="modulepreload" as="script" crossorigin href="/_nuxt/index.61d74bb5.js"><link rel="modulepreload" as="script" crossorigin href="/_nuxt/utils.ee0874ff.js"><link rel="modulepreload" as="script" crossorigin href="/_nuxt/composables.33c0faa0.js"><link rel="modulepreload" as="script" crossorigin href="/_nuxt/HeroSection.87ab4243.js"><link rel="preload" as="style" href="/_nuxt/HeroSection.4c50b1af.css"><link rel="modulepreload" as="script" crossorigin href="/_nuxt/ProseP.143a8a9b.js"><link rel="modulepreload" as="script" crossorigin href="/_nuxt/ProseH2.c5c4021a.js"><link rel="modulepreload" as="script" crossorigin href="/_nuxt/ProseA.351afb7a.js"><link rel="modulepreload" as="script" crossorigin href="/_nuxt/ProseUl.b28e4f95.js"><link rel="modulepreload" as="script" crossorigin href="/_nuxt/ProseLi.24398592.js"><link rel="modulepreload" as="script" crossorigin href="/_nuxt/ProseImg.ae087578.js"><link rel="prefetch" as="script" crossorigin href="/_nuxt/error-component.a43d0574.js"><link rel="prefetch" as="image" type="image/svg+xml" href="/_nuxt/github_new.4e3fe23c.svg"><link rel="prefetch" as="image" type="image/svg+xml" href="/_nuxt/rss.9e0b880c.svg"><link rel="prefetch" as="image" type="image/svg+xml" href="/_nuxt/mastodon.f0ecdde8.svg"><link rel="prefetch" as="image" type="image/svg+xml" href="/_nuxt/linkeding.34c3bc6d.svg"><link rel="prefetch" as="image" type="image/svg+xml" href="/_nuxt/twitter.457cff27.svg"><link rel="stylesheet" href="/_nuxt/entry.cc839bdc.css"><link rel="stylesheet" href="/_nuxt/TheHeader.3cfb9104.css"><link rel="stylesheet" href="/_nuxt/HeroSection.4c50b1af.css"><style>.inverted[data-v-e7ed15a9]{--tw-bg-opacity:1;background-color:rgb(248 250 252/var(--tw-bg-opacity))}.inverted .font-to-invert-to-pink[data-v-e7ed15a9]{color:rgb(236 72 153/var(--tw-text-opacity))}.inverted .font-to-invert-to-black[data-v-e7ed15a9],.inverted .font-to-invert-to-pink[data-v-e7ed15a9]{--tw-text-opacity:1;transition-duration:.15s;transition-property:all;transition-timing-function:cubic-bezier(.4,0,.2,1)}.inverted .font-to-invert-to-black[data-v-e7ed15a9]{color:rgb(51 65 85/var(--tw-text-opacity))}.inverted .font-to-invert-to-black[data-v-e7ed15a9]:hover{--tw-text-opacity:1;color:rgb(255 255 255/var(--tw-text-opacity))}.link[data-v-e7ed15a9]{display:block;font-size:1rem;font-weight:500;line-height:1.5rem;overflow:hidden;padding-left:.75rem;padding-right:.75rem;position:relative;text-decoration:none}.link.NuxtLink-exact-active[data-v-e7ed15a9]:after{bottom:-2px;height:100%;left:0;width:100%}.link[data-v-e7ed15a9]:after{background:rgba(236,64,122,.25);bottom:-6px;content:"";height:calc(100% - 8px);left:18px;position:absolute;transition:.35s cubic-bezier(.25,.1,0,2.05);width:calc(100% - 8px);z-index:-1}.link[data-v-e7ed15a9]:hover:after{bottom:-2px;height:100%;left:0;width:100%}</style><style>.nuxt-content h2{font-size:28px;font-weight:700}.nuxt-content h3{font-size:22px;font-weight:700}.nuxt-content p{margin-bottom:20px}</style></head>
<body ><div id="__nuxt"><!--[--><section class="w-full pb-12 antialiased"><div class="mx-auto max-w-8xl"><div data-v-e7ed15a9><nav class="transition-colors fixed w-full z-10 top-0" id="header-menu" data-v-e7ed15a9><div class="max-w-7xl mx-auto px-2 sm:px-6 lg:px-8" data-v-e7ed15a9><div class="relative flex items-center justify-between h-16" data-v-e7ed15a9><div class="absolute inset-y-0 left-0 flex items-center sm:hidden" data-v-e7ed15a9><button type="button" class="inline-flex items-center justify-center p-2 rounded-md text-gray-400 hover:text-white hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-inset focus:ring-white" aria-controls="mobile-menu" aria-expanded="false" data-v-e7ed15a9><span class="sr-only" data-v-e7ed15a9>Open main menu</span><svg class="block h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" aria-hidden="true" data-v-e7ed15a9><path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 12h16M4 18h16" data-v-e7ed15a9></path></svg><svg class="hidden h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" aria-hidden="true" data-v-e7ed15a9><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" data-v-e7ed15a9></path></svg></button></div><div class="flex-1 flex items-center justify-center sm:items-stretch sm:justify-start" data-v-e7ed15a9><div class="flex-shrink-0 flex items-center" data-v-e7ed15a9><span class="text-white text-base font-medium font-bruno text-2xl font-to-invert-to-pink" data-v-e7ed15a9><a href="/" class="" data-v-e7ed15a9>EventuallyCoding.com</a></span></div><div class="hidden sm:block sm:ml-6 absolute right-0 font-mark" data-v-e7ed15a9><div class="flex space-x-4" data-v-e7ed15a9><!--[--><a href="/speaking" class="link text-white font-to-invert-to-black" data-v-e7ed15a9>Speaking</a><a href="/blog" class="link text-white font-to-invert-to-black" data-v-e7ed15a9>Writing</a><a href="/resources" class="link text-white font-to-invert-to-black" data-v-e7ed15a9>Resources</a><a href="/about" class="link text-white font-to-invert-to-black" data-v-e7ed15a9>About</a><!--]--></div></div></div></div></div><div class="hidden" data-v-e7ed15a9><div class="px-2 pt-2 pb-3 space-y-1" data-v-e7ed15a9><!--[--><a href="/speaking" class="text-white hover:bg-gray-700 hover:text-white block px-3 py-2 rounded-md text-base font-medium font-to-invert-to-black" data-v-e7ed15a9>Speaking</a><a href="/blog" class="text-white hover:bg-gray-700 hover:text-white block px-3 py-2 rounded-md text-base font-medium font-to-invert-to-black" data-v-e7ed15a9>Writing</a><a href="/resources" class="text-white hover:bg-gray-700 hover:text-white block px-3 py-2 rounded-md text-base font-medium font-to-invert-to-black" data-v-e7ed15a9>Resources</a><a href="/about" class="text-white hover:bg-gray-700 hover:text-white block px-3 py-2 rounded-md text-base font-medium font-to-invert-to-black" data-v-e7ed15a9>About</a><!--]--></div></div></nav></div><!--[--><!--[--><div><section class="flex items-center justify-center h-128 bg-transparent"><canvas id="c" class="-z-10 absolute w-full h-128 block"></canvas><div class="clip-ellipse absolute top-124 rotate-180"></div><!--[--><div class="absolute top-96 w-96 -translate-y-20"><img src="/images/covers/cover2.jpg" alt="Retour d&#39;utilisation de Mongodb et pourquoi nous migrons vers Postgresql" class="object-cover"></div><!--]--></section><div class="px-4 mx-auto sm:px-6 xl:max-w-7xl xl:px-0 mt-10"><h1 class="text-4xl text-gray-700 font-extrabold text-center mb-5">Retour d&#39;utilisation de Mongodb et pourquoi nous migrons vers Postgresql</h1><p class="text-slate-400 text-center mb-5"><!----></p><div class="grid grid-cols-3 text-center sm:w-full md:w-1/2 mx-auto"><div><p class="text-center font-bold my-5 text-slate-400 text-xs"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 inline-block" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg> July 3, 2019</p></div><div><p class="text-center font-bold my-5 text-slate-400 text-xs"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 inline-block" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg> 13 min read</p></div><div class="flex items-center font-medium sm:mx-3 justify-center"><img src="/hugo-nb.jpg" loading="lazy" alt="" class="mr-3 w-10 h-10 rounded-full bg-slate-50 dark:bg-slate-800"><div><div class="font-bold text-slate-400 text-xs">Hugo Lassiège</div><a target="_blank" href="https://twitter.com/hugolassiege" class="font-bold text-sky-400 text-xs hover:text-sky-600"> @hugolassiege</a></div></div></div><div class="sm:w-full md:w-1/2 mx-auto"><p class="mt-2 text-xs my-3 flex flex-wrap -m-1 justify-center"><!--[--><a href="/blog?tag=data" class="m-1 leading-loose text-slate-400 border border-current lowercase px-2 rounded font-medium">#data</a><a href="/blog?tag=mongodb" class="m-1 leading-loose text-slate-400 border border-current lowercase px-2 rounded font-medium">#mongodb</a><a href="/blog?tag=postgresql" class="m-1 leading-loose text-slate-400 border border-current lowercase px-2 rounded font-medium">#postgresql</a><!--]--></p></div><div class="text-left mx-auto"><div class="flex flex-wrap lg:flex-row-reverse py-12"><div class="w-full lg:w-1/4 px-5"><div class="lg:sticky top-0 pt-5 -mt-5"><div class="toc hidden lg:block"><h3 class="border-b-4 pb-3 mb-3 border-gray-200 text-xl">On this page</h3><ul class="pl-0"><!--[--><li class="py-1"><a class="hover:text-smalt-blue-700" href="#le-bon-vieux-temps">Le bon vieux temps </a></li><li class="py-1"><a class="hover:text-smalt-blue-700" href="#première-alerte">Première alerte </a></li><li class="py-1"><a class="hover:text-smalt-blue-700" href="#remise-en-question">Remise en question</a></li><li class="py-1"><a class="hover:text-smalt-blue-700" href="#une-rapidité-de-développement-en-déclin">Une rapidité de développement en déclin</a></li><li class="py-1"><a class="hover:text-smalt-blue-700" href="#digression">Digression</a></li><li class="py-1"><a class="hover:text-smalt-blue-700" href="#le-temps-de-la-migration">Le temps de la migration </a></li><!--]--></ul></div><div class="text-right mb-12"><div class="relative inline-block text-left ml-2 block lg:hidden"><div><span class="rounded-md shadow-sm"><button type="button" class="inline-flex justify-center w-full rounded-md border border-gray-300 px-4 py-2 bg-white text-sm leading-5 font-medium text-black hover:text-white hover:bg-smalt-blue-500 focus:outline-none transition ease-in-out duration-150" aria-haspopup="true" aria-expanded="true"><!--[-->On this page<!--]--><svg class="-mr-1 ml-2 h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"></path></svg></button></span></div><!----></div></div></div></div><div class="lg:w-3/4 w-full px-5 max-w-none centered-image"><div id="nuxtContent" class="prose font-proxima text-sm md:text-xl font-medium min-w-full md:p-10 mx-auto"><p><!--[--><img src="/images/af912-mongo.jpg" alt><!--]--></p><p><!--[-->Dans de précédents billets j&#39;évoquais que nous utilisions Mongodb chez Malt mais j&#39;ai évoqué dans certains meetups que nous n&#39;en étions pas totalement satisfaits et que nous entamions une (lente) migration vers postgresql.<!--]--></p><p><!--[-->Je vous propose de faire un petit retour d&#39;expérience sur ce sujet après désormais 7 ans d&#39;utilisation de mongodb chez nous.<!--]--></p><p><!--[-->Tout d&#39;abord posons le contexte, cela permet de comprendre certains choix. <!--]--></p><p><!--[-->Malt (ou anciennement Hopwork) démarre en 2012 pendant l&#39;été. Vincent JB et moi on se rencontre tous ensemble pour la première fois en juillet. Vincent nous propose une idée, JB et moi sommes pile poil dans une période un peu creuse (déménagement sur Lyon pour moi et long voyage aux US pour JB) du coup c&#39;est envisageable d&#39;y passer un peu de temps. On accepte donc ce fameux projet ou un inconnu vous propose de faire mieux qu&#39;une industrie toute entière payé en parts de la société qui ne valent rien :)<!--]--></p><p><!--[--><img src="/images/hqdefault.jpg" alt="Résultat de recherche d&#39;images pour &quot;parce que c&#39;est notre projet&quot;"><!--]--></p><p><!--[-->A ce moment là, JB et moi on voit dans le projet plusieurs objectifs :<!--]--></p><ul><!--[--><li><!--[-->démontrer qu&#39;à deux on peut créer une application complète rapidement. A force de faire de la prestation de service on a trop vu de projets pharaoniques qui ne mène nulle part.<!--]--></li><li><!--[-->tester de nouvelles technos et ne pas forcément rester dans notre zone de confort, ce qui peut entrer en conflit avec le premier objectif de vitesse<!--]--></li><!--]--></ul><p><!--[-->Je passe sur les objectifs sur la portée du produit, la je n&#39;évoque que les points technologiques.<!--]--></p><p><!--[-->Dans ce contexte, nous allons faire quelque choix nous permettant d&#39;avoir un minimum d&#39;aisance, comme le choix du langage de développement par exemple : Java<!--]--></p><p><!--[-->Mais nous allons par contre tester des nouveautés pour nous : Lucene (puis elasticsearch), mongodb<!--]--></p><p><!--[-->Bref, c&#39;est donc comme sujets de veille que mongo et elasticsearch rentreront chez Malt.<!--]--></p><h2 id="le-bon-vieux-temps"><a href="#le-bon-vieux-temps"><!--[-->Le bon vieux temps <!--]--></a></h2><p><!--[-->Rien à redire au début, mongo s&#39;avérera très très utile. L&#39;outil a pour lui une simplicité d&#39;accès permettant de développer très rapidement :<!--]--></p><ul><!--[--><li><!--[-->lancer une base mongo sur linux ou windows c&#39;est immédiat (et par la suite le mode cluster/replica set s&#39;avèrera aussi simple)<!--]--></li><li><!--[-->manipuler du json nous paraît à ce moment plutôt simple d&#39;accès, le format étant déjà très populaire<!--]--></li><li><!--[-->la console shell de mongo en javascript et le requêtage nécessitent peu de formation<!--]--></li><li><!--[-->l&#39;absence/souplesse de schéma permet de développer sans jamais s&#39;occuper du DDL, les tables se créent toutes seules, les colonnes aussi, aucun overhead de ce côté<!--]--></li><li><!--[-->l&#39;utilisation avec Jongo en Java est très agréable, la lib est légère, facile à utiliser dans un contexte de test unitaire avec Fongo<!--]--></li><!--]--></ul><p><!--[-->L&#39;application qui va naître en l&#39;espace de 2/3 mois doit en grande partie sa rapidité à mongodb. <!--]--></p><p><!--[-->Entre 2012 et 2017 globalement, on peut dire que mongo aura bien fonctionné et il n&#39;y a aucun regret à avoir sur ce choix.<!--]--></p><p><!--[-->D&#39;ailleurs sur la même période je vais personnellement beaucoup apprendre dessus, passer successivement les formations en ligne 101 for developpers, 102 for dba, 202 advanced deployment and operations et commencer à donner des formations dessus jusque fin 2016. <!--]--></p><p><!--[-->Mais au fur et à mesure quelques petits couacs vont se faire ressentir, mineurs au début :<!--]--></p><p><!--[-->- Effectivement l&#39;administration d&#39;une base mongo est simple pour les choses de base. La gestion des backup en &quot;point in time&quot; l&#39;est un peu moins. Vous pouvez faire des backups journaliers à heure fixe mais l&#39;idéal reste un backup en continu pour viser un <a href="https://fr.wikipedia.org/wiki/Dur%C3%A9e_maximale_d%27interruption_admissible" rel="nofollow"><!--[-->RPO<!--]--></a> proche de zéro.<!--]--></p><p><!--[-->Et il n&#39;existe que la solution vendue par l&#39;éditeur sur son SAAS pour cela. Pas trop grave malgré tout, nous l&#39;avons utilisé et effectivement cela marche plutôt bien. <!--]--></p><p><!--[-->- Le JSON pour écrire des requêtes, passé l&#39;engouement du début c&#39;est quand même peu lisible. Et l&#39;API recèle des petites merveilles en termes de WTF notamment quand on utilise le framework d’agrégation. Rien n&#39;a encore été écrit de plus expressif que le SQL pour interroger ces données. Et ce n&#39;est sans doute pas pour rien que d&#39;autres bases de données ont fini par fournir des syntaxes SQL à leurs utilisateurs : Cassandra CQL, Hadoop Hive. Combien on parie que mongo finira par y venir ?<!--]--></p><p><!--[-->- si l&#39;absence de schéma &quot;visible&quot; existe, vous avez bien sûr des données qui ont un modèle. Tout cela doit vivre dans le temps. Nous avons utilisé mongeez pendant très longtemps (même philosophie que liquibase mais pour mongodb). Sauf que la mise à jour de données dans un univers non transactionnel comporte quelques pièges amusants<!--]--></p><p><!--[-->Tout cela reste très mineur, aucun outil n&#39;est parfait et la vitesse de développement avec mongo reste beaucoup plus rapide qu&#39;avec un système traditionnel.<!--]--></p><p><!--[-->Alors oui il existe aussi des articles sur le net qui casse pas mal de sucre sur mongo et des problèmes de pertes de données. Mais tous ces articles parlent des premières versions de mongo antérieures à la version 2.2 et malgré le FUD ambiant sur mongo, ça se passe bien. <!--]--></p><h2 id="première-alerte"><a href="#première-alerte"><!--[-->Première alerte <!--]--></a></h2><p><!--[-->Jusqu&#39;à 2016, nous n&#39;avions pas encore de gros besoins en termes de reporting data. Nous avions résolu, un peu, ces points en faisant tout d&#39;abord des extractions de données qui étaient ensuite intégrées dans Tableau Software.<!--]--></p><p><!--[-->Puis nous avions codé des écouteurs d&#39;évènements qui alimentaient un schéma SQL dédié au reporting pour faire du temps réel. Ca n&#39;était pas satisfaisant au vu du temps de maintenance passé dessus. <!--]--></p><p><!--[-->Finalement après de nombreux tests nous arrivons à la conclusion que faire de l&#39;analyse de données sur mongo est très difficile, voire impossible, nous construirons une brique plus robuste de synchronisation temps réel mongo vers postgresql. <!--]--></p><p><!--[-->Ce composant est open source et vous pourrez trouver <a href="http://www.eventuallycoding.com/index.php/connecteur-mongo-postgresql" rel="nofollow"><!--[-->un vieux billet à ce sujet<!--]--></a> (attention, ce composant a été réécrit entièrement l&#39;année dernière donc prenez bien la dernière version).<!--]--></p><p><!--[-->Bref, le choix de notre outil nous handicape clairement pour nos visualisations de données. <!--]--></p><p><!--[-->Mais la suite s&#39;avérera tout aussi sympathique. <!--]--></p><h2 id="remise-en-question"><a href="#remise-en-question"><!--[-->Remise en question<!--]--></a></h2><p><!--[-->Avec l&#39;arrivée de bons outils de visualisation de données, ce sera aussi l&#39;occasion de se rendre compte de nombreuses données incohérentes en bases de données. <!--]--></p><p><!--[-->Mais, c&#39;est en fait tout sauf une surprise. <!--]--></p><p><!--[-->En effet, par principe mongo a quelques particularités qu&#39;il faut bien comprendre :<!--]--></p><ul><!--[--><li><!--[-->ce n&#39;est pas transactionnel (tout du moins pas avant la version 4.0)<!--]--></li><li><!--[-->aucune relation n&#39;existe entre les tables, donc aucune jointure possible (hormis avec $lookup introduit en 3.2 mais qui reste limité dans son usage)<!--]--></li><!--]--></ul><p><!--[-->Le crédo de mongo était de proposer une base de données riche en termes de fonctionnalités mais sans les fonctionnalités impliquant de grosses pertes en performance. C&#39;était censé être le bon compromis fonctionnalités/rapidité.<!--]--></p><p><!--[-->Mon avis personnel, non vérifié, c&#39;est que ce mantra s&#39;est imposé APRES que le produit soit devenu populaire. A la toute origine mongo c&#39;est surtout un sous produit d&#39;un PAAS édité par 10gen. Ce PAAS n&#39;a pas fonctionné mais mongo avait plu et il est devenu le produit phare de la société.<!--]--></p><p><!--[-->Sauf que ce produit initialement conçu comme une sous brique de PAAS pas forcément très évolué s&#39;est retrouvé propulsé comme moteur de base de données pouvant magiquement remplacer des bases de données relationnelles du jour au lendemain. <!--]--></p><p><!--[-->Il lui manquait tout un tas de fonctionnalités mais 10gen a réussi à en faire une force en mettant en avant que c&#39;était volontaire. L&#39;absence de transaction et de relations : c&#39;est un choix. Si vous modélisez tout sous forme de documents sans relation, pas besoin de transaction (forcément coûteuse comme mécanisme de synchronisation) et pas besoin de jointure, coûteuse également dans des environnements clusterisé ou les données peuvent résider sur des noeuds différents. <!--]--></p><p><!--[-->Pourtant avec le temps mongo a commencé à introduire des solutions de remplacement, $lookup d&#39;abord pour la partie jointure, puis finalement les transactions en version 4.0. <!--]--></p><p><!--[-->Mais ces points ne sont presque que le sommet visible de l&#39;iceberg, la gestion des bigdecimaux, les conversions de type, l&#39;égalité entre champs du même document etc... étaient aussi de gros manques sur la base de données. <!--]--></p><p><!--[-->De tous les manques dans le langage de requêtage certains ont progressivement été comblé avec de nouveaux opérateurs d’agrégation mais au prix d&#39;une syntaxe toujours plus horrible version après version.<!--]--></p><p><!--[-->Même si la version 4.0 est attractive, transactions, conversions de type, nouveaux opérateurs, finalement, si l&#39;évolution de mongo depuis le début consiste à rattraper les manques fonctionnels vis à vis des bases relationnelles, pourquoi s&#39;embêter avec mongo ?<!--]--></p><p><!--[-->Première réponse : l&#39;argument de la rapidité de développement avec mongo. <!--]--></p><h2 id="une-rapidité-de-développement-en-déclin"><a href="#une-rapidité-de-développement-en-déclin"><!--[-->Une rapidité de développement en déclin<!--]--></a></h2><p><!--[-->En fait avec l&#39;augmentation du volume de code, c&#39;est finalement la modélisation dans mongodb qui va commencer à nous ralentir.<!--]--></p><p><!--[-->Pour spoiler un tout petit peu, nous avons fait une erreur classique, nous avons pris le seul outil à disposition pour résoudre tous nos problèmes.<!--]--></p><p><!--[-->Le fameux : &quot;si vous n&#39;avez qu&#39;un marteau, tous les problèmes ressemblent à des clous&quot;<!--]--></p><p><!--[-->Comme je le disais plus haut, mongodb est non relationnel. Chaque fois que vous modélisez des documents dans une collection vous devez réfléchir si vos documents vont contenir leurs relations ou des références à ces relations, sachant que vous ne pourrez pas faire de jointure dans le second cas. <!--]--></p><p><!--[-->Exemple si vous modélisiez ce blog :<!--]--></p><ul><!--[--><li><!--[-->un post de blog peut contenir la liste des commentaires de l&#39;article dans le même document (on parlera d&#39;embarquer les données).<!--]--></li><li><!--[-->un post de blog peut contenir l&#39;id de l&#39;auteur mais pas la définition de l&#39;auteur (sinon il serait dupliqué dans chaque article)<!--]--></li><!--]--></ul><p><!--[-->Sauf que ce choix embarqué vs référencé correspond bien souvent à un cas d&#39;usage. <!--]--></p><ul><!--[--><li><!--[-->les tags d&#39;un post de blog peuvent être embarqués si vous ne les utilisez qu&#39;à l&#39;affichage<!--]--></li><li><!--[-->vous pourriez choisir de les référencer si vous souhaitez les administrer au global et les normaliser<!--]--></li><li><!--[-->les commentaires d&#39;un article s&#39;ils sont embarqués et très nombreux peuvent dépasser la capacité maximale d&#39;un document mongo<!--]--></li><!--]--></ul><p><!--[-->Bref, ce choix embarqué vs référencé va entraîner des casses têtes qui vieilliront mal dans le temps parfois ou causeront de nombreuses duplications de données dans d&#39;autres cas.<!--]--></p><p><!--[-->La dénormalisation (ou duplication de données si vous préférez) c&#39;est l&#39;un des concepts clés à comprendre avec Mongo. <!--]--></p><p><!--[-->Pour des raisons de modélisation, mongo incite forcément à dénormaliser.<!--]--></p><p><!--[-->Exemple :<!--]--></p><ul><!--[--><li><!--[-->pour avoir la liste des articles de blog avec plus de 5 commentaires, il est préférable de créer un champ nbComments que l’on incrémentera à chaque ajout de commentaires (c&#39;est une duplication)<!--]--></li><li><!--[-->pour ne pas faire de jointure avec la collection des auteurs de commentaires, on pourrait dupliquer les noms/prénoms d&#39;un auteur de commentaire dans chaque article pour l&#39;affichage et pas uniquement conserver l&#39;id<!--]--></li><!--]--></ul><p><!--[-->Cette duplication est inévitable et même conseillée dans les bonnes pratiques de mongo pour répondre à de nombreux cas d&#39;usages.<!--]--></p><p><!--[-->Avec le temps, ces duplications, ces corrections de modélisations pour gérer de nouveaux cas d&#39;usages vont commencer à être très coûteux. <!--]--></p><p><!--[-->Et l&#39;absence de transactionnalité a entraîné des incohérences dans nos données qui pourrait s’illustrer comme suit : un auteur référencé dans un article mais inexistant dans la collection des auteurs, car par exemple l&#39;opération de suppression de l&#39;auteur a planté après la première opération sans avoir le temps de supprimer les commentaires.<!--]--></p><p><!--[-->Avec le temps, l&#39;ensemble des garanties proposé par une base de données standards :<!--]--></p><ul><!--[--><li><!--[-->cohérence des données (via les index, clés étrangères, typage)<!--]--></li><li><!--[-->le caractère ACID d&#39;un ensemble d&#39;opération <!--]--></li><li><!--[-->les jointures<!--]--></li><!--]--></ul><p><!--[-->Tout cela, vous devez le gérer dans votre code. Si ca n&#39;existe pas en base, alors c&#39;est le code qui doit prendre le relais. <!--]--></p><p><!--[-->Plus l’application va grandir, plus statistiquement vous allez rencontrer des soucis liés à l’augmentation du trafic (des races conditions par exemple qui ne vous arrivaient jamais avant), et plus vous allez devoir écrire du code défensif.<!--]--></p><p><!--[-->Et bien là, cela commence à ralentir le développement.<!--]--></p><ul><!--[--><li><!--[-->Il faut des batchs de vérifications de la cohérence des données.<!--]--></li><li><!--[-->Il faut parfois implémenter un <a href="https://docs.mongodb.com/v3.6/tutorial/perform-two-phase-commits/" rel="nofollow"><!--[-->two phase commit logiciel<!--]--></a> <!--]--></li><li><!--[-->il faut prévoir tous les cas de plantage et être capable de corriger une donnée incohérente au moment où on la rencontre<!--]--></li><li><!--[-->Anecdote amusante, il faut coder de nombreuses fois des gestions d&#39;erreur pour le cas ou un upsert plante pour cause de... violation de clé unique (pourtant la sémantique même de l&#39;upsert ca devrait être d&#39;éviter cela).<!--]--></li><!--]--></ul><p><!--[-->Pour recréer certaines pages complexes (tableau de bord par exemple), l&#39;interrogation du modèle est tellement coûteuse que vous devez construire des vues maintenues en temps réel via des systèmes d&#39;observateurs d&#39;évènements. Et ces vues sont régulièrement désynchronisées donc rebelotte, vous devez aussi maintenir un batch de cohérence de donnée.<!--]--></p><p><!--[-->Si on prend un peu de recul, tout ceci était évitable si on avait accepté que mongo est une base pour un cas d&#39;usage : des collections de documents hétérogènes et non liées entre eux. Ce n&#39;est absolument pas fait pour recréer l&#39;ensemble du/des modèle(s) d&#39;une application dans lesquels vous modélisez des relations entre vos entités. <!--]--></p><h2 id="digression"><a href="#digression"><!--[-->Digression<!--]--></a></h2><p><!--[-->Petite parenthèse utile, j’entends parfois des raccourcis qui consiste à penser que mongo est utilisé pour ses performances ou dans un contexte bigdata.<!--]--></p><p><!--[-->Sur les performances, c’est discutable et dépendant des cas d’usages. Je m’explique.<!--]--></p><p><!--[-->Reprenons le blog dont je parlais plus haut. Si vous stockez les commentaires au sein du document “article” alors récupérer l’article et ces commentaires, c’est une requête avec accès à un document.<!--]--></p><p><!--[-->L’équivalent dans un mode relationnel suppose une jointure et la récupération de n lignes. <!--]--></p><p><!--[-->Mécaniquement il y a un overhead.<!--]--></p><p><!--[-->Par contre si dans mongo vous avez une collection “articles” et une collection “commentaires”, cette fois le nombre d’opérations est supérieur dans mongo.<!--]--></p><p><!--[-->Bref, comparer les performances entre les deux en lecture ça ne peut se faire que pour votre cas d’usage, votre modélisation. <!--]--></p><p><!--[-->Intrinsèquement mongo va proposer des solutions pour être plus rapide (embarquer des documents, absence de transactions) mais qui doivent s’accommoder avec vos contraintes de modèles.<!--]--></p><p><!--[-->En écriture mongo propose des modes d’acquittements très light qui permettent effectivement d’aller vite (si vous n’avez pas de soucis à perdre des données).<!--]--></p><p><!--[-->Et concernant le bigdata ?<!--]--></p><p><!--[-->Outre le fait que peu de gens font vraiment du BigData, j’ai un avis tronqué sur la question, je considère au contraire que Mongo est plus adapté pour du prototypage rapide au début d’une application. Je ne l’ai jamais considéré comme une base bigdata et la complexité du sharding dans mongo me faire dire que plus on s’en passe, mieux c’est. Mais j’ai peu d’expériences sur le sujet.  <!--]--></p><h2 id="le-temps-de-la-migration"><a href="#le-temps-de-la-migration"><!--[-->Le temps de la migration <!--]--></a></h2><p><!--[-->En 2018 nous avons rencontré de nombreux problèmes de stabilité de notre solution maison de synchronisation temps réel mongo vers pg. Le volume de la table à synchroniser(plusieurs centaines de millions d&#39;enregistrements) et les changements réguliers de modèle entraînaient des resynchro depuis le début et coûtaient plusieurs jours d&#39;indisponibilité de nos analytiques. Nous avons donc entamé un retour vers postgresql pour cette table là dans un premier temps.<!--]--></p><p><!--[-->Puis ensuite nous avons choisi de poursuivre avec postgresql pour les nouvelles fonctionnalités et de migrer progressivement les anciennes tables lorsque l&#39;occasion se présentait.<!--]--></p><p><!--[-->Et bien après plusieurs années de mongo, le retour au SQL c&#39;est perturbant mais très agréable. <!--]--></p><p><!--[-->J&#39;avais beau avoir travaillé sur postgresql, mysql, oracle, sybase, sql server, je me suis senti un peu rouillé :) Et je n&#39;étais pas le seul. <!--]--></p><p><!--[-->Aujourd&#39;hui en 2019 les nouveaux développements continuent de se faire sur postgresql. Nous avons repris de nombreuses bonnes habitudes, une meilleure modélisation en base de données, moins de duplication, des requêtes plus compréhensibles et puissantes, des garanties plus fortes sur la cohérence, moins de code défensif pour pallier aux manques de la base, moins de (nouveaux) batchs de cohérences.<!--]--></p><p><!--[-->Tout n&#39;est pas rose bien sûr, nous avons redécouvert des problématiques classiques de base de données (maintenance du schéma par exemple) mais l&#39;expérience est positive.<!--]--></p><p><!--[-->Nous n&#39;abandonnons pas mongo, une grosse partie de l&#39;application reste dessus pour l&#39;instant et nous nous autorisons à l&#39;utiliser pour des cas simples, des collections de données sans relations entre elles, des données très hétérogènes etc... <!--]--></p><p><!--[-->Le tout étant juste de savoir quand utiliser l&#39;un ou l&#39;autre.<!--]--></p><p><!--[-->&quot;Si vous n&#39;avez qu&#39;un marteau, tout les problèmes ressemblent à des clous&quot;<!--]--></p></div></div></div></div><hr class="mb-12"><div><span> Partager sur : </span><div class="mt-4"><a href="https://facebook.com/sharer/sharer.php?u=https://eventuallycoding.com/2019/07/03/mongodb-vers-postgresql" target="_blank" rel="noopener" aria-label=""><button type="button" class="text-white bg-[#3b5998] hover:bg-[#3b5998]/90 focus:ring-4 focus:outline-none focus:ring-[#3b5998]/50 font-medium rounded-lg text-sm px-3 py-3 text-center inline-flex items-center dark:focus:ring-[#3b5998]/55 mr-2 mb-2"><svg class="w-6 h-6" aria-hidden="true" focusable="false" data-prefix="fab" data-icon="facebook-f" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><path fill="currentColor" d="M279.1 288l14.22-92.66h-88.91v-60.13c0-25.35 12.42-50.06 52.24-50.06h40.42V6.26S260.4 0 225.4 0c-73.22 0-121.1 44.38-121.1 124.7v70.62H22.89V288h81.39v224h100.2V288z"></path></svg></button></a><a href="https://twitter.com/share?url=https://eventuallycoding.com/2019/07/03/mongodb-vers-postgresql&amp;text=Retour d&#39;utilisation de Mongodb et pourquoi nous migrons vers Postgresql&amp;via=hugolassiege" target="_blank" title="Share on Twitter" rel="noopener noreferrer"><button type="button" class="text-white bg-[#1da1f2] hover:bg-[#1da1f2]/90 focus:ring-4 focus:outline-none focus:ring-[#1da1f2]/50 font-medium rounded-lg text-sm px-3 py-3 text-center inline-flex items-center dark:focus:ring-[#1da1f2]/55 mr-2 mb-2"><svg class="w-6 h-6" aria-hidden="true" focusable="false" data-prefix="fab" data-icon="twitter" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M459.4 151.7c.325 4.548 .325 9.097 .325 13.65 0 138.7-105.6 298.6-298.6 298.6-59.45 0-114.7-17.22-161.1-47.11 8.447 .974 16.57 1.299 25.34 1.299 49.06 0 94.21-16.57 130.3-44.83-46.13-.975-84.79-31.19-98.11-72.77 6.498 .974 12.99 1.624 19.82 1.624 9.421 0 18.84-1.3 27.61-3.573-48.08-9.747-84.14-51.98-84.14-102.1v-1.299c13.97 7.797 30.21 12.67 47.43 13.32-28.26-18.84-46.78-51.01-46.78-87.39 0-19.49 5.197-37.36 14.29-52.95 51.65 63.67 129.3 105.3 216.4 109.8-1.624-7.797-2.599-15.92-2.599-24.04 0-57.83 46.78-104.9 104.9-104.9 30.21 0 57.5 12.67 76.67 33.14 23.72-4.548 46.46-13.32 66.6-25.34-7.798 24.37-24.37 44.83-46.13 57.83 21.12-2.273 41.58-8.122 60.43-16.24-14.29 20.79-32.16 39.31-52.63 54.25z"></path></svg></button></a></div></div><!----><div id="hyvor-talk-view"></div></div></div><!--]--><!--]--><footer class="lg:mt-52 border-t border-t-2"><div class="flex flex-col items-center mt-16"><div class="flex mb-3 space-x-4"><a target="_self" href="/rss.xml" class="text-sm text-gray-500 transition hover:text-gray-600"><img class="transition-transform hover:scale-110 w-8 h-8" src="/_nuxt/rss.9e0b880c.svg"></a><a class="text-sm text-gray-500 transition hover:text-gray-600" target="_blank" rel="me" href="https://piaille.fr/@hugolassiege"><span class="sr-only">Mastodon</span><img class="transition-transform hover:scale-110 w-8 h-8" src="/_nuxt/mastodon.f0ecdde8.svg"></a><a class="text-sm text-gray-500 transition hover:text-gray-600" target="_blank" rel="nofollow noopener noreferrer" href="https://github.com/hlassiege"><span class="sr-only">github</span><img class="transition-transform hover:scale-110 w-8 h-8" src="/_nuxt/github_new.4e3fe23c.svg"></a><a class="text-sm text-gray-500 transition hover:text-gray-600" target="_blank" rel="noopener noreferrer" href="https://www.linkedin.com/in/hugolassiege/"><span class="sr-only">Linkedin</span><img class="transition-transform hover:scale-110 w-8 h-8" src="/_nuxt/linkeding.34c3bc6d.svg"></a><a target="_blank" rel="nofollow noopener noreferrer" href="https://twitter.com/hugolassiege" class="text-sm text-gray-500 transition hover:text-gray-600"><img class="transition-transform hover:scale-110 w-8 h-8" src="/_nuxt/twitter.457cff27.svg"></a></div><div class="flex mb-2 space-x-2 text-sm text-gray-500 dark:text-gray-400"><div>Copyright © 2023</div><div>•</div> EventuallyCoding - A la fin de l&#39;envoi, je code !</div><div class="text-sm text-gray-500">Credits to www.freepik.com - <a href="https://www.freepik.com/vectors/citizen">Citizen vector created by freepik - </a><a href="https://www.freepik.com/vectors/css">Css vector created by vectorjuice</a></div></div></footer></div></section><!--]--></div><script type="module">import p from "/2019/07/03/mongodb-vers-postgresql/_payload.js";window.__NUXT__={...p,...((function(a,b){return {state:{},_errors:{},serverRendered:true,config:{public:{content:{locales:[],defaultLocale:b,integrity:1676815809126,experimental:{stripQueryParameters:a,clientDB:a},api:{baseURL:"\u002Fapi\u002F_content"},navigation:{fields:[]},tags:{p:"prose-p",a:"prose-a",blockquote:"prose-blockquote","code-inline":"prose-code-inline",code:"prose-code",em:"prose-em",h1:"prose-h1",h2:"prose-h2",h3:"prose-h3",h4:"prose-h4",h5:"prose-h5",h6:"prose-h6",hr:"prose-hr",img:"prose-img",ul:"prose-ul",ol:"prose-ol",li:"prose-li",strong:"prose-strong",table:"prose-table",thead:"prose-thead",tbody:"prose-tbody",td:"prose-td",th:"prose-th",tr:"prose-tr"},highlight:a,wsUrl:b,documentDriven:a,host:b,trailingSlash:a,anchorLinks:{depth:4,exclude:[1]}}},app:{baseURL:"\u002F",buildAssetsDir:"\u002F_nuxt\u002F",cdnURL:b}},prerenderedAt:1676815847314}}(false,"")))}</script><script type="module" src="/_nuxt/entry.a0b073ce.js" crossorigin></script><script type="module" src="/_nuxt/default.5a13eb30.js" crossorigin></script><script type="module" src="/_nuxt/_id_.73ebf3bb.js" crossorigin></script><script type="module" src="/_nuxt/ContentRenderer.1498c36a.js" crossorigin></script><script type="module" src="/_nuxt/ContentRendererMarkdown.cad91e83.js" crossorigin></script><script type="module" src="/_nuxt/ProseP.143a8a9b.js" crossorigin></script><script type="module" src="/_nuxt/ProseH2.c5c4021a.js" crossorigin></script><script type="module" src="/_nuxt/ProseA.351afb7a.js" crossorigin></script><script type="module" src="/_nuxt/ProseUl.b28e4f95.js" crossorigin></script><script type="module" src="/_nuxt/ProseLi.24398592.js" crossorigin></script><script type="module" src="/_nuxt/ProseImg.ae087578.js" crossorigin></script></body>
</html>