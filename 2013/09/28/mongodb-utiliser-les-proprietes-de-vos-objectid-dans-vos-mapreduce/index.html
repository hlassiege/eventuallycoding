<!DOCTYPE html>
<html >
<head><meta charset="utf-8">
<title>MongoDB : Utiliser les propri&#233;t&#233;s de vos ObjectId dans vos MapReduce | EventuallyCoding</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="https://digianalytics.fr/js/script.js" data-host="https://digianalytics.fr" id="ZwSg9rf6GA" async="" defer="" type="text/javascript"></script>
<meta name="description" content="Je vous propose de voir deux fonctionnalités plutôt pratiques de [MongoDB](http://www.mongodb.org/) dans ce billet. D’une part je vais vous parler de ...">
<meta name="og:description" content="Je vous propose de voir deux fonctionnalités plutôt pratiques de [MongoDB](http://www.mongodb.org/) dans ce billet. D’une part je vais vous parler de ...">
<meta name="og:type" content="article">
<meta name="og:title" content="MongoDB : Utiliser les propriétés de vos ObjectId dans vos MapReduce">
<meta name="og:url" content="https://eventuallycoding.com/2013/09/28/mongodb-utiliser-les-proprietes-de-vos-objectid-dans-vos-mapreduce">
<meta name="og:image" content="https://eventuallycoding.com/images/covers/cover7.jpg">
<meta name="og:image:alt" content="MongoDB : Utiliser les propriétés de vos ObjectId dans vos MapReduce">
<meta name="twitter:text:title" content="MongoDB : Utiliser les propriétés de vos ObjectId dans vos MapReduce">
<meta name="twitter:image" content="https://eventuallycoding.com/images/covers/cover7.jpg">
<meta name="twitter:card" content="summary">
<meta name="article:published_time" content="2013-09-28T00:00:00.000Z">
<meta name="article:article:modified_time" content="2013-09-28T00:00:00.000Z">
<meta name="article:article:tag" content="mapreduce,mongodb">
<link rel="canonical" href="https://eventuallycoding.com/2013/09/28/mongodb-utiliser-les-proprietes-de-vos-objectid-dans-vos-mapreduce">
<link rel="alternate" href="https://eventuallycoding.com/2013/09/28/mongodb-utiliser-les-proprietes-de-vos-objectid-dans-vos-mapreduce" hreflang="fr"><link rel="modulepreload" href="/2013/09/28/mongodb-utiliser-les-proprietes-de-vos-objectid-dans-vos-mapreduce/_payload.js"><link rel="modulepreload" as="script" crossorigin href="/_nuxt/entry.bc66937c.js"><link rel="preload" as="style" href="/_nuxt/entry.92a255c9.css"><link rel="modulepreload" as="script" crossorigin href="/_nuxt/default.464f23fe.js"><link rel="preload" as="style" href="/_nuxt/TheHeader.b358b850.css"><link rel="modulepreload" as="script" crossorigin href="/_nuxt/nuxt-link.ab83c11e.js"><link rel="modulepreload" as="script" crossorigin href="/_nuxt/siteMetaData.b87d0183.js"><link rel="modulepreload" as="script" crossorigin href="/_nuxt/_id_.1f56b819.js"><link rel="modulepreload" as="script" crossorigin href="/_nuxt/nuxt-picture.f18e9f37.js"><link rel="preload" as="style" href="/_nuxt/nuxt-picture.19f3d165.css"><link rel="modulepreload" as="script" crossorigin href="/_nuxt/_commonjsHelpers.28e086c5.js"><link rel="modulepreload" as="script" crossorigin href="/_nuxt/ContentRenderer.de158063.js"><link rel="modulepreload" as="script" crossorigin href="/_nuxt/ContentRendererMarkdown.dded116a.js"><link rel="modulepreload" as="script" crossorigin href="/_nuxt/index.a6ef77ff.js"><link rel="modulepreload" as="script" crossorigin href="/_nuxt/query.e8160beb.js"><link rel="modulepreload" as="script" crossorigin href="/_nuxt/index.61d74bb5.js"><link rel="modulepreload" as="script" crossorigin href="/_nuxt/utils.be873bed.js"><link rel="modulepreload" as="script" crossorigin href="/_nuxt/composables.0304fe6a.js"><link rel="modulepreload" as="script" crossorigin href="/_nuxt/HeroSection.49c0b8b1.js"><link rel="preload" as="style" href="/_nuxt/HeroSection.4c50b1af.css"><link rel="modulepreload" as="script" crossorigin href="/_nuxt/ProseP.f70fee99.js"><link rel="modulepreload" as="script" crossorigin href="/_nuxt/ProseA.9010ee6d.js"><link rel="modulepreload" as="script" crossorigin href="/_nuxt/ProseH2.1e235626.js"><link rel="modulepreload" as="script" crossorigin href="/_nuxt/ProseCode.d4910b28.js"><link rel="modulepreload" as="script" crossorigin href="/_nuxt/ProseUl.236ca489.js"><link rel="modulepreload" as="script" crossorigin href="/_nuxt/ProseLi.c2d015c7.js"><link rel="modulepreload" as="script" crossorigin href="/_nuxt/ProseImg.5fbeacfb.js"><link rel="modulepreload" as="script" crossorigin href="/_nuxt/ProseEm.d8619bc3.js"><link rel="modulepreload" as="script" crossorigin href="/_nuxt/ProseH3.c77d85e0.js"><link rel="modulepreload" as="script" crossorigin href="/_nuxt/ProseStrong.00132d4f.js"><link rel="prefetch" as="script" crossorigin href="/_nuxt/error-component.7d58b67f.js"><link rel="prefetch" as="image" type="image/svg+xml" href="/_nuxt/github_new.4e3fe23c.svg"><link rel="prefetch" as="image" type="image/svg+xml" href="/_nuxt/rss.9e0b880c.svg"><link rel="prefetch" as="image" type="image/svg+xml" href="/_nuxt/mastodon.f0ecdde8.svg"><link rel="prefetch" as="image" type="image/svg+xml" href="/_nuxt/linkeding.34c3bc6d.svg"><link rel="prefetch" as="image" type="image/svg+xml" href="/_nuxt/twitter.457cff27.svg"><link rel="stylesheet" href="/_nuxt/entry.92a255c9.css"><link rel="stylesheet" href="/_nuxt/TheHeader.b358b850.css"><link rel="stylesheet" href="/_nuxt/nuxt-picture.19f3d165.css"><link rel="stylesheet" href="/_nuxt/HeroSection.4c50b1af.css"><style>.inverted[data-v-129d7a9c]{--tw-bg-opacity:1;background-color:rgb(248 250 252/var(--tw-bg-opacity))}.inverted .font-to-invert-to-pink[data-v-129d7a9c]{color:rgb(236 72 153/var(--tw-text-opacity))}.inverted .font-to-invert-to-black[data-v-129d7a9c],.inverted .font-to-invert-to-pink[data-v-129d7a9c]{--tw-text-opacity:1;transition-duration:.15s;transition-property:all;transition-timing-function:cubic-bezier(.4,0,.2,1)}.inverted .font-to-invert-to-black[data-v-129d7a9c]{color:rgb(51 65 85/var(--tw-text-opacity))}.inverted .font-to-invert-to-black[data-v-129d7a9c]:hover{--tw-text-opacity:1;color:rgb(255 255 255/var(--tw-text-opacity))}.link[data-v-129d7a9c]{display:block;font-size:1rem;font-weight:500;line-height:1.5rem;overflow:hidden;padding-left:.75rem;padding-right:.75rem;position:relative;text-decoration:none}.link.NuxtLink-exact-active[data-v-129d7a9c]:after{bottom:-2px;height:100%;left:0;width:100%}.link[data-v-129d7a9c]:after{background:rgba(236,64,122,.25);bottom:-6px;content:"";height:calc(100% - 8px);left:18px;position:absolute;transition:.35s cubic-bezier(.25,.1,0,2.05);width:calc(100% - 8px);z-index:-1}.link[data-v-129d7a9c]:hover:after{bottom:-2px;height:100%;left:0;width:100%}</style><style>.nuxt-content h2{font-size:28px;font-weight:700}.nuxt-content h3{font-size:22px;font-weight:700}.nuxt-content p{margin-bottom:20px}</style><style>pre code .line{display:block;min-height:1rem}</style></head>
<body ><div id="__nuxt"><!--[--><section class="w-full pb-12 antialiased"><div class="mx-auto max-w-8xl"><div data-v-129d7a9c><nav id="header-menu" class="transition-colors fixed w-full z-10 top-0" data-v-129d7a9c><div class="max-w-7xl mx-auto px-2 sm:px-6 lg:px-8" data-v-129d7a9c><div class="relative flex items-center justify-between h-16" data-v-129d7a9c><div class="absolute inset-y-0 left-0 flex items-center sm:hidden" data-v-129d7a9c><button type="button" class="inline-flex items-center justify-center p-2 rounded-md text-gray-400 hover:text-white hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-inset focus:ring-white" aria-controls="mobile-menu" aria-expanded="false" data-v-129d7a9c><span class="sr-only" data-v-129d7a9c>Open main menu</span><svg class="block h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" aria-hidden="true" data-v-129d7a9c><path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 12h16M4 18h16" data-v-129d7a9c></path></svg><svg class="hidden h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" aria-hidden="true" data-v-129d7a9c><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" data-v-129d7a9c></path></svg></button></div><div class="flex-1 flex items-center justify-center sm:items-stretch sm:justify-start" data-v-129d7a9c><div class="flex-shrink-0 flex items-center" data-v-129d7a9c><span class="text-white text-base font-medium font-bruno text-2xl font-to-invert-to-pink" data-v-129d7a9c><a href="/" class="" data-v-129d7a9c>EventuallyCoding.com</a></span></div><div class="hidden sm:block sm:ml-6 absolute right-0 font-mark" data-v-129d7a9c><div class="flex space-x-4" data-v-129d7a9c><!--[--><a href="/speaking" class="link text-white font-to-invert-to-black" data-v-129d7a9c>Speaking</a><a href="/blog" class="link text-white font-to-invert-to-black" data-v-129d7a9c>Writing</a><a href="/resources" class="link text-white font-to-invert-to-black" data-v-129d7a9c>Resources</a><a href="/about" class="link text-white font-to-invert-to-black" data-v-129d7a9c>About</a><!--]--></div></div></div></div></div><div class="hidden" data-v-129d7a9c><div class="px-2 pt-2 pb-3 space-y-1" data-v-129d7a9c><!--[--><a href="/speaking" class="text-white hover:bg-gray-700 hover:text-white block px-3 py-2 rounded-md text-base font-medium font-to-invert-to-black" data-v-129d7a9c>Speaking</a><a href="/blog" class="text-white hover:bg-gray-700 hover:text-white block px-3 py-2 rounded-md text-base font-medium font-to-invert-to-black" data-v-129d7a9c>Writing</a><a href="/resources" class="text-white hover:bg-gray-700 hover:text-white block px-3 py-2 rounded-md text-base font-medium font-to-invert-to-black" data-v-129d7a9c>Resources</a><a href="/about" class="text-white hover:bg-gray-700 hover:text-white block px-3 py-2 rounded-md text-base font-medium font-to-invert-to-black" data-v-129d7a9c>About</a><!--]--></div></div></nav></div><!--[--><!--[--><div><section class="flex items-center justify-center h-128 bg-transparent"><canvas id="c" class="-z-10 absolute w-full h-128 block"></canvas><div class="clip-ellipse absolute top-124 rotate-180"></div><!--[--><div class="absolute top-96 w-96 -translate-y-20"><img src="/images/covers/cover7.jpg" alt="MongoDB : Utiliser les propriétés de vos ObjectId dans vos MapReduce" class="object-cover"></div><!--]--></section><div class="px-4 mx-auto sm:px-6 xl:max-w-7xl xl:px-0 mt-10"><h1 class="text-4xl text-gray-700 font-extrabold text-center mb-5">MongoDB : Utiliser les propriétés de vos ObjectId dans vos MapReduce</h1><p class="text-slate-400 text-center mb-5"><!----></p><div class="grid grid-cols-3 text-center sm:w-full md:w-1/2 mx-auto"><div><p class="text-center font-bold my-5 text-slate-400 text-xs"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 inline-block" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg> September 28, 2013</p></div><div><p class="text-center font-bold my-5 text-slate-400 text-xs"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 inline-block" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg> 6 min read</p></div><div class="flex items-center font-medium sm:mx-3 justify-center"><img src="/hugo-nb.jpg" loading="lazy" alt="" class="mr-3 w-10 h-10 rounded-full bg-slate-50 dark:bg-slate-800"><div><div class="font-bold text-slate-400 text-xs">Hugo Lassiège</div><a target="_blank" href="https://twitter.com/hugolassiege" class="font-bold text-sky-400 text-xs hover:text-sky-600"> @hugolassiege</a></div></div></div><div class="sm:w-full md:w-1/2 mx-auto"><p class="mt-2 text-xs my-3 flex flex-wrap -m-1 justify-center"><!--[--><a href="/blog?tag=mapreduce" class="m-1 leading-loose text-slate-400 border border-current lowercase px-2 rounded font-medium">#mapreduce</a><a href="/blog?tag=mongodb" class="m-1 leading-loose text-slate-400 border border-current lowercase px-2 rounded font-medium">#mongodb</a><!--]--></p></div><div class="text-left mx-auto"><div class="flex flex-wrap lg:flex-row-reverse py-12"><div class="w-full lg:w-1/4 px-5"><div class="lg:sticky top-0 pt-5 -mt-5"><div class="toc hidden lg:block"><h3 class="border-b-4 pb-3 mb-3 border-gray-200 text-xl"> On this page </h3><ul class="pl-0"><!--[--><li class="py-1"><a class="hover:text-smalt-blue-700" href="#objectid">ObjectId</a></li><li class="py-1"><a class="hover:text-smalt-blue-700" href="#mapreduce">MapReduce</a></li><!--]--></ul></div><div class="text-right mb-12"><div class="relative inline-block text-left ml-2 block lg:hidden"><div><span class="rounded-md shadow-sm"><button type="button" class="inline-flex justify-center w-full rounded-md border border-gray-300 px-4 py-2 bg-white text-sm leading-5 font-medium text-black hover:text-white hover:bg-smalt-blue-500 focus:outline-none transition ease-in-out duration-150" aria-haspopup="true" aria-expanded="true"><!--[-->On this page<!--]--><svg class="-mr-1 ml-2 h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"></path></svg></button></span></div><!----></div></div></div></div><div class="lg:w-3/4 w-full px-5 max-w-none centered-image"><div id="nuxtContent" class="prose font-proxima text-sm md:text-xl font-medium min-w-full md:p-10 mx-auto"><p><!--[-->Je vous propose de voir deux fonctionnalités plutôt pratiques de <a href="http://www.mongodb.org/" rel="nofollow"><!--[-->MongoDB<!--]--></a> dans ce billet. D’une part je vais vous parler de certaines propriétés très intéressantes des <a href="http://docs.mongodb.org/manual/reference/object-id/" rel="nofollow"><!--[-->ObjectId<!--]--></a>, la classe qu’utilise MongoDB pour générer les identifiants de vos entités, et ensuite je vais vous montrer comment utiliser cette propriété dans un exemple tout simple avec un MapReduce.<!--]--></p><h2 id="objectid"><a href="#objectid"><!--[-->ObjectId<!--]--></a></h2><p><!--[-->MongoDB est une base de données orientée documents dans laquelle vous pouvez stocker des documents Json dans des collections, elles-mêmes regroupées dans des bases de données.<!--]--></p><p><!--[-->Chaque document Json doit contenir une propriété _id qui identifie de manière unique votre document au sein de votre collection.<!--]--></p><p><!--[-->Par exemple :<!--]--></p><!--[--><pre><code>{
    &quot;_id&quot;: &quot;51f1b5b5e4b0d8b9b5b5b5b5&quot;,
    &quot;name&quot;: &quot;MongoDB&quot;,
    &quot;type&quot;: &quot;database&quot;,
    &quot;count&quot;: 1,
    &quot;info&quot;: { x: 203, y: 102 }
}
</code></pre><!--]--><!--[--><pre><code>{
&quot;\_id&quot; : 1
… autre propriétés
}
</code></pre><!--]--><p><!--[-->Par défaut, MongoDB vous propose de générer lui-même des identifiants grâce aux ObjectId :<!--]--></p><!--[--><pre><code>{

 &quot;\_id&quot; : ObjectId(&quot;5197c6b453cce2ec3a743811&quot;)
}
</code></pre><!--]--><p><!--[-->Comme MongoDB privilégie avant tout la scalabilité, ces identifiants ne sont pas générés par un processus centralisé. Évidemment quand vous les laissez générer côté serveur, l’intérêt reste limité puisque vous n’avez qu’un seul maître actif. Mais ces ObjectId peuvent être générés côté client (et certains drivers marchent de cette façon).<!--]--></p><p><!--[-->Ces identifiants doivent donc être “à priori uniques” sans avoir besoin d’un mécanisme complexe de synchronisation avec le serveur.<!--]--></p><p><!--[-->Pour cela MongoDB utilise les ObjectId qui contiennent un identifiant sur 12 bytes.<!--]--></p><ul><!--[--><li><!--[-->4 bytes qui représentent le timestamp courant (nombre de secondes depuis epoch)<!--]--></li><li><!--[-->3 bytes pour identifier la machine<!--]--></li><li><!--[-->2 bytes pour représenter l’identifiant du processus<!--]--></li><li><!--[-->3 bytes qui représentent un compteur qui démarre à un numéro aléatoire<!--]--></li><!--]--></ul><p><!--[--><img src="/images/objectid.png" alt><!--]--></p><p><!--[-->Cet ObjectId a donc une propriété très intéressante, il contient automatiquement la date de création de votre entité !<!--]--></p><p><!--[-->Ce qui nous permet d’écrire le code suivant par exemple sur le MongoShell :<!--]--></p><!--[--><pre><code>var id = ObjectId()
print(id)
ObjectId(&quot;5247019073ed0c203c79b995&quot;)
print(id.getTimestamp())
ISODate(&quot;2013-09-28T16:19:28Z&quot;)
</code></pre><!--]--><p><!--[-->Et si nous utilisions cette propriété pour obtenir quelques statistiques ?<!--]--></p><h2 id="mapreduce"><a href="#mapreduce"><!--[-->MapReduce<!--]--></a></h2><p><!--[-->Les algorithmes de MapReduce permettent de traiter des données en découpant votre problème initial en plusieurs sous-problèmes.<!--]--></p><p><!--[-->L’idée étant d’appliquer la même fonction a des sous ensembles de votre jeu de donnée initial (via une fonction map), puis d’appliquer une “réduction” de ces résultats pour les agréger et trouver le résultat final.<!--]--></p><p><!--[--><img src="/images/fcd2c-mapreduce.png" alt="mapreduce"><!--]--></p><p><!--[-->Ce type d’algorithme est géré nativement par MongoDB.<!--]--></p><p><!--[-->Pour cela vous devez définir une fonction map qui va émettre des couplés clés-valeurs.<!--]--></p><p><!--[-->Une fonction reduce qui va s’occuper de l&#39;agrégation et ensuite vous appliquez une commande MapReduce sur l’ensemble.<!--]--></p><p><!--[-->Ici, par exemple si on veut compter le nombre d’éléments dans votre collection<!--]--></p><p><!--[--><em><!--[-->(l’exemple est volontairement simpliste et n’a aucun intérêt puisque vous pouvez utiliser db.mycollection.count() pour le même résultat)<!--]--></em><!--]--></p><!--[--><pre><code>map = function() {
    emit(1,1);
}

reduce = function(key, values) {
    return  Array.sum(values);
}

db.mycollection.mapReduce( map , reduce , { out : “results” } )
{
        &quot;result&quot; : &quot;results&quot;,
        &quot;timeMillis&quot; : 751,
        &quot;counts&quot; : {
                &quot;input&quot; : 113,
                &quot;emit&quot; : 113,
                &quot;reduce&quot; : 2,
                &quot;output&quot; : 1
        },
        &quot;ok&quot; : 1,
}
</code></pre><!--]--><p><!--[-->Le résultat de ce MapReduce est désormais consultable dans la collection results et sans surprise nous n’avons qu’une seule ligne qui contient notre somme :<!--]--></p><!--[--><pre><code>db.results\_tst.find()
{ &quot;\_id&quot; : 1, &quot;value&quot; : 113 }
</code></pre><!--]--><p><!--[-->Bon, maintenant faisons quelque chose de plus intéressant et utilisons les ObjectId que nous avons vu au dessus.<!--]--></p><p><!--[-->Imaginons que vous avez un site qui contient une liste d’inscrits et que l’on vous demande le nombre d’inscription par mois.<!--]--></p><p><!--[-->Votre inscrit très basiquement :<!--]--></p><!--[--><pre><code>{
 &quot;\_id&quot; : ObjectId(&quot;5197c6b453cce2ec3a743811&quot;),
“firstname” : “Hugo”,
“lastname” : “Lassiege”
}
</code></pre><!--]--><h3 id="comment-nous-laurions-résolu-en-sql"><a href="#comment-nous-laurions-résolu-en-sql"><!--[-->Comment nous l’aurions résolu en SQL :<!--]--></a></h3><p><!--[-->En SQL, vous auriez du ajouter une colonne figurant la date de création de chaque compte :<!--]--></p><p><!--[-->ID = 1
firstname = Hugo
lastname = Lassiege
created = une date (exemple: 26 septembre 2013)<!--]--></p><p><!--[-->Ensuite vous auriez appliqué une requête ressemblant à ceci :<!--]--></p><!--[--><pre><code>SELECT COUNT(ID)
FROM accounts
GROUP BY YEAR(created), MONTH(created)
</code></pre><!--]--><p><!--[-->Afin d’éviter de faire cette requête sans arrêt nous l’aurions placé dans une vue afin de profiter d’un minimum de cache (et simplifier le requètage) :<!--]--></p><!--[--><pre><code>CREATE VIEW results as SELECT COUNT(ID)
FROM accounts
GROUP BY YEAR(created), MONTH(created)
</code></pre><!--]--><p><!--[-->Certaines bases proposent d’utiliser des vues matérialisées qui ne se rafraîchissent qu’à intervalle régulier vous évitant de relancer constamment le même calcul pour rien.<!--]--></p><p><!--[-->(A noter que Mysql ne le supporte pas)<!--]--></p><h3 id="comment-nous-pouvons-le-résoudre-avec-mongodb"><a href="#comment-nous-pouvons-le-résoudre-avec-mongodb"><!--[-->Comment nous pouvons le résoudre avec MongoDB<!--]--></a></h3><p><!--[-->Déjà partons du principe que vous n&#39;aviez pas pensé à ajouter le champ created, grâce aux ObjectId vous pourriez quand même vous en sortir :)<!--]--></p><p><!--[-->Tout d’abord nous allons créer une fonction map qui va émettre des clés qui contiendront l’année et le mois de chaque record. Nous allons utiliser la méthode getTimestamp() de ObjectId qui nous renvoie une date.<!--]--></p><p><!--[-->Il faut voir cette fonction comme l’équivalent du GROUP BY YEAR(created), MONTH(created) fait précédemment :<!--]--></p><!--[--><pre><code>map = function() { 
var key = {   y : this.\_id.getTimestamp().getFullYear(),   
         m : this.\_id.getTimestamp().getMonth()+1   };  
emit(key,1); 
}
</code></pre><!--]--><p><!--[-->Ensuite la fonction reduce qui se contentent de faire une somme, l’équivalent de notre SELECT count(ID) :<!--]--></p><!--[--><pre><code>reduce = function(key, values) { 
return Array.sum(values); 
}
</code></pre><!--]--><p><!--[-->Et enfin l’application de la commande :<!--]--></p><!--[--><pre><code>db.accounts.mapReduce( map , reduce , { out : “account\_stats” } )
db.account\_stats.find()
{ &quot;\_id&quot; : { &quot;year&quot; : 2013, &quot;month&quot; : 5 }, &quot;value&quot; : 200 }
{ &quot;\_id&quot; : { &quot;year&quot; : 2013, &quot;month&quot; : 6 }, &quot;value&quot; : 145 }
{ &quot;\_id&quot; : { &quot;year&quot; : 2013, &quot;month&quot; : 7 }, &quot;value&quot; : 32 }
{ &quot;\_id&quot; : { &quot;year&quot; : 2013, &quot;month&quot; : 8 }, &quot;value&quot; : 45 }
{ &quot;\_id&quot; : { &quot;year&quot; : 2013, &quot;month&quot; : 9 }, &quot;value&quot; : 320 }
</code></pre><!--]--><p><!--[-->Vous remarquerez que nous n’avons pas besoin de relancer le calcul à chaque nouvelle demande puisque la collection de sortie est désormais consultable très facilement.<!--]--></p><p><!--[-->Maintenant optimisons un peu cela.<!--]--></p><p><!--[-->On remarque très rapidement que recalculer systématiquement pour les mois passés n’a aucun sens puisque ces données ne peuvent plus changer. Nous allons donc utiliser un MapReduce incrémental.<!--]--></p><p><!--[-->Pour cela, il vous suffit d’appliquer deux options supplémentaires à votre commande :<!--]--></p><!--[--><pre><code>db.accounts.mapReduce( map , reduce , { 
out : { merge: &quot;account\_stats&quot; },
query : { \_id: { $gt: objectIdWithTimestamp(2013/09/01&#39;) } },
} )
</code></pre><!--]--><p><!--[-->Ici nous avons utilisé deux astuces.<!--]--></p><p><!--[-->Par défaut, le résultat d’un map reduce remplace toutes les données présentes dans la collection de sortie.<!--]--></p><p><!--[-->Mais nous pouvons préciser le paramètre <strong><!--[-->merge<!--]--></strong> pour que les résultats soient fusionnés avec des résultats déjà présents.<!--]--></p><p><!--[-->Cela va nous permettre de n’ajouter que les résultats concernant les derniers mois.<!--]--></p><p><!--[-->Et nous allons utiliser le paramètre <strong><!--[-->query<!--]--></strong> pour limiter le jeu de données sur lequel appliquer l’algorithme.<!--]--></p><p><!--[-->Ici nous utilisons une méthode que vous devez définir au préalable permettant de créer un ObjectId à partir d’une date :<!--]--></p><!--[--><pre><code>function objectIdWithTimestamp(timestamp)
{
    // Convert string date to Date object (otherwise assume timestamp is a date)
    if (typeof(timestamp) == &#39;string&#39;) {
        timestamp = new Date(timestamp);
    }

    // Convert date object to hex seconds since Unix epoch
    var hexSeconds = Math.floor(timestamp/1000).toString(16);

    // Create an ObjectId with that hex timestamp
    var constructedObjectId = ObjectId(hexSeconds + &quot;0000000000000000&quot;);

    return constructedObjectId
} 
</code></pre><!--]--><p><!--[-->(source : <a href="http://stackoverflow.com/questions/8749971/can-i-query-mongodb-objectid-by-date" rel="nofollow"><!--[-->http://stackoverflow.com/questions/8749971/can-i-query-mongodb-objectid-by-date<!--]--></a>)<!--]--></p><p><!--[-->Et voila, vous avez désormais un mapreduce incrémental. On remarquera quand même que l&#39;utilisation d&#39;une date aurait malgré tout simplifié l&#39;écriture de la query de filtrage mais nous nous en sommes sortis sans champ &quot;created&quot;.<!--]--></p><p><!--[-->Et c’est terminé. Nous aurions pu voir encore de multiples choses, comment lancer un MapReduce en Java ou comment faire la même chose avec le framework d’aggrégation de MongoDB. Peut-être une autre fois.<!--]--></p><p><!--[-->Ou bien vous pouvez aussi me contacter pour <a href="http://www.lateral-thoughts.com/formations/formation-mongodb" rel="nofollow"><!--[-->une formation sur MongoDB<!--]--></a> si jamais ça vous intéresse ;)<!--]--></p></div></div></div></div><hr class="mb-12"><div><span> Partager sur : </span><div class="mt-4"><a href="https://facebook.com/sharer/sharer.php?u=https://eventuallycoding.com/2013/09/28/mongodb-utiliser-les-proprietes-de-vos-objectid-dans-vos-mapreduce" target="_blank" rel="noopener" aria-label=""><button type="button" class="text-white bg-[#3b5998] hover:bg-[#3b5998]/90 focus:ring-4 focus:outline-none focus:ring-[#3b5998]/50 font-medium rounded-lg text-sm px-3 py-3 text-center inline-flex items-center dark:focus:ring-[#3b5998]/55 mr-2 mb-2"><svg class="w-6 h-6" aria-hidden="true" focusable="false" data-prefix="fab" data-icon="facebook-f" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><path fill="currentColor" d="M279.1 288l14.22-92.66h-88.91v-60.13c0-25.35 12.42-50.06 52.24-50.06h40.42V6.26S260.4 0 225.4 0c-73.22 0-121.1 44.38-121.1 124.7v70.62H22.89V288h81.39v224h100.2V288z"></path></svg></button></a><a href="https://twitter.com/share?url=https://eventuallycoding.com/2013/09/28/mongodb-utiliser-les-proprietes-de-vos-objectid-dans-vos-mapreduce&amp;text=MongoDB : Utiliser les propriétés de vos ObjectId dans vos MapReduce&amp;via=hugolassiege" target="_blank" title="Share on Twitter" rel="noopener noreferrer"><button type="button" class="text-white bg-[#1da1f2] hover:bg-[#1da1f2]/90 focus:ring-4 focus:outline-none focus:ring-[#1da1f2]/50 font-medium rounded-lg text-sm px-3 py-3 text-center inline-flex items-center dark:focus:ring-[#1da1f2]/55 mr-2 mb-2"><svg class="w-6 h-6" aria-hidden="true" focusable="false" data-prefix="fab" data-icon="twitter" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M459.4 151.7c.325 4.548 .325 9.097 .325 13.65 0 138.7-105.6 298.6-298.6 298.6-59.45 0-114.7-17.22-161.1-47.11 8.447 .974 16.57 1.299 25.34 1.299 49.06 0 94.21-16.57 130.3-44.83-46.13-.975-84.79-31.19-98.11-72.77 6.498 .974 12.99 1.624 19.82 1.624 9.421 0 18.84-1.3 27.61-3.573-48.08-9.747-84.14-51.98-84.14-102.1v-1.299c13.97 7.797 30.21 12.67 47.43 13.32-28.26-18.84-46.78-51.01-46.78-87.39 0-19.49 5.197-37.36 14.29-52.95 51.65 63.67 129.3 105.3 216.4 109.8-1.624-7.797-2.599-15.92-2.599-24.04 0-57.83 46.78-104.9 104.9-104.9 30.21 0 57.5 12.67 76.67 33.14 23.72-4.548 46.46-13.32 66.6-25.34-7.798 24.37-24.37 44.83-46.13 57.83 21.12-2.273 41.58-8.122 60.43-16.24-14.29 20.79-32.16 39.31-52.63 54.25z"></path></svg></button></a></div></div><div id="hyvor-talk-view"></div></div></div><!--]--><!--]--><footer class="lg:mt-52 border-t border-t-2"><div class="flex flex-col items-center mt-16"><div class="flex mb-3 space-x-4"><a target="_self" href="/rss.xml" class="text-sm text-gray-500 transition hover:text-gray-600"><img class="transition-transform hover:scale-110 w-8 h-8" src="/_nuxt/rss.9e0b880c.svg"></a><a class="text-sm text-gray-500 transition hover:text-gray-600" target="_blank" rel="me" href="https://piaille.fr/@hugolassiege"><span class="sr-only">Mastodon</span><img class="transition-transform hover:scale-110 w-8 h-8" src="/_nuxt/mastodon.f0ecdde8.svg"></a><a class="text-sm text-gray-500 transition hover:text-gray-600" target="_blank" rel="nofollow noopener noreferrer" href="https://github.com/hlassiege"><span class="sr-only">github</span><img class="transition-transform hover:scale-110 w-8 h-8" src="/_nuxt/github_new.4e3fe23c.svg"></a><a class="text-sm text-gray-500 transition hover:text-gray-600" target="_blank" rel="noopener noreferrer" href="https://www.linkedin.com/in/hugolassiege/"><span class="sr-only">Linkedin</span><img class="transition-transform hover:scale-110 w-8 h-8" src="/_nuxt/linkeding.34c3bc6d.svg"></a><a target="_blank" rel="nofollow noopener noreferrer" href="https://twitter.com/hugolassiege" class="text-sm text-gray-500 transition hover:text-gray-600"><img class="transition-transform hover:scale-110 w-8 h-8" src="/_nuxt/twitter.457cff27.svg"></a></div><div class="flex mb-2 space-x-2 text-sm text-gray-500 dark:text-gray-400"><div>Copyright © 2023</div><div>•</div> EventuallyCoding - A la fin de l&#39;envoi, je code !</div><div class="text-sm text-gray-500"> Credits to www.freepik.com - <a href="https://www.freepik.com/vectors/citizen">Citizen vector created by freepik - </a><a href="https://www.freepik.com/vectors/css">Css vector created by vectorjuice</a></div></div></footer></div></section><!--]--></div><script type="module">import p from "/2013/09/28/mongodb-utiliser-les-proprietes-de-vos-objectid-dans-vos-mapreduce/_payload.js";window.__NUXT__={...p,...((function(a,b){return {state:{},_errors:{},serverRendered:true,config:{public:{content:{locales:[],defaultLocale:b,integrity:1676842508608,experimental:{stripQueryParameters:a,clientDB:a},api:{baseURL:"\u002Fapi\u002F_content"},navigation:{fields:[]},tags:{p:"prose-p",a:"prose-a",blockquote:"prose-blockquote","code-inline":"prose-code-inline",code:"prose-code",em:"prose-em",h1:"prose-h1",h2:"prose-h2",h3:"prose-h3",h4:"prose-h4",h5:"prose-h5",h6:"prose-h6",hr:"prose-hr",img:"prose-img",ul:"prose-ul",ol:"prose-ol",li:"prose-li",strong:"prose-strong",table:"prose-table",thead:"prose-thead",tbody:"prose-tbody",td:"prose-td",th:"prose-th",tr:"prose-tr"},highlight:a,wsUrl:b,documentDriven:a,host:b,trailingSlash:a,anchorLinks:{depth:4,exclude:[1]}}},app:{baseURL:"\u002F",buildAssetsDir:"\u002F_nuxt\u002F",cdnURL:b}},prerenderedAt:1676842542274}}(false,"")))}</script><script type="module" src="/_nuxt/entry.bc66937c.js" crossorigin></script><script type="module" src="/_nuxt/default.464f23fe.js" crossorigin></script><script type="module" src="/_nuxt/_id_.1f56b819.js" crossorigin></script><script type="module" src="/_nuxt/ContentRenderer.de158063.js" crossorigin></script><script type="module" src="/_nuxt/ContentRendererMarkdown.dded116a.js" crossorigin></script><script type="module" src="/_nuxt/ProseP.f70fee99.js" crossorigin></script><script type="module" src="/_nuxt/ProseA.9010ee6d.js" crossorigin></script><script type="module" src="/_nuxt/ProseH2.1e235626.js" crossorigin></script><script type="module" src="/_nuxt/ProseCode.d4910b28.js" crossorigin></script><script type="module" src="/_nuxt/ProseUl.236ca489.js" crossorigin></script><script type="module" src="/_nuxt/ProseLi.c2d015c7.js" crossorigin></script><script type="module" src="/_nuxt/ProseImg.5fbeacfb.js" crossorigin></script><script type="module" src="/_nuxt/ProseEm.d8619bc3.js" crossorigin></script><script type="module" src="/_nuxt/ProseH3.c77d85e0.js" crossorigin></script><script type="module" src="/_nuxt/ProseStrong.00132d4f.js" crossorigin></script></body>
</html>