<!DOCTYPE html>
<html lang="fr">
<head><meta charset="utf-8">
<title>Nosql, 4 bases &#224; la loupe 2/4 | EventuallyCoding</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="https://digianalytics.fr/js/script.js" data-host="https://digianalytics.fr" id="ZwSg9rf6GA" async="" defer="" type="text/javascript"></script>
<meta name="description" content="[![](/images/nosql-logo.gif &quot;nosql-logo&quot;)](http://hakanai.free.fr/index.php/nosql-4-bases-a-la-loupe-14/nosql-logo/)Vous vous rappelez du bouquin [7 d...">
<meta name="og:description" content="[![](/images/nosql-logo.gif &quot;nosql-logo&quot;)](http://hakanai.free.fr/index.php/nosql-4-bases-a-la-loupe-14/nosql-logo/)Vous vous rappelez du bouquin [7 d...">
<meta name="og:type" content="article">
<meta name="og:title" content="Nosql, 4 bases à la loupe 2/4">
<meta name="og:url" content="https://eventuallycoding.com/2012/11/11/nosql-4-bases-a-la-loupe-24">
<meta name="og:image" content="https://eventuallycoding.com/images/covers/cover2.jpg">
<meta name="og:image:alt" content="Nosql, 4 bases à la loupe 2/4">
<meta name="twitter:text:title" content="Nosql, 4 bases à la loupe 2/4">
<meta name="twitter:image" content="https://eventuallycoding.com/images/covers/cover2.jpg">
<meta name="twitter:card" content="summary">
<meta name="article:published_time" content="2012-11-11T00:00:00.000Z">
<meta name="article:article:modified_time" content="2012-11-11T00:00:00.000Z">
<meta name="article:article:tag" content="lucene,mongodb,redis">
<link rel="canonical" href="https://eventuallycoding.com/2012/11/11/nosql-4-bases-a-la-loupe-24">
<link rel="alternate" href="https://eventuallycoding.com/2012/11/11/nosql-4-bases-a-la-loupe-24" hreflang="fr"><link rel="modulepreload" href="/2012/11/11/nosql-4-bases-a-la-loupe-24/_payload.js"><link rel="modulepreload" as="script" crossorigin href="/_nuxt/entry.88dbae5f.js"><link rel="preload" as="style" href="/_nuxt/entry.a4b241a7.css"><link rel="modulepreload" as="script" crossorigin href="/_nuxt/default.ef1af82c.js"><link rel="preload" as="style" href="/_nuxt/TheHeader.b358b850.css"><link rel="modulepreload" as="script" crossorigin href="/_nuxt/nuxt-link.36fc9595.js"><link rel="modulepreload" as="script" crossorigin href="/_nuxt/siteMetaData.b74feb44.js"><link rel="modulepreload" as="script" crossorigin href="/_nuxt/_id_.58899afd.js"><link rel="modulepreload" as="script" crossorigin href="/_nuxt/nuxt-picture.e949953a.js"><link rel="preload" as="style" href="/_nuxt/nuxt-picture.19f3d165.css"><link rel="modulepreload" as="script" crossorigin href="/_nuxt/_commonjsHelpers.28e086c5.js"><link rel="modulepreload" as="script" crossorigin href="/_nuxt/ContentRenderer.8d5ab423.js"><link rel="modulepreload" as="script" crossorigin href="/_nuxt/ContentRendererMarkdown.980ec26e.js"><link rel="modulepreload" as="script" crossorigin href="/_nuxt/index.a6ef77ff.js"><link rel="modulepreload" as="script" crossorigin href="/_nuxt/query.664701c0.js"><link rel="modulepreload" as="script" crossorigin href="/_nuxt/index.61d74bb5.js"><link rel="modulepreload" as="script" crossorigin href="/_nuxt/utils.5740425a.js"><link rel="modulepreload" as="script" crossorigin href="/_nuxt/composables.3fdf5460.js"><link rel="modulepreload" as="script" crossorigin href="/_nuxt/HeroSection.e16a8d82.js"><link rel="preload" as="style" href="/_nuxt/HeroSection.4c50b1af.css"><link rel="modulepreload" as="script" crossorigin href="/_nuxt/ProseP.b19e702a.js"><link rel="modulepreload" as="script" crossorigin href="/_nuxt/ProseA.99007763.js"><link rel="modulepreload" as="script" crossorigin href="/_nuxt/ProseImg.9cce0247.js"><link rel="modulepreload" as="script" crossorigin href="/_nuxt/ProseUl.1281c19c.js"><link rel="modulepreload" as="script" crossorigin href="/_nuxt/ProseLi.43a10d0a.js"><link rel="modulepreload" as="script" crossorigin href="/_nuxt/ProseH3.b22d331f.js"><link rel="modulepreload" as="script" crossorigin href="/_nuxt/ProseEm.5a807b06.js"><link rel="modulepreload" as="script" crossorigin href="/_nuxt/ProseStrong.9863733c.js"><link rel="modulepreload" as="script" crossorigin href="/_nuxt/ProseCode.524f80b5.js"><link rel="modulepreload" as="script" crossorigin href="/_nuxt/ProseH4.f173cefe.js"><link rel="prefetch" as="script" crossorigin href="/_nuxt/error-component.a950f9e2.js"><link rel="prefetch" as="image" type="image/svg+xml" href="/_nuxt/github_new.4e3fe23c.svg"><link rel="prefetch" as="image" type="image/svg+xml" href="/_nuxt/rss.9e0b880c.svg"><link rel="prefetch" as="image" type="image/svg+xml" href="/_nuxt/mastodon.f0ecdde8.svg"><link rel="prefetch" as="image" type="image/svg+xml" href="/_nuxt/linkeding.34c3bc6d.svg"><link rel="prefetch" as="image" type="image/svg+xml" href="/_nuxt/twitter.457cff27.svg"><link rel="stylesheet" href="/_nuxt/entry.a4b241a7.css"><link rel="stylesheet" href="/_nuxt/TheHeader.b358b850.css"><link rel="stylesheet" href="/_nuxt/nuxt-picture.19f3d165.css"><link rel="stylesheet" href="/_nuxt/HeroSection.4c50b1af.css"><style>.inverted[data-v-129d7a9c]{--tw-bg-opacity:1;background-color:rgb(248 250 252/var(--tw-bg-opacity))}.inverted .font-to-invert-to-pink[data-v-129d7a9c]{color:rgb(236 72 153/var(--tw-text-opacity))}.inverted .font-to-invert-to-black[data-v-129d7a9c],.inverted .font-to-invert-to-pink[data-v-129d7a9c]{--tw-text-opacity:1;transition-duration:.15s;transition-property:all;transition-timing-function:cubic-bezier(.4,0,.2,1)}.inverted .font-to-invert-to-black[data-v-129d7a9c]{color:rgb(51 65 85/var(--tw-text-opacity))}.inverted .font-to-invert-to-black[data-v-129d7a9c]:hover{--tw-text-opacity:1;color:rgb(255 255 255/var(--tw-text-opacity))}.link[data-v-129d7a9c]{display:block;font-size:1rem;font-weight:500;line-height:1.5rem;overflow:hidden;padding-left:.75rem;padding-right:.75rem;position:relative;text-decoration:none}.link.NuxtLink-exact-active[data-v-129d7a9c]:after{bottom:-2px;height:100%;left:0;width:100%}.link[data-v-129d7a9c]:after{background:rgba(236,64,122,.25);bottom:-6px;content:"";height:calc(100% - 8px);left:18px;position:absolute;transition:.35s cubic-bezier(.25,.1,0,2.05);width:calc(100% - 8px);z-index:-1}.link[data-v-129d7a9c]:hover:after{bottom:-2px;height:100%;left:0;width:100%}</style><style>.nuxt-content h2{font-size:28px;font-weight:700}.nuxt-content h3{font-size:22px;font-weight:700}.nuxt-content p{margin-bottom:20px}</style><style>pre code .line{display:block;min-height:1rem}</style></head>
<body ><div id="__nuxt"><!--[--><section class="w-full pb-12 antialiased"><div class="mx-auto max-w-8xl"><div data-v-129d7a9c><nav id="header-menu" class="transition-colors fixed w-full z-10 top-0" data-v-129d7a9c><div class="max-w-7xl mx-auto px-2 sm:px-6 lg:px-8" data-v-129d7a9c><div class="relative flex items-center justify-between h-16" data-v-129d7a9c><div class="absolute inset-y-0 left-0 flex items-center sm:hidden" data-v-129d7a9c><button type="button" class="inline-flex items-center justify-center p-2 rounded-md text-gray-400 hover:text-white hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-inset focus:ring-white" aria-controls="mobile-menu" aria-expanded="false" data-v-129d7a9c><span class="sr-only" data-v-129d7a9c>Open main menu</span><svg class="block h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" aria-hidden="true" data-v-129d7a9c><path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 12h16M4 18h16" data-v-129d7a9c></path></svg><svg class="hidden h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" aria-hidden="true" data-v-129d7a9c><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" data-v-129d7a9c></path></svg></button></div><div class="flex-1 flex items-center justify-center sm:items-stretch sm:justify-start" data-v-129d7a9c><div class="flex-shrink-0 flex items-center" data-v-129d7a9c><span class="text-white text-base font-medium font-bruno text-2xl font-to-invert-to-pink" data-v-129d7a9c><a href="/" class="" data-v-129d7a9c>EventuallyCoding.com</a></span></div><div class="hidden sm:block sm:ml-6 absolute right-0 font-mark" data-v-129d7a9c><div class="flex space-x-4" data-v-129d7a9c><!--[--><a href="/speaking" class="link text-white font-to-invert-to-black" data-v-129d7a9c>Speaking</a><a href="/blog" class="link text-white font-to-invert-to-black" data-v-129d7a9c>Writing</a><a href="/resources" class="link text-white font-to-invert-to-black" data-v-129d7a9c>Resources</a><a href="/about" class="link text-white font-to-invert-to-black" data-v-129d7a9c>About</a><!--]--></div></div></div></div></div><div class="hidden" data-v-129d7a9c><div class="px-2 pt-2 pb-3 space-y-1" data-v-129d7a9c><!--[--><a href="/speaking" class="text-white hover:bg-gray-700 hover:text-white block px-3 py-2 rounded-md text-base font-medium font-to-invert-to-black" data-v-129d7a9c>Speaking</a><a href="/blog" class="text-white hover:bg-gray-700 hover:text-white block px-3 py-2 rounded-md text-base font-medium font-to-invert-to-black" data-v-129d7a9c>Writing</a><a href="/resources" class="text-white hover:bg-gray-700 hover:text-white block px-3 py-2 rounded-md text-base font-medium font-to-invert-to-black" data-v-129d7a9c>Resources</a><a href="/about" class="text-white hover:bg-gray-700 hover:text-white block px-3 py-2 rounded-md text-base font-medium font-to-invert-to-black" data-v-129d7a9c>About</a><!--]--></div></div></nav></div><!--[--><!--[--><div><section class="flex items-center justify-center h-128 bg-transparent"><canvas id="c" class="-z-10 absolute w-full h-128 block"></canvas><div class="clip-ellipse absolute top-124 rotate-180"></div><!--[--><div class="absolute top-96 w-96 -translate-y-20"><img src="/images/covers/cover2.jpg" alt="Nosql, 4 bases à la loupe 2/4" class="object-cover"></div><!--]--></section><div class="px-4 mx-auto sm:px-6 xl:max-w-7xl xl:px-0 mt-10"><div><h1 class="text-4xl text-gray-700 font-extrabold text-center mb-5">Nosql, 4 bases à la loupe 2/4</h1><p class="text-slate-400 text-center mb-5"><!----></p><div class="grid grid-cols-3 text-center sm:w-full md:w-1/2 mx-auto"><div><p class="text-center font-bold my-5 text-slate-400 text-xs"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 inline-block" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg> November 11, 2012</p></div><div><p class="text-center font-bold my-5 text-slate-400 text-xs"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 inline-block" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg> 10 min read</p></div><div class="flex items-center font-medium sm:mx-3 justify-center"><img src="/hugo-nb.jpg" loading="lazy" alt="" class="mr-3 w-10 h-10 rounded-full bg-slate-50 dark:bg-slate-800"><div><div class="font-bold text-slate-400 text-xs">Hugo Lassiège</div><a target="_blank" href="https://twitter.com/hugolassiege" class="font-bold text-sky-400 text-xs hover:text-sky-600"> @hugolassiege</a></div></div></div><div class="sm:w-full md:w-1/2 mx-auto"><p class="mt-2 text-xs my-3 flex flex-wrap -m-1 justify-center"><!--[--><a href="/blog?tag=lucene" class="m-1 leading-loose text-slate-400 border border-current lowercase px-2 rounded font-medium">#lucene</a><a href="/blog?tag=mongodb" class="m-1 leading-loose text-slate-400 border border-current lowercase px-2 rounded font-medium">#mongodb</a><a href="/blog?tag=redis" class="m-1 leading-loose text-slate-400 border border-current lowercase px-2 rounded font-medium">#redis</a><!--]--></p></div></div><div class="text-left mx-auto"><div class="flex flex-wrap lg:flex-row-reverse py-12"><div class="w-full lg:w-1/4 px-5"><div class="lg:sticky top-0 pt-5 -mt-5"><div class="toc hidden lg:block"><p class="border-b-4 pb-3 mb-3 border-gray-200 text-xl"> On this page </p><ul class="pl-0"><!--[--><li class="ml-4 py-1"><a class="text-shark-400 hover:text-smalt-blue-700" href="#redis">Redis</a></li><li class="ml-4 py-1"><a class="text-shark-400 hover:text-smalt-blue-700" href="#mongodb">MongoDb</a></li><li class="ml-4 py-1"><a class="text-shark-400 hover:text-smalt-blue-700" href="#mongo-et-lucene">Mongo et Lucene</a></li><!--]--></ul></div><div class="text-right mb-12"><div class="relative inline-block text-left ml-2 block lg:hidden"><div><span class="rounded-md shadow-sm"><button type="button" class="inline-flex justify-center w-full rounded-md border border-gray-300 px-4 py-2 bg-white text-sm leading-5 font-medium text-black hover:text-white hover:bg-smalt-blue-500 focus:outline-none transition ease-in-out duration-150" aria-haspopup="true" aria-expanded="true"><!--[-->On this page<!--]--><svg class="-mr-1 ml-2 h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"></path></svg></button></span></div><!----></div></div></div></div><div class="lg:w-3/4 w-full px-5 max-w-none centered-image"><div id="nuxtContent" class="prose font-proxima text-sm md:text-xl font-medium min-w-full md:p-10 mx-auto"><p><!--[--><a href="http://hakanai.free.fr/index.php/nosql-4-bases-a-la-loupe-14/nosql-logo/" rel="nofollow"><!--[--><img src="/images/nosql-logo.gif" alt title="nosql-logo"><!--]--></a>Vous vous rappelez du bouquin <a href="http://pragprog.com/book/rwdata/seven-databases-in-seven-weeks" rel="nofollow"><!--[-->7 databases in seven weeks<!--]--></a> ? Pour le coup j&#39;ai eu l&#39;occasion de réaliser une expérience un peu moins ambitieuse, seulement 4 bases de données. Et si je n&#39;ai pas été aussi loin que le bouquin précédent je vous propose quand même un retour d&#39;expérience sur :<!--]--></p><ul><!--[--><li><!--[-->Redis<!--]--></li><li><!--[-->Solr<!--]--></li><li><!--[-->Elastic Search<!--]--></li><li><!--[-->MongoDb<!--]--></li><!--]--></ul><p><!--[-->Ce billet fait partie d&#39;une série de plusieurs billets dont le premier est <a href="http://hakanai.free.fr/index.php/nosql-4-bases-a-la-loupe-14/" rel="nofollow" title="Nosql, 4 bases à la loupe 1/4"><!--[-->ici<!--]--></a>. Et le sujet de celui-ci est MongoDb et Redis.<!--]--></p><h3 id="redis"><a href="#redis"><!--[--><a href="http://redis.io/" rel="nofollow"><!--[-->Redis<!--]--></a><!--]--></a></h3><p><!--[--><em><!--[-->Note : Redis n&#39;est pas disponible sur Windows du coup j&#39;ai du prendre une version non officielle pour tester.<!--]--></em><!--]--></p><p><!--[-->C&#39;est la première base de données que j&#39;ai testé sous les conseils de <a href="https://fr.twitter.com/jblemee" rel="nofollow"><!--[-->Jean Baptiste Lemée<!--]--></a>. Il s&#39;agit avant tout d&#39;un stockage <strong><!--[-->clé-valeur<!--]--></strong> mais il permet aussi de manipuler des listes et des sets. On hésite parfois à la considérer comme une base de données et plus comme un cache.<!--]--></p><p><!--[-->Et pourtant c&#39;est bien une base de données, les données sont persisté sur disque.<!--]--></p><p><!--[-->Sur le chapitre des fonctionnalités Redis, malgré le fait qu&#39;il soit rangé dans la catégorie des bases clé valeurs, reste assez riche. On pourra gérer des transactions, enchaîner des commandes (pipeline), gérer des listes ou des sets. Sur le papier c&#39;est donc pas mal : rapide, fonctionnellement plus riche que d&#39;autres équivalents clé-valeur. Mais malgré tout on est quand même loin de la richesse fonctionnelle attendue, pas de recherche full text ou de géospatial et surtout une représentation des données qui va nous obliger à pas mal de gymnastique.<!--]--></p><p><!--[-->Avec ce mode de stockage, il faut être imaginatif et changer sa façon de concevoir ces modèles de données. Notamment il faut penser &quot;dénormalisation&quot;.<!--]--></p><p><!--[--><strong><!--[-->Explication.<!--]--></strong> Redis est orienté clé valeur donc même si nous pouvons stocker notre document sous forme Json il nous sera alors impossible de requêter sur une de ces propriétés, ce n’est donc pas suffisant. Du coup, on va dénormaliser notre objet au maximum et stocker chaque propriété selon des conventions de nommage que nous allons nous fixer. Par exemple pour un objet Profile nous pourrions avoir les records suivants :<!--]--></p><p><!--[--><em><!--[-->&quot;id:1:login&quot; =&gt; &quot;loginDuPremierProfile&quot; &quot;login:loginDuPremierProfile&quot; =&gt; 1<!--]--></em><!--]--></p><p><!--[-->Ces deux premiers records permettront de rechercher très rapidement o(1) un profile par son login ou bien de connaitre le login du profile d&#39;id 1.<!--]--></p><p><!--[--><em><!--[-->&quot;id:1:email&quot; =&gt; &quot;<a href="mailto:profile@email.com" rel="noopener noreferrer"><!--[-->profile@email.com<!--]--></a>&quot; &quot;email:<a href="mailto:profile@email.com" rel="noopener noreferrer"><!--[-->profile@email.com<!--]--></a>&quot; =&gt; 1<!--]--></em><!--]--></p><p><!--[-->même genre d&#39;exemple avec l&#39;email.<!--]--></p><p><!--[--><em><!--[-->&quot;profile:1:object&quot; =&gt; représentation JSON de mon objet Profile<!--]--></em><!--]--></p><p><!--[-->Et enfin un dernier record permettant de stocker l&#39;objet entier lorsqu&#39;on veut le récupérer en une seule fois.<!--]--></p><p><!--[-->Un exemple avec redis-cli en ligne de commande :<!--]--></p><!--[--><pre><code>
redis 127.0.0.1:6379&gt; get profile:login1:object
&quot;{&quot;address&quot;:{&quot;zipCode&quot;:&quot;1&quot;,&quot;loc&quot;:[0.0,0.0]},&quot;_id&quot;:&quot;login1&quot;}&quot;
</code></pre><!--]--><p><!--[-->Une recherche par login va donc se faire en plusieurs requêtes :<!--]--></p><p><!--[-->&quot;login:loginDuPremierProfile&quot; va nous renvoyer 1 &quot;profile:1:object&quot; va nous renvoyer l&#39;objet sérialisé en json.<!--]--></p><p><!--[-->Je ne vais pas plus loin pour mon exemple mais vous pouvez trouver la liste des opérations possibles sur vos données ici : <a href="http://redis.io/commands" rel="nofollow"><!--[-->http://redis.io/commands<!--]--></a><!--]--></p><p><!--[-->Voyons les APIs<!--]--></p><h4 id="jedis"><a href="#jedis"><!--[-->Jedis<!--]--></a></h4><p><!--[-->Ce fut a mon sens une erreur en testant Redis, j&#39;ai utilisé <a href="https://github.com/xetorthio/jedis" rel="nofollow"><!--[-->Jedis<!--]--></a> comme client et je suis donc resté très proche du protocole. Sauf qu&#39;il ne s&#39;agit pas du protocole le plus simple.<!--]--></p><p><!--[-->Voyons par exemple le code pour le cas que j&#39;ai décrit plus haut :<!--]--></p><!--[--><pre><code>
ObjectMapper mapper = new ObjectMapper();
jedis.set(&quot;fid:&quot;+profile.getLogin()+&quot;:login&quot;,profile.getLogin());
jedis.set(&quot;flogin:&quot;+profile.getLogin(),profile.getLogin());
jedis.set(&quot;fid:&quot;+profile.getLogin()+&quot;:zipcode&quot;,profile.getAddress().getZipCode());
jedis.set(&quot;zipcode:&quot;+profile.getAddress().getZipCode(), profile.getLogin());
jedis.set(&quot;profile:&quot;+profile.getLogin()+&quot;:object&quot;,mapper.writeValueAsString(profile));
jedis.incr(&quot;profile:count&quot;);
</code></pre><!--]--><p><!--[-->Je sens que vous comprenez à quel point les migrations de données vont être galère (par exemple le jour où vous décidez de rajouter une autre propriété disponible pour la recherche...)<!--]--></p><p><!--[-->Vous pouvez jeter un oeil sur <a href="https://bitbucket.org/hlassiege/nosql/src/821b12c7c105/src/test/java/com/sandbox/JedisTest.java?at=default" rel="nofollow"><!--[-->JedisTest<!--]--></a>, pour moi ce fut une mauvaise entrée en matière. J’ai peu apprécié l’API. Par contre côté perf je n’ai pas été décu :<!--]--></p><p><!--[--><strong><!--[-->JedisTest<!--]--></strong>.findByLoginShouldReturnSomething: [measured 10 out of 15 rounds, threads: 1 (sequential)] round: <strong><!--[-->0.03<!--]--></strong> [+- 0.01], round.gc: 0.00 [+- 0.00], GC.calls: 2, GC.time: 0.00, time.total: 57.59, time.warmup: 57.25, time.bench: 0.34 <strong><!--[-->JedisTest<!--]--></strong>.assertThatMyDatabaseHasMoreThan100Profile: [measured 10 out of 15 rounds, threads: 1 (sequential)] round: <strong><!--[-->0.00<!--]--></strong> [+- 0.00], round.gc: 0.00 [+- 0.00], GC.calls: 0, GC.time: 0.00, time.total: 0.07, time.warmup: 0.03, time.bench: 0.04 <strong><!--[-->JedisTest<!--]--></strong>.testSearchWithEmbeddedObject: [measured 10 out of 15 rounds, threads: 1 (sequential)] round: <strong><!--[-->0.03<!--]--></strong> [+- 0.00], round.gc: 0.00 [+- 0.00], GC.calls: 2, GC.time: 0.00, time.total: 0.43, time.warmup: 0.15, time.bench: 0.28<!--]--></p><p><!--[-->Et surtout, quelque soit la volumétrie ce temps est constant puisqu&#39;on accède à chaque enregistrement par sa clé.<!--]--></p><p><!--[-->Par la suite on m&#39;a conseillé d&#39;autres apis sans doute plus adapté :<!--]--></p><ul><!--[--><li><!--[-->Johm<!--]--></li><li><!--[-->Spring Data<!--]--></li><!--]--></ul><h4 id="johm"><a href="#johm"><!--[-->Johm<!--]--></a></h4><p><!--[--><a href="https://github.com/xetorthio/johm" rel="nofollow"><!--[-->https://github.com/xetorthio/johm<!--]--></a> J’ai voulu tester Johm car le premier a m’avoir aiguillé vers des Apis plus haut niveau m’avait conseillé Ohm (pour Ruby). Mais malgré l’annonce sur Github : <em><!--[-->JOhm is still in active development.<!--]--></em>, le dernier commit date de 2 ans... J’ai quand même voulu testé mais Johm n’est pas compatible avec les dernières versions de Redis. Epic fail.<!--]--></p><h4 id="spring-data-redis"><a href="#spring-data-redis"><!--[-->Spring data Redis<!--]--></a></h4><p><!--[--><a href="http://www.springsource.org/spring-data/redis" rel="nofollow"><!--[-->http://www.springsource.org/spring-data/redis<!--]--></a> Pour le coup même si j’utilise Spring depuis 2006 et que j’en ai été un grand fan, aujourd’hui je n’avais pas envie de faire entrer le loup dans la bergerie. Je serais ravi d’approfondir le fond de ma pensée autour d’un verre, mais ce n’est pas le sujet de ce billet. Bon, malgré tout si j’avais choisi Redis, ce que je n’ai pas fait au final, je pense que ca aurait été l’API à choisir.<!--]--></p><h3 id="mongodb"><a href="#mongodb"><!--[--><a href="http://www.mongodb.org/" rel="nofollow"><!--[-->MongoDb<!--]--></a><!--]--></a></h3><p><!--[-->MongoDb fait partie de la famille des bases Nosql orienté document. Plus riche fonctionnellement que Redis on va notamment trouver le support des recherches géospatiales, des fonctions d’aggrégation, le stockage de fichiers de grandes tailles avec GridFS. Par contre pas de transactionnalité excepté au niveau du document, ce qui va nécessiter de recourir à certaines astuces pour gérer la cohérence de nos données. <em><!--[-->Explication<!--]--></em>. Tout d’abord s’il n’y a pas de transaction lorsqu’on agit sur plusieurs documents, on a tout de même des &quot;transactions&quot; au niveau document. Ca tombe bien, cette première stratégie consiste donc à stocker des documents Json contenant votre entité et ses relations et c’est exactement ce qui nous convient pour notre relation entre Profile et Adress. Exemple :<!--]--></p><p><!--[-->{ _id : 1 , login: “login1”, address : { zipCode : “69003”}}<!--]--></p><p><!--[-->Ici, mon entité inclut un attribut address qui aurait pu être stocké dans une table à part avec un modèle relationnel classique.<!--]--></p><p><!--[-->D’autres techniques décrite dans la doc permettent d’envisager des “transactions” applicatives : <a href="http://docs.mongodb.org/manual/tutorial/perform-two-phase-commits/" rel="nofollow"><!--[-->http://docs.mongodb.org/manual/tutorial/perform-two-phase-commits/<!--]--></a><!--]--></p><p><!--[-->Si vous en êtes là, peut être faut-il quand même se poser des questions...<!--]--></p><p><!--[-->Pour mes tests j’ai souhaité utiliser Jongo et Morphia, deux librairies avec des approches relativement différentes. La première va rechercher la performance en restant très proche du protocole. La seconde va proposer plus de simplicité d’utilisation via un mapping document objet.<!--]--></p><h4 id="jongo"><a href="#jongo"><!--[-->Jongo<!--]--></a></h4><p><!--[-->Jongo reste très proche du shell mongo donc il faut aimer manipuler le json. J’ai été un peu perplexe au début. Je me suis pris quelques murs et puis finalement, avec l’aide de la formation en ligne de 10gen je me suis bien habitué à la syntaxe. Les performances obtenues sont relativement sympa :<!--]--></p><p><!--[--><strong><!--[-->JongoTest<!--]--></strong>.findByLoginShouldReturnSomething: [measured 10 out of 15 rounds, threads: 1 (sequential)] round: <strong><!--[-->0.01<!--]--></strong> [+- 0.00], round.gc: 0.00 [+- 0.00], GC.calls: 0, GC.time: 0.00, time.total: 0.17, time.warmup: 0.10, time.bench: 0.07 <strong><!--[-->JongoTest<!--]--></strong>.assertThatMyDatabaseHasMoreThan100Profile: [measured 10 out of 15 rounds, threads: 1 (sequential)] round: <strong><!--[-->0.01<!--]--></strong> [+- 0.01], round.gc: 0.00 [+- 0.00], GC.calls: 1, GC.time: 0.02, time.total: 0.18, time.warmup: 0.06, time.bench: 0.12 <strong><!--[-->JongoTest<!--]--></strong>.testSearchWithEmbeddedObject: [measured 10 out of 15 rounds, threads: 1 (sequential)] round: <strong><!--[-->0.03<!--]--></strong> [+- 0.00], round.gc: 0.00 [+- 0.00], GC.calls: 1, GC.time: 0.01, time.total: 0.52, time.warmup: 0.22, time.bench: 0.29 <strong><!--[-->JongoTest<!--]--></strong>.testGeoSpatialSearch: [measured 10 out of 15 rounds, threads: 1 (sequential)] round: <strong><!--[-->0.21<!--]--></strong> [+- 0.03], round.gc: 0.00 [+- 0.00], GC.calls: 3, GC.time: 0.15, time.total: 3.81, time.warmup: 1.67, time.bench: 2.14<!--]--></p><p><!--[--><a href="https://bitbucket.org/hlassiege/nosql/src/821b12c7c105/src/test/java/com/sandbox/JongoTest.java?at=default" rel="nofollow"><!--[-->Le code complet sous bitbucket<!--]--></a><!--]--></p><p><!--[-->Quelques exemple de code :<!--]--></p><!--[--><pre><code>
    return profiles.find(&quot;{login:#}&quot;,login).as(Profile.class);
    return profiles.find(&quot;{address.loc : {$near: [0, 0], $maxDistance: 5}}&quot;).as(Profile.class);
</code></pre><!--]--><h4 id="morphia"><a href="#morphia"><!--[-->Morphia<!--]--></a></h4><p><!--[-->Pour tout dire, nous avions choisi Jongo au début suite aux premières phases de ce bench et à l’époque j’avais obtenu un facteur de 1 à 10 entre Jongo et Morphia. Sauf que maintenant que je maîtrise mieux les deux APIs et les réglages, les dernières tests montrent une autre réalité :<!--]--></p><p><!--[--><strong><!--[-->MorphiaTest<!--]--></strong>.findByLoginShouldReturnSomething: [measured 10 out of 15 rounds, threads: 1 (sequential)] round: <strong><!--[-->0.02<!--]--></strong> [+- 0.00], round.gc: 0.00 [+- 0.00], GC.calls: 0, GC.time: 0.00, time.total: 0.34, time.warmup: 0.14, time.bench: 0.21 <strong><!--[-->MorphiaTest<!--]--></strong>.assertThatMyDatabaseHasMoreThan100Profile: [measured 10 out of 15 rounds, threads: 1 (sequential)] round: <strong><!--[-->0.01<!--]--></strong> [+- 0.00], round.gc: 0.00 [+- 0.00], GC.calls: 0, GC.time: 0.00, time.total: 0.15, time.warmup: 0.06, time.bench: 0.08 <strong><!--[-->MorphiaTest<!--]--></strong>.testSearchWithEmbeddedObject: [measured 10 out of 15 rounds, threads: 1 (sequential)] round: <strong><!--[-->0.02<!--]--></strong> [+- 0.00], round.gc: 0.00 [+- 0.00], GC.calls: 0, GC.time: 0.00, time.total: 0.28, time.warmup: 0.11, time.bench: 0.17 <strong><!--[-->MorphiaTest<!--]--></strong>.testGeoSpatialSearch: [measured 10 out of 15 rounds, threads: 1 (sequential)] round: <strong><!--[-->0.18<!--]--></strong> [+- 0.04], round.gc: 0.00 [+- 0.00], GC.calls: 2, GC.time: 0.14, time.total: 2.93, time.warmup: 1.15, time.bench: 1.78<!--]--></p><p><!--[-->Pour le coup, l&#39;API fait vraiment penser à un O(object) D(document) M(Mapping) et on s&#39;éloigne beaucoup plus du protocole.<!--]--></p><p><!--[--><a href="https://bitbucket.org/hlassiege/nosql/src/821b12c7c105/src/test/java/com/sandbox/MorphiaTest.java?at=default" rel="nofollow"><!--[-->Le code complet sur bitbucket<!--]--></a><!--]--></p><p><!--[-->Quelques exemples :<!--]--></p><!--[--><pre><code>
        return ds.find(Profile.class).field(&quot;address.zipCode&quot;).equal(&quot;94500&quot;).asList();
        return ds.find(Profile.class).field(&quot;address.loc&quot;).near(0,0,100).asList();
</code></pre><!--]--><p><!--[-->Verdict : Dans les deux cas la mise en place a été très simple. Sur l’aspect performance on reste sur des performances équivalentes. Jongo semble être très souple en restant proche du protocole au détriment par contre d’une lisibilité assez médiocre cependant quand on aborde des requêtes complexes. Avec le recul j’aurais peut être du partir sur du Morphia. Quoi qu’il en soit, utiliser les deux APIs en fonction des besoins ne doit poser aucun souci de toute façon.<!--]--></p><p><!--[-->Dernier point, en terme de fonctionnalités il me manque encore des capacités de recherche full-text digne de ce nom. Du coup en s’inspirant de ce que beaucoup d’autres ont fait avant nous, nous allons coupler notre solution avec du <strong><!--[-->Lucene<!--]--></strong>.<!--]--></p><h3 id="mongo-et-lucene"><a href="#mongo-et-lucene"><!--[-->Mongo et Lucene<!--]--></a></h3><p><!--[-->Lucene est un superbe outil spécialisé sur la recherche. En terme de fonctionnalités on va retrouver tout ce qui nous intéresse : recherche full text, par synonyme, géospatiale, fuzzy etc...<!--]--></p><p><!--[-->Tout d’abord, enfonçons des portes ouvertes, on y stocke des documents, on les lit, les supprime, les modifie, oui c’est une forme de bases de données pour ceux qui en douteraient encore.<!--]--></p><p><!--[-->Du coup, si c’est une base de données et qu’on y trouve toutes les fonctionnalités, pourquoi ne pas en faire notre stockage primaire ?<!--]--></p><p><!--[-->La première fois que JB m’a parlé d’utiliser Lucene + Mongo ou Redis j’avoue ne pas avoir bien compris le but. Pourquoi deux modes de stockage ? Même après la présentation faite au JUG par Xebia <a href="http://www.parisjug.org/xwiki/bin/view/Meeting/20120703" rel="nofollow"><!--[-->http://www.parisjug.org/xwiki/bin/view/Meeting/20120703<!--]--></a> je n’avais pas encore le recul nécessaire. Et oui, il a fallu que je pratique car je fais partie des personnes qui comprennent vite quand on leur explique longtemps ^^<!--]--></p><p><!--[--><a href="http://hakanai.free.fr/index.php/nosql-4-bases-a-la-loupe-24/mongo-lucene/" rel="nofollow"><!--[--><img src="/images/mongo.lucene-300x91.png" alt title="mongo.lucene"><!--]--></a><!--]--></p><p><!--[-->Effectivement ma première idée lorsque j’ai testé Lucene c’était de l’utiliser comme stockage primaire. Sans entrer dans les détails Lucene fait bien la différence entre le <strong><!--[-->stockage<!--]--></strong> d’une donnée, qui permet donc d’utiliser Lucene comme un entrepôt de données, et <strong><!--[-->l’indexation<!--]--></strong> d’une donnée qui la rend disponible pour la recherche. Dans notre cas, il suffisait de stocker la donner en plus de l’indexer.<!--]--></p><p><!--[-->J’ai donc cherché et lu pas mal d’articles indiquant que la bonne pratique c’était de n’utiliser Lucene que pour rechercher des ID.<!--]--></p><p><!--[--><em><!--[-->Explication<!--]--></em>.<!--]--></p><p><!--[-->Lucene est optimisé pour les recherches, moins pour manipuler de la donnée et pas forcément la meilleure solution lorsqu’il s’agit de mettre à jour ces données régulièrement. De plus si on stocke chaque information un index lucene peut vite prendre la place. Mongo propose moins de fonctionnalités de recherche mais permet de manipuler des données efficacement.<!--]--></p><p><!--[-->La pratique courante donc c’est de profiter des capacités de recherche de Lucene et de l’efficacité de Mongo pour le stockage. On stocke uniquement les ID de nos entités sous Lucene et on indexe toutes les propriétés nécessaires à la recherche. Le stockage s’effectue donc sous Mongo. Les recherches permettent de récupérer des ID qui permettront par la suite d’aller chercher nos enregistrements dans Mongo.<!--]--></p><p><!--[--><a href="http://hakanai.free.fr/index.php/nosql-4-bases-a-la-loupe-24/mongo-lucene2/" rel="nofollow"><!--[--><img src="/images/mongo.lucene2-300x294.png" alt title="mongo.lucene2"><!--]--></a><!--]--></p><p><!--[-->Cool, en tout cas une chose était sure, le projet se ferait avec Lucene.<!--]--></p><p><!--[-->Billet suivant nous verrons que les choses n’étant jamais simples on ne n’est pas contenté de Lucene.<!--]--></p><p><!--[-->Pour voir chaque billet :<!--]--></p><ul><!--[--><li><!--[--><a href="http://hakanai.free.fr/index.php/nosql-4-bases-a-la-loupe-14/" rel="nofollow" title="Nosql, 4 bases à la loupe 1/4"><!--[-->L&#39;intro<!--]--></a><!--]--></li><li><!--[--><a href="http://hakanai.free.fr/index.php/nosql-4-bases-a-la-loupe-24/" rel="nofollow" title="Nosql, 4 bases à la loupe 2/4"><!--[-->Redis et Mongo<!--]--></a><!--]--></li><li><!--[--><a href="http://hakanai.free.fr/index.php/nosql-4-bases-a-la-loupe-34/" rel="nofollow" title="Nosql, 4 bases à la loupe 3/4"><!--[-->ElasticSearch et Solr<!--]--></a><!--]--></li><li><!--[--><a href="http://hakanai.free.fr/index.php/nosql-4-bases-a-la-loupe-44/" rel="nofollow"><!--[-->Le récap<!--]--></a><!--]--></li><!--]--></ul></div></div></div></div><div class="mt-10 text-slate-600 font-extrabold text-sm font-medium min-w-full mx-auto mb-2"><a href="https://github.com/hlassiege/eventuallycoding/blob/master/content/articles/2012/11/11/nosql-4-bases-a-la-loupe-24.md" rel="noopener noreferrer" target="_blank">Edit on Github <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 inline-block text-slate-600 -mt-1" viewBox="0 0 512 512"><path d="M320 0c-17.7 0-32 14.3-32 32s14.3 32 32 32h82.7L201.4 265.4c-12.5 12.5-12.5 32.8 0 45.3s32.8 12.5 45.3 0L448 109.3V192c0 17.7 14.3 32 32 32s32-14.3 32-32V32c0-17.7-14.3-32-32-32H320zM80 32C35.8 32 0 67.8 0 112V432c0 44.2 35.8 80 80 80H400c44.2 0 80-35.8 80-80V320c0-17.7-14.3-32-32-32s-32 14.3-32 32V432c0 8.8-7.2 16-16 16H80c-8.8 0-16-7.2-16-16V112c0-8.8 7.2-16 16-16H192c17.7 0 32-14.3 32-32s-14.3-32-32-32H80z"></path></svg></a></div><hr class="mb-8"><div><span class="font-proxima text-sm md:text-xl font-medium"> Did you like this blog post? </span><div class="mt-4 flex flex-row"><div><a href="https://facebook.com/sharer/sharer.php?u=https://eventuallycoding.com/2012/11/11/nosql-4-bases-a-la-loupe-24" target="_blank" rel="noopener" aria-label="Share on Facebook"><button aria-label="Share on Facebook" type="button" class="text-white bg-[#3b5998] hover:bg-[#3b5998]/90 focus:ring-4 focus:outline-none focus:ring-[#3b5998]/50 font-medium rounded-lg text-sm px-3 py-3 text-center inline-flex items-center dark:focus:ring-[#3b5998]/55 mr-2 mb-2"><svg class="w-6 h-6" aria-hidden="true" focusable="false" data-prefix="fab" data-icon="facebook-f" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><path fill="currentColor" d="M279.1 288l14.22-92.66h-88.91v-60.13c0-25.35 12.42-50.06 52.24-50.06h40.42V6.26S260.4 0 225.4 0c-73.22 0-121.1 44.38-121.1 124.7v70.62H22.89V288h81.39v224h100.2V288z"></path></svg></button></a></div><div><a href="https://twitter.com/share?url=https://eventuallycoding.com/2012/11/11/nosql-4-bases-a-la-loupe-24&amp;text=Nosql, 4 bases à la loupe 2/4&amp;via=hugolassiege" target="_blank" title="Share on Twitter" rel="noopener noreferrer" aria-label="Share on Twitter"><button aria-label="Share on Twitter" type="button" class="text-white bg-[#1da1f2] hover:bg-[#1da1f2]/90 focus:ring-4 focus:outline-none focus:ring-[#1da1f2]/50 font-medium rounded-lg text-sm px-3 py-3 text-center inline-flex items-center dark:focus:ring-[#1da1f2]/55 mr-2 mb-2"><svg class="w-6 h-6" aria-hidden="true" focusable="false" data-prefix="fab" data-icon="twitter" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M459.4 151.7c.325 4.548 .325 9.097 .325 13.65 0 138.7-105.6 298.6-298.6 298.6-59.45 0-114.7-17.22-161.1-47.11 8.447 .974 16.57 1.299 25.34 1.299 49.06 0 94.21-16.57 130.3-44.83-46.13-.975-84.79-31.19-98.11-72.77 6.498 .974 12.99 1.624 19.82 1.624 9.421 0 18.84-1.3 27.61-3.573-48.08-9.747-84.14-51.98-84.14-102.1v-1.299c13.97 7.797 30.21 12.67 47.43 13.32-28.26-18.84-46.78-51.01-46.78-87.39 0-19.49 5.197-37.36 14.29-52.95 51.65 63.67 129.3 105.3 216.4 109.8-1.624-7.797-2.599-15.92-2.599-24.04 0-57.83 46.78-104.9 104.9-104.9 30.21 0 57.5 12.67 76.67 33.14 23.72-4.548 46.46-13.32 66.6-25.34-7.798 24.37-24.37 44.83-46.13 57.83 21.12-2.273 41.58-8.122 60.43-16.24-14.29 20.79-32.16 39.31-52.63 54.25z"></path></svg></button></a></div><div class=""><a href="https://www.buymeacoffee.com/hlassiege" target="_blank"><img src="https://cdn.buymeacoffee.com/buttons/v2/default-red.png" alt="Buy Me A Coffee" style="height:48px !important;width:209px !important;"></a></div></div></div><div id="hyvor-talk-view"></div></div></div><!--]--><!--]--><footer class="lg:mt-40 border-t border-t-2"><div class="flex flex-col items-center mt-16"><div class="flex mb-3 space-x-4"><a aria-label="Open RSS feed" target="_self" href="/rss.xml" class="text-sm text-gray-500 transition hover:text-gray-600"><img alt="RSS" class="transition-transform hover:scale-110 w-8 h-8" src="/_nuxt/rss.9e0b880c.svg"></a><a aria-label="Open Mastodon profile" class="text-sm text-gray-500 transition hover:text-gray-600" target="_blank" rel="me" href="https://piaille.fr/@hugolassiege"><span class="sr-only">Mastodon</span><img alt="Mastodon" class="transition-transform hover:scale-110 w-8 h-8" src="/_nuxt/mastodon.f0ecdde8.svg"></a><a aria-label="Open github profile" class="text-sm text-gray-500 transition hover:text-gray-600" target="_blank" rel="nofollow noopener noreferrer" href="https://github.com/hlassiege"><span class="sr-only">github</span><img alt="github" class="transition-transform hover:scale-110 w-8 h-8" src="/_nuxt/github_new.4e3fe23c.svg"></a><a aria-label="Open linkedin profile" class="text-sm text-gray-500 transition hover:text-gray-600" target="_blank" rel="noopener noreferrer" href="https://www.linkedin.com/in/hugolassiege/"><span class="sr-only">Linkedin</span><img alt="Linkedin" class="transition-transform hover:scale-110 w-8 h-8" src="/_nuxt/linkeding.34c3bc6d.svg"></a><a aria-label="Open twitter profile" target="_blank" rel="nofollow noopener noreferrer" href="https://twitter.com/hugolassiege" class="text-sm text-gray-500 transition hover:text-gray-600"><img alt="Twitter" class="transition-transform hover:scale-110 w-8 h-8" src="/_nuxt/twitter.457cff27.svg"></a></div><div class="flex mb-2 space-x-2 text-sm text-gray-500 dark:text-gray-400"><div>Copyright © 2023</div><div>•</div> EventuallyCoding - A la fin de l&#39;envoi, je code !</div><div class="text-sm text-gray-500"> Credits to www.freepik.com - <a href="https://www.freepik.com/vectors/citizen">Citizen vector created by freepik - </a><a href="https://www.freepik.com/vectors/css">Css vector created by vectorjuice</a></div></div></footer></div></section><!--]--></div><script type="module">import p from "/2012/11/11/nosql-4-bases-a-la-loupe-24/_payload.js";window.__NUXT__={...p,...((function(a,b){return {state:{},_errors:{},serverRendered:true,config:{public:{content:{locales:[],defaultLocale:b,integrity:1677325378447,experimental:{stripQueryParameters:a,clientDB:a},api:{baseURL:"\u002Fapi\u002F_content"},navigation:{fields:[]},tags:{p:"prose-p",a:"prose-a",blockquote:"prose-blockquote","code-inline":"prose-code-inline",code:"prose-code",em:"prose-em",h1:"prose-h1",h2:"prose-h2",h3:"prose-h3",h4:"prose-h4",h5:"prose-h5",h6:"prose-h6",hr:"prose-hr",img:"prose-img",ul:"prose-ul",ol:"prose-ol",li:"prose-li",strong:"prose-strong",table:"prose-table",thead:"prose-thead",tbody:"prose-tbody",td:"prose-td",th:"prose-th",tr:"prose-tr"},highlight:a,wsUrl:b,documentDriven:a,host:b,trailingSlash:a,anchorLinks:{depth:4,exclude:[1]}}},app:{baseURL:"\u002F",buildAssetsDir:"\u002F_nuxt\u002F",cdnURL:b}},prerenderedAt:1677325416005}}(false,"")))}</script><script type="module" src="/_nuxt/entry.88dbae5f.js" crossorigin></script><script type="module" src="/_nuxt/default.ef1af82c.js" crossorigin></script><script type="module" src="/_nuxt/_id_.58899afd.js" crossorigin></script><script type="module" src="/_nuxt/ContentRenderer.8d5ab423.js" crossorigin></script><script type="module" src="/_nuxt/ContentRendererMarkdown.980ec26e.js" crossorigin></script><script type="module" src="/_nuxt/ProseP.b19e702a.js" crossorigin></script><script type="module" src="/_nuxt/ProseA.99007763.js" crossorigin></script><script type="module" src="/_nuxt/ProseImg.9cce0247.js" crossorigin></script><script type="module" src="/_nuxt/ProseUl.1281c19c.js" crossorigin></script><script type="module" src="/_nuxt/ProseLi.43a10d0a.js" crossorigin></script><script type="module" src="/_nuxt/ProseH3.b22d331f.js" crossorigin></script><script type="module" src="/_nuxt/ProseEm.5a807b06.js" crossorigin></script><script type="module" src="/_nuxt/ProseStrong.9863733c.js" crossorigin></script><script type="module" src="/_nuxt/ProseCode.524f80b5.js" crossorigin></script><script type="module" src="/_nuxt/ProseH4.f173cefe.js" crossorigin></script></body>
</html>