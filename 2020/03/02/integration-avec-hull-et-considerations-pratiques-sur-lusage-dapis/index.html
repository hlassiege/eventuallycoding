<!DOCTYPE html>
<html data-head-attrs="">
<head><title>Intégration avec Hull et considérations pratiques sur l'usage d'APIs | EventuallyCoding</title><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1"><script src="https://digianalytics.fr/js/script.js" data-host="https://digianalytics.fr" data-dnt="false" id="ZwSg9rf6GA" async defer type="text/javascript"></script><meta name="description" content="Je vous propose aujourd'hui de découvrir [Hull](https://www.hull.io/). que nous utilisons depuis quelques mois chez Malt.   Hull fait partie des outil..."><meta name="og:description" content="Je vous propose aujourd'hui de découvrir [Hull](https://www.hull.io/). que nous utilisons depuis quelques mois chez Malt.   Hull fait partie des outil..."><meta name="og:type" content="article"><meta name="og:title" content="Intégration avec Hull et considérations pratiques sur l'usage d'APIs"><meta name="og:url" content="https://eventuallycoding.com/2020/03/02/integration-avec-hull-et-considerations-pratiques-sur-lusage-dapis"><meta name="og:image" content="https://eventuallycoding.com/images/covers/cover8.jpg"><meta name="og:image:alt" content="Intégration avec Hull et considérations pratiques sur l'usage d'APIs"><meta name="twitter:text:title" content="Intégration avec Hull et considérations pratiques sur l'usage d'APIs"><meta name="twitter:image" content="https://eventuallycoding.com/images/covers/cover8.jpg"><meta name="twitter:card" content="summary"><meta name="article:published_time" content="2020-03-02T00:00:00.000Z"><meta name="article:article:modified_time" content="2020-03-02T00:00:00.000Z"><meta name="article:article:tag" content="api,data,datamarketing,hull"><link rel="canonical" href="https://eventuallycoding.com/2020/03/02/integration-avec-hull-et-considerations-pratiques-sur-lusage-dapis"><meta name="head:count" content="17"><link rel="modulepreload" href="/2020/03/02/integration-avec-hull-et-considerations-pratiques-sur-lusage-dapis/_payload.js"><link rel="modulepreload" as="script" crossorigin href="/_nuxt/entry.1f061433.js"><link rel="preload" as="style" href="/_nuxt/entry.2fb37f22.css"><link rel="modulepreload" as="script" crossorigin href="/_nuxt/default.6d027c12.js"><link rel="preload" as="style" href="/_nuxt/TheHeader.19f98060.css"><link rel="modulepreload" as="script" crossorigin href="/_nuxt/TheHeader.11512ce7.js"><link rel="modulepreload" as="script" crossorigin href="/_nuxt/TheFooter.e758e308.js"><link rel="modulepreload" as="script" crossorigin href="/_nuxt/siteMetaData.bb10a390.js"><link rel="modulepreload" as="script" crossorigin href="/_nuxt/github_new.c6ffbd0b.js"><link rel="modulepreload" as="script" crossorigin href="/_nuxt/_id_.9c932153.js"><link rel="modulepreload" as="script" crossorigin href="/_nuxt/PageSidebar.7eecb4f1.js"><link rel="modulepreload" as="script" crossorigin href="/_nuxt/Dropdown.5bf5f9c4.js"><link rel="modulepreload" as="script" crossorigin href="/_nuxt/_commonjsHelpers.f8a6f4fc.js"><link rel="modulepreload" as="script" crossorigin href="/_nuxt/ContentRenderer.56de4234.js"><link rel="modulepreload" as="script" crossorigin href="/_nuxt/ContentRendererMarkdown.7b66e39b.js"><link rel="modulepreload" as="script" crossorigin href="/_nuxt/BlogCard.vue_vue_type_script_setup_true_lang.b5c60239.js"><link rel="modulepreload" as="script" crossorigin href="/_nuxt/asyncData.5f49fea1.js"><link rel="modulepreload" as="script" crossorigin href="/_nuxt/query.58444dfd.js"><link rel="modulepreload" as="script" crossorigin href="/_nuxt/utils.1b9302a0.js"><link rel="modulepreload" as="script" crossorigin href="/_nuxt/HeroSection.78eade73.js"><link rel="modulepreload" as="script" crossorigin href="/_nuxt/ProseP.d6638831.js"><link rel="modulepreload" as="script" crossorigin href="/_nuxt/ProseA.80716a9a.js"><link rel="modulepreload" as="script" crossorigin href="/_nuxt/ProseImg.4589e1a4.js"><link rel="modulepreload" as="script" crossorigin href="/_nuxt/Disclaimer.9a1cc2e6.js"><link rel="modulepreload" as="script" crossorigin href="/_nuxt/ProseUl.62658379.js"><link rel="modulepreload" as="script" crossorigin href="/_nuxt/ProseLi.dad5ca06.js"><link rel="modulepreload" as="script" crossorigin href="/_nuxt/ProseH2.8b34a6ae.js"><link rel="modulepreload" as="script" crossorigin href="/_nuxt/ProseStrong.063b5b24.js"><link rel="modulepreload" as="script" crossorigin href="/_nuxt/ProseH3.bfc02e33.js"><link rel="modulepreload" as="script" crossorigin href="/_nuxt/ProseEm.938d2e90.js"><link rel="modulepreload" as="script" crossorigin href="/_nuxt/ProseCode.bbbd0dc5.js"><link rel="prefetch" as="script" crossorigin href="/_nuxt/web-socket.c2e1c077.js"><link rel="prefetch" as="script" crossorigin href="/_nuxt/error-component.84466c0c.js"><link rel="prefetch" as="image" type="image/svg+xml" href="/_nuxt/rss.9e0b880c.svg"><link rel="prefetch" as="image" type="image/svg+xml" href="/_nuxt/mastodon.f0ecdde8.svg"><link rel="prefetch" as="image" type="image/svg+xml" href="/_nuxt/linkeding.34c3bc6d.svg"><link rel="prefetch" as="image" type="image/svg+xml" href="/_nuxt/twitter.457cff27.svg"><link rel="prefetch" as="image" type="image/svg+xml" href="/_nuxt/github_new.4e3fe23c.svg"><link rel="stylesheet" href="/_nuxt/entry.2fb37f22.css"><link rel="stylesheet" href="/_nuxt/TheHeader.19f98060.css"><style>.nuxt-content h2{font-size:28px;font-weight:700}.nuxt-content h3{font-size:22px;font-weight:700}.nuxt-content p{margin-bottom:20px}</style><style>.nuxt-content h2{font-size:28px;font-weight:700}.nuxt-content h3{font-size:22px;font-weight:700}.nuxt-content p{margin-bottom:20px}.clip-ellipse{--tw-bg-opacity:1;background-color:rgb(255 255 255/var(--tw-bg-opacity));-webkit-clip-path:ellipse(60% 100% at 50% 0);clip-path:ellipse(60% 100% at 50% 0);height:100px;width:100%}</style><style>.admonition[data-v-b521c72b]{--bg-opacity:1;--border-opacity:1;background-color:#faf5ff;background-color:rgba(250,245,255,var(--bg-opacity));border-color:#805ad5;border-color:rgba(128,90,213,var(--border-opacity));border-left-width:8px;margin-bottom:.5rem;padding:1rem}.admonition .admonition-icon[data-v-b521c72b]{display:inline-block;margin-right:.25rem;vertical-align:middle}.admonition .admonition-icon svg[data-v-b521c72b]{stroke:currentColor;fill:currentColor;stroke-width:0;display:inline-block;height:1.25rem;margin-bottom:.25rem;width:1.25rem}.admonition-caution[data-v-b521c72b]{--bg-opacity:1;--border-opacity:1;background-color:#fffaf0;background-color:rgba(255,250,240,var(--bg-opacity));border-color:#dd6b20;border-color:rgba(221,107,32,var(--border-opacity));border-left-width:8px}.admonition-caution h5[data-v-b521c72b]{--text-opacity:1;color:#dd6b20;color:rgba(221,107,32,var(--text-opacity))}</style><style>pre code .line{display:block;min-height:1rem}</style></head>
<body data-head-attrs=""><div id="__nuxt"><!--[--><section class="w-full pb-12 antialiased"><div class="mx-auto max-w-8xl"><div data-v-b5718d32><nav class="transition-colors fixed w-full z-10 top-0" id="header-menu" data-v-b5718d32><div class="max-w-7xl mx-auto px-2 sm:px-6 lg:px-8" data-v-b5718d32><div class="relative flex items-center justify-between h-16" data-v-b5718d32><div class="absolute inset-y-0 left-0 flex items-center sm:hidden" data-v-b5718d32><button type="button" class="inline-flex items-center justify-center p-2 rounded-md text-gray-400 hover:text-white hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-inset focus:ring-white" aria-controls="mobile-menu" aria-expanded="false" data-v-b5718d32><span class="sr-only" data-v-b5718d32>Open main menu</span><svg class="block h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" aria-hidden="true" data-v-b5718d32><path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 12h16M4 18h16" data-v-b5718d32></path></svg><svg class="hidden h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" aria-hidden="true" data-v-b5718d32><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" data-v-b5718d32></path></svg></button></div><div class="flex-1 flex items-center justify-center sm:items-stretch sm:justify-start" data-v-b5718d32><div class="flex-shrink-0 flex items-center" data-v-b5718d32><span class="text-white text-base font-medium font-bruno text-2xl font-to-invert-to-pink" data-v-b5718d32> EventuallyCoding.com </span></div><div class="hidden sm:block sm:ml-6 absolute right-0" data-v-b5718d32><div class="flex space-x-4" data-v-b5718d32><!--[--><a href="/" class="link text-white font-to-invert-to-black" data-v-b5718d32>Home</a><a href="/blog" class="link text-white font-to-invert-to-black" data-v-b5718d32>Blog</a><a href="/resources" class="link text-white font-to-invert-to-black" data-v-b5718d32>Resources</a><!--]--></div></div></div></div></div><div class="hidden" data-v-b5718d32><div class="px-2 pt-2 pb-3 space-y-1" data-v-b5718d32><!--[--><a href="/" class="text-white hover:bg-gray-700 hover:text-white block px-3 py-2 rounded-md text-base font-medium font-to-invert-to-black" data-v-b5718d32>Home</a><a href="/blog" class="text-white hover:bg-gray-700 hover:text-white block px-3 py-2 rounded-md text-base font-medium font-to-invert-to-black" data-v-b5718d32>Blog</a><a href="/resources" class="text-white hover:bg-gray-700 hover:text-white block px-3 py-2 rounded-md text-base font-medium font-to-invert-to-black" data-v-b5718d32>Resources</a><!--]--></div></div></nav></div><!--[--><!--[--><div><section class="flex items-center justify-center h-128 bg-transparent"><canvas id="c" class="-z-10 absolute w-full h-128 block"></canvas><div class="clip-ellipse absolute top-124 rotate-180"></div><!--[--><div class="absolute top-96 w-96 -translate-y-20"><img src="/images/covers/cover8.jpg" alt="Intégration avec Hull et considérations pratiques sur l&#39;usage d&#39;APIs" class="object-cover"></div><!--]--></section><div class="px-4 mx-auto sm:px-6 xl:max-w-7xl xl:px-0 mt-10"><h1 class="text-4xl text-gray-700 font-extrabold mb-10 text-center">Intégration avec Hull et considérations pratiques sur l&#39;usage d&#39;APIs</h1><div class="grid grid-cols-3 text-center sm:w-full md:w-1/2 mx-auto"><div><p class="text-center font-bold my-5 text-slate-400 text-xs"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 inline-block" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg> March 2, 2020</p></div><div><p class="text-center font-bold my-5 text-slate-400 text-xs"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 inline-block" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg> 13 min read</p></div><div class="flex items-center font-medium sm:mx-3 justify-center"><img src="/hugo-nb.jpg" loading="lazy" alt="" class="mr-3 w-10 h-10 rounded-full bg-slate-50 dark:bg-slate-800"><div><div class="font-bold text-slate-400 text-xs">Hugo Lassiège</div><a target="_blank" href="https://twitter.com/hugolassiege" class="font-bold text-sky-400 text-xs hover:text-sky-600"> @hugolassiege</a></div></div></div><div class="sm:w-full md:w-1/2 mx-auto"><p class="mt-2 text-xs my-3 flex flex-wrap -m-1 justify-center"><!--[--><a href="/blog?tag=api" class="m-1 leading-loose text-slate-400 border border-current lowercase px-2 rounded font-medium">#api</a><a href="/blog?tag=data" class="m-1 leading-loose text-slate-400 border border-current lowercase px-2 rounded font-medium">#data</a><a href="/blog?tag=datamarketing" class="m-1 leading-loose text-slate-400 border border-current lowercase px-2 rounded font-medium">#datamarketing</a><a href="/blog?tag=hull" class="m-1 leading-loose text-slate-400 border border-current lowercase px-2 rounded font-medium">#hull</a><!--]--></p></div><div class="text-left mx-auto"><div class="flex flex-wrap lg:flex-row-reverse py-12"><div class="w-full lg:w-1/4 px-5"><div class="lg:sticky top-0 pt-5 -mt-5"><div class="toc hidden lg:block"><h3 class="border-b-4 pb-3 mb-3 border-gray-200 text-xl">On this page</h3><ul class="pl-0"><!--[--><li class="py-1"><a class="hover:text-smalt-blue-700" href="#utilisation-de-lapi-firehose">Utilisation de l&#39;API Firehose</a></li><li class="py-1"><a class="hover:text-smalt-blue-700" href="#gestion-de-tokens-jwt">Gestion de tokens JWT</a></li><li class="py-1"><a class="hover:text-smalt-blue-700" href="#utilisation-dun-incoming-webhook">Utilisation d&#39;un Incoming Webhook</a></li><li class="py-1"><a class="hover:text-smalt-blue-700" href="#utilisation-dun-connecteur-dimport">Utilisation d&#39;un connecteur d&#39;import</a></li><li class="py-1"><a class="hover:text-smalt-blue-700" href="#un-défaut-majeur">Un défaut majeur</a></li><li class="py-1"><a class="hover:text-smalt-blue-700" href="#lexport-de-données">L&#39;export de données</a></li><!--]--></ul></div><div class="text-right mb-12"><div class="relative inline-block text-left ml-2 block lg:hidden"><div><span class="rounded-md shadow-sm"><button type="button" class="inline-flex justify-center w-full rounded-md border border-gray-300 px-4 py-2 bg-white text-sm leading-5 font-medium text-black hover:text-white hover:bg-smalt-blue-500 focus:outline-none transition ease-in-out duration-150" aria-haspopup="true" aria-expanded="true"><!--[-->On this page<!--]--><svg class="-mr-1 ml-2 h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"></path></svg></button></span></div><!----></div></div></div></div><div class="lg:w-3/4 w-full px-5 max-w-none centered-image"><div id="nuxtContent" class="prose font-proxima text-sm md:text-xl font-medium min-w-full md:p-10 mx-auto"><p><!--[-->Je vous propose aujourd&#39;hui de découvrir <a href="https://www.hull.io/" rel="nofollow"><!--[-->Hull<!--]--></a>. que nous utilisons depuis quelques mois chez Malt.<br>
Hull fait partie des outils de &quot;<a href="https://www.definitions-marketing.com/definition/data-marketing/" rel="nofollow"><!--[-->Data Marketing<!--]--></a>&quot; (marketing dirigé par la donnée). C&#39;est un outil qui permet d&#39;unifier des données de plusieurs sources (analytics, crm) et/ou de les dispatcher vers plusieurs sources (mailchimp, intercom) tout en gardant la main sur la donnée, sa segmentation (audiences), son cycle de vie.<!--]--></p><p><!--[-->Comme je le disais plus haut, l&#39;outil permet donc, par exemple, de créer des audiences à un seul endroit et de les pousser dans les outils d&#39;envoi d&#39;email, sms etc… pour ne pas reparamétrer cela dans chaque outil. C&#39;est aussi une sorte de Hub de consolidation de données qui enrichit l&#39;information dans plusieurs outils et la redispatch.<!--]--></p><p><!--[--><img src="/images/automate.png" alt><!--]--></p><p><!--[-->image tiré de leur site qui illustre l&#39;enrichissement par plusieurs sources<!--]--></p><p><!--[-->Je ne vais pas trop m&#39;étendre sur le fonctionnel, ici je vous propose plutôt de parler des problématiques d&#39;intégration.<br>
C&#39;est un billet un peu &quot;niche&quot; qui intéressera moins de monde mais je trouve les problématiques assez intéressantes en terme d&#39;API et je me trouve moi même assez souvent en manque de sources quand je cherche à utiliser ce type d&#39;outils. Même si vous ne connaissez pas ou ne comptez pas utiliser Hull, les réflexions sur l&#39;ingestion et l&#39;export de données vous intéresseront peut-être.<!--]--></p><div class="admonition admonition-caution" data-v-b521c72b><div class="admonition-heading" data-v-b521c72b><h5 data-v-b521c72b><span class="admonition-icon" data-v-b521c72b><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 16 16" data-v-b521c72b><path fill-rule="evenodd" d="M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z" data-v-b521c72b></path></svg></span> Disclaimer </h5></div><div class="admonition-content" data-v-b521c72b><p data-v-b521c72b><!--[--><p><!--[-->Vous allez me dire que certains produits n&#39;ont pas besoin qu&#39;on leur dédie des billets de blog parce que leur doc est très bonne. Et c&#39;est pas faux. Hull a une <a href="https://www.hull.io/docs/" rel="nofollow"><!--[-->documentation en ligne<!--]--></a> mais c&#39;est un produit jeune et la documentation n&#39;est pas toujours exacte ou exhaustive. Cependant elle s&#39;améliore.<!--]--></p><!--]--></p></div></div><p><!--[-->Maintenant que les présentations sont faites, parlons de la première étape : l&#39;injection de données.<!--]--></p><p><!--[-->Pour injecter de la donnée nous avons plusieurs possibilités :<!--]--></p><ul><!--[--><li><!--[-->l&#39;API Firehose<!--]--></li><li><!--[-->un Webhook<!--]--></li><li><!--[-->Un connecteur SQL<!--]--></li><!--]--></ul><h2 id="utilisation-de-lapi-firehose"><a href="#utilisation-de-lapi-firehose"><!--[-->Utilisation de l&#39;API Firehose<!--]--></a></h2><p><!--[-->L&#39;api est documenté ici : <a href="https://www.hull.io/docs/data_lifecycle/ingest/#firehose-api" rel="nofollow"><!--[-->https://www.hull.io/docs/data_lifecycle/ingest/#firehose-api<!--]--></a><!--]--></p><p><!--[-->Au moment où j&#39;écris cette documentation elle a légèrement changé depuis le moment de notre intégration.<br>
Notamment cette api devait auparavant nécessiter que l&#39;on créé un connecteur de type <strong><!--[-->incoming Webhook<!--]--></strong> pour l&#39;utiliser. Désormais on peut l&#39;utiliser sur une url globale <strong><!--[-->firehose.hullapp.io<!--]--></strong>, même s&#39;il faut toujours créer un connecteur pour avoir des credentials.<br>
Ce n&#39;est pas notre cas, nous sommes restés sur l&#39;ancienne url et il est possible que cela explique de très nombreuses erreurs 500, 502, 504 que nous avons.<br>
Justement, faisons une digression sur le sujet.<!--]--></p><h3 id="comment-gérer-la-fiabilité-ou-absence-de-fiabilité-dune-api-externe"><a href="#comment-gérer-la-fiabilité-ou-absence-de-fiabilité-dune-api-externe"><!--[-->Comment gérer la fiabilité (ou absence de fiabilité) d&#39;une API externe<!--]--></a></h3><p><!--[-->Que ce soit Hull ou n&#39;importe quel autre fournisseur, il faut partir du principe qu&#39;une API externe n&#39;est pas fiable. Cela peut être lié au réseau, ou à l&#39;API elle même.<br>
Sans parler de fiabilité, certaines API imposent un certain Rate Limiting (nombre d&#39;appels max par période de temps).<br><em><!--[-->A ce propos Hull n&#39;impose pas de Rate limiting et gère au contraire celui des API externes au niveau de ces connecteurs. Très bon point.<!--]--></em><!--]--></p><p><!--[-->Comme cela fait plusieurs fois que je parle de connecteur, je me permet d&#39;en donner une définition très simple : un connecteur permet de déverser des données vers une destination ou d&#39;aspirer des données depuis une source. Cela vous rappellera peut être des tas d&#39;outils qui utilisent ces notions d&#39;input/output, comme Logstash par exemple. Sauf que les connecteurs Hull sont souvent fait pour aspirer/envoyer des données vers des produits/SAAS et non juste des composants techniques (bases de données).<!--]--></p><p><!--[-->Reprenons, même en évacuant cette notion de Rate limit, il reste la notion de fiabilité d&#39;une API.<br>
Au tout début de notre intégration, nous avions le pattern suivant<!--]--></p><p><!--[--><img src="/images/image-3.png" alt><!--]--></p><p><!--[-->Pour résumer :<!--]--></p><ul><!--[--><li><!--[-->lecture d&#39;un event symbolisant un ordre de mise à jour de Hull<!--]--></li><li><!--[-->appel de l&#39;API Firehose<!--]--></li><li><!--[-->En cas d&#39;erreur, le message était réempilé en queue et relu plus tard<!--]--></li><!--]--></ul><p><!--[-->Très bien, c&#39;est résistant à l&#39;erreur en théorie.<br>
Mais cela peut avoir plusieurs défauts :<!--]--></p><ul><!--[--><li><!--[-->on logge malgré tout des erreurs à chaque retry. Si l&#39;API est capricieuse (c&#39;est le cas de celle de Hull), c&#39;est beaucoup de logs d&#39;erreur &quot;attendus&quot;<!--]--></li><li><!--[-->on induit une pression en plus sur une API déjà un peu malade, au risque de ne jamais lui permettre de s&#39;en remettre.<!--]--></li><!--]--></ul><p><!--[-->Nous avons fait une première action en changeant les choses comme cela :<!--]--></p><ul><!--[--><li><!--[-->lecture d&#39;un event<!--]--></li><li><!--[-->appel de l&#39;API<!--]--></li><li><!--[-->en cas d&#39;erreur, retry <strong><!--[-->silencieux<!--]--></strong> avec un <strong><!--[-->délai<!--]--></strong><!--]--></li><li><!--[-->log d&#39;erreur uniquement au bout de 10 tentatives<!--]--></li><!--]--></ul><p><!--[-->C&#39;est mieux mais dans certains cas, ça nous laissait malgré tout de nombreux messages en <a href="https://www.rabbitmq.com/dlx.html" rel="nofollow"><!--[-->deadletter<!--]--></a> queue sur RabbitMQ et cela, sans limite de temps.<br>
Après 10 tentatives on reste dans la situation où l&#39;on loggue beaucoup d&#39;erreurs.<br>
(et donc on casse nos quotas de logs sur Sentry, snif…)<br>
De plus la deadletter de Rabbit n&#39;est pas requêtable. On ne peut pas non plus filtrer les messages par queue d&#39;origine etc… Donc cela reste assez pauvre si on veut contrôler ce qu&#39;il y a dedans.<!--]--></p><p><!--[-->Dans le cadre de ce projet nous avons développé une nouvelle solution avec une mise en quarantaine des messages dans une base de données :<!--]--></p><ul><!--[--><li><!--[-->lecture d&#39;un event<!--]--></li><li><!--[-->appel de l&#39;API<!--]--></li><li><!--[-->en cas d&#39;erreur, retry silencieux avec un délai<!--]--></li><li><!--[-->log d&#39;erreur uniquement au bout de 10 tentatives<!--]--></li><li><!--[--><strong><!--[-->mise en quarantaine au bout de 11 tentatives<!--]--></strong> .<!--]--></li><!--]--></ul><p><!--[--><img src="/images/image-5.png" alt><!--]--></p><p><!--[-->Il y a clairement du mieux, depuis cette quarantaine on peut filtrer les messages par queue d&#39;origine, voir les messages en questions, rejouer les events selon un filtre etc…<!--]--></p><p><!--[-->Malgré tout, nous avions un autre point.<br>
En effet je parlais d&#39;event tout à l&#39;heure. Un event est de la forme : ProfileUpdated, AccountUpdated, EmailUpdated, ConversationStarted etc… Il existe de très nombreux events et on veut mettre à jour Hull sur beaucoup d&#39;event car cela peut changer des informations ou des statistiques importantes (taux de contact par exemple).<br>
Une action peut entrainer plusieurs events de nature différente.<br>
Autrement dit, pour un même user, il est possible d&#39;appeler Hull <strong><!--[-->plusieurs fois<!--]--></strong> avec des données très proches dans des <strong><!--[-->laps de temps assez courts<!--]--></strong>.<!--]--></p><p><!--[-->Il se trouve que Nicolas, Lead developper chez Malt, travaillait lui aussi sur une API partenaire à ce moment là : Oracle Netsuite. Si Hull est parfois capricieux, ça reste une API qui fonctionne. Netsuite en comparaison est une horreur à plus d&#39;un titre.<br>
Et comme cette notion d&#39;appel à des API partenaires est un sujet qui revient souvent il a développé une queue de commande qui permet entre autre :<!--]--></p><ul><!--[--><li><!--[-->de prendre en compte les rates limites des API (inutile pour mon cas)<!--]--></li><li><!--[-->de dédoublonner les appels<!--]--></li><li><!--[-->de garder des séquences de commandes à faire dans un ordre<!--]--></li><li><!--[-->de gérer les retry<!--]--></li><!--]--></ul><p><!--[-->C&#39;est pas le sujet de l&#39;article donc Nico développera sans doute dans un autre billet à part car c&#39;est devenue une brique très pratique chez nous.<br>
Je l&#39;ai réutilisé sur Hull et j&#39;ai donc désormais également un outil qui permet de temporiser mes envois sur Hull et qui dédoublonne par tranche de temps (configurable) pour éviter d&#39;envoyer trop de commandes à Hull.<!--]--></p><h2 id="gestion-de-tokens-jwt"><a href="#gestion-de-tokens-jwt"><!--[-->Gestion de tokens JWT<!--]--></a></h2><p><!--[-->Je ne vais pas revenir sur l&#39;usage de l&#39;API Firehose elle-même qui est pas <a href="https://www.hull.io/docs/data_lifecycle/ingest/#firehose-api" rel="nofollow"><!--[-->trop mal documentée<!--]--></a>.<br>
J&#39;ai cependant rencontré des difficultés sur les tokens JWT qui doivent être inclus dans ces appels.<br>
Un appel Firehose doit contenir plusieurs blocs d&#39;informations. Chaque bloc d&#39;information contient un header et ce header contient un token JWT.<br>
Au moment de l&#39;intégration, la doc qui décrivait ce token était relativement petite. On peut la retrouver <a href="https://www.hull.io/docs/reference/identity_resolution/" rel="nofollow"><!--[-->ici<!--]--></a>, elle s&#39;est améliorée.<br>
Ce qu&#39;elle ne décrit pas bien, c&#39;est la structure d&#39;un token d&#39;exemple. Je vous propose donc de regarder à quoi cela ressemble :<!--]--></p><!--[--><pre><code>Hull-Access-Token : { &quot;io.hull.active&quot; : true, &quot;io.hull.create&quot; : true, &quot;io.hull.asUser&quot; : {&quot;external\_id&quot; : &quot;maltUserID&quot;}, &quot;io.hull.subjectType&quot; : &quot;user&quot;, &quot;io.hull.asAccount&quot; : {&quot;external\_id&quot; : &quot;maltCompanyID&quot;}}
</code></pre><!--]--><p><!--[-->io.hull.asUser permet de définir l&#39;identité à utiliser pour résoudre l&#39;utilisateur chez Hull. Il permet notamment d&#39;utiliser un external_id qui peut être par exemple l&#39;id dans notre système.<!--]--></p><p><!--[-->On peut aussi faire la liaison entre un user et sa société, concept existant chez nous, en ajoutant un attribut io.hull.asAccount et qui définit l&#39;ID de la société.<!--]--></p><p><!--[-->L&#39;objet déclaré plus haut est facile à construire à partir d&#39;une Map.<!--]--></p><p><!--[-->Par exemple<!--]--></p><!--[--><pre><code>Map mapOfClaims = new HashMap&lt;&gt;(Map.of(
    &quot;io.hull.active&quot;, true,
    &quot;io.hull.create&quot;, true,
...
));
</code></pre><!--]--><p><!--[-->Ensuite il faut signer cet objet avec JWT. En Java cela donne :<!--]--></p><!--[--><pre><code>public static String sign(String secret, String issuer, Map mapOfClaims) throws JoseException {
   JsonWebSignature jwtSigner = new JsonWebSignature();
   jwtSigner.setKey(new AesKey(secret.getBytes()));
jwtSigner.setAlgorithmHeaderValue(AlgorithmIdentifiers.HMAC\_SHA256);
   JwtClaims claims = new JwtClaims();
   claims.setIssuer(issuer);
   claims.setIssuedAtToNow();
   claims.setExpirationTimeMinutesInTheFuture(20);
   mapOfClaims.forEach(claims::setClaim);
   jwtSigner.setPayload(claims.toJson());
   return jwtSigner.getCompactSerialization();
}
</code></pre><!--]--><p><!--[-->Petit point d&#39;attention sur le claims.toJson() qui utilise donc une serialisation JSON de votre Map.<br>
Et donc pour les sous objets io.hull.asUser et io.hull.asAccount il faut bien penser à utiliser un JSONObject, sinon la sérialisation va donner<br>
&quot;io.hull.asUser&quot; : &quot;{\&quot;external_id\&quot; : \&quot;maltUserID\&quot;}&quot; et non pas &quot;io.hull.asUser&quot; : {&quot;external_id&quot; : &quot;maltUserID&quot;}<!--]--></p><p><!--[-->Oui c&#39;est bête mais j&#39;ai fait l&#39;erreur au début…<!--]--></p><p><!--[-->Est-ce que ça a marché ? Pour le savoir, il suffit d&#39;aller sur l&#39;interface des logs de Hull :<!--]--></p><p><!--[--><img src="/images/image-1.png" alt><!--]--></p><p><!--[-->L&#39;interface marche relativement bien. C&#39;est du Kibana derrière et il est simple de filtrer par champ, tranche de date etc…<br>
Le seul petit piège, c&#39;est que Hull gère ça sans doute en interne sous forme de queue de message. De votre côté vous avez simplement reçu un code d&#39;acquittement 204 (reçu mais sera traité plus tard).<br>
Et cette attente peut aller jusque 5/10 minutes. Donc le feedback est assez long entre votre envoi et le résultat.<br>
Ce n&#39;est clairement pas un souci dans le cas nominal parce que le choix est totalement logique d&#39;une part, vu le volume Hull a pris une bonne décision sans doute, et d&#39;autre part vous n&#39;êtes pas à la minute pour un update dans la majorité du temps.<br>
Mais j&#39;avoue qu&#39;en développement c&#39;est un peu frustrant, notamment car l&#39;appel de l&#39;API ne fait aucun contrôle de surface donc pendant la phase d&#39;intégration il arrive souvent de devoir attendre plusieurs minutes juste pour voir que votre format comporte une erreur (dans le token JWT la très grande majorité du temps).<br>
J&#39;avoue qu&#39;en dev j&#39;aurais aimé un mode dégradé avec contrôle immédiat, mode à interdire en production bien sûr.<!--]--></p><h2 id="utilisation-dun-incoming-webhook"><a href="#utilisation-dun-incoming-webhook"><!--[-->Utilisation d&#39;un Incoming Webhook<!--]--></a></h2><p><!--[-->La seconde solution proposée repose sur un Webhook côté Hull que l&#39;on retrouve documenté <a href="https://www.hull.io/docs/connectors/incoming-webhooks/#incoming-webhooks" rel="nofollow"><!--[-->ici<!--]--></a>.<br>
Sur le principe j&#39;ai rapidement choisi de ne pas utiliser cette solution.<br>
L&#39;idée étant d&#39;envoyer n&#39;importe quel objet JSON et d&#39;utiliser ensuite un éditeur de texte depuis l&#39;interface d&#39;admin de Hull pour traiter ce JSON et appeler directement l&#39;API de Hull depuis cet éditeur en ligne.<!--]--></p><p><!--[--><img src="/images/dashboard.png" alt="Getting Started Step 3"><!--]--></p><p><!--[-->J&#39;avoue qu&#39;avoir du code non versionné de mon côté, non testé et à synchroniser en même temps qu&#39;un changement d&#39;API, était plutôt rédhibitoire. Même si je comprends l&#39;idée, cela permet à des utilisateurs &quot;non tech&quot; de votre équipe marketing de pouvoir hacker directement de leur côté. En pratique, je ne sais pas si c&#39;est vraiment un cas d&#39;usage fréquent d&#39;avoir des personnes de l&#39;équipe marketing qui font du javascript sur ce type d&#39;interface.<!--]--></p><h2 id="utilisation-dun-connecteur-dimport"><a href="#utilisation-dun-connecteur-dimport"><!--[-->Utilisation d&#39;un connecteur d&#39;import<!--]--></a></h2><p><!--[-->Cette solution est pour moi la plus séduisante sur le papier et je pense que nous l&#39;utiliserons dans l&#39;avenir. Il s&#39;agit d&#39;un connecteur direct sur une source de données.<br>
L&#39;idée étant de créer une vue sur votre source de données et dès qu&#39;elle change, les modifications sont reportées chez Hull. La seule chose à maintenir est donc une vue SQL par exemple sur votre base analytique.<br><strong><!--[-->Malheureusement<!--]--></strong> nous ne l&#39;avons pas testé car pour l&#39;instant ce connecteur n&#39;accepte pas encore les Datasources <strong><!--[-->BigQuery<!--]--></strong> : <a href="https://www.hull.io/docs/connectors/sql-importer/" rel="nofollow"><!--[-->https://www.hull.io/docs/connectors/sql-importer/<!--]--></a><!--]--></p><h2 id="un-défaut-majeur"><a href="#un-défaut-majeur"><!--[-->Un défaut majeur<!--]--></a></h2><p><!--[-->Sur le papier Hull est effectivement très pratique plutôt que de devoir maintenir des intégrations sur tous vos outils tierces, Intercom, Mailchimp, Salesforce, Customer.io pour ne citer que ceux la par exemple.<br>
En effet Hull ayant des connecteurs pour ces outils, ce n&#39;est plus à l&#39;application de gérer ces données vers ces outils.<br>
En pratique c&#39;est globalement vrai, sauf… pour la suppression.<!--]--></p><p><!--[-->Déjà la suppression de données dans Hull est peu triviale dirons-nous.<br>
Un enregistrement dans Hull est identifié par un ID qui ne correspond pas à votre ID logique. En effet vous pouvez préciser un ID logique (external_id) correspondant aux ID utilisé dans votre application mais Hull a ses propres ID. Or l&#39;API de DELETE ne fonctionne qu&#39;à partir des ID Hull. Dommage de ne pas avoir proposé de DELETE qui fasse un lookup avec un external_id.<br>
D&#39;ailleurs le DELETE n&#39;est pas vraiment documenté pour les users : <a href="https://www.hull.io/docs/reference/http%5C_api/" rel="nofollow"><!--[-->https://www.hull.io/docs/reference/http\_api/<!--]--></a><br>
Une fois qu&#39;on a cependant compris que l&#39;on peut supprimer un user par son vrai ID, il faut le trouver.<br>
Il faut donc<!--]--></p><ul><!--[--><li><!--[-->utiliser <a href="https://www.hull.io/docs/reference/http_api/#search-for-users" rel="nofollow"><!--[-->l&#39;API de search<!--]--></a> par son external_id. Vous noterez que cela ressemble furieusement à une requête elasticsearch<!--]--></li><li><!--[-->lire l&#39;ID interne dans le résultat<!--]--></li><li><!--[-->appeler l&#39;API de DELETE qui n&#39;est pas documenté sur cet ID<!--]--></li><!--]--></ul><p><!--[-->Je ne cache pas, ça pique un peu.<!--]--></p><p><!--[-->Mais surtout, le DELETE n&#39;est pas propagé vers les autres outils. Et c&#39;est la le plus gros souci.<br>
Une solution un peu &quot;bof&quot; c&#39;est de ne pas faire un DELETE mais de faire un UPDATE et de mettre à null tous les champs, ce qui rend la donnée totalement inutile.<br>
En pratique, ca ne semble pas bien marcher non plus. Chaque outil ne supporte pas forcément de mettre à null l&#39;ensemble des champs. De plus, Hull fonctionne aussi dans l&#39;autre sens avec ces connecteurs.<br>
Autrement dit le connecteur vers Intercom, il met aussi à jour la donnée vers Hull. Donc on peut nullifier dans Hull puis récupérer la donnée depuis intercom. Du coup on ne s&#39;en sort jamais.<!--]--></p><p><!--[-->Pour l&#39;instant nous avons donc du créer des intégrations avec les autres outils (intercom etc…) pour supprimer nous même la donnée. Ce qui est quand même un gros défaut pour la solution et je ne suis pas certain de la fiabilité. Il est bien évident que nous travaillons toujours là dessus.<!--]--></p><h2 id="lexport-de-données"><a href="#lexport-de-données"><!--[-->L&#39;export de données<!--]--></a></h2><p><!--[-->C&#39;est un autre atout de Hull. Hull est aussi rempli d&#39;informations utiles car il permet par exemple de savoir qu&#39;il y a eu des contacts sur intercom, il peut indiquer les emails envoyés par customer.io ou avoir été enrichi par Clearbit etc…<br>
Bref, de nombreuses choses que l&#39;on veut récupérer ensuite chez soi.<br>
Pour l&#39;export, nous avons donc mis en place un <a href="https://www.hull.io/docs/connectors/outgoing-webhooks/" rel="nofollow"><!--[-->Outgoing Webhook<!--]--></a> vers notre plateforme Data.<br>
Une fois mis en place, ce webhook permet de faire du BigQuery streaming et d&#39;insérer la data directement depuis un code python deployé en Serverless dans Google Cloud Functions.<br>
Je ne détaille pas trop car cette architecture de plateforme data serait sans doute intéressante à décrire dans un autre billet.<!--]--></p><p><!--[-->A savoir cependant sur ce webhook, plusieurs choses ne sont pas documentées :<!--]--></p><ul><!--[--><li><!--[-->La doc ne précise pas comment sécuriser le webhook. Le support indique cependant qu&#39;il faut paramétrer le webhook en https avec un paramètre GET secret que l&#39;on lit dans le code de réception<!--]--></li><li><!--[-->la doc ne précise pas si Hull gère bien les cas où notre API échoue (et oui, nous aussi on peut échouer). A priori le support nous indique qu&#39;il y a bien des retry mais nous n&#39;avons aucune info, aucune stats, aucun monitoring donc cela reste un peu mystérieux.<!--]--></li><!--]--></ul><p><!--[-->C&#39;est tout pour ce billet. Au delà de l&#39;outil, j&#39;espère qu&#39;il a pu être intéressant sur les approches employés ou pour avoir un aperçu de notre plateforme Data.<!--]--></p><p><!--[-->A bientôt<!--]--></p></div></div></div></div><hr class="mb-12"><div><span> Partager sur : </span><div class="mt-4"><a href="https://facebook.com/sharer/sharer.php?u=https://eventuallycoding.com/2020/03/02/integration-avec-hull-et-considerations-pratiques-sur-lusage-dapis" target="_blank" rel="noopener" aria-label=""><button type="button" class="text-white bg-[#3b5998] hover:bg-[#3b5998]/90 focus:ring-4 focus:outline-none focus:ring-[#3b5998]/50 font-medium rounded-lg text-sm px-3 py-3 text-center inline-flex items-center dark:focus:ring-[#3b5998]/55 mr-2 mb-2"><svg class="w-6 h-6" aria-hidden="true" focusable="false" data-prefix="fab" data-icon="facebook-f" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><path fill="currentColor" d="M279.1 288l14.22-92.66h-88.91v-60.13c0-25.35 12.42-50.06 52.24-50.06h40.42V6.26S260.4 0 225.4 0c-73.22 0-121.1 44.38-121.1 124.7v70.62H22.89V288h81.39v224h100.2V288z"></path></svg></button></a><a href="https://twitter.com/share?url=https://eventuallycoding.com/2020/03/02/integration-avec-hull-et-considerations-pratiques-sur-lusage-dapis&amp;text=Intégration avec Hull et considérations pratiques sur l&#39;usage d&#39;APIs&amp;via=hugolassiege" target="_blank" title="Share on Twitter" rel="noopener noreferrer"><button type="button" class="text-white bg-[#1da1f2] hover:bg-[#1da1f2]/90 focus:ring-4 focus:outline-none focus:ring-[#1da1f2]/50 font-medium rounded-lg text-sm px-3 py-3 text-center inline-flex items-center dark:focus:ring-[#1da1f2]/55 mr-2 mb-2"><svg class="w-6 h-6" aria-hidden="true" focusable="false" data-prefix="fab" data-icon="twitter" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M459.4 151.7c.325 4.548 .325 9.097 .325 13.65 0 138.7-105.6 298.6-298.6 298.6-59.45 0-114.7-17.22-161.1-47.11 8.447 .974 16.57 1.299 25.34 1.299 49.06 0 94.21-16.57 130.3-44.83-46.13-.975-84.79-31.19-98.11-72.77 6.498 .974 12.99 1.624 19.82 1.624 9.421 0 18.84-1.3 27.61-3.573-48.08-9.747-84.14-51.98-84.14-102.1v-1.299c13.97 7.797 30.21 12.67 47.43 13.32-28.26-18.84-46.78-51.01-46.78-87.39 0-19.49 5.197-37.36 14.29-52.95 51.65 63.67 129.3 105.3 216.4 109.8-1.624-7.797-2.599-15.92-2.599-24.04 0-57.83 46.78-104.9 104.9-104.9 30.21 0 57.5 12.67 76.67 33.14 23.72-4.548 46.46-13.32 66.6-25.34-7.798 24.37-24.37 44.83-46.13 57.83 21.12-2.273 41.58-8.122 60.43-16.24-14.29 20.79-32.16 39.31-52.63 54.25z"></path></svg></button></a></div></div><!----><div id="hyvor-talk-view"></div></div></div><!--]--><!--]--><footer class="lg:mt-52 border-t border-t-2"><div class="flex flex-col items-center mt-16"><div class="flex mb-3 space-x-4"><a target="_self" href="/rss.xml" class="text-sm text-gray-500 transition hover:text-gray-600"><img class="transition-transform hover:scale-110 w-8 h-8" src="/_nuxt/rss.9e0b880c.svg"></a><a class="text-sm text-gray-500 transition hover:text-gray-600" target="_blank" rel="me" href="https://piaille.fr/@hugolassiege"><span class="sr-only">Mastodon</span><img class="transition-transform hover:scale-110 w-8 h-8" src="/_nuxt/mastodon.f0ecdde8.svg"></a><a class="text-sm text-gray-500 transition hover:text-gray-600" target="_blank" rel="nofollow noopener noreferrer" href="https://github.com/hlassiege"><span class="sr-only">github</span><img class="transition-transform hover:scale-110 w-8 h-8" src="/_nuxt/github_new.4e3fe23c.svg"></a><a class="text-sm text-gray-500 transition hover:text-gray-600" target="_blank" rel="noopener noreferrer" href="https://www.linkedin.com/in/hugolassiege/"><span class="sr-only">Linkedin</span><img class="transition-transform hover:scale-110 w-8 h-8" src="/_nuxt/linkeding.34c3bc6d.svg"></a><a target="_blank" rel="nofollow noopener noreferrer" href="https://twitter.com/hugolassiege" class="text-sm text-gray-500 transition hover:text-gray-600"><img class="transition-transform hover:scale-110 w-8 h-8" src="/_nuxt/twitter.457cff27.svg"></a></div><div class="flex mb-2 space-x-2 text-sm text-gray-500 dark:text-gray-400"><div>Copyright © 2023</div><div>•</div> EventuallyCoding - A la fin de l&#39;envoi, je code !</div><div class="text-sm text-gray-500">Credits to www.freepik.com - <a href="https://www.freepik.com/vectors/citizen">Citizen vector created by freepik - </a><a href="https://www.freepik.com/vectors/css">Css vector created by vectorjuice</a></div></div></footer></div></section><!--]--></div><script type="module">import p from "/2020/03/02/integration-avec-hull-et-considerations-pratiques-sur-lusage-dapis/_payload.js";window.__NUXT__={...p,...((function(a,b){return {state:{},_errors:{},serverRendered:true,config:{public:{content:{clientDB:{isSPA:a,integrity:1674132068170},navigation:{fields:[]},base:"_content",tags:{p:"prose-p",a:"prose-a",blockquote:"prose-blockquote","code-inline":"prose-code-inline",code:"prose-code",em:"prose-em",h1:"prose-h1",h2:"prose-h2",h3:"prose-h3",h4:"prose-h4",h5:"prose-h5",h6:"prose-h6",hr:"prose-hr",img:"prose-img",ul:"prose-ul",ol:"prose-ol",li:"prose-li",strong:"prose-strong",table:"prose-table",thead:"prose-thead",tbody:"prose-tbody",td:"prose-td",th:"prose-th",tr:"prose-tr"},highlight:a,wsUrl:b,documentDriven:a,anchorLinks:{depth:4,exclude:[1]}}},app:{baseURL:"\u002F",buildAssetsDir:"\u002F_nuxt\u002F",cdnURL:b}},prerenderedAt:1674132101659}}(false,"")))}</script><script type="module" src="/_nuxt/entry.1f061433.js" crossorigin></script><script type="module" src="/_nuxt/default.6d027c12.js" crossorigin></script><script type="module" src="/_nuxt/TheHeader.11512ce7.js" crossorigin></script><script type="module" src="/_nuxt/_id_.9c932153.js" crossorigin></script><script type="module" src="/_nuxt/TheFooter.e758e308.js" crossorigin></script><script type="module" src="/_nuxt/HeroSection.78eade73.js" crossorigin></script><script type="module" src="/_nuxt/PageSidebar.7eecb4f1.js" crossorigin></script><script type="module" src="/_nuxt/Dropdown.5bf5f9c4.js" crossorigin></script><script type="module" src="/_nuxt/ContentRenderer.56de4234.js" crossorigin></script><script type="module" src="/_nuxt/ContentRendererMarkdown.7b66e39b.js" crossorigin></script><script type="module" src="/_nuxt/ProseP.d6638831.js" crossorigin></script><script type="module" src="/_nuxt/ProseA.80716a9a.js" crossorigin></script><script type="module" src="/_nuxt/ProseImg.4589e1a4.js" crossorigin></script><script type="module" src="/_nuxt/Disclaimer.9a1cc2e6.js" crossorigin></script><script type="module" src="/_nuxt/ProseUl.62658379.js" crossorigin></script><script type="module" src="/_nuxt/ProseLi.dad5ca06.js" crossorigin></script><script type="module" src="/_nuxt/ProseH2.8b34a6ae.js" crossorigin></script><script type="module" src="/_nuxt/ProseStrong.063b5b24.js" crossorigin></script><script type="module" src="/_nuxt/ProseH3.bfc02e33.js" crossorigin></script><script type="module" src="/_nuxt/ProseEm.938d2e90.js" crossorigin></script><script type="module" src="/_nuxt/ProseCode.bbbd0dc5.js" crossorigin></script></body>
</html>