__NUXT_JSONP__("/2015/04/13/micro-services-la-composition-de-page-avec-zuul-et-sitemesh", (function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B,C,D,E,F,G,H,I,J,K,L,M,N,O,P,Q,R,S,T,U,V,W,X,Y,Z,_,$,aa){return {data:[{article:{slug:"micro-services-la-composition-de-page-avec-zuul-et-sitemesh",description:"[![03BC](\u002Fimages\u002F07933-03bc.gif)](http:\u002F\u002Feventuallycoding.com\u002Fwp-content\u002Fuploads\u002F2015\u002F04\u002F07933-03bc.gif) Le dernier billet de ce blog entamait une min...",id:"1169",title:"Micro-services : la composition de page avec Zuul et Sitemesh",date:"2015-04-13",categories:["waza"],tags:[z,"microservices",y,A,"zuul"],img:"07933-03bc.gif",cover:"cover2.jpg",toc:[{id:B,depth:o,text:C},{id:D,depth:o,text:E},{id:F,depth:o,text:G},{id:H,depth:o,text:I},{id:J,depth:o,text:K},{id:L,depth:o,text:M},{id:N,depth:o,text:O},{id:P,depth:o,text:Q}],body:{type:"root",children:[{type:b,tag:d,props:{},children:[{type:b,tag:g,props:{href:"http:\u002F\u002Feventuallycoding.com\u002Fwp-content\u002Fuploads\u002F2015\u002F04\u002F07933-03bc.gif",rel:[i,j,k],target:l},children:[{type:b,tag:p,props:{alt:"03BC",src:"\u002Fimages\u002F07933-03bc.gif"},children:[]}]},{type:a,value:" Le dernier billet de ce blog entamait une mini-série sur les microservices et j'espère bien susciter des commentaires afin d'améliorer le travail réalisé jusqu'ici. Voici une liste non exhaustive des différents sujets que j'aimerais traiter :"}]},{type:a,value:c},{type:b,tag:n,props:{},children:[{type:a,value:c},{type:b,tag:f,props:{},children:[{type:a,value:"comment gérer une fédération d’identité (one login to rule them all)"}]},{type:a,value:c},{type:b,tag:f,props:{},children:[{type:a,value:"gérer une configuration distribuée"}]},{type:a,value:c},{type:b,tag:f,props:{},children:[{type:b,tag:g,props:{href:R,rel:[i,j,k],target:l,title:S},children:[{type:a,value:"le routage"}]}]},{type:a,value:c},{type:b,tag:f,props:{},children:[{type:a,value:"le load balancing"}]},{type:a,value:c},{type:b,tag:f,props:{},children:[{type:a,value:"dispatcher des évènements sur plusieurs services"}]},{type:a,value:c},{type:b,tag:f,props:{},children:[{type:a,value:"les jobs"}]},{type:a,value:c},{type:b,tag:f,props:{},children:[{type:a,value:"la découverte de services"}]},{type:a,value:c},{type:b,tag:f,props:{},children:[{type:a,value:"simplifier l’écriture des appels de services"}]},{type:a,value:c},{type:b,tag:f,props:{},children:[{type:a,value:"la composition de page"}]},{type:a,value:c},{type:b,tag:f,props:{},children:[{type:a,value:"la résistance aux pannes"}]},{type:a,value:c},{type:b,tag:f,props:{},children:[{type:a,value:"le monitoring"}]},{type:a,value:c},{type:b,tag:f,props:{},children:[{type:a,value:"le déploiement"}]},{type:a,value:c}]},{type:a,value:c},{type:b,tag:d,props:{},children:[{type:a,value:"Le "},{type:b,tag:g,props:{href:R,rel:[i,j,k],target:l,title:S},children:[{type:a,value:"dernier billet"}]},{type:a,value:" s'attardait sur le routage. Dans ce billet j'aimerais aborder une problématique récurrente : la composition de pages"}]},{type:a,value:c},{type:b,tag:d,props:{},children:[{type:a,value:"TLDR; le code avec l'utilisation de sitemesh est disponible sur "},{type:b,tag:g,props:{href:T,rel:[i,j,k],target:l},children:[{type:a,value:"github"}]}]},{type:a,value:c},{type:b,tag:d,props:{},children:[{type:a,value:"Tout d'abord, resituons le problème. Imaginons une application, au hasard Hopwork, que nous avons décomposé en microservices comme suit :"}]},{type:a,value:c},{type:b,tag:n,props:{},children:[{type:a,value:c},{type:b,tag:f,props:{},children:[{type:a,value:"le moteur de recherche"}]},{type:a,value:c},{type:b,tag:f,props:{},children:[{type:a,value:"le back office freelance\u002Fclients"}]},{type:a,value:c},{type:b,tag:f,props:{},children:[{type:a,value:"les pages \"statiques\" (accueil, comment ca marche etc...)"}]},{type:a,value:c}]},{type:a,value:c},{type:b,tag:d,props:{},children:[{type:b,tag:g,props:{href:"http:\u002F\u002Feventuallycoding.com\u002Fwp-content\u002Fuploads\u002F2015\u002F04\u002Fdf8a2-services.jpg",rel:[i,j,k],target:l},children:[{type:b,tag:p,props:{alt:"services",src:"\u002Fimages\u002Fdf8a2-services.jpg"},children:[]}]}]},{type:a,value:c},{type:b,tag:d,props:{},children:[{type:a,value:"Vous remarquerez sur les captures d'écran qu'il y a tout de même un élément commun : le menu Et si nous allions en bas de la page, nous aurions également le footer. Chaque page est donc composée comme suit :"}]},{type:a,value:c},{type:b,tag:d,props:{},children:[{type:b,tag:g,props:{href:"http:\u002F\u002Feventuallycoding.com\u002Fwp-content\u002Fuploads\u002F2015\u002F04\u002Fc7c59-composition.png",rel:[i,j,k],target:l},children:[{type:b,tag:p,props:{alt:"composition",src:"\u002Fimages\u002Fc7c59-composition.png"},children:[]}]}]},{type:a,value:c},{type:b,tag:d,props:{},children:[{type:a,value:"Le footer ne bouge pas. Par contre le menu est dynamique. Il affiche votre nom quand vous êtes loggés ainsi que des items de menus différents par exemple."}]},{type:a,value:c},{type:b,tag:d,props:{},children:[{type:a,value:"Traditionnellement sur une application monolithique vous utiliseriez des inclusions de jsp, des custom tags, "},{type:b,tag:g,props:{href:U,rel:[i,j,k],target:l},children:[{type:a,value:V}]},{type:a,value:", "},{type:b,tag:g,props:{href:"http:\u002F\u002Fwww.thymeleaf.org\u002F",rel:[i,j,k],target:l},children:[{type:a,value:"thymeleaf"}]},{type:a,value:" etc..."}]},{type:a,value:c},{type:b,tag:d,props:{},children:[{type:a,value:"Et pour une application décomposé en plusieurs services ? Quelles seraient les solutions à envisager ?"}]},{type:a,value:c},{type:b,tag:q,props:{id:B},children:[{type:b,tag:g,props:{href:"#dupliquer-vos-%C3%A9l%C3%A9ments-communs-dans-chaque-application",ariaHidden:r,tabIndex:s},children:[{type:b,tag:t,props:{className:[u,v]},children:[]}]},{type:a,value:C}]},{type:a,value:c},{type:b,tag:d,props:{},children:[{type:a,value:"Sans doute la pire solution mais il ne faut rien écarter. Ici il s'agit simplement d'avoir votre menu et votre footer dupliqué dans chaque micro services."}]},{type:a,value:c},{type:b,tag:d,props:{},children:[{type:b,tag:g,props:{href:"http:\u002F\u002Feventuallycoding.com\u002Fwp-content\u002Fuploads\u002F2015\u002F04\u002F3f257-duplication.jpg",rel:[i,j,k],target:l},children:[{type:b,tag:p,props:{alt:"duplication",src:"\u002Fimages\u002F3f257-duplication.jpg"},children:[]}]}]},{type:a,value:c},{type:b,tag:d,props:{},children:[{type:a,value:"Bon, vous imaginez sans mal les inconvénients :"}]},{type:a,value:c},{type:b,tag:n,props:{},children:[{type:a,value:c},{type:b,tag:f,props:{},children:[{type:a,value:"effort de maintenance démultipliée"}]},{type:a,value:c},{type:b,tag:f,props:{},children:[{type:a,value:"aucun mécanisme pour qu'une application ait le même menu que les autres, vous pourriez avoir des liens dans le footer différent par exemple"}]},{type:a,value:c}]},{type:a,value:c},{type:b,tag:d,props:{},children:[{type:a,value:"Par contre à sa décharge, cette méthode a quand même des avantages :"}]},{type:a,value:c},{type:b,tag:n,props:{},children:[{type:a,value:c},{type:b,tag:f,props:{},children:[{type:a,value:W}]},{type:a,value:c},{type:b,tag:f,props:{},children:[{type:a,value:"vous pouvez utiliser des versions différentes de css pour un rendu équivalent"}]},{type:a,value:c},{type:b,tag:f,props:{},children:[{type:a,value:X}]},{type:a,value:c}]},{type:a,value:c},{type:b,tag:d,props:{},children:[{type:a,value:"Ce dernier point est très important. Mais l'effort de maintenance reste beaucoup trop important pour envisager sérieusement cette solution."}]},{type:a,value:c},{type:b,tag:q,props:{id:D},children:[{type:b,tag:g,props:{href:"#reconstruire-le-code-du-footer-et-du-menu-dynamiquement-via-des-m%C3%A9ta-donn%C3%A9es-dans-une-base-de-donn%C3%A9es",ariaHidden:r,tabIndex:s},children:[{type:b,tag:t,props:{className:[u,v]},children:[]}]},{type:a,value:E}]},{type:a,value:c},{type:b,tag:d,props:{},children:[{type:a,value:"C'est une petite amélioration du cas précédent. Le code css\u002Fjs\u002Fhtml reste dupliqué, permettant à chaque microservices d'évoluer indépendamment. Mais le contenu du menu et du footer est dynamique. Ce qui reste une petite amélioration intéressante."}]},{type:a,value:c},{type:b,tag:d,props:{},children:[{type:b,tag:g,props:{href:"http:\u002F\u002Feventuallycoding.com\u002Fwp-content\u002Fuploads\u002F2015\u002F04\u002F43bd1-duplication-with-db1.jpg",rel:[i,j,k],target:l},children:[{type:b,tag:p,props:{alt:"duplication-with-db",src:"\u002Fimages\u002F43bd1-duplication-with-db1.jpg"},children:[]}]}]},{type:a,value:c},{type:b,tag:d,props:{},children:[{type:a,value:"L'effort de maintenance reste très important."}]},{type:a,value:c},{type:b,tag:d,props:{},children:[{type:a,value:"Une variante de cette solution serait d'avoir le code html complet du header\u002Ffooter en base de données."}]},{type:a,value:c},{type:b,tag:d,props:{},children:[{type:a,value:"Cette fois on élimine l'effort de maintenance. Le versionning peut se faire facilement."}]},{type:a,value:c},{type:b,tag:d,props:{},children:[{type:a,value:"Le défaut majeur repose sur le fait que votre menu peut avoir des composantes dynamiques et afficher certains items :"}]},{type:a,value:c},{type:b,tag:n,props:{},children:[{type:a,value:c},{type:b,tag:f,props:{},children:[{type:a,value:"si l'utilisateur est loggé ou non"}]},{type:a,value:c},{type:b,tag:f,props:{},children:[{type:a,value:"si certaines fonctionnalités sont affichées pour lui (feature flipping)"}]},{type:a,value:c},{type:b,tag:f,props:{},children:[{type:a,value:"si certaines fonctionnalités lui sont accessibles (hopwork analytiques ou widgets non disponible pour les clients par exemple)"}]},{type:a,value:c}]},{type:a,value:c},{type:b,tag:d,props:{},children:[{type:a,value:"Voyons autre chose."}]},{type:a,value:c},{type:b,tag:q,props:{id:F},children:[{type:b,tag:g,props:{href:"#partager-une-jsp-commune-dans-un-jar-pour-pouvoir-linclure-dans-chaque-application-web",ariaHidden:r,tabIndex:s},children:[{type:b,tag:t,props:{className:[u,v]},children:[]}]},{type:a,value:G}]},{type:a,value:c},{type:b,tag:d,props:{},children:[{type:a,value:"Ca parait simple comme idée, il suffit ensuite d'utiliser cette jsp ensuite avec une directive d'inclusion :"}]},{type:a,value:c},{type:b,tag:d,props:{},children:[{type:a,value:"\u003C%@ include file=\"include\u002Fmenu.jsp\"\u002F\u003E"}]},{type:a,value:c},{type:b,tag:d,props:{},children:[{type:b,tag:g,props:{href:"http:\u002F\u002Feventuallycoding.com\u002Fwp-content\u002Fuploads\u002F2015\u002F04\u002F65476-webresources.jpg",rel:[i,j,k],target:l},children:[{type:b,tag:p,props:{alt:"webresources",src:"\u002Fimages\u002F65476-webresources.jpg"},children:[]}]}]},{type:a,value:c},{type:b,tag:d,props:{},children:[{type:a,value:"Plusieurs défauts à celà :"}]},{type:a,value:c},{type:b,tag:n,props:{},children:[{type:a,value:c},{type:b,tag:f,props:{},children:[{type:a,value:"ce n'est pas si simple de partager une jsp dans un jar. D'ailleurs je n'ai pas réussi. La seule solution technique que j'ai trouvé a été d'utiliser une dépendance sous forme de war avec le plugin maven war qui fait ensuite une fusion des deux wars"}]},{type:a,value:c},{type:b,tag:f,props:{},children:[{type:a,value:"cela implique que toutes vos applications web partagent la même technologie. Si a un moment vous choisisissez d'utiliser Thymeleaf ou velocity dans un autre service, votre jsp devient inutile."}]},{type:a,value:c},{type:b,tag:f,props:{},children:[{type:a,value:"Pire, même pour du contenu statique, vous êtes obligé d'en faire une jsp. Dommage."}]},{type:a,value:c},{type:b,tag:f,props:{},children:[{type:a,value:"cela impose de relivrer pour avoir la dernière version du menu ou du footer"}]},{type:a,value:c}]},{type:a,value:c},{type:b,tag:d,props:{},children:[{type:a,value:"Quelques avantages :"}]},{type:a,value:c},{type:b,tag:n,props:{},children:[{type:a,value:c},{type:b,tag:f,props:{},children:[{type:a,value:X}]},{type:a,value:c},{type:b,tag:f,props:{},children:[{type:a,value:"vous dépendez d'une version stable et pouvez évoluer quand vous le souhaitez (pensez aux gros refactoring js et css qui pourrait impacter chaque application)"}]},{type:a,value:c}]},{type:a,value:c},{type:b,tag:d,props:{},children:[{type:a,value:"Evidemment on peut partir du principe que ces éléments bougent peu donc le jeu ne vaut pas la chandelle d'aller plus loin et on peut accepter des désynchro de temps en temps. Pour être honnête, c'était ma première pensée de prime abord."}]},{type:a,value:c},{type:b,tag:d,props:{},children:[{type:a,value:"Et puis je suis tombé sur un vieux billet de Matt Raible de 2005 : "},{type:b,tag:g,props:{href:"http:\u002F\u002Fraibledesigns.com\u002Frd\u002Fentry\u002Fuse_sitemesh_to_decorate_multiple",rel:[i,j,k],target:l},children:[{type:a,value:"Use SiteMesh to decorate multiple webapps"}]}]},{type:a,value:c},{type:b,tag:q,props:{id:H},children:[{type:b,tag:g,props:{href:"#utilisons-sitemesh-alors",ariaHidden:r,tabIndex:s},children:[{type:b,tag:t,props:{className:[u,v]},children:[]}]},{type:a,value:I}]},{type:a,value:c},{type:b,tag:d,props:{},children:[{type:a,value:"Je ne connaissais pas bien "},{type:b,tag:g,props:{href:"http:\u002F\u002Fwiki.sitemesh.org\u002Fwiki\u002F",rel:[i,j,k],target:l},children:[{type:a,value:y}]},{type:a,value:". Je l'avais croisé sur un projet pour un voyagiste d'affaire il y a quelques années mais a l'époque, tout le monde se demandait surtout ce que ca foutait dans le projet :) Les joies du legacy. Mais ce billet très court de M. Raible m'a convaincu de tester."}]},{type:a,value:c},{type:b,tag:d,props:{},children:[{type:a,value:"Sitemesh en soi est finalement très simple à comprendre. Il agit en tant que filtre de servlet pour décorer votre page. C'est très différent d'un "},{type:b,tag:g,props:{href:U,rel:[i,j,k],target:l},children:[{type:a,value:V}]},{type:a,value:" dans le sens ou votre page d'origine est complète. Nous sommes ici dans le cas d'un parfait exemple du "},{type:b,tag:g,props:{href:"http:\u002F\u002Ffr.wikipedia.org\u002Fwiki\u002FD%C3%A9corateur_%28patron_de_conception%29",rel:[i,j,k],target:l},children:[{type:a,value:"pattern decorator"}]},{type:a,value:"."}]},{type:a,value:c},{type:b,tag:d,props:{},children:[{type:a,value:"Vous pourriez par exemple avoir le code suivant :"}]},{type:a,value:c},{type:b,tag:d,props:{},children:[{type:a,value:"A title"}]},{type:a,value:c},{type:b,tag:d,props:{},children:[{type:a,value:Y}]},{type:a,value:c},{type:b,tag:d,props:{},children:[{type:a,value:"Cette décoration se fait à l'aide d'un fichier decorators.html qui décrit la décoration à réaliser. Par exemple :"}]},{type:a,value:c},{type:b,tag:d,props:{},children:[{type:a,value:"Site name : A title"}]},{type:a,value:c},{type:b,tag:d,props:{},children:[{type:a,value:Z}]},{type:a,value:c},{type:b,tag:d,props:{},children:[{type:a,value:Y}]},{type:a,value:c},{type:b,tag:d,props:{},children:[{type:a,value:Z}]},{type:a,value:c},{type:b,tag:d,props:{},children:[{type:a,value:"Chose intéressante, le billet de M. Raible semblait suggérer que ce décorateur pouvait se trouver dans une autre application web."}]},{type:a,value:c},{type:b,tag:d,props:{},children:[{type:a,value:"Bon, ce ne fut pas si simple au final. En effet sitemesh est un projet peu actif (5 commits en un an). La version 3 a apporté son lot de simplification, mais elle a aussi dégagé le support des décorateurs cross webapp (dans une autre application web)."}]},{type:a,value:c},{type:b,tag:d,props:{},children:[{type:a,value:"Cependant ca s'est quand même avéré très simple à mettre en place."}]},{type:a,value:c},{type:b,tag:d,props:{},children:[{type:a,value:"Il a suffit de rajouter un filtre sitemesh :"}]},{type:a,value:c},{type:b,tag:d,props:{},children:[{type:a,value:"@Configuration\n@ConditionalOnProperty(\"sitemesh.filter.enabled\")\npublic class SitemeshConfig {\n@Bean\npublic FilterRegistrationBean siteMeshFilter() {\nFilterRegistrationBean filterRegistrationBean = new FilterRegistrationBean();\nfilterRegistrationBean.setFilter(new MySiteMeshFilter());\nreturn filterRegistrationBean;\n}\n}"}]},{type:a,value:c},{type:b,tag:d,props:{},children:[{type:a,value:"Au passage vous remarquerez l'utilisation des beans conditionnels facilité avec spring-boot. Ce filtre est actif ou non en fonction d'une configuration \"sitemesh.filter.enabled\""}]},{type:a,value:c},{type:b,tag:d,props:{},children:[{type:a,value:"Et le filtre sitemesh en lui-même :"}]},{type:a,value:c},{type:b,tag:d,props:{},children:[{type:a,value:"public class MySiteMeshFilter extends ConfigurableSiteMeshFilter {\n@Override\nprotected void applyCustomConfiguration(SiteMeshFilterBuilder builder) {\nbuilder.addDecoratorPath(\"\u002F*\", \"\u002Fdecorators\u002Fdecorator\");\n}\n}"}]},{type:a,value:c},{type:b,tag:d,props:{},children:[{type:a,value:"Ok, mais ce n'est pas cross webapp ça."}]},{type:a,value:c},{type:b,tag:d,props:{},children:[{type:a,value:"Effectivement, mais l'astuce très simple consiste à créer un controleur qui va servir le contenu d'une autre page distante"}]},{type:a,value:c},{type:b,tag:d,props:{},children:[{type:a,value:"@Controller\npublic class SitemeshController {\nprivate final OkHttpClient client = new OkHttpClient();\n@Value(\"${sitemesh.decorator.url}\")\nprivate String decoratorUrl;\n@RequestMapping(value = \"\u002Fdecorators\u002Fdecorator\", method = RequestMethod.GET)\n@ResponseBody\npublic Object decorator() throws IOException {\nRequest request = new Request.Builder()\n.url(decoratorUrl)\n.build();\nResponse response = client.newCall(request).execute();\nreturn response.body().string();\n}\n}"}]},{type:a,value:c},{type:b,tag:d,props:{},children:[{type:a,value:"J'ai utilisé ici "},{type:b,tag:g,props:{href:"http:\u002F\u002Fsquare.github.io\u002Fokhttp\u002F",rel:[i,j,k],target:l},children:[{type:a,value:"okHttp"}]},{type:a,value:" pour la récupération du contenu distant."}]},{type:a,value:c},{type:b,tag:d,props:{},children:[{type:a,value:"A partir de là, vous êtes capable de décorer votre page à partir d'un décorateur commun à tous vos services."}]},{type:a,value:c},{type:b,tag:d,props:{},children:[{type:b,tag:g,props:{href:"http:\u002F\u002Feventuallycoding.com\u002Fwp-content\u002Fuploads\u002F2015\u002F04\u002F3d5ad-sitemesh.jpg",rel:[i,j,k],target:l},children:[{type:b,tag:p,props:{alt:y,src:"\u002Fimages\u002F3d5ad-sitemesh.jpg"},children:[]}]}]},{type:a,value:c},{type:b,tag:d,props:{},children:[{type:a,value:"Mais que vient faire Zuul dans tout cela ?"}]},{type:a,value:c},{type:b,tag:d,props:{},children:[{type:a,value:"Si vous avez lu le premier billet de cette série, nous utilisons Zuul pour présenter une seule url au client et pour lui inviter de naviguer sans arrêt entre différents sous domaines correspondant à mes applications."}]},{type:a,value:c},{type:b,tag:d,props:{},children:[{type:a,value:"Et dans notre cas cela nous permet de partager aussi des ressources en commun :"}]},{type:a,value:c},{type:b,tag:d,props:{},children:[{type:b,tag:g,props:{href:"http:\u002F\u002Feventuallycoding.com\u002Fwp-content\u002Fuploads\u002F2015\u002F04\u002Fad5b9-zuul-sitemesh.jpg",rel:[i,j,k],target:l},children:[{type:b,tag:p,props:{alt:"zuul-sitemesh",src:"\u002Fimages\u002Fad5b9-zuul-sitemesh.jpg"},children:[]}]}]},{type:a,value:c},{type:b,tag:d,props:{},children:[{type:a,value:"Au final cette solution est très intéressante :"}]},{type:a,value:c},{type:b,tag:n,props:{},children:[{type:a,value:c},{type:b,tag:f,props:{},children:[{type:a,value:"aucune duplication de code"}]},{type:a,value:c},{type:b,tag:f,props:{},children:[{type:a,value:"les pages dans vos applications sont complètes et peuvent donc être utilisées de facon autonome"}]},{type:a,value:c},{type:b,tag:f,props:{},children:[{type:a,value:W}]},{type:a,value:c}]},{type:a,value:c},{type:b,tag:d,props:{},children:[{type:a,value:"mais elle comporte quand même des inconvénients :"}]},{type:a,value:c},{type:b,tag:n,props:{},children:[{type:a,value:c},{type:b,tag:f,props:{},children:[{type:a,value:"si vous souhaitez le rendu final, vous devez avoir au moins le proxy Zuul lancé en même temps pour travailler."}]},{type:a,value:c},{type:b,tag:f,props:{},children:[{type:a,value:"si vous partagez des css\u002Fjs sur le proxy Zuul, il y a des risques de casser votre microservice le jour ou le proxy Zuul fait évoluer ces ressources sans prévenir. Il faut sans doute penser à les versionner"}]},{type:a,value:c},{type:b,tag:f,props:{},children:[{type:a,value:"la petite astuce avec le controleur intermédiaire n'est pas des plus optimales en terme de chemin."}]},{type:a,value:c}]},{type:a,value:c},{type:b,tag:q,props:{id:J},children:[{type:b,tag:g,props:{href:"#autre-pistes-non-explor%C3%A9es-encore--les-filtres-zuul",ariaHidden:r,tabIndex:s},children:[{type:b,tag:t,props:{className:[u,v]},children:[]}]},{type:a,value:K}]},{type:a,value:c},{type:b,tag:d,props:{},children:[{type:a,value:"Selon moi, spring-cloud qui se veut la réponse absolue pour construire des microservices en Java aurait vocation à répondre à ce point. Et je pense que cela pourrait passer par l'utilisation de filtres Zuul en post filtering. Par contre ceux-ci sont assez mal documentées et je n'ai pas encore bien compris comment en rajouter. On en entend parler sur "},{type:b,tag:g,props:{href:"https:\u002F\u002Fgithub.com\u002FNetflix\u002Fzuul\u002Fwiki\u002FWriting-Filters",rel:[i,j,k],target:l},children:[{type:a,value:"la doc officielle de Netflix"}]},{type:a,value:", mais rien ne permet de comprendre comment les associer à Zuul dans le cas de Spring-cloud."}]},{type:a,value:c},{type:b,tag:d,props:{},children:[{type:a,value:"Par rapport à la solution précédente, on déporterait la responsabilité de la décoration au proxy. Cela éviterait la petite astuce avec le controleur supplémentaire vu ci-dessus. Par contre on reste obligé d'avoir le proxy Zuul lancé pour travailler. Mais de toute facon ca semble assez inéluctable vu les responsabilités qu'on lui donne de plus en plus."}]},{type:a,value:c},{type:b,tag:q,props:{id:L},children:[{type:b,tag:g,props:{href:"#et-un-widget-js-",ariaHidden:r,tabIndex:s},children:[{type:b,tag:t,props:{className:[u,v]},children:[]}]},{type:a,value:M}]},{type:a,value:c},{type:b,tag:d,props:{},children:[{type:a,value:"Piste intéressante, ca se versionne sans souci, ca permet de laisser chaque application vivre sa vie indépendamment. Ca oblige toujours à garder le proxy Zuul qui héberge la resource allumé cependant. Par contre je ne suis vraiment pas fan d'avoir un composant qui js qui induit une petite pause au chargement et un affichage qui se fait en deux temps."}]},{type:a,value:c},{type:b,tag:q,props:{id:N},children:[{type:b,tag:g,props:{href:"#et-les-webcomponents-",ariaHidden:r,tabIndex:s},children:[{type:b,tag:t,props:{className:[u,v]},children:[]}]},{type:a,value:O}]},{type:a,value:c},{type:b,tag:d,props:{},children:[{type:a,value:"Aucune idée pour être honnête, je ne connais pas assez pour savoir si c'est très différent d'une widget (en mieux). Mais si le défaut de l'affichage est le même, pas plus d'intérêt selon moi."}]},{type:a,value:c},{type:b,tag:q,props:{id:P},children:[{type:b,tag:g,props:{href:"#tableau-r%C3%A9capitulatif",ariaHidden:r,tabIndex:s},children:[{type:b,tag:t,props:{className:[u,v]},children:[]}]},{type:a,value:Q}]},{type:a,value:"\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n"},{type:b,tag:"table",props:{},children:[{type:b,tag:"thead",props:{},children:[{type:b,tag:x,props:{},children:[{type:b,tag:w,props:{},children:[{type:a,value:"Solution"}]},{type:b,tag:w,props:{},children:[{type:a,value:"Utilisation de contenu dynamique"}]},{type:b,tag:w,props:{},children:[{type:a,value:"Pas de duplication de code"}]},{type:b,tag:w,props:{},children:[{type:a,value:"Insensible au refactoring"}]},{type:b,tag:w,props:{},children:[{type:a,value:"Pas de relivraison pour mise à jour"}]},{type:b,tag:w,props:{},children:[{type:a,value:"Peut utiliser des technos différentes"}]},{type:b,tag:w,props:{},children:[{type:a,value:"Microservices autonomes"}]},{type:b,tag:w,props:{},children:[{type:a,value:"Confort utilisateur"}]}]}]},{type:b,tag:"tbody",props:{},children:[{type:b,tag:x,props:{},children:[{type:b,tag:e,props:{},children:[{type:a,value:"widgets\u002Fwebcomponent"}]},{type:b,tag:e,props:{},children:[{type:a,value:_}]},{type:b,tag:e,props:{},children:[{type:a,value:m}]},{type:b,tag:e,props:{},children:[{type:a,value:m}]},{type:b,tag:e,props:{},children:[{type:a,value:m}]},{type:b,tag:e,props:{},children:[{type:a,value:h}]},{type:b,tag:e,props:{},children:[{type:a,value:m}]},{type:b,tag:e,props:{},children:[{type:a,value:m}]}]},{type:b,tag:x,props:{},children:[{type:b,tag:e,props:{},children:[{type:a,value:"zuul filter"}]},{type:b,tag:e,props:{},children:[{type:a,value:h}]},{type:b,tag:e,props:{},children:[{type:a,value:h}]},{type:b,tag:e,props:{},children:[{type:a,value:m}]},{type:b,tag:e,props:{},children:[{type:a,value:h}]},{type:b,tag:e,props:{},children:[{type:a,value:h}]},{type:b,tag:e,props:{},children:[{type:a,value:m}]},{type:b,tag:e,props:{},children:[{type:a,value:h}]}]},{type:b,tag:x,props:{},children:[{type:b,tag:e,props:{},children:[{type:a,value:y}]},{type:b,tag:e,props:{},children:[{type:a,value:h}]},{type:b,tag:e,props:{},children:[{type:a,value:h}]},{type:b,tag:e,props:{},children:[{type:a,value:m}]},{type:b,tag:e,props:{},children:[{type:a,value:h}]},{type:b,tag:e,props:{},children:[{type:a,value:h}]},{type:b,tag:e,props:{},children:[{type:a,value:m}]},{type:b,tag:e,props:{},children:[{type:a,value:h}]}]},{type:b,tag:x,props:{},children:[{type:b,tag:e,props:{},children:[{type:a,value:"Construction via base de données"}]},{type:b,tag:e,props:{},children:[{type:a,value:_}]},{type:b,tag:e,props:{},children:[{type:a,value:h}]},{type:b,tag:e,props:{},children:[{type:a,value:m}]},{type:b,tag:e,props:{},children:[{type:a,value:"partiel"}]},{type:b,tag:e,props:{},children:[{type:a,value:h}]},{type:b,tag:e,props:{},children:[{type:a,value:h}]},{type:b,tag:e,props:{},children:[{type:a,value:h}]}]},{type:b,tag:x,props:{},children:[{type:b,tag:e,props:{},children:[{type:a,value:"Duplication html\u002Fjs\u002Fjsp"}]},{type:b,tag:e,props:{},children:[{type:a,value:h}]},{type:b,tag:e,props:{},children:[{type:a,value:h}]},{type:b,tag:e,props:{},children:[{type:a,value:h}]},{type:b,tag:e,props:{},children:[{type:a,value:m}]},{type:b,tag:e,props:{},children:[{type:a,value:m}]},{type:b,tag:e,props:{},children:[{type:a,value:h}]},{type:b,tag:e,props:{},children:[{type:a,value:h}]}]},{type:b,tag:x,props:{},children:[{type:b,tag:e,props:{},children:[{type:a,value:"Partage de jsp"}]},{type:b,tag:e,props:{},children:[{type:a,value:h}]},{type:b,tag:e,props:{},children:[{type:a,value:h}]},{type:b,tag:e,props:{},children:[{type:a,value:h}]},{type:b,tag:e,props:{},children:[{type:a,value:m}]},{type:b,tag:e,props:{},children:[{type:a,value:m}]},{type:b,tag:e,props:{},children:[{type:a,value:h}]},{type:b,tag:e,props:{},children:[{type:a,value:h}]}]}]}]},{type:a,value:c},{type:b,tag:d,props:{},children:[{type:a,value:"(1) on pourrait imager un menu statique qui présenterait un aspect \"basique\" et qui serait ensuite modifié en js si l'utilisateur est connecté et si certains items devait être rajouté au menu. Cela laisserait cependant un désagréable effet de clignotement pour l'utilisateur final"}]},{type:a,value:c},{type:b,tag:d,props:{},children:[{type:a,value:"Si cela vous intéresse, voici le code sous github : "},{type:b,tag:g,props:{href:T,rel:[i,j,k],target:l},children:[{type:a,value:"microservices-sandbox"}]}]}]},dir:"\u002Farticles\u002F2015\u002F04\u002F13",path:"\u002Farticles\u002F2015\u002F04\u002F13\u002Fmicro-services-la-composition-de-page-avec-zuul-et-sitemesh",extension:".md",createdAt:$,updatedAt:$,bodyPlainText:"\n03BC Le dernier billet de ce blog entamait une mini-série sur les microservices et j'espère bien susciter des commentaires afin d'améliorer le travail réalisé jusqu'ici. Voici une liste non exhaustive des différents sujets que j'aimerais traiter :\n\ncomment gérer une fédération d’identité (one login to rule them all)\ngérer une configuration distribuée\nle routage\nle load balancing\ndispatcher des évènements sur plusieurs services\nles jobs\nla découverte de services\nsimplifier l’écriture des appels de services\nla composition de page\nla résistance aux pannes\nle monitoring\nle déploiement\n\nLe dernier billet s'attardait sur le routage. Dans ce billet j'aimerais aborder une problématique récurrente : la composition de pages\n\nTLDR; le code avec l'utilisation de sitemesh est disponible sur github\n\nTout d'abord, resituons le problème. Imaginons une application, au hasard Hopwork, que nous avons décomposé en microservices comme suit :\n\nle moteur de recherche\nle back office freelance\u002Fclients\nles pages \"statiques\" (accueil, comment ca marche etc...)\n\nservices\n\nVous remarquerez sur les captures d'écran qu'il y a tout de même un élément commun : le menu Et si nous allions en bas de la page, nous aurions également le footer. Chaque page est donc composée comme suit :\n\ncomposition\n\nLe footer ne bouge pas. Par contre le menu est dynamique. Il affiche votre nom quand vous êtes loggés ainsi que des items de menus différents par exemple.\n\nTraditionnellement sur une application monolithique vous utiliseriez des inclusions de jsp, des custom tags, tiles, thymeleaf etc...\n\nEt pour une application décomposé en plusieurs services ? Quelles seraient les solutions à envisager ?\n\nDupliquer vos éléments communs dans chaque application.\n\nSans doute la pire solution mais il ne faut rien écarter. Ici il s'agit simplement d'avoir votre menu et votre footer dupliqué dans chaque micro services.\n\nduplication\n\nBon, vous imaginez sans mal les inconvénients :\n\neffort de maintenance démultipliée\naucun mécanisme pour qu'une application ait le même menu que les autres, vous pourriez avoir des liens dans le footer différent par exemple\n\nPar contre à sa décharge, cette méthode a quand même des avantages :\n\nvous pouvez utiliser des technologies de templating différentes dans chaque application (jinja en python, jsp en java etc...)\nvous pouvez utiliser des versions différentes de css pour un rendu équivalent\nvos applications sont vraiment autonomes et peuvent être utilisées toute seules\n\nCe dernier point est très important. Mais l'effort de maintenance reste beaucoup trop important pour envisager sérieusement cette solution.\n\nReconstruire le code du footer et du menu dynamiquement via des méta données dans une base de données\n\nC'est une petite amélioration du cas précédent. Le code css\u002Fjs\u002Fhtml reste dupliqué, permettant à chaque microservices d'évoluer indépendamment. Mais le contenu du menu et du footer est dynamique. Ce qui reste une petite amélioration intéressante.\n\nduplication-with-db\n\nL'effort de maintenance reste très important.\n\nUne variante de cette solution serait d'avoir le code html complet du header\u002Ffooter en base de données.\n\nCette fois on élimine l'effort de maintenance. Le versionning peut se faire facilement.\n\nLe défaut majeur repose sur le fait que votre menu peut avoir des composantes dynamiques et afficher certains items :\n\nsi l'utilisateur est loggé ou non\nsi certaines fonctionnalités sont affichées pour lui (feature flipping)\nsi certaines fonctionnalités lui sont accessibles (hopwork analytiques ou widgets non disponible pour les clients par exemple)\n\nVoyons autre chose.\n\nPartager une jsp commune dans un jar pour pouvoir l'inclure dans chaque application web\n\nCa parait simple comme idée, il suffit ensuite d'utiliser cette jsp ensuite avec une directive d'inclusion :\n\n\n\nwebresources\n\nPlusieurs défauts à celà :\n\nce n'est pas si simple de partager une jsp dans un jar. D'ailleurs je n'ai pas réussi. La seule solution technique que j'ai trouvé a été d'utiliser une dépendance sous forme de war avec le plugin maven war qui fait ensuite une fusion des deux wars\ncela implique que toutes vos applications web partagent la même technologie. Si a un moment vous choisisissez d'utiliser Thymeleaf ou velocity dans un autre service, votre jsp devient inutile.\nPire, même pour du contenu statique, vous êtes obligé d'en faire une jsp. Dommage.\ncela impose de relivrer pour avoir la dernière version du menu ou du footer\n\nQuelques avantages :\n\nvos applications sont vraiment autonomes et peuvent être utilisées toute seules\nvous dépendez d'une version stable et pouvez évoluer quand vous le souhaitez (pensez aux gros refactoring js et css qui pourrait impacter chaque application)\n\nEvidemment on peut partir du principe que ces éléments bougent peu donc le jeu ne vaut pas la chandelle d'aller plus loin et on peut accepter des désynchro de temps en temps. Pour être honnête, c'était ma première pensée de prime abord.\n\nEt puis je suis tombé sur un vieux billet de Matt Raible de 2005 : Use SiteMesh to decorate multiple webapps\n\nUtilisons sitemesh alors\n\nJe ne connaissais pas bien sitemesh. Je l'avais croisé sur un projet pour un voyagiste d'affaire il y a quelques années mais a l'époque, tout le monde se demandait surtout ce que ca foutait dans le projet :) Les joies du legacy. Mais ce billet très court de M. Raible m'a convaincu de tester.\n\nSitemesh en soi est finalement très simple à comprendre. Il agit en tant que filtre de servlet pour décorer votre page. C'est très différent d'un tiles dans le sens ou votre page d'origine est complète. Nous sommes ici dans le cas d'un parfait exemple du pattern decorator.\n\nVous pourriez par exemple avoir le code suivant :\n\nA title\n\nhello world\n\nCette décoration se fait à l'aide d'un fichier decorators.html qui décrit la décoration à réaliser. Par exemple :\n\nSite name : A title\n\nadded by sitemesh\n\nhello world\n\nadded by sitemesh\n\nChose intéressante, le billet de M. Raible semblait suggérer que ce décorateur pouvait se trouver dans une autre application web.\n\nBon, ce ne fut pas si simple au final. En effet sitemesh est un projet peu actif (5 commits en un an). La version 3 a apporté son lot de simplification, mais elle a aussi dégagé le support des décorateurs cross webapp (dans une autre application web).\n\nCependant ca s'est quand même avéré très simple à mettre en place.\n\nIl a suffit de rajouter un filtre sitemesh :\n\n@Configuration\n@ConditionalOnProperty(\"sitemesh.filter.enabled\")\npublic class SitemeshConfig {\n @Bean\n public FilterRegistrationBean siteMeshFilter() {\n FilterRegistrationBean filterRegistrationBean = new FilterRegistrationBean();\n filterRegistrationBean.setFilter(new MySiteMeshFilter());\n return filterRegistrationBean;\n }\n}\n\nAu passage vous remarquerez l'utilisation des beans conditionnels facilité avec spring-boot. Ce filtre est actif ou non en fonction d'une configuration \"sitemesh.filter.enabled\"\n\nEt le filtre sitemesh en lui-même :\n\npublic class MySiteMeshFilter extends ConfigurableSiteMeshFilter {\n @Override\n protected void applyCustomConfiguration(SiteMeshFilterBuilder builder) {\n builder.addDecoratorPath(\"\u002F\\*\", \"\u002Fdecorators\u002Fdecorator\");\n }\n}\n\nOk, mais ce n'est pas cross webapp ça.\n\nEffectivement, mais l'astuce très simple consiste à créer un controleur qui va servir le contenu d'une autre page distante\n\n@Controller\npublic class SitemeshController {\n private final OkHttpClient client = new OkHttpClient();\n @Value(\"${sitemesh.decorator.url}\")\n private String decoratorUrl;\n @RequestMapping(value = \"\u002Fdecorators\u002Fdecorator\", method = RequestMethod.GET)\n @ResponseBody\n public Object decorator() throws IOException {\n Request request = new Request.Builder()\n .url(decoratorUrl)\n .build();\n  Response response = client.newCall(request).execute();\n  return response.body().string();\n }\n}\n\nJ'ai utilisé ici okHttp pour la récupération du contenu distant.\n\nA partir de là, vous êtes capable de décorer votre page à partir d'un décorateur commun à tous vos services.\n\nsitemesh\n\nMais que vient faire Zuul dans tout cela ?\n\nSi vous avez lu le premier billet de cette série, nous utilisons Zuul pour présenter une seule url au client et pour lui inviter de naviguer sans arrêt entre différents sous domaines correspondant à mes applications.\n\nEt dans notre cas cela nous permet de partager aussi des ressources en commun :\n\nzuul-sitemesh\n\nAu final cette solution est très intéressante :\n\naucune duplication de code\nles pages dans vos applications sont complètes et peuvent donc être utilisées de facon autonome\nvous pouvez utiliser des technologies de templating différentes dans chaque application (jinja en python, jsp en java etc...)\n\nmais elle comporte quand même des inconvénients :\n\nsi vous souhaitez le rendu final, vous devez avoir au moins le proxy Zuul lancé en même temps pour travailler.\nsi vous partagez des css\u002Fjs sur le proxy Zuul, il y a des risques de casser votre microservice le jour ou le proxy Zuul fait évoluer ces ressources sans prévenir. Il faut sans doute penser à les versionner\nla petite astuce avec le controleur intermédiaire n'est pas des plus optimales en terme de chemin.\n\nAutre pistes non explorées encore : les filtres Zuul\n\nSelon moi, spring-cloud qui se veut la réponse absolue pour construire des microservices en Java aurait vocation à répondre à ce point. Et je pense que cela pourrait passer par l'utilisation de filtres Zuul en post filtering. Par contre ceux-ci sont assez mal documentées et je n'ai pas encore bien compris comment en rajouter. On en entend parler sur la doc officielle de Netflix, mais rien ne permet de comprendre comment les associer à Zuul dans le cas de Spring-cloud.\n\nPar rapport à la solution précédente, on déporterait la responsabilité de la décoration au proxy. Cela éviterait la petite astuce avec le controleur supplémentaire vu ci-dessus. Par contre on reste obligé d'avoir le proxy Zuul lancé pour travailler. Mais de toute facon ca semble assez inéluctable vu les responsabilités qu'on lui donne de plus en plus.\n\nEt un widget js ?\n\nPiste intéressante, ca se versionne sans souci, ca permet de laisser chaque application vivre sa vie indépendamment. Ca oblige toujours à garder le proxy Zuul qui héberge la resource allumé cependant. Par contre je ne suis vraiment pas fan d'avoir un composant qui js qui induit une petite pause au chargement et un affichage qui se fait en deux temps.\n\nEt les webcomponents ?\n\nAucune idée pour être honnête, je ne connais pas assez pour savoir si c'est très différent d'une widget (en mieux). Mais si le défaut de l'affichage est le même, pas plus d'intérêt selon moi.\n\nTableau récapitulatif\n\n| Solution | Utilisation de contenu dynamique | Pas de duplication de code | Insensible au refactoring | Pas de relivraison pour mise à jour | Peut utiliser des technos différentes | Microservices autonomes | Confort utilisateur |\n| --- | --- | --- | --- | --- | --- | --- | --- |\n| widgets\u002Fwebcomponent | non (1) | non | non | non | oui | non | non |\n| zuul filter | oui | oui | non | oui | oui | non | oui |\n| sitemesh | oui | oui | non | oui | oui | non | oui |\n| Construction via base de données | non (1) | oui | non | partiel | oui | oui | oui |\n| Duplication html\u002Fjs\u002Fjsp | oui | oui | oui | non | non | oui | oui |\n| Partage de jsp | oui | oui | oui | non | non | oui | oui |\n\n(1) on pourrait imager un menu statique qui présenterait un aspect \"basique\" et qui serait ensuite modifié en js si l'utilisateur est connecté et si certains items devait être rajouté au menu. Cela laisserait cependant un désagréable effet de clignotement pour l'utilisateur final\n\nSi cela vous intéresse, voici le code sous github : microservices-sandbox\n",readTime:{text:"10 min read",minutes:9.52,time:571200,words:1904}},relatedArticles:[{slug:"vers-linfini-et-au-dela",description:"[![tumblr_lw0g09a2hf1qaz5oho1_500[1]](\u002Fimages\u002F1ace7-tumblr_lw0g09a2hf1qaz5oho1_5001.png)](https:\u002F\u002Feventuallycoding.com\u002Fwp-content\u002Fuploads\u002F2019\u002F10\u002F1ace...",id:"1222",title:"Vers l'infini et au-delà",date:"2015-12-22",tags:[z,"gatling","jmeter","loader-io","performance"],img:"1ace7-tumblr_lw0g09a2hf1qaz5oho1_5001.png",cover:aa,path:"\u002Farticles\u002F2015\u002F12\u002F22\u002Fvers-linfini-et-au-dela"},{slug:"feature-branching-vs-feature-flipping",description:"![](\u002Fimages\u002FqXMqcos.png)\nJe ne sais pas vous mais de mon côté, dans chaque job que j'ai pu faire j'ai toujours retrouvé certains éternels débats. Vou...",id:"1316",title:"Feature branching vs Feature Flipping",date:"2017-09-29",tags:[z,"feature-flipping","ff4j"],img:"qXMqcos.png",cover:aa,path:"\u002Farticles\u002F2017\u002F09\u002F29\u002Ffeature-branching-vs-feature-flipping"},{slug:"spring-boot-dans-le-doute-reboote",description:"[![spring-boot-logo](\u002Fimages\u002F28307-spring-boot-logo.png)](http:\u002F\u002Feventuallycoding.com\u002Fwp-content\u002Fuploads\u002F2014\u002F07\u002F28307-spring-boot-logo.png)Le dernier...",id:"1089",title:"Spring Boot : dans le doute reboote",date:"2014-07-16",tags:["devops","monitoring","spring",A],img:"28307-spring-boot-logo.png",cover:"cover1.jpg",path:"\u002Farticles\u002F2014\u002F07\u002F16\u002Fspring-boot-dans-le-doute-reboote"}],_img:{"/_ipx/_/hugo-nb.jpg":"\u002F_nuxt\u002Fimage\u002Fc3e54c.jpg"}}],fetch:{},mutations:void 0}}("text","element","\n","p","td","li","a","oui","nofollow","noopener","noreferrer","_blank","non","ul",2,"img","h2","true",-1,"span","icon","icon-link","th","tr","sitemesh","backend","spring-boot","dupliquer-vos-éléments-communs-dans-chaque-application","Dupliquer vos éléments communs dans chaque application.","reconstruire-le-code-du-footer-et-du-menu-dynamiquement-via-des-méta-données-dans-une-base-de-données","Reconstruire le code du footer et du menu dynamiquement via des méta données dans une base de données","partager-une-jsp-commune-dans-un-jar-pour-pouvoir-linclure-dans-chaque-application-web","Partager une jsp commune dans un jar pour pouvoir l'inclure dans chaque application web","utilisons-sitemesh-alors","Utilisons sitemesh alors","autre-pistes-non-explorées-encore--les-filtres-zuul","Autre pistes non explorées encore : les filtres Zuul","et-un-widget-js-","Et un widget js ?","et-les-webcomponents-","Et les webcomponents ?","tableau-récapitulatif","Tableau récapitulatif","http:\u002F\u002Fwww.eventuallycoding.com\u002Findex.php\u002Fzuul\u002F","Micro-services : routing avec Zuul","https:\u002F\u002Fgithub.com\u002Fhlassiege\u002Fmicroservice-sandbox\u002Ftree\u002Fmaster\u002Fcompose","https:\u002F\u002Ftiles.apache.org\u002F","tiles","vous pouvez utiliser des technologies de templating différentes dans chaque application (jinja en python, jsp en java etc...)","vos applications sont vraiment autonomes et peuvent être utilisées toute seules","hello world","added by sitemesh","non (1)","2022-10-03T11:41:42.070Z","cover4.jpg")));