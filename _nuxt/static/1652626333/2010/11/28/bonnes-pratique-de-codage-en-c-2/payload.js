__NUXT_JSONP__("/2010/11/28/bonnes-pratique-de-codage-en-c-2", (function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B,C,D,E,F,G,H,I,J,K,L,M,N,O,P,Q,R,S,T,U,V,W,X,Y,Z,_,$,aa,ab,ac,ad,ae,af,ag,ah,ai,aj,ak,al,am,an,ao,ap,aq,ar,as,at,au,av,aw,ax,ay,az,aA,aB,aC,aD,aE,aF){return {data:[{article:{slug:"bonnes-pratique-de-codage-en-c-2",description:"Dans la lignée d'un [billet précédent](http:\u002F\u002Flocalhost\u002Flocalweb\u002Fwordpress\u002F?p=144 \"Introduction aux tests unitaires et aux bouchons en C#\") qui consti...",title:"Bonnes pratique de codage en C#",date:"2010-11-28",categories:["waza"],tags:["csharp","testunitaire"],img:"linkext7.gif",cover:"cover3.jpg",toc:[{id:N,depth:s,text:E},{id:O,depth:s,text:P},{id:Q,depth:G,text:R},{id:S,depth:G,text:T},{id:U,depth:G,text:V},{id:W,depth:G,text:X},{id:Y,depth:G,text:Z},{id:_,depth:s,text:E},{id:$,depth:s,text:H},{id:aa,depth:s,text:E},{id:ab,depth:s,text:ac},{id:ad,depth:s,text:ae},{id:af,depth:s,text:ag},{id:ah,depth:s,text:H},{id:ai,depth:s,text:aj},{id:ak,depth:s,text:al}],body:{type:"root",children:[{type:b,tag:d,props:{},children:[{type:a,value:"Dans la lignée d'un "},{type:b,tag:f,props:{href:"http:\u002F\u002Flocalhost\u002Flocalweb\u002Fwordpress\u002F?p=144",rel:[t,u,v],target:w,title:"Introduction aux tests unitaires et aux bouchons en C#"},children:[{type:a,value:"billet précédent"}]},{type:a,value:" qui constituait une introduction aux tests unitaires en C#, voici un autre billet orienté \"bonnes pratiques de codage\" toujours en C#."}]},{type:a,value:c},{type:b,tag:d,props:{},children:[{type:a,value:"Mais loin d'être cantonné au C#, les principes données dans ce billet sont facilement transposables dans d'autres langages. Après tout, il ne s'agit que de \"bonnes pratiques\"."}]},{type:a,value:c},{type:b,tag:x,props:{id:"les-principes-généraux"},children:[{type:b,tag:f,props:{href:"#les-principes-g%C3%A9n%C3%A9raux",ariaHidden:g,tabIndex:h},children:[{type:b,tag:i,props:{className:[j,k]},children:[]}]},{type:a,value:"Les principes généraux"}]},{type:a,value:c},{type:b,tag:d,props:{},children:[{type:a,value:"Les deux principes généraux pour une bonne testabilité :"}]},{type:a,value:c},{type:b,tag:l,props:{},children:[{type:a,value:c},{type:b,tag:e,props:{},children:[{type:a,value:"l'isolabilité"}]},{type:a,value:c},{type:b,tag:e,props:{},children:[{type:a,value:"la simplicité"}]},{type:a,value:c}]},{type:a,value:c},{type:b,tag:am,props:{},children:[{type:a,value:c},{type:b,tag:d,props:{},children:[{type:a,value:"La perfection est atteinte non pas quand il n’y a plus rien à ajouter, mais quand il n’y a plus rien à retirer !"}]},{type:a,value:c}]},{type:a,value:c},{type:b,tag:d,props:{},children:[{type:a,value:"Symptômes d'un code intestable :"}]},{type:a,value:c},{type:b,tag:d,props:{},children:[{type:a,value:"Symptômes d'un code testable :"}]},{type:a,value:c},{type:b,tag:x,props:{id:"constructeur-couteux"},children:[{type:b,tag:f,props:{href:"#constructeur-couteux",ariaHidden:g,tabIndex:h},children:[{type:b,tag:i,props:{className:[j,k]},children:[]}]},{type:a,value:"Constructeur couteux"}]},{type:a,value:c},{type:b,tag:y,props:{id:N},children:[{type:b,tag:f,props:{href:"#probl%C3%A9matique",ariaHidden:g,tabIndex:h},children:[{type:b,tag:i,props:{className:[j,k]},children:[]}]},{type:a,value:E}]},{type:a,value:c},{type:b,tag:d,props:{},children:[{type:a,value:"Exemple de constructeur couteux :"}]},{type:a,value:c},{type:b,tag:d,props:{},children:[{type:a,value:"public Dictionnaire ()\n{\nStreamReader monStreamReader = new StreamReader(\"francais.txt\");\nstring ligne = monStreamReader.ReadLine();"}]},{type:a,value:c},{type:b,tag:m,props:{className:[n]},children:[{type:b,tag:o,props:{className:[p,q]},children:[{type:b,tag:r,props:{},children:[{type:a,value:K}]}]}]},{type:a,value:c},{type:b,tag:d,props:{},children:[{type:a,value:B}]},{type:a,value:c},{type:b,tag:d,props:{},children:[{type:a,value:"Problèmes :"}]},{type:a,value:c},{type:b,tag:l,props:{},children:[{type:a,value:c},{type:b,tag:e,props:{},children:[{type:a,value:"potentiellement couteux"}]},{type:a,value:c},{type:b,tag:e,props:{},children:[{type:a,value:"dépendant d'une ressource externe (le fichier francais.txt)"}]},{type:a,value:c},{type:b,tag:e,props:{},children:[{type:a,value:"création d'objet (présence de new)"}]},{type:a,value:c},{type:b,tag:e,props:{},children:[{type:a,value:"l'initialisation peut échouer"}]},{type:a,value:c}]},{type:a,value:c},{type:b,tag:d,props:{},children:[{type:a,value:"=\u003E "},{type:b,tag:D,props:{},children:[{type:a,value:"Le test n'est pas isolé, il peut durer longtemps et son comportement ne peut pas être différent entre deux tests"}]}]},{type:a,value:c},{type:b,tag:y,props:{id:O},children:[{type:b,tag:f,props:{href:"#solutions",ariaHidden:g,tabIndex:h},children:[{type:b,tag:i,props:{className:[j,k]},children:[]}]},{type:a,value:P}]},{type:a,value:c},{type:b,tag:I,props:{id:Q},children:[{type:b,tag:f,props:{href:"#m%C3%A9thodes-init-optionnelle",ariaHidden:g,tabIndex:h},children:[{type:b,tag:i,props:{className:[j,k]},children:[]}]},{type:a,value:R}]},{type:a,value:c},{type:b,tag:d,props:{},children:[{type:a,value:"public Dictionnaire ()\n{\n}"}]},{type:a,value:c},{type:b,tag:d,props:{},children:[{type:a,value:"private void Init ()\n{\nStreamReader monStreamReader = new StreamReader(\"francais.txt\");\nstring ligne = monStreamReader.ReadLine();"}]},{type:a,value:c},{type:b,tag:m,props:{className:[n]},children:[{type:b,tag:o,props:{className:[p,q]},children:[{type:b,tag:r,props:{},children:[{type:a,value:K}]}]}]},{type:a,value:c},{type:b,tag:d,props:{},children:[{type:a,value:B}]},{type:a,value:c},{type:b,tag:d,props:{},children:[{type:a,value:"=\u003E pour du code existant, le risque c'est que les appelants n'appellent pas cette méthode"}]},{type:a,value:c},{type:b,tag:I,props:{id:S},children:[{type:b,tag:f,props:{href:"#m%C3%A9thode-init-surchargeable",ariaHidden:g,tabIndex:h},children:[{type:b,tag:i,props:{className:[j,k]},children:[]}]},{type:a,value:T}]},{type:a,value:c},{type:b,tag:d,props:{},children:[{type:a,value:"protected void Init ()\n{\nStreamReader monStreamReader = new StreamReader(\"francais.txt\");\nstring ligne = monStreamReader.ReadLine();"}]},{type:a,value:c},{type:b,tag:m,props:{className:[n]},children:[{type:b,tag:o,props:{className:[p,q]},children:[{type:b,tag:r,props:{},children:[{type:a,value:K}]}]}]},{type:a,value:c},{type:b,tag:d,props:{},children:[{type:a,value:B}]},{type:a,value:c},{type:b,tag:d,props:{},children:[{type:a,value:"=\u003E la méthode étant protected, on peut créer un objet DictionnaireTestable qui redéfinit la méthode Init"}]},{type:a,value:c},{type:b,tag:d,props:{},children:[{type:a,value:"public class DictionnaireTestable ()\n{\nprotected void Init ()\n{\n\u002F\u002F Do nothing\n}\n}"}]},{type:a,value:c},{type:b,tag:d,props:{},children:[{type:a,value:"=\u003E Obligé de créer une classe pour les tests"}]},{type:a,value:c},{type:b,tag:I,props:{id:U},children:[{type:b,tag:f,props:{href:"#constructeur-diff%C3%A9rent-pour-les-tests",ariaHidden:g,tabIndex:h},children:[{type:b,tag:i,props:{className:[j,k]},children:[]}]},{type:a,value:V}]},{type:a,value:c},{type:b,tag:d,props:{},children:[{type:a,value:"public Dictionnaire (boolean ForTest)\n{\n\u002F\u002F Do nothing\n}"}]},{type:a,value:c},{type:b,tag:l,props:{},children:[{type:a,value:c},{type:b,tag:e,props:{},children:[{type:a,value:"risque de confusion avec le constructeur existant"}]},{type:a,value:c},{type:b,tag:e,props:{},children:[{type:a,value:"paramétre supplémentaire non utilisé"}]},{type:a,value:c}]},{type:a,value:c},{type:b,tag:I,props:{id:W},children:[{type:b,tag:f,props:{href:"#solution-optimale",ariaHidden:g,tabIndex:h},children:[{type:b,tag:i,props:{className:[j,k]},children:[]}]},{type:a,value:X}]},{type:a,value:c},{type:b,tag:l,props:{},children:[{type:a,value:c},{type:b,tag:e,props:{},children:[{type:a,value:"objets liés passés en paramètre"}]},{type:a,value:c}]},{type:a,value:c},{type:b,tag:d,props:{},children:[{type:a,value:"public Dictionnaire ()\n{\n\u002F\u002F ancien code\n...\n}"}]},{type:a,value:c},{type:b,tag:d,props:{},children:[{type:a,value:"public Dictionnaire (Dictionary definitions )\n{\nthis.definitions = definitions;\n}"}]},{type:a,value:c},{type:b,tag:d,props:{},children:[{type:a,value:"Les définitions sont initialisées dans une factory."}]},{type:a,value:c},{type:b,tag:d,props:{},children:[{type:a,value:"public class DictionnaireFactory\n{\npublic static Dictionnaire buildFromTextFile ()\n{\nDictionary definitions = new Dictionnary();\nStreamReader monStreamReader = new StreamReader(\"francais.txt\");\nstring ligne = monStreamReader.ReadLine();"}]},{type:a,value:c},{type:b,tag:m,props:{className:[n]},children:[{type:b,tag:o,props:{className:[p,q]},children:[{type:b,tag:r,props:{},children:[{type:a,value:"    while (ligne != null)\n    {\n        string\\[\\] words = ligne.Split(':');\n        definitions.Put(words \\[0\\],words \\[1\\]);\n        ligne = monStreamReader.ReadLine();\n    }\n    monStreamReader.Close();\n\n    return new Dictionnaire (definitions);\n}\n"}]}]}]},{type:a,value:c},{type:b,tag:d,props:{},children:[{type:a,value:B}]},{type:a,value:c},{type:b,tag:d,props:{},children:[{type:a,value:"Ainsi, un test peut utiliser le constructeur avec un dictionnary par défaut. La lecture du fichier a été délocalisé hors de la classe."}]},{type:a,value:c},{type:b,tag:I,props:{id:Y},children:[{type:b,tag:f,props:{href:"#attention-%C3%A0-lencapsulation",ariaHidden:g,tabIndex:h},children:[{type:b,tag:i,props:{className:[j,k]},children:[]}]},{type:a,value:Z}]},{type:a,value:c},{type:b,tag:d,props:{},children:[{type:a,value:"La technique ci-dessus a cependant un risque important si on l'applique naivement, celui de briser l'encapsulation."}]},{type:a,value:c},{type:b,tag:d,props:{},children:[{type:a,value:L}]},{type:a,value:c},{type:b,tag:d,props:{},children:[{type:a,value:"public class Car\n{\npublic Car (Engine engine);\n...\n}"}]},{type:a,value:c},{type:b,tag:d,props:{},children:[{type:a,value:"En exposant les collaborateurs je donne des indications sur la façon dont fonctionne mon objet. Ici ma voiture est une voiture à moteur."}]},{type:a,value:c},{type:b,tag:d,props:{},children:[{type:a,value:"Si au final l'appelant doit instancier tout les objets nécessaires à ma voiture : le moteur, le frein, la boite de vitesse, je brise l'encapsulation et je rends l'utilisation de l'objet très difficile."}]},{type:a,value:c},{type:b,tag:d,props:{},children:[{type:a,value:"D'où l'intérêt de manipuler des interfaces et d'utiliser des Factory."}]},{type:a,value:c},{type:b,tag:x,props:{id:"les-instanciations-directes"},children:[{type:b,tag:f,props:{href:"#les-instanciations-directes",ariaHidden:g,tabIndex:h},children:[{type:b,tag:i,props:{className:[j,k]},children:[]}]},{type:a,value:"Les instanciations directes"}]},{type:a,value:c},{type:b,tag:y,props:{id:_},children:[{type:b,tag:f,props:{href:"#probl%C3%A9matique-1",ariaHidden:g,tabIndex:h},children:[{type:b,tag:i,props:{className:[j,k]},children:[]}]},{type:a,value:E}]},{type:a,value:c},{type:b,tag:d,props:{},children:[{type:a,value:"Les instanciations (via l'opérateur new) comme dans l'exemple suivant peuvent être gênant pour les tests :"}]},{type:a,value:c},{type:b,tag:d,props:{},children:[{type:a,value:"Dictionnaire dico = new Dictionnaire ();\n..."}]},{type:a,value:c},{type:b,tag:d,props:{},children:[{type:a,value:"Ici on créé un couplage fort avec l'implémentation du dictionnaire."},{type:b,tag:F,props:{},children:[]},{type:a,value:"\nSi celui-ci établit une connexion à la base de données, le code devient intestable."}]},{type:a,value:c},{type:b,tag:y,props:{id:$},children:[{type:b,tag:f,props:{href:"#solution",ariaHidden:g,tabIndex:h},children:[{type:b,tag:i,props:{className:[j,k]},children:[]}]},{type:a,value:H}]},{type:a,value:c},{type:b,tag:d,props:{},children:[{type:a,value:"Plusieurs approches sont possibles, elles sont toutes basées sur l'utilisation d'une interface qui va définir le contrat du dictionnaire."}]},{type:a,value:c},{type:b,tag:d,props:{},children:[{type:a,value:"public interface IDictionnaire\n{\n...\n}"}]},{type:a,value:c},{type:b,tag:d,props:{},children:[{type:a,value:"Le code appelant utilisera désormais l'interface qui ne déclare que son comportement métier."}]},{type:a,value:c},{type:b,tag:d,props:{},children:[{type:a,value:"On pourra ensuite utiliser :"}]},{type:a,value:c},{type:b,tag:l,props:{},children:[{type:a,value:c},{type:b,tag:e,props:{},children:[{type:a,value:"une Factory"}]},{type:a,value:c},{type:b,tag:e,props:{},children:[{type:a,value:"l'injection de dépendances via un framework spécialisé (Spring.Net, GenericFacade etc...)"}]},{type:a,value:c}]},{type:a,value:c},{type:b,tag:d,props:{},children:[{type:a,value:"\u002F\u002F Ici la factory nous permet de rajouter un découplage entre celui qui utilise et l'implémentation.\nIDictionnaire dico = DictionnaireFactory.BuildDictionnaire ();\n..."}]},{type:a,value:c},{type:b,tag:d,props:{},children:[{type:a,value:"ou avec Spring.Net"}]},{type:a,value:c},{type:b,tag:d,props:{},children:[{type:a,value:"ApplicationContext ctx = ContextRegistry.GetContext();\nIDictionnaire dico= (IDictionnaire ) ctx.GetObject (\"MyDictionnaire\");"}]},{type:a,value:c},{type:b,tag:d,props:{},children:[{type:a,value:"L'intérêt des Frameworks, entre autre, par rapport à une factory classique, c'est de pouvoir configurer l'implémentation renvoyé selon le contexte."}]},{type:a,value:c},{type:b,tag:x,props:{id:"les-blocs-statiques"},children:[{type:b,tag:f,props:{href:"#les-blocs-statiques",ariaHidden:g,tabIndex:h},children:[{type:b,tag:i,props:{className:[j,k]},children:[]}]},{type:a,value:"Les blocs statiques"}]},{type:a,value:c},{type:b,tag:y,props:{id:aa},children:[{type:b,tag:f,props:{href:"#probl%C3%A9matique-2",ariaHidden:g,tabIndex:h},children:[{type:b,tag:i,props:{className:[j,k]},children:[]}]},{type:a,value:E}]},{type:a,value:c},{type:b,tag:d,props:{},children:[{type:a,value:"L'utilisation de bloc statique est impossible en C# donc ce paragraphe n'est pas applicable."},{type:b,tag:F,props:{},children:[]},{type:a,value:"\nCependant en C# on peut avoir des constructeurs statiques."}]},{type:a,value:c},{type:b,tag:d,props:{},children:[{type:a,value:"class SimpleClass\n{\n\u002F\u002F Static constructor\nstatic SimpleClass()\n{\n\u002F\u002F...\n}\n}"}]},{type:a,value:c},{type:b,tag:d,props:{},children:[{type:a,value:"Le défaut des constructeurs statiques étant qu'ils créent un état permanent. Tester une classe avec état peut être très difficile a cause des effets de bord :"}]},{type:a,value:c},{type:b,tag:d,props:{},children:[{type:a,value:"class SimpleClass\n{\nprivate static int compteur;"}]},{type:a,value:c},{type:b,tag:m,props:{className:[n]},children:[{type:b,tag:o,props:{className:[p,q]},children:[{type:b,tag:r,props:{},children:[{type:a,value:"\u002F\u002F Static constructor\nstatic SimpleClass()\n{\n    compteur = 0;\n}\n\npublic static int AddValueToCompteur (int value)\n{\n    compteur +=value;\n    return compteur;\n}\n"}]}]}]},{type:a,value:c},{type:b,tag:d,props:{},children:[{type:a,value:B}]},{type:a,value:c},{type:b,tag:d,props:{},children:[{type:a,value:an},{type:b,tag:D,props:{},children:[{type:a,value:ao}]},{type:a,value:ap}]},{type:a,value:c},{type:b,tag:m,props:{className:[n]},children:[{type:b,tag:o,props:{className:[p,q]},children:[{type:b,tag:r,props:{},children:[{type:a,value:"\\[Test\\]\npublic void TestAddNegativeValue()\n{\n    Assert.AreEquals(-2, SimpleClass.AddValueToCompteur(-2));\n\n}\n\\[Test\\]\npublic void TestAddPositiveValue()\n{\n    Assert.AreEquals(0, SimpleClass.AddValueToCompteur(2));\n}\n"}]}]}]},{type:a,value:c},{type:b,tag:y,props:{id:ab},children:[{type:b,tag:f,props:{href:"#suppression-des-constructeurs-statiques",ariaHidden:g,tabIndex:h},children:[{type:b,tag:i,props:{className:[j,k]},children:[]}]},{type:a,value:ac}]},{type:a,value:c},{type:b,tag:d,props:{},children:[{type:a,value:"class SimpleClass\n{\nprivate int compteur;"}]},{type:a,value:c},{type:b,tag:m,props:{className:[n]},children:[{type:b,tag:o,props:{className:[p,q]},children:[{type:b,tag:r,props:{},children:[{type:a,value:"public SimpleClass()\n{\n    compteur = 0;\n}\n\npublic int AddValueToCompteur (int value)\n{\n    compteur +=value;\n    return compteur;\n}\n"}]}]}]},{type:a,value:c},{type:b,tag:d,props:{},children:[{type:a,value:B}]},{type:a,value:c},{type:b,tag:x,props:{id:"dynastie-de-classes"},children:[{type:b,tag:f,props:{href:"#dynastie-de-classes",ariaHidden:g,tabIndex:h},children:[{type:b,tag:i,props:{className:[j,k]},children:[]}]},{type:a,value:"Dynastie de classes"}]},{type:a,value:c},{type:b,tag:y,props:{id:ad},children:[{type:b,tag:f,props:{href:"#introduction",ariaHidden:g,tabIndex:h},children:[{type:b,tag:i,props:{className:[j,k]},children:[]}]},{type:a,value:ae}]},{type:a,value:c},{type:b,tag:d,props:{},children:[{type:a,value:"L'utilisation de l'héritage n'est pas toujours idéale :"}]},{type:a,value:c},{type:b,tag:l,props:{},children:[{type:a,value:c},{type:b,tag:e,props:{},children:[{type:a,value:"duplication de code"}]},{type:a,value:c},{type:b,tag:e,props:{},children:[{type:a,value:"fragilité du modèle"}]},{type:a,value:c},{type:b,tag:e,props:{},children:[{type:a,value:"non réutilisabilité"}]},{type:a,value:c}]},{type:a,value:c},{type:b,tag:d,props:{},children:[{type:a,value:"En fait, bien souvent : "},{type:b,tag:D,props:{},children:[{type:a,value:"Il faut privilégier la composition à l'héritage"}]}]},{type:a,value:c},{type:b,tag:d,props:{},children:[{type:a,value:"Nous n'allons pas redémontrer ce point ici, mais si vous voulez plus de sources à ce sujet :"}]},{type:a,value:c},{type:b,tag:l,props:{},children:[{type:a,value:c},{type:b,tag:e,props:{},children:[{type:b,tag:f,props:{href:"http:\u002F\u002Fberniesumption.com\u002Fsoftware\u002Finheritance-is-evil-and-must-be-destroyed\u002F",rel:[t,u,v],target:w},children:[{type:a,value:"Inhéritance is evil and must be destroyed"},{type:b,tag:z,props:{alt:A,src:C},children:[]}]}]},{type:a,value:c},{type:b,tag:e,props:{},children:[{type:b,tag:f,props:{href:"http:\u002F\u002Fwww.siteduzero.com\u002Ftutoriel-3-65563-les-limites-de-l-heritage-le-pattern-strategy.html",rel:[t,u,v],target:w},children:[{type:a,value:"Les limites de l'héritage (le pattern strategy)"},{type:b,tag:z,props:{alt:A,src:C},children:[]}]}]},{type:a,value:c},{type:b,tag:e,props:{},children:[{type:b,tag:f,props:{href:"http:\u002F\u002Fblogs.developpeur.org\u002Ftja\u002Farchive\u002F2009\u002F06\u002F28\u002Fdesign-patterns-privil-giez-la-composition-l-h-ritage-strat-gie.aspx",rel:[t,u,v],target:w},children:[{type:a,value:"Le design pattern Stratégy en .Net"},{type:b,tag:z,props:{alt:A,src:C},children:[]}]}]},{type:a,value:c}]},{type:a,value:c},{type:b,tag:d,props:{},children:[{type:a,value:"En fait, selon le principe de Liskov :"}]},{type:a,value:c},{type:b,tag:am,props:{},children:[{type:a,value:c},{type:b,tag:d,props:{},children:[{type:a,value:"\"une relation d'héritage est bien employée s'il est possible de substituer n'importe quel instance d'une super-classe, par n'importe quel instance d'une de ses sous-classes, sans que la sémantique d'un programme écrit dans les termes de la super-classe n'en soit affectée.\""}]},{type:a,value:c}]},{type:a,value:c},{type:b,tag:d,props:{},children:[{type:a,value:"(Cf. "},{type:b,tag:f,props:{href:"http:\u002F\u002Ffr.wikipedia.org\u002Fwiki\u002FPrincipe_de_substitution_de_Liskov",rel:[t,u,v],target:w},children:[{type:a,value:"Le principe de Liskov, à la base de la conception par contrat"},{type:b,tag:z,props:{alt:A,src:C},children:[]}]},{type:a,value:M}]},{type:a,value:c},{type:b,tag:y,props:{id:af},children:[{type:b,tag:f,props:{href:"#exemple",ariaHidden:g,tabIndex:h},children:[{type:b,tag:i,props:{className:[j,k]},children:[]}]},{type:a,value:ag}]},{type:a,value:c},{type:b,tag:d,props:{},children:[{type:a,value:"Ci-dessous un hiérarchie de classe :"}]},{type:a,value:c},{type:b,tag:d,props:{},children:[{type:a,value:"Un compte peut être spécialisé en compte courant ou compte epargne. Un compte hérite des méthodes liées aux objets sécurisées et sauvegardable."}]},{type:a,value:c},{type:b,tag:d,props:{},children:[{type:a,value:"Outre les problèmes inhérents à cette modélisation :"}]},{type:a,value:c},{type:b,tag:l,props:{},children:[{type:a,value:c},{type:b,tag:e,props:{},children:[{type:a,value:"duplication de code au niveau des comptes (sans doute des override pour redéfinir des comportements)"}]},{type:a,value:c},{type:b,tag:e,props:{},children:[{type:a,value:"réutilisation des comptes en dehors du contexte de notre modèle de données impossible"}]},{type:a,value:c},{type:b,tag:e,props:{},children:[{type:a,value:"fragilité du modèle (rajouter des types de comptes, spécialiser la sécurité par type d'objet ou la sauvegarde, tout cela est dangereux pour ce modèle legacy)"}]},{type:a,value:c},{type:b,tag:e,props:{},children:[{type:a,value:"scalabilité faible (que va-t-il se passer avec 32 types de comptes différents)"}]},{type:a,value:c}]},{type:a,value:c},{type:b,tag:d,props:{},children:[{type:b,tag:D,props:{},children:[{type:a,value:"Il se pose aussi des problèmes de testabilité !"}]}]},{type:a,value:c},{type:b,tag:d,props:{},children:[{type:a,value:L}]},{type:a,value:c},{type:b,tag:l,props:{},children:[{type:a,value:c},{type:b,tag:e,props:{},children:[{type:a,value:"Pour tester un compte, je dois configurer une connexion à la base de données car EntiteSauvegardable s'initialise à partir d'une connexion"}]},{type:a,value:c},{type:b,tag:e,props:{},children:[{type:a,value:"La sécurisation nécessite l'accès à une ressource Active Directory"},{type:b,tag:F,props:{},children:[]},{type:a,value:"\netc..."}]},{type:a,value:c}]},{type:a,value:c},{type:b,tag:d,props:{},children:[{type:b,tag:D,props:{},children:[{type:a,value:"En instanciant un objet Compte, je suis fortement couplé avec les objets dont il hérite."}]}]},{type:a,value:c},{type:b,tag:y,props:{id:ah},children:[{type:b,tag:f,props:{href:"#solution-1",ariaHidden:g,tabIndex:h},children:[{type:b,tag:i,props:{className:[j,k]},children:[]}]},{type:a,value:H}]},{type:a,value:c},{type:b,tag:l,props:{},children:[{type:a,value:c},{type:b,tag:e,props:{},children:[{type:a,value:"le design pattern strategy (voir article plus haut)"}]},{type:a,value:c},{type:b,tag:e,props:{},children:[{type:a,value:"la composition (un compte n'est pas une entité sécurisé mais "},{type:b,tag:D,props:{},children:[{type:a,value:"utilise"}]},{type:a,value:" une entité sécurisé)"}]},{type:a,value:c},{type:b,tag:e,props:{},children:[{type:a,value:"la séparation des responsabilités (séparation DAO (accès aux données), entités (objets simples), services (comportement métier)"}]},{type:a,value:c}]},{type:a,value:c},{type:b,tag:d,props:{},children:[{type:a,value:"Toutes ces solutions reposent sur la programmation par contrat (l'utilisation d'interface pour définir le contrat d'un objet) et peuvent s'appuyer sur l'injection de dépendances pour injecter les implémentations correspondantes au comportement voulu."}]},{type:a,value:c},{type:b,tag:d,props:{},children:[{type:b,tag:D,props:{},children:[{type:a,value:"Et surtout, c'est testable !"}]}]},{type:a,value:c},{type:b,tag:d,props:{},children:[{type:a,value:"public class Compte\n{\nprivate string titulaire;\nprivate float amount;\nprivate ISecureEntity;\n....\n}"}]},{type:a,value:c},{type:b,tag:d,props:{},children:[{type:a,value:"En injectant un bouchon pour ISecureEntity, mon Compte est testable en isolation."}]},{type:a,value:c},{type:b,tag:aq,props:{},children:[{type:b,tag:"colgroup",props:{},children:[{type:b,tag:ar,props:{width:24},children:[]},{type:a,value:as},{type:b,tag:ar,props:{},children:[]},{type:a,value:as}]},{type:b,tag:at,props:{},children:[{type:b,tag:au,props:{},children:[{type:b,tag:J,props:{vAlign:av},children:[{type:b,tag:z,props:{src:"\u002Fimages\u002Finformation.gif",alt:A,width:aw,height:aw,align:"absmiddle",border:0},children:[]}]},{type:b,tag:J,props:{},children:[{type:a,value:"L'exemple ci-dessus bénéficierait sans doute encore plus d'une véritable séparation des responsabilités. Le compte ne devrait pas être responsable de la façon dont il est sauvé, ou sécurisé."}]}]}]}]},{type:a,value:c},{type:b,tag:x,props:{id:"des-états-globaux"},children:[{type:b,tag:f,props:{href:"#des-%C3%A9tats-globaux",ariaHidden:g,tabIndex:h},children:[{type:b,tag:i,props:{className:[j,k]},children:[]}]},{type:a,value:"Des états globaux"}]},{type:a,value:c},{type:b,tag:d,props:{},children:[{type:a,value:"Un état global est en général contenu par une variable globale :"}]},{type:a,value:c},{type:b,tag:d,props:{},children:[{type:a,value:"public static string maValeur ;"}]},{type:a,value:c},{type:b,tag:d,props:{},children:[{type:a,value:"Les différents problèmes que posent les variables globales :"}]},{type:a,value:c},{type:b,tag:l,props:{},children:[{type:a,value:c},{type:b,tag:e,props:{},children:[{type:a,value:"La variable globale persiste d'un test à l'autre et créé de la confusion"}]},{type:a,value:c},{type:b,tag:e,props:{},children:[{type:a,value:"Un test peut fonctionner seul mais pas quand il est joué avec les autres"}]},{type:a,value:c},{type:b,tag:e,props:{},children:[{type:a,value:"Les tests peuvent échouer ensemble mais marcher individuellement"}]},{type:a,value:c},{type:b,tag:e,props:{},children:[{type:a,value:"L'ordre des tests influe sur le résultat"}]},{type:a,value:c}]},{type:a,value:c},{type:b,tag:d,props:{},children:[{type:a,value:"L'exemple plus haut avec un compteur dans un bloc statique illustre bien ces problèmes."}]},{type:a,value:c},{type:b,tag:d,props:{},children:[{type:a,value:"class SimpleClass\n{\nprivate static int compteur = 0 ;"}]},{type:a,value:c},{type:b,tag:m,props:{className:[n]},children:[{type:b,tag:o,props:{className:[p,q]},children:[{type:b,tag:r,props:{},children:[{type:a,value:"public static int AddValueToCompteur (int value)\n{\ncompteur +=value;\nreturn compteur;\n}\n"}]}]}]},{type:a,value:c},{type:b,tag:d,props:{},children:[{type:a,value:B}]},{type:a,value:c},{type:b,tag:d,props:{},children:[{type:a,value:an},{type:b,tag:D,props:{},children:[{type:a,value:ao}]},{type:a,value:ap}]},{type:a,value:c},{type:b,tag:m,props:{className:[n]},children:[{type:b,tag:o,props:{className:[p,q]},children:[{type:b,tag:r,props:{},children:[{type:a,value:"\\[Test\\]\npublic void TestAddNegativeValue()\n{\n    Assert.AreEquals(-2, SimpleClass.AddValueToCompteur(-2));\n}\n\\[Test\\]\npublic void TestAddPositiveValue()\n{\n    Assert.AreEquals(0, SimpleClass.AddValueToCompteur(2));\n}\n"}]}]}]},{type:a,value:c},{type:b,tag:d,props:{},children:[{type:a,value:"Il existe un pattern pour remplacer cette variable globale : le singleton ("},{type:b,tag:"em",props:{},children:[{type:a,value:"mais injecté !"}]},{type:a,value:M}]},{type:a,value:c},{type:b,tag:d,props:{},children:[{type:a,value:"public class Compteur\n{\nprivate int myCompteur ;\npublic int MyCompteur\n{\nget {return myCompteur} ;\nset {myCompteur = value}\n}"}]},{type:a,value:c},{type:b,tag:m,props:{className:[n]},children:[{type:b,tag:o,props:{className:[p,q]},children:[{type:b,tag:r,props:{},children:[{type:a,value:"public int AddValueToCompteur (int value)\n{\n    myCompteur += value\n    return myCompteur;\n}\n"}]}]}]},{type:a,value:c},{type:b,tag:d,props:{},children:[{type:a,value:B}]},{type:a,value:c},{type:b,tag:d,props:{},children:[{type:a,value:"Vous avez encapsulé le comportement de votre compteur dans un objet compteur, lui-même pourra être injecté dans les classes qui l'utilisent."}]},{type:a,value:c},{type:b,tag:d,props:{},children:[{type:a,value:"Ainsi, dans un contexte de production vous utiliserez un singleton et garantirez donc que votre état reste global à l'application."},{type:b,tag:F,props:{},children:[]},{type:a,value:"\nSi par exemple vous utilisez spring.Net, vous utiliserez des singletons :"}]},{type:a,value:c},{type:b,tag:d,props:{},children:[{type:a,value:"Et dans un contexte de production, vous pourrez injecter une nouvelle instance de compteur pour chaque test."}]},{type:a,value:c},{type:b,tag:x,props:{id:"annuaire-de-service"},children:[{type:b,tag:f,props:{href:"#annuaire-de-service",ariaHidden:g,tabIndex:h},children:[{type:b,tag:i,props:{className:[j,k]},children:[]}]},{type:a,value:"Annuaire de service"}]},{type:a,value:c},{type:b,tag:d,props:{},children:[{type:a,value:"Si l'utilisation d'annuaire est récurrente, son usage doit être bien contrôlé pour favoriser une bonne testabilité."}]},{type:a,value:c},{type:b,tag:d,props:{},children:[{type:a,value:"Prenons les exemples suivant :"}]},{type:a,value:c},{type:b,tag:m,props:{className:[n]},children:[{type:b,tag:o,props:{className:[p,q]},children:[{type:b,tag:r,props:{},children:[{type:a,value:"XmlApplicationContext context = new XmlApplicationContext(\"assembly:\u002F\u002FMySolution\u002FNamespace\u002Fspring.xml\");\nMySuperObject configuration = (MySuperObject )context.GetObject(\"MySuperObject\");\n\nMySuperObject.DoSomething();\n\n....\n\nMyService service = Locator.findService (\"Service\");\nservice.DoSomething();\n\n....\n\npublic MonObjet (Context context)\n{\n    MyProperty1 = context.getProperty1();\n    MyProperty2 = context.getProperty2();\n    MyProperty3 = context.getProperty3();\n}\n"}]}]}]},{type:a,value:c},{type:b,tag:d,props:{},children:[{type:a,value:"Ces bouts de code ont un impact sur la testabilité :"}]},{type:a,value:c},{type:b,tag:l,props:{},children:[{type:a,value:c},{type:b,tag:e,props:{},children:[{type:a,value:"méthodes statiques (voir plus haut)"}]},{type:a,value:c},{type:b,tag:e,props:{},children:[{type:a,value:"liaison avec l'implémentation du XmlApplicationContext basé sur un fichier xml dans le premier exemple"}]},{type:a,value:c},{type:b,tag:e,props:{},children:[{type:a,value:"dépendances cachées entre objet"}]},{type:a,value:c}]},{type:a,value:c},{type:b,tag:d,props:{},children:[{type:a,value:H}]},{type:a,value:c},{type:b,tag:d,props:{},children:[{type:a,value:"De façon générale, l'injection de dépendance permet d'éviter l'utilisation des annuaires."}]},{type:a,value:c},{type:b,tag:d,props:{},children:[{type:a,value:"Cependant si l'utilisation d'un annuaire est nécessaire, l'injection de l'annuaire est préférable à l'instanciation directe."},{type:b,tag:F,props:{},children:[]},{type:a,value:"\nDans le premier exemple, se faire injecter un IApplicationContext permet d'être indépendant de l'implémentation et donc de fournir à l'annuaire nos propres services."}]},{type:a,value:c},{type:b,tag:x,props:{id:"trop-dintermédiaire"},children:[{type:b,tag:f,props:{href:"#trop-dinterm%C3%A9diaire",ariaHidden:g,tabIndex:h},children:[{type:b,tag:i,props:{className:[j,k]},children:[]}]},{type:a,value:"Trop d'intermédiaire"}]},{type:a,value:c},{type:b,tag:d,props:{},children:[{type:a,value:L}]},{type:a,value:c},{type:b,tag:d,props:{},children:[{type:a,value:"public void facturer (Commande commande, Client client)\n{\nbanqueService.prelever (client.getCompteBancaire(),commande.getTotal());\nemailService.notifierPrelevement(client.getEmail());\n}"}]},{type:a,value:c},{type:b,tag:d,props:{},children:[{type:a,value:"Les défauts :"}]},{type:a,value:c},{type:b,tag:l,props:{},children:[{type:a,value:c},{type:b,tag:e,props:{},children:[{type:a,value:"manque de lisibilité, la facturation nécessite bien plus que Commande et Client"}]},{type:a,value:c},{type:b,tag:e,props:{},children:[{type:a,value:"initialisation du test complexe"}]},{type:a,value:c},{type:b,tag:e,props:{},children:[{type:a,value:"couplage avec les objets intermédiaires"}]},{type:a,value:c}]},{type:a,value:c},{type:b,tag:d,props:{},children:[{type:a,value:"La solution :"}]},{type:a,value:c},{type:b,tag:l,props:{},children:[{type:a,value:c},{type:b,tag:e,props:{},children:[{type:a,value:"appliquer le principe de "},{type:b,tag:f,props:{href:"http:\u002F\u002Ffr.wikipedia.org\u002Fwiki\u002FLoi_de_D%C3%A9m%C3%A9ter",rel:[t,u,v],target:w},children:[{type:a,value:"Demeter"},{type:b,tag:z,props:{alt:A,src:C},children:[]}]}]},{type:a,value:c}]},{type:a,value:c},{type:b,tag:d,props:{},children:[{type:a,value:"Exemple de test avant :"}]},{type:a,value:c},{type:b,tag:d,props:{},children:[{type:a,value:"Commande commande = new Commande();commande.setTotal(20.0);"}]},{type:a,value:c},{type:b,tag:d,props:{},children:[{type:a,value:"Client client = new Client();\nCompte compte = new Compte();\nclient.setCompte  (compte);"}]},{type:a,value:c},{type:b,tag:d,props:{},children:[{type:a,value:"string email= \""},{type:b,tag:f,props:{href:ax},children:[{type:a,value:ay}]},{type:a,value:"\";\nclient.setEmail(email);"}]},{type:a,value:c},{type:b,tag:d,props:{},children:[{type:a,value:"manager.facturer (commande,client);"}]},{type:a,value:c},{type:b,tag:d,props:{},children:[{type:a,value:"Après :"}]},{type:a,value:c},{type:b,tag:d,props:{},children:[{type:a,value:"Compte compte = new Compte();\nstring email= \""},{type:b,tag:f,props:{href:ax},children:[{type:a,value:ay}]},{type:a,value:"\";\ndouble total = 20.0;"}]},{type:a,value:c},{type:b,tag:d,props:{},children:[{type:a,value:"manager.facturer (compte,total,email);"}]},{type:a,value:c},{type:b,tag:x,props:{id:"méthodes-trop-chargées"},children:[{type:b,tag:f,props:{href:"#m%C3%A9thodes-trop-charg%C3%A9es",ariaHidden:g,tabIndex:h},children:[{type:b,tag:i,props:{className:[j,k]},children:[]}]},{type:a,value:"Méthodes trop chargées"}]},{type:a,value:c},{type:b,tag:d,props:{},children:[{type:a,value:"Une méthode est trop chargé :"}]},{type:a,value:c},{type:b,tag:l,props:{},children:[{type:a,value:c},{type:b,tag:e,props:{},children:[{type:a,value:"s'il y a trop de if else, for, while imbriqué"}]},{type:a,value:c},{type:b,tag:e,props:{},children:[{type:a,value:"s'il y a beaucoup de conditions"}]},{type:a,value:c}]},{type:a,value:c},{type:b,tag:d,props:{},children:[{type:a,value:"=\u003E on utilise souvent l'indicateur de complexité cyclomatique pour le mesurer."}]},{type:a,value:c},{type:b,tag:d,props:{},children:[{type:a,value:"Comment faire baisser la complexité :"}]},{type:a,value:c},{type:b,tag:l,props:{},children:[{type:a,value:c},{type:b,tag:e,props:{},children:[{type:a,value:"déléguer dans d'autres méthodes"}]},{type:a,value:c},{type:b,tag:e,props:{},children:[{type:a,value:"extraire d'autres classes et déléguer"}]},{type:a,value:c},{type:b,tag:e,props:{},children:[{type:a,value:"utiliser le polymorphisme"}]},{type:a,value:c},{type:b,tag:e,props:{},children:[{type:a,value:"retourner des objets vides plutot que null"}]},{type:a,value:c},{type:b,tag:e,props:{},children:[{type:a,value:"donner des valeurs par défaut (pour éviter les else)"}]},{type:a,value:c}]},{type:a,value:c},{type:b,tag:d,props:{},children:[{type:a,value:"Quel est le rapport avec la testabilité ?"}]},{type:a,value:c},{type:b,tag:d,props:{},children:[{type:a,value:"Plus il y a de routes différentes (les valeurs aux limites, les valeurs null), plus le test sera complexe à écrire."}]},{type:a,value:c},{type:b,tag:y,props:{id:ai},children:[{type:b,tag:f,props:{href:"#exemple1",ariaHidden:g,tabIndex:h},children:[{type:b,tag:i,props:{className:[j,k]},children:[]}]},{type:a,value:aj}]},{type:a,value:c},{type:b,tag:d,props:{},children:[{type:a,value:"public boolean laisserPasser (Personne personne)\n{\nif (personne.getAge() \u003E 12 && personne.getTaille() \u003E 1.3 && personne.EstEnBonneSante())\n{\nif ((personne.getAge() \u003C 18 && personne.EstAccompagne()) || personne.getAge()\u003E=18)\n{\nfacturer(personne);\nreturn true;\n}\n}\nreturn false;\n}"}]},{type:a,value:c},{type:b,tag:d,props:{},children:[{type:a,value:"Exemple avec découpage des méthodes :"}]},{type:a,value:c},{type:b,tag:d,props:{},children:[{type:a,value:"public boolean laisserPasser (Personne personne)\n{\nif (EstPhysiquementCompatibleJeuxIntense(personne))\n{\nif (EstLegalementCompatibleJeuxIntense(personne))\n{\nfacturer(personne);\nreturn true;\n}\n}\nreturn false;\n}"}]},{type:a,value:c},{type:b,tag:d,props:{},children:[{type:a,value:"Exemple avec délégation dans d'autres classes :"}]},{type:a,value:c},{type:b,tag:d,props:{},children:[{type:a,value:"private PersonneChecker personneChecker;"}]},{type:a,value:c},{type:b,tag:d,props:{},children:[{type:a,value:"public boolean laisserPasser (Personne personne)\n{\nif (personneChecker.PhysiqueMinimum(personne) && personneChecker.EstMajeur(personne))\n{\nfacturer(personne);\nreturn true;\n}\nreturn false;\n}"}]},{type:a,value:c},{type:b,tag:y,props:{id:ak},children:[{type:b,tag:f,props:{href:"#exemple-2",ariaHidden:g,tabIndex:h},children:[{type:b,tag:i,props:{className:[j,k]},children:[]}]},{type:a,value:al}]},{type:a,value:c},{type:b,tag:d,props:{},children:[{type:a,value:az}]},{type:a,value:c},{type:b,tag:m,props:{className:[n]},children:[{type:b,tag:o,props:{className:[p,q]},children:[{type:b,tag:r,props:{},children:[{type:a,value:"if (commandes != null)\n{\n    foreach (Commande commande in commandes)\n    {\n        \u002F\u002F do something\n    }\n}\n"}]}]}]},{type:a,value:c},{type:b,tag:d,props:{},children:[{type:a,value:B}]},{type:a,value:c},{type:b,tag:d,props:{},children:[{type:a,value:"si le Dao est fait de facon à toujours renvoyer une liste, même vide (c'est ce que fait NHibernate par exemple)"}]},{type:a,value:c},{type:b,tag:d,props:{},children:[{type:a,value:az}]},{type:a,value:c},{type:b,tag:m,props:{className:[n]},children:[{type:b,tag:o,props:{className:[p,q]},children:[{type:b,tag:r,props:{},children:[{type:a,value:"foreach (Commande commande in commandes)\n{\n    \u002F\u002F do something\n}\n"}]}]}]},{type:a,value:c},{type:b,tag:d,props:{},children:[{type:a,value:B}]},{type:a,value:c},{type:b,tag:x,props:{id:"conclusion"},children:[{type:b,tag:f,props:{href:"#conclusion",ariaHidden:g,tabIndex:h},children:[{type:b,tag:i,props:{className:[j,k]},children:[]}]},{type:a,value:"Conclusion"}]},{type:a,value:c},{type:b,tag:d,props:{},children:[{type:a,value:"Comme vu ci-dessus, la testabilité va souvent de pair avec une bonne conception objet."},{type:b,tag:F,props:{},children:[]},{type:a,value:"\nUne bonne conception permet une bonne modularité et une grande souplesse, tout ce qui est nécessaire à la testabilité."}]},{type:a,value:c},{type:b,tag:d,props:{},children:[{type:a,value:"C'est d'ailleurs parce que la testabilité impose une programmation plus rigoureuse que certaines méthodes de développement impose d'écrire les tests en premiers (Voir "},{type:b,tag:f,props:{href:"http:\u002F\u002Ffr.wikipedia.org\u002Fwiki\u002FTest_Driven_Development",rel:[t,u,v],target:w},children:[{type:a,value:"TDD"},{type:b,tag:z,props:{alt:A,src:C},children:[]}]},{type:a,value:M}]},{type:a,value:c},{type:b,tag:aq,props:{width:36},children:[{type:b,tag:at,props:{},children:[{type:b,tag:au,props:{},children:[{type:b,tag:J,props:{vAlign:av},children:[{type:a,value:aA}]},{type:b,tag:J,props:{},children:[{type:a,value:aA}]}]}]}]},{type:a,value:c},{type:b,tag:d,props:{},children:[{type:a,value:"Sur un code ancien n'ayant pas été conçu pour être testable, l'application des solutions ci-dessus permet de rendre progressivement testable le logiciel."}]},{type:a,value:c},{type:b,tag:x,props:{id:"sources"},children:[{type:b,tag:f,props:{href:"#sources",ariaHidden:g,tabIndex:h},children:[{type:b,tag:i,props:{className:[j,k]},children:[]}]},{type:a,value:"Sources"}]},{type:a,value:c},{type:b,tag:l,props:{},children:[{type:a,value:c},{type:b,tag:e,props:{},children:[{type:b,tag:f,props:{href:aB,rel:[t,u,v],target:w},children:[{type:a,value:aB},{type:b,tag:z,props:{alt:A,src:C},children:[]}]}]},{type:a,value:c},{type:b,tag:e,props:{},children:[{type:b,tag:f,props:{href:aC,rel:[t,u,v],target:w},children:[{type:a,value:aC},{type:b,tag:z,props:{alt:A,src:C},children:[]}]}]},{type:a,value:c},{type:b,tag:e,props:{},children:[{type:b,tag:f,props:{href:aD,rel:[t,u,v],target:w},children:[{type:a,value:aD},{type:b,tag:z,props:{alt:A,src:C},children:[]}]}]},{type:a,value:c},{type:b,tag:e,props:{},children:[{type:b,tag:f,props:{href:aE,rel:[t,u,v],target:w},children:[{type:a,value:aE},{type:b,tag:z,props:{alt:A,src:C},children:[]}]}]},{type:a,value:c}]}]},dir:"\u002Farticles\u002F2010\u002F11\u002F28",path:"\u002Farticles\u002F2010\u002F11\u002F28\u002Fbonnes-pratique-de-codage-en-c-2",extension:".md",createdAt:aF,updatedAt:aF,bodyPlainText:"\nDans la lignée d'un billet précédent qui constituait une introduction aux tests unitaires en C#, voici un autre billet orienté \"bonnes pratiques de codage\" toujours en C#.\n\nMais loin d'être cantonné au C#, les principes données dans ce billet sont facilement transposables dans d'autres langages. Après tout, il ne s'agit que de \"bonnes pratiques\".\n\nLes principes généraux\n\nLes deux principes généraux pour une bonne testabilité :\n\nl'isolabilité\nla simplicité\nLa perfection est atteinte non pas quand il n’y a plus rien à ajouter, mais quand il n’y a plus rien à retirer !\n\nSymptômes d'un code intestable :\n\nSymptômes d'un code testable :\n\nConstructeur couteux\n\nProblématique\n\nExemple de constructeur couteux :\n\npublic Dictionnaire ()\n{\n\tStreamReader monStreamReader = new StreamReader(\"francais.txt\");\n\tstring ligne = monStreamReader.ReadLine();\n\n\twhile (ligne != null)\n\t{\n\t\tstring\\[\\] words = ligne.Split(':');\n\t\tdefinitions.Put(words \\[0\\],words \\[1\\]);\n\t\tligne = monStreamReader.ReadLine();\n\t}\n\tmonStreamReader.Close();\n}\n\nProblèmes :\n\npotentiellement couteux\ndépendant d'une ressource externe (le fichier francais.txt)\ncréation d'objet (présence de new)\nl'initialisation peut échouer\n\n\\=\u003E Le test n'est pas isolé, il peut durer longtemps et son comportement ne peut pas être différent entre deux tests\n\nSolutions\n\nméthodes init optionnelle\n\npublic Dictionnaire ()\n{\n}\n\nprivate void Init ()\n{\n\tStreamReader monStreamReader = new StreamReader(\"francais.txt\");\n\tstring ligne = monStreamReader.ReadLine();\n\n    while (ligne != null)\n\t{\n\t\tstring\\[\\] words = ligne.Split(':');\n\t\tdefinitions.Put(words \\[0\\],words \\[1\\]);\n\t\tligne = monStreamReader.ReadLine();\n\t}\n\tmonStreamReader.Close();\n}\n\n\\=\u003E pour du code existant, le risque c'est que les appelants n'appellent pas cette méthode\n\nméthode init surchargeable\n\nprotected void Init ()\n{\n\tStreamReader monStreamReader = new StreamReader(\"francais.txt\");\n\tstring ligne = monStreamReader.ReadLine();\n\n    while (ligne != null)\n\t{\n\t\tstring\\[\\] words = ligne.Split(':');\n\t\tdefinitions.Put(words \\[0\\],words \\[1\\]);\n\t\tligne = monStreamReader.ReadLine();\n\t}\n\tmonStreamReader.Close();\n}\n\n\\=\u003E la méthode étant protected, on peut créer un objet DictionnaireTestable qui redéfinit la méthode Init\n\npublic class DictionnaireTestable ()\n{\n\tprotected void Init ()\n\t{\n\t\t\u002F\u002F Do nothing\n\t}\n}\n\n\\=\u003E Obligé de créer une classe pour les tests\n\nconstructeur différent pour les tests\n\npublic Dictionnaire (boolean ForTest)\n{\n\t\u002F\u002F Do nothing\n}\n\nrisque de confusion avec le constructeur existant\nparamétre supplémentaire non utilisé\n\nSolution optimale\n\nobjets liés passés en paramètre\n\npublic Dictionnaire ()\n{\n\t\u002F\u002F ancien code\n\t...\n}\n\npublic Dictionnaire (Dictionary definitions )\n{\n\tthis.definitions = definitions;\n}\n\nLes définitions sont initialisées dans une factory.\n\npublic class DictionnaireFactory\n{\n\tpublic static Dictionnaire buildFromTextFile ()\n\t{\n\t\tDictionary definitions = new Dictionnary();\n\t\tStreamReader monStreamReader = new StreamReader(\"francais.txt\");\n\t\tstring ligne = monStreamReader.ReadLine();\n\n        while (ligne != null)\n\t\t{\n\t\t\tstring\\[\\] words = ligne.Split(':');\n\t\t\tdefinitions.Put(words \\[0\\],words \\[1\\]);\n\t\t\tligne = monStreamReader.ReadLine();\n\t\t}\n\t\tmonStreamReader.Close();\n\n        return new Dictionnaire (definitions);\n\t}\n}\n\nAinsi, un test peut utiliser le constructeur avec un dictionnary par défaut. La lecture du fichier a été délocalisé hors de la classe.\n\nAttention à l'encapsulation\n\nLa technique ci-dessus a cependant un risque important si on l'applique naivement, celui de briser l'encapsulation.\n\nExemple :\n\npublic class Car\n{\n\tpublic Car (Engine engine);\n\t...\n}\n\nEn exposant les collaborateurs je donne des indications sur la façon dont fonctionne mon objet. Ici ma voiture est une voiture à moteur.\n\nSi au final l'appelant doit instancier tout les objets nécessaires à ma voiture : le moteur, le frein, la boite de vitesse, je brise l'encapsulation et je rends l'utilisation de l'objet très difficile.\n\nD'où l'intérêt de manipuler des interfaces et d'utiliser des Factory.\n\nLes instanciations directes\n\nProblématique\n\nLes instanciations (via l'opérateur new) comme dans l'exemple suivant peuvent être gênant pour les tests :\n\nDictionnaire dico = new Dictionnaire ();\n...\n\nIci on créé un couplage fort avec l'implémentation du dictionnaire.\nSi celui-ci établit une connexion à la base de données, le code devient intestable.\n\nSolution\n\nPlusieurs approches sont possibles, elles sont toutes basées sur l'utilisation d'une interface qui va définir le contrat du dictionnaire.\n\npublic interface IDictionnaire\n{\n    ...\n}\n\nLe code appelant utilisera désormais l'interface qui ne déclare que son comportement métier.\n\nOn pourra ensuite utiliser :\n\nune Factory\nl'injection de dépendances via un framework spécialisé (Spring.Net, GenericFacade etc...)\n\n\u002F\u002F Ici la factory nous permet de rajouter un découplage entre celui qui utilise et l'implémentation.\nIDictionnaire dico = DictionnaireFactory.BuildDictionnaire ();\n...\n\nou avec Spring.Net\n\nApplicationContext ctx = ContextRegistry.GetContext();\nIDictionnaire dico= (IDictionnaire ) ctx.GetObject (\"MyDictionnaire\");\n\nL'intérêt des Frameworks, entre autre, par rapport à une factory classique, c'est de pouvoir configurer l'implémentation renvoyé selon le contexte.\n\nLes blocs statiques\n\nProblématique\n\nL'utilisation de bloc statique est impossible en C# donc ce paragraphe n'est pas applicable.\nCependant en C# on peut avoir des constructeurs statiques.\n\nclass SimpleClass\n{\n\t\u002F\u002F Static constructor\n\tstatic SimpleClass()\n\t{\n\t\t\u002F\u002F...\n\t}\n}\n\nLe défaut des constructeurs statiques étant qu'ils créent un état permanent. Tester une classe avec état peut être très difficile a cause des effets de bord :\n\nclass SimpleClass\n{\n\tprivate static int compteur;\n\n    \u002F\u002F Static constructor\n\tstatic SimpleClass()\n\t{\n\t\tcompteur = 0;\n\t}\n\n    public static int AddValueToCompteur (int value)\n\t{\n\t\tcompteur +=value;\n\t\treturn compteur;\n\t}\n}\n\nLes tests suivants échoueront aléatoirement =\u003E l'ordre des tests n'est pas garanti par les frameworks de tests. On ne doit pas se reposer sur l'ordre d'écriture des tests pour présumer du résultat.\n\n    \\[Test\\]\n\tpublic void TestAddNegativeValue()\n\t{\n\t\tAssert.AreEquals(-2, SimpleClass.AddValueToCompteur(-2));\n\n\t}\n\t\\[Test\\]\n\tpublic void TestAddPositiveValue()\n\t{\n\t\tAssert.AreEquals(0, SimpleClass.AddValueToCompteur(2));\n\t}\n\nSuppression des constructeurs statiques\n\nclass SimpleClass\n{\n\tprivate int compteur;\n\n    public SimpleClass()\n\t{\n\t\tcompteur = 0;\n\t}\n\n    public int AddValueToCompteur (int value)\n\t{\n\t\tcompteur +=value;\n\t\treturn compteur;\n\t}\n}\n\nDynastie de classes\n\nIntroduction\n\nL'utilisation de l'héritage n'est pas toujours idéale :\n\nduplication de code\nfragilité du modèle\nnon réutilisabilité\n\nEn fait, bien souvent : Il faut privilégier la composition à l'héritage\n\nNous n'allons pas redémontrer ce point ici, mais si vous voulez plus de sources à ce sujet :\n\nInhéritance is evil and must be destroyed\nLes limites de l'héritage (le pattern strategy)\nLe design pattern Stratégy en .Net\n\nEn fait, selon le principe de Liskov :\n\"une relation d'héritage est bien employée s'il est possible de substituer n'importe quel instance d'une super-classe, par n'importe quel instance d'une de ses sous-classes, sans que la sémantique d'un programme écrit dans les termes de la super-classe n'en soit affectée.\"\n\n(Cf. Le principe de Liskov, à la base de la conception par contrat)\n\nExemple\n\nCi-dessous un hiérarchie de classe :\n\nUn compte peut être spécialisé en compte courant ou compte epargne. Un compte hérite des méthodes liées aux objets sécurisées et sauvegardable.\n\nOutre les problèmes inhérents à cette modélisation :\n\nduplication de code au niveau des comptes (sans doute des override pour redéfinir des comportements)\nréutilisation des comptes en dehors du contexte de notre modèle de données impossible\nfragilité du modèle (rajouter des types de comptes, spécialiser la sécurité par type d'objet ou la sauvegarde, tout cela est dangereux pour ce modèle legacy)\nscalabilité faible (que va-t-il se passer avec 32 types de comptes différents)\n\nIl se pose aussi des problèmes de testabilité !\n\nExemple :\n\nPour tester un compte, je dois configurer une connexion à la base de données car EntiteSauvegardable s'initialise à partir d'une connexion\nLa sécurisation nécessite l'accès à une ressource Active Directory\n    etc...\n\nEn instanciant un objet Compte, je suis fortement couplé avec les objets dont il hérite.\n\nSolution\n\nle design pattern strategy (voir article plus haut)\nla composition (un compte n'est pas une entité sécurisé mais utilise une entité sécurisé)\nla séparation des responsabilités (séparation DAO (accès aux données), entités (objets simples), services (comportement métier)\n\nToutes ces solutions reposent sur la programmation par contrat (l'utilisation d'interface pour définir le contrat d'un objet) et peuvent s'appuyer sur l'injection de dépendances pour injecter les implémentations correspondantes au comportement voulu.\n\nEt surtout, c'est testable !\n\npublic class Compte\n{\n\tprivate string titulaire;\n\tprivate float amount;\n\tprivate ISecureEntity;\n\t....\n}\n\nEn injectant un bouchon pour ISecureEntity, mon Compte est testable en isolation.\n\n  L'exemple ci-dessus bénéficierait sans doute encore plus d'une véritable séparation des responsabilités. Le compte ne devrait pas être responsable de la façon dont il est sauvé, ou sécurisé.\n\nDes états globaux\n\nUn état global est en général contenu par une variable globale :\n\npublic static string maValeur ;\n\nLes différents problèmes que posent les variables globales :\n\nLa variable globale persiste d'un test à l'autre et créé de la confusion\nUn test peut fonctionner seul mais pas quand il est joué avec les autres\nLes tests peuvent échouer ensemble mais marcher individuellement\nL'ordre des tests influe sur le résultat\n\nL'exemple plus haut avec un compteur dans un bloc statique illustre bien ces problèmes.\n\nclass SimpleClass\n{\n\tprivate static int compteur = 0 ;\n\n    public static int AddValueToCompteur (int value)\n\t{\n\tcompteur +=value;\n\treturn compteur;\n\t}\n}\n\nLes tests suivants échoueront aléatoirement =\u003E l'ordre des tests n'est pas garanti par les frameworks de tests. On ne doit pas se reposer sur l'ordre d'écriture des tests pour présumer du résultat.\n\n    \\[Test\\]\n\tpublic void TestAddNegativeValue()\n\t{\n\t\tAssert.AreEquals(-2, SimpleClass.AddValueToCompteur(-2));\n\t}\n\t\\[Test\\]\n\tpublic void TestAddPositiveValue()\n\t{\n\t\tAssert.AreEquals(0, SimpleClass.AddValueToCompteur(2));\n\t}\n\nIl existe un pattern pour remplacer cette variable globale : le singleton (mais injecté !)\n\npublic class Compteur\n{\n\tprivate int myCompteur ;\n\tpublic int MyCompteur\n\t{\n\t\tget {return myCompteur} ;\n\t\tset {myCompteur = value}\n\t}\n\n    public int AddValueToCompteur (int value)\n\t{\n\t\tmyCompteur += value\n\t\treturn myCompteur;\n\t}\n}\n\nVous avez encapsulé le comportement de votre compteur dans un objet compteur, lui-même pourra être injecté dans les classes qui l'utilisent.\n\nAinsi, dans un contexte de production vous utiliserez un singleton et garantirez donc que votre état reste global à l'application.\nSi par exemple vous utilisez spring.Net, vous utiliserez des singletons :\n\nEt dans un contexte de production, vous pourrez injecter une nouvelle instance de compteur pour chaque test.\n\nAnnuaire de service\n\nSi l'utilisation d'annuaire est récurrente, son usage doit être bien contrôlé pour favoriser une bonne testabilité.\n\nPrenons les exemples suivant :\n\n    XmlApplicationContext context = new XmlApplicationContext(\"assembly:\u002F\u002FMySolution\u002FNamespace\u002Fspring.xml\");\n\tMySuperObject configuration = (MySuperObject )context.GetObject(\"MySuperObject\");\n\n    MySuperObject.DoSomething();\n\n\t....\n\n    MyService service = Locator.findService (\"Service\");\n\tservice.DoSomething();\n\n\t....\n\n    public MonObjet (Context context)\n\t{\n\t\tMyProperty1 = context.getProperty1();\n\t\tMyProperty2 = context.getProperty2();\n\t\tMyProperty3 = context.getProperty3();\n\t}\n\nCes bouts de code ont un impact sur la testabilité :\n\nméthodes statiques (voir plus haut)\nliaison avec l'implémentation du XmlApplicationContext basé sur un fichier xml dans le premier exemple\ndépendances cachées entre objet\n\nSolution\n\nDe façon générale, l'injection de dépendance permet d'éviter l'utilisation des annuaires.\n\nCependant si l'utilisation d'un annuaire est nécessaire, l'injection de l'annuaire est préférable à l'instanciation directe.\nDans le premier exemple, se faire injecter un IApplicationContext permet d'être indépendant de l'implémentation et donc de fournir à l'annuaire nos propres services.\n\nTrop d'intermédiaire\n\nExemple :\n\npublic void facturer (Commande commande, Client client)\n{\n\tbanqueService.prelever (client.getCompteBancaire(),commande.getTotal());\n\temailService.notifierPrelevement(client.getEmail());\n}\n\nLes défauts :\n\nmanque de lisibilité, la facturation nécessite bien plus que Commande et Client\ninitialisation du test complexe\ncouplage avec les objets intermédiaires\n\nLa solution :\n\nappliquer le principe de Demeter\n\nExemple de test avant :\n\nCommande commande = new Commande();commande.setTotal(20.0);\n\nClient client = new Client();\nCompte compte = new Compte();\nclient.setCompte  (compte);\n\nstring email= \"toto@free.fr\";\nclient.setEmail(email);\n\nmanager.facturer (commande,client);\n\nAprès :\n\nCompte compte = new Compte();\nstring email= \"toto@free.fr\";\ndouble total = 20.0;\n\nmanager.facturer (compte,total,email);\n\nMéthodes trop chargées\n\nUne méthode est trop chargé :\n\ns'il y a trop de if else, for, while imbriqué\ns'il y a beaucoup de conditions\n\n\\=\u003E on utilise souvent l'indicateur de complexité cyclomatique pour le mesurer.\n\nComment faire baisser la complexité :\n\ndéléguer dans d'autres méthodes\nextraire d'autres classes et déléguer\nutiliser le polymorphisme\nretourner des objets vides plutot que null\ndonner des valeurs par défaut (pour éviter les else)\n\nQuel est le rapport avec la testabilité ?\n\nPlus il y a de routes différentes (les valeurs aux limites, les valeurs null), plus le test sera complexe à écrire.\n\nExemple1\n\npublic boolean laisserPasser (Personne personne)\n{\n\tif (personne.getAge() \u003E 12 && personne.getTaille() \u003E 1.3 && personne.EstEnBonneSante())\n\t{\n\t\tif ((personne.getAge() =18)\n\t\t{\n\t\t\tfacturer(personne);\n\t\t\treturn true;\n\t\t}\n\t}\n\treturn false;\n}\n\nExemple avec découpage des méthodes :\n\npublic boolean laisserPasser (Personne personne)\n{\n\tif (EstPhysiquementCompatibleJeuxIntense(personne))\n\t{\n\t\tif (EstLegalementCompatibleJeuxIntense(personne))\n\t\t{\n\t\t\tfacturer(personne);\n\t\t\treturn true;\n\t\t}\n\t}\n\treturn false;\n}\n\nExemple avec délégation dans d'autres classes :\n\nprivate PersonneChecker personneChecker;\n\npublic boolean laisserPasser (Personne personne)\n{\n\tif (personneChecker.PhysiqueMinimum(personne) && personneChecker.EstMajeur(personne))\n\t{\n\t\tfacturer(personne);\n\t\treturn true;\n\t}\n\treturn false;\n}\n\nExemple 2\n\npublic void TraiterListeCommande()\n{\n\tList commandes = RecupererCommandes();\n\n    if (commandes != null)\n\t{\n\t\tforeach (Commande commande in commandes)\n\t\t{\n\t\t\t\u002F\u002F do something\n\t\t}\n\t}\n}\n\nsi le Dao est fait de facon à toujours renvoyer une liste, même vide (c'est ce que fait NHibernate par exemple)\n\npublic void TraiterListeCommande()\n{\n\tList commandes = RecupererCommandes();\n\n    foreach (Commande commande in commandes)\n\t{\n\t\t\u002F\u002F do something\n\t}\n}\n\nConclusion\n\nComme vu ci-dessus, la testabilité va souvent de pair avec une bonne conception objet.\nUne bonne conception permet une bonne modularité et une grande souplesse, tout ce qui est nécessaire à la testabilité.\n\nC'est d'ailleurs parce que la testabilité impose une programmation plus rigoureuse que certaines méthodes de développement impose d'écrire les tests en premiers (Voir TDD)\n\n&nbsp;&nbsp;\n\nSur un code ancien n'ayant pas été conçu pour être testable, l'application des solutions ci-dessus permet de rendre progressivement testable le logiciel.\n\nSources\n\nhttp:\u002F\u002Fblog.o2sources.com\u002F2009\u002F03\u002F23\u002Fcelui-qui-voulait-ecrire-du-code-testable.html\nhttp:\u002F\u002Fmisko.hevery.com\u002Fcode-reviewers-guide\u002F\nhttp:\u002F\u002Fgoogletesting.blogspot.com\u002F2008\u002F08\u002Fby-miko-hevery-so-you-decided-to.html\nhttp:\u002F\u002Fwww.slideshare.net\u002Ffoucha\u002Fcomment-crire-du-code-testable\n",readTime:{text:"12 min read",minutes:11.195,time:671700,words:2239}},_img:{"/_ipx/_/hugo-nb.jpg":"\u002F_nuxt\u002Fimage\u002Fc3e54c.jpg"}}],fetch:{},mutations:void 0}}("text","element","\n","p","li","a","true",-1,"span","icon","icon-link","ul","div","nuxt-content-highlight","pre","language-text","line-numbers","code",2,"nofollow","noopener","noreferrer","_blank","h1","h2","img","","}","\u002Fimages\u002Flinkext7.gif","strong","Problématique","br",3,"Solution","h3","td","while (ligne != null)\n{\n    string\\[\\] words = ligne.Split(':');\n    definitions.Put(words \\[0\\],words \\[1\\]);\n    ligne = monStreamReader.ReadLine();\n}\nmonStreamReader.Close();\n","Exemple :",")","problématique","solutions","Solutions","méthodes-init-optionnelle","méthodes init optionnelle","méthode-init-surchargeable","méthode init surchargeable","constructeur-différent-pour-les-tests","constructeur différent pour les tests","solution-optimale","Solution optimale","attention-à-lencapsulation","Attention à l'encapsulation","problématique-1","solution","problématique-2","suppression-des-constructeurs-statiques","Suppression des constructeurs statiques","introduction","Introduction","exemple","Exemple","solution-1","exemple1","Exemple1","exemple-2","Exemple 2","blockquote","Les tests suivants échoueront aléatoirement =\u003E l'ordre des tests n'est pas garanti par les frameworks de tests. ","On ne doit pas se reposer sur l'ordre d'écriture des tests pour présumer du résultat",".","table","col"," ","tbody","tr","top",16,"mailto:toto@free.fr","toto@free.fr","public void TraiterListeCommande()\n{\nList commandes = RecupererCommandes();"," ","http:\u002F\u002Fblog.o2sources.com\u002F2009\u002F03\u002F23\u002Fcelui-qui-voulait-ecrire-du-code-testable.html","http:\u002F\u002Fmisko.hevery.com\u002Fcode-reviewers-guide\u002F","http:\u002F\u002Fgoogletesting.blogspot.com\u002F2008\u002F08\u002Fby-miko-hevery-so-you-decided-to.html","http:\u002F\u002Fwww.slideshare.net\u002Ffoucha\u002Fcomment-crire-du-code-testable","2022-05-15T14:50:52.957Z")));