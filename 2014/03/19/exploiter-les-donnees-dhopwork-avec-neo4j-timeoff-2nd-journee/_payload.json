[{"data":1,"prerenderedAt":489},["Reactive",2],{"/articles/2014/03/19/exploiter-les-donnees-dhopwork-avec-neo4j-timeoff-2nd-journee":3},{"_path":4,"_dir":5,"_draft":6,"_partial":6,"_locale":7,"title":8,"description":9,"id":10,"date":11,"categories":12,"tags":14,"img":17,"cover":18,"readingTime":19,"body":24,"_type":484,"_id":485,"_source":486,"_file":487,"_extension":488},"/articles/2014/03/19/exploiter-les-donnees-dhopwork-avec-neo4j-timeoff-2nd-journee","19",false,"","Exploiter les données d'HopWork avec Neo4j (timeoff 2nd journée)","[![neo4j](/images/426f8-neo4j.jpg)](http://eventuallycoding.com/wp-content/uploads/2014/03/426f8-neo4j.jpg)[Second jour](http://www.eventuallycoding.c...","1058","2014-03-19",[13],"waza",[15,16],"neo4j","timeoff","426f8-neo4j.jpg","cover4.jpg",{"text":20,"minutes":21,"time":22,"words":23},"5 min read",4.205,252300,841,{"type":25,"children":26,"toc":478},"root",[27,73,87,101,106,126,133,138,143,148,153,164,178,192,197,202,207,212,222,227,240,246,251,265,270,275,280,285,290,295,300,305,310,315,330,335,340,355,360,365,369,383,397,411,425,439,453,457,462,468,473],{"type":28,"tag":29,"props":30,"children":31},"element","p",{},[32,44,53,55,62,64,71],{"type":28,"tag":33,"props":34,"children":38},"a",{"href":35,"rel":36},"http://eventuallycoding.com/wp-content/uploads/2014/03/426f8-neo4j.jpg",[37],"nofollow",[39],{"type":28,"tag":40,"props":41,"children":43},"img",{"alt":15,"src":42},"/images/426f8-neo4j.jpg",[],{"type":28,"tag":33,"props":45,"children":49},{"href":46,"rel":47,"title":48},"http://www.eventuallycoding.com/index.php/ansible-timeoff-lt-1ere-journee/",[37],"Ansible (timeoff LT 1ère journée)",[50],{"type":51,"value":52},"text","Second jour",{"type":51,"value":54}," de ",{"type":28,"tag":33,"props":56,"children":60},{"href":57,"rel":58,"title":59},"http://www.eventuallycoding.com/index.php/on-devrait-toujours-travailler-comme-ca-bis/",[37],"On devrait toujours travailler comme ça (bis)",[61],{"type":51,"value":16},{"type":51,"value":63}," Lateral-Thoughts, je tente toujours de me tenir à un billet par jour. Et aujourd’hui ce post concernera ",{"type":28,"tag":33,"props":65,"children":68},{"href":66,"rel":67},"http://www.neo4j.org/",[37],[69],{"type":51,"value":70},"Neo4J",{"type":51,"value":72},".",{"type":28,"tag":29,"props":74,"children":75},{},[76,78,85],{"type":51,"value":77},"Neo4j fait partie des bases de données orientée graphe. Chez LT nous avons la chance d’avoir ",{"type":28,"tag":33,"props":79,"children":82},{"href":80,"rel":81},"https://twitter.com/fbiville",[37],[83],{"type":51,"value":84},"Florent Biville",{"type":51,"value":86}," qui maîtrise bien le sujet et j’ai un peu profité de lui, en tout bien tout honneur, pour me faire un peu guider dessus.",{"type":28,"tag":29,"props":88,"children":89},{},[90,92,99],{"type":51,"value":91},"Une base de données graphe par définition c’est une base qui traite de relation. Eh oui, toutes les bases nosql n’ont pas abandonné la composante relationnelle. Et c’est bien ce qui m’intéresse ici car je veux jouer avec les profils inscrits sur ",{"type":28,"tag":33,"props":93,"children":96},{"href":94,"rel":95},"http://www.hopwork.com",[37],[97],{"type":51,"value":98},"HopWork",{"type":51,"value":100}," en les reliant via leurs compétences.",{"type":28,"tag":29,"props":102,"children":103},{},[104],{"type":51,"value":105},"Objectif pour moi, répondre à des questions simples :",{"type":28,"tag":107,"props":108,"children":109},"ul",{},[110,116,121],{"type":28,"tag":111,"props":112,"children":113},"li",{},[114],{"type":51,"value":115},"les mots clés les plus utilisés. Cette requête sert pour la mise en jambe car elle ne profite pas des relations",{"type":28,"tag":111,"props":117,"children":118},{},[119],{"type":51,"value":120},"les mots clés les plus souvent associés",{"type":28,"tag":111,"props":122,"children":123},{},[124],{"type":51,"value":125},"chercher un profil “proche” vis à vis d’un autre en prenant en compte uniquement les mots clés",{"type":28,"tag":127,"props":128,"children":130},"h2",{"id":129},"le-chargement",[131],{"type":51,"value":132},"Le chargement",{"type":28,"tag":29,"props":134,"children":135},{},[136],{"type":51,"value":137},"Première étape, on va charger les données à partir de MongoDB. Pour cela on va utiliser un simple main Java :",{"type":28,"tag":29,"props":139,"children":140},{},[141],{"type":51,"value":142},"       GraphDatabaseService graphDb = new GraphDatabaseFactory().newEmbeddedDatabase( \"C:/temp/graphdb\" );\n       ExecutionEngine executionEngine = new ExecutionEngine(graphDb);",{"type":28,"tag":29,"props":144,"children":145},{},[146],{"type":51,"value":147},"       MongoURI mongoURI = new MongoURI(\"mongodb://localhost/workable\");\n       DB db = mongoURI.connectDB();\n       Jongo jongo = new Jongo(db);\n       MongoCollection profiles = jongo.getCollection(\"profiles\");",{"type":28,"tag":29,"props":149,"children":150},{},[151],{"type":51,"value":152},"       profiles.find().as(Profile.class).forEach(profile -> {\n            Map\u003CString, Object> params = new HashMap\u003C>();\n            params.put(\"id\", profile.getKey().toString());\n           executionEngine.execute(\"MERGE (p:PROFILE {key: {id}}) ON CREATE set p.created  = 'true' \", params);",{"type":28,"tag":29,"props":154,"children":155},{},[156,158,162],{"type":51,"value":157},"           profile.getInfos().getKeyWords().forEach(keyword -> {\n               params.put(\"keyword\", keyword);\n               executionEngine.execute(\"MERGE (k:KEYWORD {label: {keyword} }) ON CREATE set k.created  = 'true' \", params);\n               ExecutionResult relationResult = executionEngine.execute(\"MATCH (p:PROFILE {key: {id} }), (k:KEYWORD {label: {keyword} }) \" +\n                       \"CREATE UNIQUE p-[",{"type":28,"tag":159,"props":160,"children":161},"specialises",{},[],{"type":51,"value":163},"_IN]-> k\", params);\n           });\n       });\n       graphDb.shutdown();",{"type":28,"tag":29,"props":165,"children":166},{},[167,169,176],{"type":51,"value":168},"Ici on utilise un executionEngine pour exécuter des requêtes ",{"type":28,"tag":33,"props":170,"children":173},{"href":171,"rel":172},"http://www.neo4j.org/learn/cypher",[37],[174],{"type":51,"value":175},"CYPHER",{"type":51,"value":177},", le langage de requêtage pour Neo4J.",{"type":28,"tag":29,"props":179,"children":180},{},[181,183,190],{"type":51,"value":182},"On utilise ",{"type":28,"tag":33,"props":184,"children":187},{"href":185,"rel":186},"http://jongo.org/",[37],[188],{"type":51,"value":189},"Jongo",{"type":51,"value":191}," pour interroger la base MongoDB.",{"type":28,"tag":29,"props":193,"children":194},{},[195],{"type":51,"value":196},"On remarquera l’utilisation de Java 8 pour itérer sur les collections, faut bien fêter la sortie de Java8 :)",{"type":28,"tag":29,"props":198,"children":199},{},[200],{"type":51,"value":201},"Les requêtes CYPHER utilisées pour insérer les noeuds profiles et les noeuds keywords ont pour but d’éviter d’insérer des doublons :",{"type":28,"tag":29,"props":203,"children":204},{},[205],{"type":51,"value":206},"MERGE (k:KEYWORD {label: {keyword} }) ON CREATE set k.created  = 'true'",{"type":28,"tag":29,"props":208,"children":209},{},[210],{"type":51,"value":211},"La requête pour insérer les relations entre keywords et profiles utilise CREATE UNIQUE pour éviter d’ajouter une relation déjà existante :",{"type":28,"tag":29,"props":213,"children":214},{},[215,217,220],{"type":51,"value":216},"MATCH (p:PROFILE {key: {id} }), (k:KEYWORD {label: {keyword} })\nCREATE UNIQUE p-[",{"type":28,"tag":159,"props":218,"children":219},{},[],{"type":51,"value":221},"_IN]->k",{"type":28,"tag":29,"props":223,"children":224},{},[225],{"type":51,"value":226},"Ensuite il suffit d’utiliser la console Neo4j pour afficher le résultat :",{"type":28,"tag":29,"props":228,"children":229},{},[230],{"type":28,"tag":33,"props":231,"children":234},{"href":232,"rel":233},"http://eventuallycoding.com/wp-content/uploads/2014/03/638d7-graph.png",[37],[235],{"type":28,"tag":40,"props":236,"children":239},{"alt":237,"src":238},"graph","/images/638d7-graph.png",[],{"type":28,"tag":127,"props":241,"children":243},{"id":242},"quelques-requêtes",[244],{"type":51,"value":245},"Quelques requêtes",{"type":28,"tag":29,"props":247,"children":248},{},[249],{"type":51,"value":250},"Désormais nous avons nos données, essayons quelques requêtes.",{"type":28,"tag":29,"props":252,"children":253},{},[254,256,263],{"type":51,"value":255},"Pour exécuter ces requêtes, la console Neo4j va rapidement montrer ces limites. J’ai souhaité utiliser une autre console un peu plus sympathique, ",{"type":28,"tag":33,"props":257,"children":260},{"href":258,"rel":259},"https://github.com/neo4j-contrib/rabbithole",[37],[261],{"type":51,"value":262},"rabbithole",{"type":51,"value":264},". Malheureusement je n’ai pas réussi à la démarrer pour des erreurs cryptiques en tant que débutant. Je suis donc reparti sur une exécution en Java.",{"type":28,"tag":29,"props":266,"children":267},{},[268],{"type":51,"value":269},"Quels sont les mots clés les plus utilisés :",{"type":28,"tag":29,"props":271,"children":272},{},[273],{"type":51,"value":274},"MATCH (:PROFILE)-[s:SPECIALISES_IN]->(k:KEYWORD)",{"type":28,"tag":29,"props":276,"children":277},{},[278],{"type":51,"value":279},"RETURN k, count(s) AS relCount",{"type":28,"tag":29,"props":281,"children":282},{},[283],{"type":51,"value":284},"ORDER BY relCount DESC",{"type":28,"tag":29,"props":286,"children":287},{},[288],{"type":51,"value":289},"LIMIT 10;",{"type":28,"tag":29,"props":291,"children":292},{},[293],{"type":51,"value":294},"Le résultat sur les données de production HopWork:",{"type":28,"tag":29,"props":296,"children":297},{},[298],{"type":51,"value":299},"+--------------------------------------------------------+\n| k                                           | relCount |\n+--------------------------------------------------------+\n| Node[67]{created:\"true\",label:\"web\"}        | 183      |\n| Node[403]{created:\"true\",label:\"php\"}       | 148      |\n| Node[58]{created:\"true\",label:\"webdesign\"}  | 145      |\n| Node[39]{created:\"true\",label:\"javascript\"} | 127      |\n| Node[451]{created:\"true\",label:\"wordpress\"} | 122      |\n| Node[50]{created:\"true\",label:\"logo\"}       | 107      |\n| Node[120]{created:\"true\",label:\"css\"}       | 103      |\n| Node[18]{created:\"true\",label:\"graphiste\"}  | 101      |\n| Node[125]{created:\"true\",label:\"PHP\"}       | 100      |\n| Node[1]{created:\"true\",label:\"Java\"}        | 100      |\n+--------------------------------------------------------+",{"type":28,"tag":29,"props":301,"children":302},{},[303],{"type":51,"value":304},"On remarque évidemment tout de suite que PHP et php sont comptées différemment. Bon, je m’en doutais lors de l’insertion, il y a une grosse phase de normalisation à faire sur les mots clés. Déjà il aurait fallu s’occuper des différences de casses, mais aussi des synonymes (J2EE JEE) ou des regroupements (php relié à php5, php6 etc…).",{"type":28,"tag":29,"props":306,"children":307},{},[308],{"type":51,"value":309},"Tant pis pour l’instant.",{"type":28,"tag":29,"props":311,"children":312},{},[313],{"type":51,"value":314},"Quels sont les couples de mots clés les plus souvent associés :",{"type":28,"tag":29,"props":316,"children":317},{},[318,320,323,325,328],{"type":51,"value":319},"MATCH (k2:KEYWORD)\u003C-[",{"type":28,"tag":159,"props":321,"children":322},{},[],{"type":51,"value":324},"_IN]-(:PROFILE)-[",{"type":28,"tag":159,"props":326,"children":327},{},[],{"type":51,"value":329},"_IN]->(k1:KEYWORD)\nWITH CASE k1.label > k2.label\nWHEN true THEN k1.label + '_' + k2.label\nELSE k2.label + '_' + k1.label\nEND AS result\nRETURN DISTINCT(result), COUNT(result)/2 AS count\nORDER BY count DESC\nLIMIT 10;",{"type":28,"tag":29,"props":331,"children":332},{},[333],{"type":51,"value":334},"Bon là clairement c’est une requête très peu optimisé et le temps d’exécution sur les données d’HopWork est… infini. Je vais faire appel à un ami (Florent) pour l’améliorer :)",{"type":28,"tag":29,"props":336,"children":337},{},[338],{"type":51,"value":339},"Et la dernière requête, partant de mon profil, qui est le plus proche de moi sur HopWork en comptant le nombre de mots clés en commun (faite par Florent) :",{"type":28,"tag":29,"props":341,"children":342},{},[343,345,348,350,353],{"type":51,"value":344},"MATCH (currentProfile:PROFILE { id:123 })-[",{"type":28,"tag":159,"props":346,"children":347},{},[],{"type":51,"value":349},"_IN]->(k:KEYWORD)\u003C-[",{"type":28,"tag":159,"props":351,"children":352},{},[],{"type":51,"value":354},"_IN]-(otherProfile:PROFILE)\nRETURN otherProfile, collect(k), COUNT(k) AS keywordCount\nORDER BY keywordCount DESC LIMIT 6;",{"type":28,"tag":29,"props":356,"children":357},{},[358],{"type":51,"value":359},"+-----------------------------------------------------------------------------------------------------------------------------------+",{"type":28,"tag":29,"props":361,"children":362},{},[363],{"type":51,"value":364},"| otherProfile                                              | collect(k.label)                                       | keywordCount |",{"type":28,"tag":29,"props":366,"children":367},{},[368],{"type":51,"value":359},{"type":28,"tag":29,"props":370,"children":371},{},[372,374,381],{"type":51,"value":373},"| Node[4205]{key:\"",{"type":28,"tag":33,"props":375,"children":378},{"href":376,"rel":377},"http://www.hopwork.com/profile/529c7d944168100d169d8b40",[37],[379],{"type":51,"value":380},"Raphael",{"type":51,"value":382},"\",created:\"true\"} | [\"javascript\",\"mongodb\",\"elasticsearch\",\"performance\"] | 4            |",{"type":28,"tag":29,"props":384,"children":385},{},[386,388,395],{"type":51,"value":387},"| Node[3302]{key:\"",{"type":28,"tag":33,"props":389,"children":392},{"href":390,"rel":391},"http://www.hopwork.com/profile/5103d8bed393273e34aefef8",[37],[393],{"type":51,"value":394},"Sylvain",{"type":51,"value":396},"\",created:\"true\"} | [\"javascript\",\"elasticsearch\",\"nosql\",\"mongodb\"]       | 4            |",{"type":28,"tag":29,"props":398,"children":399},{},[400,402,409],{"type":51,"value":401},"| Node[6351]{key:\"",{"type":28,"tag":33,"props":403,"children":406},{"href":404,"rel":405},"http://www.hopwork.com/profile/512c8545d393273e34af01bd",[37],[407],{"type":51,"value":408},"Katia",{"type":51,"value":410},"\",created:\"true\"} | [\"nosql\",\"javascript\",\"mongodb\"]                       | 3            |",{"type":28,"tag":29,"props":412,"children":413},{},[414,416,423],{"type":51,"value":415},"| Node[3265]{key:\"",{"type":28,"tag":33,"props":417,"children":420},{"href":418,"rel":419},"http://www.hopwork.com/profile/5241ac2e1e92c51c7c4919b7",[37],[421],{"type":51,"value":422},"Zahir",{"type":51,"value":424},"\",created:\"true\"} | [\"mongodb\",\"backbone\",\"javascript\"]                    | 3            |",{"type":28,"tag":29,"props":426,"children":427},{},[428,430,437],{"type":51,"value":429},"| Node[3452]{key:\"",{"type":28,"tag":33,"props":431,"children":434},{"href":432,"rel":433},"http://www.hopwork.com/profile/526537bc4168100d169ce2e9",[37],[435],{"type":51,"value":436},"Maxence",{"type":51,"value":438},"\",created:\"true\"} | [\"elasticsearch\",\"mongodb\",\"javascript\"]               | 3            |",{"type":28,"tag":29,"props":440,"children":441},{},[442,444,451],{"type":51,"value":443},"| Node[4869]{key:\"",{"type":28,"tag":33,"props":445,"children":448},{"href":446,"rel":447},"http://www.hopwork.com/profile/517989e92a07e9483ddedcdd",[37],[449],{"type":51,"value":450},"Arnault",{"type":51,"value":452},"\",created:\"true\"} | [\"mongodb\",\"elasticsearch\",\"performance\"]              | 3            |",{"type":28,"tag":29,"props":454,"children":455},{},[456],{"type":51,"value":359},{"type":28,"tag":29,"props":458,"children":459},{},[460],{"type":51,"value":461},"(J'ai remplacé les id par les liens vers les profils HopWork pour les besoins du billet)",{"type":28,"tag":127,"props":463,"children":465},{"id":464},"avis-au-bout-dune-journée",[466],{"type":51,"value":467},"Avis au bout d’une journée",{"type":28,"tag":29,"props":469,"children":470},{},[471],{"type":51,"value":472},"Dans l’ensemble, on voit un peu comment pourrait se dessiner un moteur de recommandation basé sur un graphe des données dans HopWork. L’outil est intéressant, un peu raide à prendre en main car les infos restent assez parcellaires sur le net. Je prends juste l’exemple des paramètres nommés dans une requête CYPHER, rien dans la doc n’explique le format attendu.",{"type":28,"tag":29,"props":474,"children":475},{},[476],{"type":51,"value":477},"Je suis bien conscient que je suis resté très en surface mais l’outil et ses applications font que j’y retournerais sans doute très prochainement.",{"title":7,"searchDepth":479,"depth":479,"links":480},2,[481,482,483],{"id":129,"depth":479,"text":132},{"id":242,"depth":479,"text":245},{"id":464,"depth":479,"text":467},"markdown","content:articles:2014:03:19:exploiter-les-donnees-dhopwork-avec-neo4j-timeoff-2nd-journee.md","content","articles/2014/03/19/exploiter-les-donnees-dhopwork-avec-neo4j-timeoff-2nd-journee.md","md",1699824939319]