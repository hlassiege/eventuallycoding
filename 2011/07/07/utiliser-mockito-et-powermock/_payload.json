[{"data":1,"prerenderedAt":441},["Reactive",2],{"/articles/2011/07/07/utiliser-mockito-et-powermock":3},{"_path":4,"_dir":5,"_draft":6,"_partial":6,"_locale":7,"title":8,"description":9,"id":10,"date":11,"categories":12,"tags":14,"cover":19,"readingTime":20,"body":25,"_type":436,"_id":437,"_source":438,"_file":439,"_extension":440},"/articles/2011/07/07/utiliser-mockito-et-powermock","07",false,"","Utiliser Mockito et PowerMock","Vous connaissez peut-être déjà [Mockito]","380","2011-07-07",[13],"waza",[15,16,17,18],"java","mockito","powermock","testunitaire","mockito.jpg",{"text":21,"minutes":22,"time":23,"words":24},"5 min read",4.165,249900,833,{"type":26,"children":27,"toc":425},"root",[28,61,66,71,78,91,97,118,123,129,134,153,164,170,183,192,197,203,208,213,218,223,235,241,253,258,263,268,273,278,290,295,300,306,320,331,336,341,346,351,356,361,385,390,395,400,405,410,415,420],{"type":29,"tag":30,"props":31,"children":32},"element","p",{},[33,38,41,50,52,59],{"type":29,"tag":34,"props":35,"children":37},"img",{"alt":7,"src":36,"title":16},"/images/mockito.jpg",[],{"type":39,"value":40},"text","Vous connaissez peut-être déjà ",{"type":29,"tag":42,"props":43,"children":47},"a",{"href":44,"rel":45},"http://mockito.org/",[46],"nofollow",[48],{"type":39,"value":49},"Mockito",{"type":39,"value":51}," ? En fait vous connaissez même surement pour ceux qui ont eu la chance d'être présent à la ",{"type":29,"tag":42,"props":53,"children":56},{"href":54,"rel":55},"http://jduchess.org/duchess-france/blog/marmite-soiree-crumble-pour-la-premiere-edition/",[46],[57],{"type":39,"value":58},"première soirée Marmite des JDuchess",{"type":39,"value":60},".",{"type":29,"tag":30,"props":62,"children":63},{},[64],{"type":39,"value":65},"Et pourquoi j'en parle ? Bon, pas seulement parce que leur logo est un mojito géant et que j'adore cette boisson (*), mais tout simplement pour présenter quelques astuces d'utilisation avec PowerMock.",{"type":29,"tag":30,"props":67,"children":68},{},[69],{"type":39,"value":70},"* inconsciemment ca doit jouer un peu quand même",{"type":29,"tag":72,"props":73,"children":75},"h3",{"id":74},"mais-cest-quoi-mockito",[76],{"type":39,"value":77},"Mais c'est quoi Mockito ?",{"type":29,"tag":30,"props":79,"children":80},{},[81,83,89],{"type":39,"value":82},"Petit retour aux sources, selon ",{"type":29,"tag":42,"props":84,"children":86},{"href":44,"rel":85},[46],[87],{"type":39,"value":88},"le site officiel",{"type":39,"value":90}," : \"Mockito is a mocking framework that tastes really good.\"",{"type":29,"tag":72,"props":92,"children":94},{"id":93},"et-pourquoi-mockito",[95],{"type":39,"value":96},"Et pourquoi Mockito ?",{"type":29,"tag":98,"props":99,"children":100},"ol",{},[101,113],{"type":29,"tag":102,"props":103,"children":104},"li",{},[105,107,111],{"type":39,"value":106},"Parce que son API utilise un DSL agréable à utiliser, lisible, typé :",{"type":29,"tag":108,"props":109,"children":110},"br",{},[],{"type":39,"value":112},"when(mockedList.get(0)).thenReturn(\"first\");\nwhen(mockedList.get(2)).thenThrow(new ArrayOutOfBoundException());",{"type":29,"tag":102,"props":114,"children":115},{},[116],{"type":39,"value":117},"Pas de record-replay obligatoire",{"type":29,"tag":30,"props":119,"children":120},{},[121],{"type":39,"value":122},"Ca c'est pour ceux qui connaissent EasyMock, pas besoin de préciser le comportement attendu de votre mock dans ses moindres détails. On se focalise juste sur le resultat produit par l'objet testé, pas sur sa facon d'utiliser le mock. (A noter que EasyMock permet désormais de créer des mocks sans nécessité de préciser son comportement avec createNiceMock)",{"type":29,"tag":72,"props":124,"children":126},{"id":125},"et-pourquoi-powermock",[127],{"type":39,"value":128},"Et pourquoi Powermock ?",{"type":29,"tag":30,"props":130,"children":131},{},[132],{"type":39,"value":133},"Parce que Mockito tout seul ne permet pas de gérer quelques cas sur du code \"intestable\". Et ce que j'appelle intestable, alors ça, je suis sur que vous en avez déjà vu (ou alors vous avez une veine incroyable et je veux savoir où vous travaillez !) :",{"type":29,"tag":135,"props":136,"children":137},"ul",{},[138,143,148],{"type":29,"tag":102,"props":139,"children":140},{},[141],{"type":39,"value":142},"des méthodes statiques de partout (getInstance, Lookup, etc...)",{"type":29,"tag":102,"props":144,"children":145},{},[146],{"type":39,"value":147},"des blocs statiques",{"type":29,"tag":102,"props":149,"children":150},{},[151],{"type":39,"value":152},"un constructeur qui fait papa-maman (j'adore cette expression...)",{"type":29,"tag":30,"props":154,"children":155},{},[156,158],{"type":39,"value":157},"Pour info, vous avez déjà un bon article sur le sujet mais concernant JMockit : ",{"type":29,"tag":42,"props":159,"children":162},{"href":160,"rel":161},"http://fchabanois.developpez.com/tutorial/java/jmockit/",[46],[163],{"type":39,"value":160},{"type":29,"tag":72,"props":165,"children":167},{"id":166},"mais-revenons-aux-fondamentaux-pourquoi-utiliser-des-mocks",[168],{"type":39,"value":169},"Mais revenons aux fondamentaux, pourquoi utiliser des mocks ?",{"type":29,"tag":30,"props":171,"children":172},{},[173,175,181],{"type":39,"value":174},"Tout simplement parce que quand on parle de test unitaire, on fait référence à des tests ",{"type":29,"tag":176,"props":177,"children":178},"strong",{},[179],{"type":39,"value":180},"UNITAIRES",{"type":39,"value":182}," ! Et tester unitairement un objet ça veut dire le tester en isolation, donc pas d'appel à une base de données, à une file de messages etc... Dans l'idéal, un test unitaire ne teste qu'une seule classe. On utilise d'ailleurs une convention simple et assez parlante pour cela : MonObjet est testé par MonObjetTest (ou TestMonObjet).",{"type":29,"tag":30,"props":184,"children":185},{},[186],{"type":29,"tag":187,"props":188,"children":189},"em",{},[190],{"type":39,"value":191},"Point personnel, sur ce dernier point, je suis plus coulant. Un test reste unitaire du moment que je n'utilise pas de ressources externes (base de données etc...) mais j'accepte l'utilisation d'autre classes du moment que je maitrise leurs propres interactions.",{"type":29,"tag":30,"props":193,"children":194},{},[195],{"type":39,"value":196},"Et donc pour tester en isolation nous allons avoir besoin des fausses implémentations de toutes les dépendances de notre objet. Nous pourrions les écrire toutes, en admettant que chaque dépendance soit utilisé via une interface mais ce serait très fastidieux. Utiliser une librairie de mock permettra donc d'éviter une tâche bien pénible.",{"type":29,"tag":72,"props":198,"children":200},{"id":199},"passons-à-la-pratique",[201],{"type":39,"value":202},"Passons à la pratique",{"type":29,"tag":30,"props":204,"children":205},{},[206],{"type":39,"value":207},"Mockito est fourni avec runner Junit que l'on peut activer comme suit :",{"type":29,"tag":30,"props":209,"children":210},{},[211],{"type":39,"value":212},"@RunWith(MockitoJUnitRunner.class)\npublic class TestMyObjet\n{\n@InjectMocks\nprivate MyObject myObjet = new MyObject();",{"type":29,"tag":30,"props":214,"children":215},{},[216],{"type":39,"value":217},"@Mock\nprivate MyComplexObject myComplexObject;",{"type":29,"tag":30,"props":219,"children":220},{},[221],{"type":39,"value":222},"@Mock\nprivate IMyComplexInterface anotherComplexObject ;\n...\n}",{"type":29,"tag":30,"props":224,"children":225},{},[226,228,233],{"type":39,"value":227},"Première bonne nouvelle, en utilisant l'annotation ",{"type":29,"tag":176,"props":229,"children":230},{},[231],{"type":39,"value":232},"@Mock",{"type":39,"value":234},", le runner Mockito va créer pour vous tout les mocks qui sont déclarés que ce soit des interfaces ou des classes.",{"type":29,"tag":72,"props":236,"children":238},{"id":237},"gérer-les-attributs-privés-sans-setters",[239],{"type":39,"value":240},"Gérer les attributs privés sans setters !",{"type":29,"tag":30,"props":242,"children":243},{},[244,246,251],{"type":39,"value":245},"Là ou le runner est encore plus fort, c'est qu'il va injecter tout les mocks nécessaires sur l'objet annoté par ",{"type":29,"tag":176,"props":247,"children":248},{},[249],{"type":39,"value":250},"@InjectMocks",{"type":39,"value":252},". Et là c'est très pratique, surtout si vous avez du code sans setter.",{"type":29,"tag":30,"props":254,"children":255},{},[256],{"type":39,"value":257},"public class MyObjet\n{\n...\n@Autowired\nprivate MyComplexObjet myComplexObjet;\n...",{"type":29,"tag":30,"props":259,"children":260},{},[261],{"type":39,"value":262},"myComplexObjet est privé et n'a aucun setter, donc sans le runner Mockito vous ne pourriez pas l'injecter.",{"type":29,"tag":30,"props":264,"children":265},{},[266],{"type":39,"value":267},"Bon en fait, si comme nous allons le voir.",{"type":29,"tag":30,"props":269,"children":270},{},[271],{"type":39,"value":272},"D'ailleurs dans le cas suivant Mockito ne vous sera d'aucune aide et du coup nous allons quand même avoir recours à des ruses de sioux :",{"type":29,"tag":30,"props":274,"children":275},{},[276],{"type":39,"value":277},"public class MyObjet\n{\n@Value(\"${onekey}\")\nprivate String onekey;\n@Value(\"${anotherkey}\")\nprivate String anotherkey;\n...\n}",{"type":29,"tag":30,"props":279,"children":280},{},[281,283,288],{"type":39,"value":282},"Dans ce cas, vous pouvez utiliser Spring à la rescousse et ",{"type":29,"tag":176,"props":284,"children":285},{},[286],{"type":39,"value":287},"ReflectionTestUtils",{"type":39,"value":289}," :",{"type":29,"tag":30,"props":291,"children":292},{},[293],{"type":39,"value":294},"@Before\npublic void initialize ()\n{\nReflectionTestUtils.setField(myObject, \"onekey\", \"one\");\nReflectionTestUtils.setField(myObject, \"anotherkey\", \"two\");\n}",{"type":29,"tag":30,"props":296,"children":297},{},[298],{"type":39,"value":299},"C'est pas du Mockito mais ça valait le coup d'être cité.",{"type":29,"tag":72,"props":301,"children":303},{"id":302},"mocker-une-méthode-statique",[304],{"type":39,"value":305},"Mocker une méthode statique",{"type":29,"tag":30,"props":307,"children":308},{},[309,311,318],{"type":39,"value":310},"En fait Mockito n'est pas capable de mocker une méthode statique par lui même. Pour cela il va falloir appeler ",{"type":29,"tag":42,"props":312,"children":315},{"href":313,"rel":314},"http://code.google.com/p/powermock/",[46],[316],{"type":39,"value":317},"PowerMock",{"type":39,"value":319}," à la rescousse.",{"type":29,"tag":30,"props":321,"children":322},{},[323,325,330],{"type":39,"value":324},"Pour l'activer, vous allez désormais utiliser un autre runner : ",{"type":29,"tag":176,"props":326,"children":327},{},[328],{"type":39,"value":329},"PowerMockRunner",{"type":39,"value":60},{"type":29,"tag":30,"props":332,"children":333},{},[334],{"type":39,"value":335},"@RunWith(PowerMockRunner.class)\n@PrepareForTest({ Lookup.class })\n@PowerMockIgnore(\"org.apache.commons.logging.*\")\npublic class TestMyObject\n{\n...\n@Before\npublic void initialize() throws Exception\n{\n// Comme vous n'utilisez pas MockitoRunner, vous devez faire appel à initMocks pour initialiser vos mocks\nMockitoAnnotations.initMocks(this);\n...\n// o utilise PowerMockito pour mocker l'appel statique à Lookup.getInstance()\n// -------------------------------------------------------------------\nPowerMockito.mockStatic(Lookup.class);\nLookup lookup = mock(Lookup.class);\nwhen(Lookup.getInstance()).thenReturn(lookup);\n...\n}",{"type":29,"tag":30,"props":337,"children":338},{},[339],{"type":39,"value":340},"Explications de texte :",{"type":29,"tag":30,"props":342,"children":343},{},[344],{"type":39,"value":345},"Activation du runner :",{"type":29,"tag":30,"props":347,"children":348},{},[349],{"type":39,"value":350},"@RunWith(PowerMockRunner.class)",{"type":29,"tag":30,"props":352,"children":353},{},[354],{"type":39,"value":355},"Liste des objets dont on va faire un mock de méthode statiques :",{"type":29,"tag":30,"props":357,"children":358},{},[359],{"type":39,"value":360},"@PrepareForTest({ Lookup.class })",{"type":29,"tag":30,"props":362,"children":363},{},[364,366,371,373,378,380],{"type":39,"value":365},"La ligne suivante est nécessaire car on n'utilise plus le runner ",{"type":29,"tag":176,"props":367,"children":368},{},[369],{"type":39,"value":370},"MockitoJUnitRunner",{"type":39,"value":372}," mais que l'on souhaite quand même utiliser les annotations ",{"type":29,"tag":176,"props":374,"children":375},{},[376],{"type":39,"value":377},"Mocks",{"type":39,"value":379}," et ",{"type":29,"tag":176,"props":381,"children":382},{},[383],{"type":39,"value":384},"InjectMocks",{"type":29,"tag":30,"props":386,"children":387},{},[388],{"type":39,"value":389},"MockitoAnnotations.initMocks(this);",{"type":29,"tag":30,"props":391,"children":392},{},[393],{"type":39,"value":394},"et enfin, le mock de la méthode statique :",{"type":29,"tag":30,"props":396,"children":397},{},[398],{"type":39,"value":399},"PowerMockito.mockStatic(Lookup.class);\nLookup lookup = mock(Lookup.class);\nwhen(Lookup.getInstance()).thenReturn(lookup );",{"type":29,"tag":30,"props":401,"children":402},{},[403],{"type":39,"value":404},"Facile non ?",{"type":29,"tag":30,"props":406,"children":407},{},[408],{"type":39,"value":409},"Allez, une petite dernière pour la route. Et si mon objet doit implémenter deux interfaces ? Par exemple j'utilise Carbon pour l'injection de dépendance (ok on sent le projet legacy là) et du coup tout mes beans doivent aussi implémenter l'interface Component.",{"type":29,"tag":30,"props":411,"children":412},{},[413],{"type":39,"value":414},"Ouf, Mockito le gère depuis 2009 :",{"type":29,"tag":30,"props":416,"children":417},{},[418],{"type":39,"value":419},"mock(Lookup.class, withSettings().extraInterfaces(Component.class));",{"type":29,"tag":30,"props":421,"children":422},{},[423],{"type":39,"value":424},"Voila, vous en savez (peut-être) un peu plus sur Mockito, à vous de jouer maintenant !",{"title":7,"searchDepth":426,"depth":426,"links":427},2,[428,430,431,432,433,434,435],{"id":74,"depth":429,"text":77},3,{"id":93,"depth":429,"text":96},{"id":125,"depth":429,"text":128},{"id":166,"depth":429,"text":169},{"id":199,"depth":429,"text":202},{"id":237,"depth":429,"text":240},{"id":302,"depth":429,"text":305},"markdown","content:articles:2011:07:07:utiliser-mockito-et-powermock.md","content","articles/2011/07/07/utiliser-mockito-et-powermock.md","md",1700639707373]