{"_path":"/articles/2015/05/05/microservice-la-decouverte-automatique-de-services","_dir":"05","_draft":false,"_partial":false,"_locale":"","title":"Microservice : la découverte automatique de services","description":"Le dernier billet de ce blog entamait une mini-série sur les microservices qui espère traiter des sujets suivants :\n- comment gérer une fédération d’...","id":"1196","date":"2015-05-05","categories":["waza"],"tags":["backend","eureka","microservices","spring-cloud","zuul"],"img":"0f9d8-microservice.jpg","cover":"cover6.jpg","readingTime":{"text":"5 min read","minutes":4.16,"time":249600,"words":832},"body":{"type":"root","children":[{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Le dernier billet de ce blog entamait une mini-série sur les microservices qui espère traiter des sujets suivants :"}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"comment gérer une fédération d’identité (one login to rule them all)"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"gérer une configuration distribuée"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"a","props":{"href":"http://www.eventuallycoding.com/index.php/zuul/","rel":["nofollow"],"title":"Micro-services : routing avec Zuul"},"children":[{"type":"text","value":"le routage"}]}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"le load balancing"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"dispatcher des évènements sur plusieurs services"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"les jobs"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"la découverte de services"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"simplifier l’écriture des appels de services"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"a","props":{"href":"http://www.eventuallycoding.com/index.php/micro-services-la-composition-de-page-avec-zuul-et-sitemesh/","rel":["nofollow"],"title":"Micro-services : la composition de page avec Zuul et Sitemesh"},"children":[{"type":"text","value":"la composition de page"}]}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"la résistance aux pannes"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"le monitoring"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"le déploiement"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Le dernier billet s’attardait sur la composition de page. Pour ce billet, nous allons parler de \"service discovery\", la découverte de service pour les francophones."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Comme je l'évoquais dans le billet précédent, une architecture en micro services implique l'utilisation de plusieurs services qui apparaissent comme un seul service pour l'utilisateur final. Par exemple le visiteur sur Hopwork voit un seul domaine avec de multiples pages, la recherche, les annonces d'emploi, la page d'accueil qui sont en réalité plusieurs applications web sur le serveur :"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"a","props":{"href":"http://eventuallycoding.com/wp-content/uploads/2015/05/0f9d8-microservice.jpg","rel":["nofollow"]},"children":[{"type":"element","tag":"img","props":{"alt":"microservice","src":"/images/0f9d8-microservice.jpg"},"children":[]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Parmi les intérêts de ce type de solution, vous pouvez augmenter le nombre de services qui vont gérer la recherche et laisser les autres inchangé. Si tout avait été dans la même application, vous auriez du dupliquer l'ensemble de votre bloc applicatif alors qu'une grande partie ne le nécessite sans doute pas."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"a","props":{"href":"http://eventuallycoding.com/wp-content/uploads/2015/05/cbbe8-microservices.jpg","rel":["nofollow"]},"children":[{"type":"element","tag":"img","props":{"alt":"microservices","src":"/images/cbbe8-microservices.jpg"},"children":[]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"La problématique qui se pose alors, c'est de pouvoir ajouter un nouveau service de type \"search\", qu'il soit automatiquement découvert par le reste de l'applicatif et que les requêtes lui parviennent."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Si vous utilisiez nginx, vous pourriez déjà avoir un système de load balancing sur vos différents services de search "},{"type":"element","tag":"a","props":{"href":"http://nginx.org/en/docs/http/load_balancing.html","rel":["nofollow"]},"children":[{"type":"text","value":"préalablement configuré"}]},{"type":"text","value":". Ceci vous impose cependant de relancer nginx. Il existe malgré tout "},{"type":"element","tag":"a","props":{"href":"http://nginx.com/products/on-the-fly-reconfiguration/","rel":["nofollow"]},"children":[{"type":"text","value":"une solution de reconfiguration à chaud pour nginx PLUS"}]},{"type":"text","value":"."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Si vous avez aussi une configuration inter micro services, une solution à base de nginx vous pousserait également à placer un frontal nginx devant chaque grappe de service. Envisageable, mais sans doute un peu pénible. Et dans ce cas de figure, nginx devient un spof (single point of failure). Il vous faut alors envisager de mettre en place de "},{"type":"element","tag":"a","props":{"href":"http://nginx.com/blog/high-availability-clustering-with-nginx-plus/","rel":["nofollow"]},"children":[{"type":"text","value":"la haute disponibilité sur chaque frontal nginx"}]},{"type":"text","value":" pour chaque grappe de microservice."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Ca serait envisageable mais nous allons voir une autre approche, toujours avec les outils de netflix qui ont été intégrés dans Spring Cloud."}]},{"type":"element","tag":"h3","props":{"id":"eureka"},"children":[{"type":"text","value":"Eureka"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"a","props":{"href":"https://github.com/Netflix/eureka","rel":["nofollow"]},"children":[{"type":"text","value":"Eureka"}]},{"type":"text","value":" est un composant utilisé par Netflix en tant que, je cite, \"AWS Service registry for resilient mid-tier load balancing and failover\". Et en réalité ce n'est pas restreint à AWS."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"C'est donc un outil qui va permettre de réaliser de la découverte de service et que vous allez interroger pour avoir des informations sur les applications qui rendent un service donné."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"a","props":{"href":"http://eventuallycoding.com/wp-content/uploads/2015/05/ae328-eureka1.jpg","rel":["nofollow"]},"children":[{"type":"element","tag":"img","props":{"alt":"eureka","src":"/images/ae328-eureka1.jpg"},"children":[]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"La cinématique est donc la suivante :"}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"pour chaque service, inscription auprès d'Eureka en tant que fournisseur d'un service X"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"pour chaque consommateur de service :\n"},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"récupération au démarrage puis périodiquement de la liste des fournisseurs pour chaque service"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"appel direct vers un fournisseur"}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Pour bien clarifier, le consommateur de service n'appelle pas Eureka à chaque fois qu'il a besoin de réaliser un appel vers un fournisseur de service !"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"La liste des fournisseurs de service est mise à jour périodiquement à travers un \"heartbeat\" communiqué à l'ensemble des clients Eureka. Mais un client peut très bien tomber sur un fournisseur down à un instant T."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Mais c'est pas un SPOF tout ça ?"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Eh bien Eureka est lui-même un fournisseur de service et "},{"type":"element","tag":"a","props":{"href":"http://cloud.spring.io/spring-cloud-netflix/spring-cloud-netflix.html#_high_availability_zones_and_regions","rel":["nofollow"]},"children":[{"type":"text","value":"peut donc lui-même s'enregistrer auprès d'autres serveurs eureka"}]},{"type":"text","value":" pour former un cluster de serveur Eureka. C'est bien sûr la configuration recommandée pour tourner en production."}]},{"type":"element","tag":"h3","props":{"id":"mise-en-oeuvre"},"children":[{"type":"text","value":"Mise en oeuvre"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Avant de démarrer, vous pouvez retrouver l'ensemble des sources disponible ici : "},{"type":"element","tag":"a","props":{"href":"https://github.com/hlassiege/microservice-sandbox/tree/master/discovery","rel":["nofollow"]},"children":[{"type":"text","value":"https://github.com/hlassiege/microservice-sandbox/tree/master/discovery"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Sur ce repo github, nous avons 3 applications :"}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"le serveur Eureka"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"un fournisseur de service"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"un client du service fourni"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Pour le serveur Eureka, il ne s'agit que d'un main avec deux annotations spécifiques à Eureka :"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"@SpringBootApplication\n@EnableEurekaServer\n@EnableDiscoveryClient\npublic class EurekaServerApplication {\npublic static void main(String[] args) {\nSpringApplication.run(EurekaServerApplication.class, args);\n}\n}"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Pour le fournisseur de service, l'annotation devient :"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"@EnableEurekaClient"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Par contre il faut bien préciser l'url du serveur eureka et le nom du service proposé dans le fichier de configuration :"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"server.port: 8081"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"eureka:\ninstance:\nleaseRenewalIntervalInSeconds: 10\nclient:\nregistryFetchIntervalSeconds: 5\nserviceUrl:\ndefaultZone: "},{"type":"element","tag":"a","props":{"href":"http://localhost:8761/eureka/","rel":["nofollow"]},"children":[{"type":"text","value":"http://localhost:8761/eureka/"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"spring.application.name: service1"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Enfin le client du service qui est également un EurekaClient utilise la même annotation :"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"@EnableEurekaClient"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Et pour nous assurer que tout fonctionne, nous allons créer un endpoint pour afficher l'adresse d'un fournisseur de service déclaré dans le registre Eureka :"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"@Autowired\nprivate DiscoveryClient discoveryClient;"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"@RequestMapping(\"/\")\npublic String serviceUrl() {\nInstanceInfo instance = discoveryClient.getNextServerFromEureka(\"service1\", false);\nreturn instance.getHomePageUrl();\n}"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Une fois toutes les applications lancées, vous pouvez retrouver la page de Eureka sur "},{"type":"element","tag":"a","props":{"href":"http://localhost:8761","rel":["nofollow"]},"children":[{"type":"text","value":"http://localhost:8761"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"a","props":{"href":"http://eventuallycoding.com/wp-content/uploads/2015/05/8e85f-eurekaui.jpg","rel":["nofollow"]},"children":[{"type":"element","tag":"img","props":{"alt":"eurekaui","src":"/images/8e85f-eurekaui.jpg"},"children":[]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Vous noterez donc que 3 services sont enregistrés car le serveur et le client sont aussi des fournisseurs de services."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Et vous avez un nouvel endpoint "},{"type":"element","tag":"a","props":{"href":"http://localhost:8761/eureka/apps/","rel":["nofollow"]},"children":[{"type":"text","value":"http://localhost:8761/eureka/apps/"}]},{"type":"text","value":" qui vous donne la liste des services enregistrés ainsi que toutes les instances de fournisseur déclarés. Par exemple pour moi ici :"}]},{"type":"element","tag":"pre","props":{"code":"SERVICE1\n\n  hugo\\_pro\n  SERVICE1\n  192.168.50.1\n  UP\n  UNKNOWN\n  8081\n  443\n  1\n  \n    MyOwn\n  \n  \n    10\n    90\n    1430824522750\n    1430824522750\n    0\n    1430824492689\n  \n  \n  http://hugo\\_pro:8081/\n  http://hugo\\_pro:8081/info\n  http://hugo\\_pro:8081/health\n  service1\n  false\n  1430824522750\n  1430824522656\n  ADDED\n"},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"SERVICE1\n\n  hugo\\_pro\n  SERVICE1\n  192.168.50.1\n  UP\n  UNKNOWN\n  8081\n  443\n  1\n  \n    MyOwn\n  \n  \n    10\n    90\n    1430824522750\n    1430824522750\n    0\n    1430824492689\n  \n  \n  http://hugo\\_pro:8081/\n  http://hugo\\_pro:8081/info\n  http://hugo\\_pro:8081/health\n  service1\n  false\n  1430824522750\n  1430824522656\n  ADDED\n"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Voilà, nous avons fait une petite introduction à Eureka. Pour l'instant nous allons en rester là mais nous allons voir par la suite comment combiner Eureka et Zuul pour faire du loadbalancing. Puis nous verrons comment utiliser Eureka pour faire des appels Rest. C'est loin d'être fini :)"}]}],"toc":{"title":"","searchDepth":2,"depth":2,"links":[{"id":"eureka","depth":3,"text":"Eureka"},{"id":"mise-en-oeuvre","depth":3,"text":"Mise en oeuvre"}]}},"_type":"markdown","_id":"content:articles:2015:05:05:microservice-la-decouverte-automatique-de-services.md","_source":"content","_file":"articles/2015/05/05/microservice-la-decouverte-automatique-de-services.md","_extension":"md"}