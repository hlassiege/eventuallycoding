{"_path":"/articles/2013/08/16/fabric-moi-un-cluster","_dir":"16","_draft":false,"_partial":false,"_locale":"en","_empty":false,"title":"Fabric moi un cluster","description":"Je vous propose dans ce billet de prendre en main Fabric...","excerpt":{"type":"root","children":[{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"img","props":{"alt":"python","src":"/images/b9590-python.jpeg"},"children":[]},{"type":"text","value":"Je vous propose dans ce billet de prendre en main "},{"type":"element","tag":"a","props":{"href":"http://docs.fabfile.org/en/1.7/","rel":["nofollow"]},"children":[{"type":"text","value":"Fabric"}]},{"type":"text","value":", un outil que j’ai utilisé récemment et qui vous permettra de scripter des déploiements sur plusieurs machines assez simplement."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Pour résumer, Fabric est une lib Python qui vous permet d’automatiser des executions de commandes via ssh sur des serveurs distants."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"En sus, Fabric permet de créer une topologie de votre application : quels sont les machines “web”, les machines “bases de données” etc..."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Grâce à ces infos, Fabric permet ensuite exécuter des scripts par famille de nœud. Par exemple installer la dernière version de votre Webapp sur tous les nœuds “web”."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Peut-être que si vous connaissiez déjà "},{"type":"element","tag":"a","props":{"href":"http://rundeck.org/","rel":["nofollow"]},"children":[{"type":"text","value":"Rundeck"}]},{"type":"text","value":" tout ceci vous rappelle quelque chose puisqu’il répond a peu près à la même problématique."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Python Fabric est plus simple d’utilisation, vous ne retrouverez pas l’application Web qui permettait de gérer votre topologie et vous ne retrouverez pas les hooks qui permettaient de déclencher des actions. Mais vous allez voir qu’on y perd pas au change."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Pourquoi Fabric et pas simplement faire du script Shell ? Nous le verrons dans la suite du billet."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Et pour illustrer ce billet par un exemple de la vraie vie, vous trouverez à la fin de ce billet les sources pour installer un Cluster de 3 noeuds pour elasticsearch, MongoDB et Cassandra qui devraient fonctionner sous Debian."}]},{"type":"element","tag":"h2","props":{"id":"installation"},"children":[{"type":"text","value":"Installation"}]},{"type":"element","tag":"code","props":{"code":"pip install fabric\n"},"children":[{"type":"element","tag":"pre","props":{},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"pip install fabric\n"}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Oui, super complexe..."}]},{"type":"element","tag":"h2","props":{"id":"mon-premier-script"},"children":[{"type":"text","value":"Mon premier script"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"(issu de la doc)"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Dans un fichier nommé fabfile.py, écrire les lignes suivantes :"}]},{"type":"element","tag":"code","props":{"code":"from fabric.api import *\n\n@task\ndef host_type():\n    run('uname -s')\n","language":"python"},"children":[{"type":"element","tag":"pre","props":{},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"from fabric.api import *\n\n@task\ndef host_type():\n    run('uname -s')\n"}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Rien d’extraordinaire pour l’instant, nous allons juste executer cette commande sur des machines distantes."}]},{"type":"element","tag":"code","props":{"code":"$ fab -H localhost,linuxbox host_type\n[localhost] run: uname -s\n[localhost] out: Darwin\n[linuxbox] run: uname -s\n[linuxbox] out: Linux\nDone. \nDisconnecting from localhost... done. \nDisconnecting from linuxbox... done.\n"},"children":[{"type":"element","tag":"pre","props":{},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"$ fab -H localhost,linuxbox host_type\n[localhost] run: uname -s\n[localhost] out: Darwin\n[linuxbox] run: uname -s\n[linuxbox] out: Linux\nDone. \nDisconnecting from localhost... done. \nDisconnecting from linuxbox... done.\n"}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"La même chose avec un script shell :"}]},{"type":"element","tag":"code","props":{"code":"for machine in localhost linuxbox ; do ssh user@$machine \"uname -s\"; done\n"},"children":[{"type":"element","tag":"pre","props":{},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"for machine in localhost linuxbox ; do ssh user@$machine \"uname -s\"; done\n"}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Premier réflexe une fois qu’on connaît l’équivalent en shell, pourquoi pas du shell uniquement ? Voici mes raisons :"}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"je préfère coder en Python (la raison la plus subjective :))"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"je ne réinvente pas la roue, les appels ssh, le parallélisme, la gestion des erreurs, les familles de noeuds, tout est déjà codé"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Voyons cela en détail."}]},{"type":"element","tag":"h2","props":{"id":"le-parralélisme"},"children":[{"type":"text","value":"Le parralélisme"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Changeons désormais notre méthode pour la remplacer par"}]},{"type":"element","tag":"code","props":{"code":"@task\n@parallel\ndef host_type():\n    run(‘uname -s’)\n","language":"python"},"children":[{"type":"element","tag":"pre","props":{},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"@task\n@parallel\ndef host_type():\n    run(‘uname -s’)\n"}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Et lors de l’execution :"}]},{"type":"element","tag":"code","props":{"code":"$ fab -H localhost,linuxbox host_type\n[localhost] Executing task ‘host_type’\n[linuxbox] Executing task ‘host_type’\n[linuxbox] run: uname -s\n[localhost run: uname -s\n[linuxbox] out: Linux\n[linuxbox] out:\n[localhost] out: Darwin\n[localhost] out:\n"},"children":[{"type":"element","tag":"pre","props":{},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"$ fab -H localhost,linuxbox host_type\n[localhost] Executing task ‘host_type’\n[linuxbox] Executing task ‘host_type’\n[linuxbox] run: uname -s\n[localhost run: uname -s\n[linuxbox] out: Linux\n[linuxbox] out:\n[localhost] out: Darwin\n[localhost] out:\n"}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Comme son nom l’indique, notre décorateur nous a permis de lancer notre commande en parallèle sur les hôtes passés en paramètre."}]},{"type":"element","tag":"h2","props":{"id":"maintenir-une-topologie-de-nœuds"},"children":[{"type":"text","value":"Maintenir une topologie de nœuds"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Comme je le disais en intro Fabric permet de gérer des topologies applicatives."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Par exemple, nous allons définir 3 type de rôles :"}]},{"type":"element","tag":"code","props":{"code":"env.roledefs = {\n‘test’:  ['localhost' ],\n‘database’:  ['root@xx.xx.xx.10', 'root@xx.xx.xx.11', 'root@xx.xx.xx.12' ],\n‘web’:  ['root@xx.xx.xx.1', 'root@xx.xx.xx.2', 'root@xx.xx.xx.3' ]\n}\n"},"children":[{"type":"element","tag":"pre","props":{},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"env.roledefs = {\n‘test’:  ['localhost' ],\n‘database’:  ['root@xx.xx.xx.10', 'root@xx.xx.xx.11', 'root@xx.xx.xx.12' ],\n‘web’:  ['root@xx.xx.xx.1', 'root@xx.xx.xx.2', 'root@xx.xx.xx.3' ]\n}\n"}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Et nous allons définir une tâche pour installer java uniquement sur les machines Web :"}]},{"type":"element","tag":"code","props":{"code":"@task\n@parallel\n@roles(‘web’)\ndef java():\n    run(‘apt-get install openjdk-7-jdk –assume-yes’)\n","language":"python"},"children":[{"type":"element","tag":"pre","props":{},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"@task\n@parallel\n@roles(‘web’)\ndef java():\n    run(‘apt-get install openjdk-7-jdk –assume-yes’)\n"}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"En tapant cette commande : fab java"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Fabric va lancer l’install de Java uniquement sur les machines de type “web”"}]},{"type":"element","tag":"h2","props":{"id":"la-gestion-des-erreurs"},"children":[{"type":"text","value":"La gestion des erreurs"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"En réalité lorsque vous lancez une commande, il ne s’agit pas uniquement de lancer votre commande et basta. Vous espérez aussi que cela s’est bien passé. Fabric va vérifier cela pour vous en regardant le code retour de chaque opération. Exemple ici :"}]},{"type":"element","tag":"code","props":{"code":"@task\n@roles(‘web’)\n@parallel\ndef something _wrong():\n    run(‘rm /tmp/unknown _file’)\n","language":"python"},"children":[{"type":"element","tag":"pre","props":{},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"@task\n@roles(‘web’)\n@parallel\ndef something _wrong():\n    run(‘rm /tmp/unknown _file’)\n"}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Et l’execution"}]},{"type":"element","tag":"code","props":{"code":"$ fab something _wrong\n [root@linuxbox ] Executing task ‘something _wrong’\n [root@linuxbox ] run: rm /tmp/unknown _file\n [root@linuxbox ] out: rm: impossible de supprimer « /tmp/unknown _file »: Aucun fichier ou dossier de ce type\n [root@linuxbox ] out:\nFatal error: run() received nonzero return code 1 while executing!\nRequested: rm /tmp/unknown _file\nExecuted: /bin/bash -l -c « rm /tmp/unknown _file »\nAborting.\n\nFatal error: One or more hosts failed while executing task ‘something _wrong’\nAborting.\n"},"children":[{"type":"element","tag":"pre","props":{},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"$ fab something _wrong\n [root@linuxbox ] Executing task ‘something _wrong’\n [root@linuxbox ] run: rm /tmp/unknown _file\n [root@linuxbox ] out: rm: impossible de supprimer « /tmp/unknown _file »: Aucun fichier ou dossier de ce type\n [root@linuxbox ] out:\nFatal error: run() received nonzero return code 1 while executing!\nRequested: rm /tmp/unknown _file\nExecuted: /bin/bash -l -c « rm /tmp/unknown _file »\nAborting.\n\nFatal error: One or more hosts failed while executing task ‘something _wrong’\nAborting.\n"}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Evidemment parfois on s’attend à une erreur, par exemple sur la tâche suivante :"}]},{"type":"element","tag":"code","props":{"code":"@task\n@roles(‘database’)\n@parallel\ndef remove():\n    run(‘service mongodb stop’)\n    run(‘aptitude purge mongodb-10gen –assume-yes’)\n    run(‘rm -rf /var/lib/mongodb/ *’)\n","language":"python"},"children":[{"type":"element","tag":"pre","props":{},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"@task\n@roles(‘database’)\n@parallel\ndef remove():\n    run(‘service mongodb stop’)\n    run(‘aptitude purge mongodb-10gen –assume-yes’)\n    run(‘rm -rf /var/lib/mongodb/ *’)\n"}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Et si MongoDB n’est pas démarré ? C’est un cas normal et la désinstall doit tout de même se poursuivre."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Dans ce cas, on pourra ignorer l’erreur :"}]},{"type":"element","tag":"code","props":{"code":"@task\n@roles(‘database’)\n@parallel\ndef remove():\n    with settings(warn _only=True):\n        run(‘service mongodb stop’)\n    run(‘aptitude purge mongodb-10gen –assume-yes’)\n    run(‘rm -rf /var/lib/mongodb/ *’)\n","language":"python"},"children":[{"type":"element","tag":"pre","props":{},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"@task\n@roles(‘database’)\n@parallel\ndef remove():\n    with settings(warn _only=True):\n        run(‘service mongodb stop’)\n    run(‘aptitude purge mongodb-10gen –assume-yes’)\n    run(‘rm -rf /var/lib/mongodb/ *’)\n"}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Le décorateur @with_settings vous permettra d’ignorer les erreurs pour une tâche entière."}]},{"type":"element","tag":"h2","props":{"id":"la-manipulation-de-fichier"},"children":[{"type":"text","value":"La manipulation de fichier"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Plutôt fréquent dans une installation, vous devez modifier la configuration par défaut. Fabric vous propose plusieurs méthodes pour cela à base de sed."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"La première, la plus simple dont on va se servir pour configurer le nom du cluster elasticsearch :"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"sed('/etc/elasticsearch/elasticsearch.yml', '."},{"type":"element","tag":"em","props":{},"children":[{"type":"text","value":"cluster.name:."}]},{"type":"text","value":"', 'cluster.name: eventuallycoding')"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Parfois cependant on a une logique plus alambiqué : si jamais la ligne n’existe pas tu la rajoutes, sinon tu la modifies (par exemple pour rajouter un dépot apt)."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Fabric vous propose ceci :"}]},{"type":"element","tag":"code","props":{"code":"append('/etc/apt/sources.list.d/mongodb.list','deb http://downloads-distro.mongodb.org/repo/debian-sysvinit dist 10gen')\n"},"children":[{"type":"element","tag":"pre","props":{},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"append('/etc/apt/sources.list.d/mongodb.list','deb http://downloads-distro.mongodb.org/repo/debian-sysvinit dist 10gen')\n"}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"La ligne ne sera pas ajouté si elle existe déjà. Et surtout le fichier sera créé s’il n’existait pas."}]},{"type":"element","tag":"h2","props":{"id":"lordonnancement"},"children":[{"type":"text","value":"L’ordonnancement"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Il arrive régulièrement d’avoir une “super tâche” Fabric qui ordonnance une mise à jour sur l’ensemble des noeuds, par exemple Web et Database. Ce serait dommage de devoir scripter en shell les appels successifs aux tâches Fabric non ?"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Donc Fabric vous propose d’appeler des tâches à l’intérieur d’une tâche :"}]},{"type":"element","tag":"code","props":{"code":"@task\n@roles('database')\ndef migrate():\n    # Database stuff here.\n    pass\n\n@task\n@roles('web')\ndef update():\n    # Code updates here.\n    pass\n\n@task\ndef deploy():\n    execute(migrate)\n    execute(update)\n","language":"python"},"children":[{"type":"element","tag":"pre","props":{},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"@task\n@roles('database')\ndef migrate():\n    # Database stuff here.\n    pass\n\n@task\n@roles('web')\ndef update():\n    # Code updates here.\n    pass\n\n@task\ndef deploy():\n    execute(migrate)\n    execute(update)\n"}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"La tâche deploy va lancer successivement les tâches migrate et update sur les bons noeuds de votre application."}]},{"type":"element","tag":"h2","props":{"id":"la-modularisation"},"children":[{"type":"text","value":"La modularisation"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Pour bien faire les choses, nous allons modulariser nos instructions d’installation. Ici je vais vous présenter un cas concret, l’installation d’un cluster MongoDB, d’un cluster ElasticSearch et d’un cluster Cassandra."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Pas question évidemment d’avoir toutes les instructions dans un seul fichier fabfile. Nous allons donc créer : elasticsearch.py, mongodb.py, cassandra.py."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Dans notre fichier fabfile.py il nous suffira de faire :"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"import mongodb, elasticsearch, cassandra"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"afin d’avoir accès à l’ensemble des tâches présentes pour chaque module."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Et ensuite pour l’utilisateur, pour connaître la liste des tâches disponibles :"}]},{"type":"element","tag":"code","props":{"code":"$ fab -l\nAvailable commands:\n\ninstall\ncassandra.install\ncassandra.start\ncassandra.stop\ncassandra.uninstall\nelasticsearch.install\nelasticsearch.uninstall\nelasticsearch.start\nelasticsearch.stop\njava.java\nmongodb.install\nmongodb.uninstall\nmongodb.start\nmongodb.stop\n"},"children":[{"type":"element","tag":"pre","props":{},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"$ fab -l\nAvailable commands:\n\ninstall\ncassandra.install\ncassandra.start\ncassandra.stop\ncassandra.uninstall\nelasticsearch.install\nelasticsearch.uninstall\nelasticsearch.start\nelasticsearch.stop\njava.java\nmongodb.install\nmongodb.uninstall\nmongodb.start\nmongodb.stop\n"}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Et voilà. Comme tout outil de qualité qui se respecte, sa simplicité nous a permis d’en faire le tour rapidement."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"En bonus vous pouvez aller voir ce repository github qui contient des scripts fabric pour installer MongoDB, ElasticSearch et Cassandra en cluster, chose dont j’ai eu besoin récemment pour réaliser des benchs sur les 3 (peut être un futur billet) :"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"a","props":{"href":"https://github.com/hlassiege/fabric-sample","rel":["nofollow"]},"children":[{"type":"text","value":"https://github.com/hlassiege/fabric-sample"}]}]}]},"id":"904","date":"2013-08-16","categories":["waza"],"tags":["devops","fabric","python"],"img":"b9590-python.jpeg","cover":"cover2.jpg","readingTime":{"text":"6 min read","minutes":5.27,"time":316200,"words":1054},"body":{"type":"root","children":[{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"img","props":{"alt":"python","src":"/images/b9590-python.jpeg"},"children":[]},{"type":"text","value":"Je vous propose dans ce billet de prendre en main "},{"type":"element","tag":"a","props":{"href":"http://docs.fabfile.org/en/1.7/","rel":["nofollow"]},"children":[{"type":"text","value":"Fabric"}]},{"type":"text","value":", un outil que j’ai utilisé récemment et qui vous permettra de scripter des déploiements sur plusieurs machines assez simplement."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Pour résumer, Fabric est une lib Python qui vous permet d’automatiser des executions de commandes via ssh sur des serveurs distants."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"En sus, Fabric permet de créer une topologie de votre application : quels sont les machines “web”, les machines “bases de données” etc..."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Grâce à ces infos, Fabric permet ensuite exécuter des scripts par famille de nœud. Par exemple installer la dernière version de votre Webapp sur tous les nœuds “web”."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Peut-être que si vous connaissiez déjà "},{"type":"element","tag":"a","props":{"href":"http://rundeck.org/","rel":["nofollow"]},"children":[{"type":"text","value":"Rundeck"}]},{"type":"text","value":" tout ceci vous rappelle quelque chose puisqu’il répond a peu près à la même problématique."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Python Fabric est plus simple d’utilisation, vous ne retrouverez pas l’application Web qui permettait de gérer votre topologie et vous ne retrouverez pas les hooks qui permettaient de déclencher des actions. Mais vous allez voir qu’on y perd pas au change."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Pourquoi Fabric et pas simplement faire du script Shell ? Nous le verrons dans la suite du billet."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Et pour illustrer ce billet par un exemple de la vraie vie, vous trouverez à la fin de ce billet les sources pour installer un Cluster de 3 noeuds pour elasticsearch, MongoDB et Cassandra qui devraient fonctionner sous Debian."}]},{"type":"element","tag":"h2","props":{"id":"installation"},"children":[{"type":"text","value":"Installation"}]},{"type":"element","tag":"code","props":{"code":"pip install fabric\n"},"children":[{"type":"element","tag":"pre","props":{},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"pip install fabric\n"}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Oui, super complexe..."}]},{"type":"element","tag":"h2","props":{"id":"mon-premier-script"},"children":[{"type":"text","value":"Mon premier script"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"(issu de la doc)"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Dans un fichier nommé fabfile.py, écrire les lignes suivantes :"}]},{"type":"element","tag":"code","props":{"code":"from fabric.api import *\n\n@task\ndef host_type():\n    run('uname -s')\n","language":"python"},"children":[{"type":"element","tag":"pre","props":{},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"from fabric.api import *\n\n@task\ndef host_type():\n    run('uname -s')\n"}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Rien d’extraordinaire pour l’instant, nous allons juste executer cette commande sur des machines distantes."}]},{"type":"element","tag":"code","props":{"code":"$ fab -H localhost,linuxbox host_type\n[localhost] run: uname -s\n[localhost] out: Darwin\n[linuxbox] run: uname -s\n[linuxbox] out: Linux\nDone. \nDisconnecting from localhost... done. \nDisconnecting from linuxbox... done.\n"},"children":[{"type":"element","tag":"pre","props":{},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"$ fab -H localhost,linuxbox host_type\n[localhost] run: uname -s\n[localhost] out: Darwin\n[linuxbox] run: uname -s\n[linuxbox] out: Linux\nDone. \nDisconnecting from localhost... done. \nDisconnecting from linuxbox... done.\n"}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"La même chose avec un script shell :"}]},{"type":"element","tag":"code","props":{"code":"for machine in localhost linuxbox ; do ssh user@$machine \"uname -s\"; done\n"},"children":[{"type":"element","tag":"pre","props":{},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"for machine in localhost linuxbox ; do ssh user@$machine \"uname -s\"; done\n"}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Premier réflexe une fois qu’on connaît l’équivalent en shell, pourquoi pas du shell uniquement ? Voici mes raisons :"}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"je préfère coder en Python (la raison la plus subjective :))"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"je ne réinvente pas la roue, les appels ssh, le parallélisme, la gestion des erreurs, les familles de noeuds, tout est déjà codé"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Voyons cela en détail."}]},{"type":"element","tag":"h2","props":{"id":"le-parralélisme"},"children":[{"type":"text","value":"Le parralélisme"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Changeons désormais notre méthode pour la remplacer par"}]},{"type":"element","tag":"code","props":{"code":"@task\n@parallel\ndef host_type():\n    run(‘uname -s’)\n","language":"python"},"children":[{"type":"element","tag":"pre","props":{},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"@task\n@parallel\ndef host_type():\n    run(‘uname -s’)\n"}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Et lors de l’execution :"}]},{"type":"element","tag":"code","props":{"code":"$ fab -H localhost,linuxbox host_type\n[localhost] Executing task ‘host_type’\n[linuxbox] Executing task ‘host_type’\n[linuxbox] run: uname -s\n[localhost run: uname -s\n[linuxbox] out: Linux\n[linuxbox] out:\n[localhost] out: Darwin\n[localhost] out:\n"},"children":[{"type":"element","tag":"pre","props":{},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"$ fab -H localhost,linuxbox host_type\n[localhost] Executing task ‘host_type’\n[linuxbox] Executing task ‘host_type’\n[linuxbox] run: uname -s\n[localhost run: uname -s\n[linuxbox] out: Linux\n[linuxbox] out:\n[localhost] out: Darwin\n[localhost] out:\n"}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Comme son nom l’indique, notre décorateur nous a permis de lancer notre commande en parallèle sur les hôtes passés en paramètre."}]},{"type":"element","tag":"h2","props":{"id":"maintenir-une-topologie-de-nœuds"},"children":[{"type":"text","value":"Maintenir une topologie de nœuds"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Comme je le disais en intro Fabric permet de gérer des topologies applicatives."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Par exemple, nous allons définir 3 type de rôles :"}]},{"type":"element","tag":"code","props":{"code":"env.roledefs = {\n‘test’:  ['localhost' ],\n‘database’:  ['root@xx.xx.xx.10', 'root@xx.xx.xx.11', 'root@xx.xx.xx.12' ],\n‘web’:  ['root@xx.xx.xx.1', 'root@xx.xx.xx.2', 'root@xx.xx.xx.3' ]\n}\n"},"children":[{"type":"element","tag":"pre","props":{},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"env.roledefs = {\n‘test’:  ['localhost' ],\n‘database’:  ['root@xx.xx.xx.10', 'root@xx.xx.xx.11', 'root@xx.xx.xx.12' ],\n‘web’:  ['root@xx.xx.xx.1', 'root@xx.xx.xx.2', 'root@xx.xx.xx.3' ]\n}\n"}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Et nous allons définir une tâche pour installer java uniquement sur les machines Web :"}]},{"type":"element","tag":"code","props":{"code":"@task\n@parallel\n@roles(‘web’)\ndef java():\n    run(‘apt-get install openjdk-7-jdk –assume-yes’)\n","language":"python"},"children":[{"type":"element","tag":"pre","props":{},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"@task\n@parallel\n@roles(‘web’)\ndef java():\n    run(‘apt-get install openjdk-7-jdk –assume-yes’)\n"}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"En tapant cette commande : fab java"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Fabric va lancer l’install de Java uniquement sur les machines de type “web”"}]},{"type":"element","tag":"h2","props":{"id":"la-gestion-des-erreurs"},"children":[{"type":"text","value":"La gestion des erreurs"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"En réalité lorsque vous lancez une commande, il ne s’agit pas uniquement de lancer votre commande et basta. Vous espérez aussi que cela s’est bien passé. Fabric va vérifier cela pour vous en regardant le code retour de chaque opération. Exemple ici :"}]},{"type":"element","tag":"code","props":{"code":"@task\n@roles(‘web’)\n@parallel\ndef something _wrong():\n    run(‘rm /tmp/unknown _file’)\n","language":"python"},"children":[{"type":"element","tag":"pre","props":{},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"@task\n@roles(‘web’)\n@parallel\ndef something _wrong():\n    run(‘rm /tmp/unknown _file’)\n"}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Et l’execution"}]},{"type":"element","tag":"code","props":{"code":"$ fab something _wrong\n [root@linuxbox ] Executing task ‘something _wrong’\n [root@linuxbox ] run: rm /tmp/unknown _file\n [root@linuxbox ] out: rm: impossible de supprimer « /tmp/unknown _file »: Aucun fichier ou dossier de ce type\n [root@linuxbox ] out:\nFatal error: run() received nonzero return code 1 while executing!\nRequested: rm /tmp/unknown _file\nExecuted: /bin/bash -l -c « rm /tmp/unknown _file »\nAborting.\n\nFatal error: One or more hosts failed while executing task ‘something _wrong’\nAborting.\n"},"children":[{"type":"element","tag":"pre","props":{},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"$ fab something _wrong\n [root@linuxbox ] Executing task ‘something _wrong’\n [root@linuxbox ] run: rm /tmp/unknown _file\n [root@linuxbox ] out: rm: impossible de supprimer « /tmp/unknown _file »: Aucun fichier ou dossier de ce type\n [root@linuxbox ] out:\nFatal error: run() received nonzero return code 1 while executing!\nRequested: rm /tmp/unknown _file\nExecuted: /bin/bash -l -c « rm /tmp/unknown _file »\nAborting.\n\nFatal error: One or more hosts failed while executing task ‘something _wrong’\nAborting.\n"}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Evidemment parfois on s’attend à une erreur, par exemple sur la tâche suivante :"}]},{"type":"element","tag":"code","props":{"code":"@task\n@roles(‘database’)\n@parallel\ndef remove():\n    run(‘service mongodb stop’)\n    run(‘aptitude purge mongodb-10gen –assume-yes’)\n    run(‘rm -rf /var/lib/mongodb/ *’)\n","language":"python"},"children":[{"type":"element","tag":"pre","props":{},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"@task\n@roles(‘database’)\n@parallel\ndef remove():\n    run(‘service mongodb stop’)\n    run(‘aptitude purge mongodb-10gen –assume-yes’)\n    run(‘rm -rf /var/lib/mongodb/ *’)\n"}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Et si MongoDB n’est pas démarré ? C’est un cas normal et la désinstall doit tout de même se poursuivre."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Dans ce cas, on pourra ignorer l’erreur :"}]},{"type":"element","tag":"code","props":{"code":"@task\n@roles(‘database’)\n@parallel\ndef remove():\n    with settings(warn _only=True):\n        run(‘service mongodb stop’)\n    run(‘aptitude purge mongodb-10gen –assume-yes’)\n    run(‘rm -rf /var/lib/mongodb/ *’)\n","language":"python"},"children":[{"type":"element","tag":"pre","props":{},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"@task\n@roles(‘database’)\n@parallel\ndef remove():\n    with settings(warn _only=True):\n        run(‘service mongodb stop’)\n    run(‘aptitude purge mongodb-10gen –assume-yes’)\n    run(‘rm -rf /var/lib/mongodb/ *’)\n"}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Le décorateur @with_settings vous permettra d’ignorer les erreurs pour une tâche entière."}]},{"type":"element","tag":"h2","props":{"id":"la-manipulation-de-fichier"},"children":[{"type":"text","value":"La manipulation de fichier"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Plutôt fréquent dans une installation, vous devez modifier la configuration par défaut. Fabric vous propose plusieurs méthodes pour cela à base de sed."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"La première, la plus simple dont on va se servir pour configurer le nom du cluster elasticsearch :"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"sed('/etc/elasticsearch/elasticsearch.yml', '."},{"type":"element","tag":"em","props":{},"children":[{"type":"text","value":"cluster.name:."}]},{"type":"text","value":"', 'cluster.name: eventuallycoding')"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Parfois cependant on a une logique plus alambiqué : si jamais la ligne n’existe pas tu la rajoutes, sinon tu la modifies (par exemple pour rajouter un dépot apt)."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Fabric vous propose ceci :"}]},{"type":"element","tag":"code","props":{"code":"append('/etc/apt/sources.list.d/mongodb.list','deb http://downloads-distro.mongodb.org/repo/debian-sysvinit dist 10gen')\n"},"children":[{"type":"element","tag":"pre","props":{},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"append('/etc/apt/sources.list.d/mongodb.list','deb http://downloads-distro.mongodb.org/repo/debian-sysvinit dist 10gen')\n"}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"La ligne ne sera pas ajouté si elle existe déjà. Et surtout le fichier sera créé s’il n’existait pas."}]},{"type":"element","tag":"h2","props":{"id":"lordonnancement"},"children":[{"type":"text","value":"L’ordonnancement"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Il arrive régulièrement d’avoir une “super tâche” Fabric qui ordonnance une mise à jour sur l’ensemble des noeuds, par exemple Web et Database. Ce serait dommage de devoir scripter en shell les appels successifs aux tâches Fabric non ?"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Donc Fabric vous propose d’appeler des tâches à l’intérieur d’une tâche :"}]},{"type":"element","tag":"code","props":{"code":"@task\n@roles('database')\ndef migrate():\n    # Database stuff here.\n    pass\n\n@task\n@roles('web')\ndef update():\n    # Code updates here.\n    pass\n\n@task\ndef deploy():\n    execute(migrate)\n    execute(update)\n","language":"python"},"children":[{"type":"element","tag":"pre","props":{},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"@task\n@roles('database')\ndef migrate():\n    # Database stuff here.\n    pass\n\n@task\n@roles('web')\ndef update():\n    # Code updates here.\n    pass\n\n@task\ndef deploy():\n    execute(migrate)\n    execute(update)\n"}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"La tâche deploy va lancer successivement les tâches migrate et update sur les bons noeuds de votre application."}]},{"type":"element","tag":"h2","props":{"id":"la-modularisation"},"children":[{"type":"text","value":"La modularisation"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Pour bien faire les choses, nous allons modulariser nos instructions d’installation. Ici je vais vous présenter un cas concret, l’installation d’un cluster MongoDB, d’un cluster ElasticSearch et d’un cluster Cassandra."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Pas question évidemment d’avoir toutes les instructions dans un seul fichier fabfile. Nous allons donc créer : elasticsearch.py, mongodb.py, cassandra.py."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Dans notre fichier fabfile.py il nous suffira de faire :"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"import mongodb, elasticsearch, cassandra"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"afin d’avoir accès à l’ensemble des tâches présentes pour chaque module."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Et ensuite pour l’utilisateur, pour connaître la liste des tâches disponibles :"}]},{"type":"element","tag":"code","props":{"code":"$ fab -l\nAvailable commands:\n\ninstall\ncassandra.install\ncassandra.start\ncassandra.stop\ncassandra.uninstall\nelasticsearch.install\nelasticsearch.uninstall\nelasticsearch.start\nelasticsearch.stop\njava.java\nmongodb.install\nmongodb.uninstall\nmongodb.start\nmongodb.stop\n"},"children":[{"type":"element","tag":"pre","props":{},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"$ fab -l\nAvailable commands:\n\ninstall\ncassandra.install\ncassandra.start\ncassandra.stop\ncassandra.uninstall\nelasticsearch.install\nelasticsearch.uninstall\nelasticsearch.start\nelasticsearch.stop\njava.java\nmongodb.install\nmongodb.uninstall\nmongodb.start\nmongodb.stop\n"}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Et voilà. Comme tout outil de qualité qui se respecte, sa simplicité nous a permis d’en faire le tour rapidement."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"En bonus vous pouvez aller voir ce repository github qui contient des scripts fabric pour installer MongoDB, ElasticSearch et Cassandra en cluster, chose dont j’ai eu besoin récemment pour réaliser des benchs sur les 3 (peut être un futur billet) :"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"a","props":{"href":"https://github.com/hlassiege/fabric-sample","rel":["nofollow"]},"children":[{"type":"text","value":"https://github.com/hlassiege/fabric-sample"}]}]}],"toc":{"title":"","searchDepth":2,"depth":2,"links":[{"id":"installation","depth":2,"text":"Installation"},{"id":"mon-premier-script","depth":2,"text":"Mon premier script"},{"id":"le-parralélisme","depth":2,"text":"Le parralélisme"},{"id":"maintenir-une-topologie-de-nœuds","depth":2,"text":"Maintenir une topologie de nœuds"},{"id":"la-gestion-des-erreurs","depth":2,"text":"La gestion des erreurs"},{"id":"la-manipulation-de-fichier","depth":2,"text":"La manipulation de fichier"},{"id":"lordonnancement","depth":2,"text":"L’ordonnancement"},{"id":"la-modularisation","depth":2,"text":"La modularisation"}]}},"_type":"markdown","_id":"content:articles:2013:08:16:fabric-moi-un-cluster.md","_source":"content","_file":"articles/2013/08/16/fabric-moi-un-cluster.md","_extension":"md"}