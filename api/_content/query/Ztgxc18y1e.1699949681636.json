{"_path":"/articles/2010/11/28/bonnes-pratique-de-codage-en-c-2","_dir":"28","_draft":false,"_partial":false,"_locale":"","title":"Bonnes pratique de codage en C#","description":"Dans la lignée d'un [billet précédent](http://localhost/localweb/wordpress/?p=144 \"Introduction aux tests unitaires et aux bouchons en C#\") qui consti...","id":"145","date":"2010-11-28","categories":["waza"],"tags":["csharp","testunitaire"],"img":"linkext7.gif","cover":"cover3.jpg","readingTime":{"text":"10 min read","minutes":9.51,"time":570600,"words":1902},"body":{"type":"root","children":[{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Dans la lignée d'un "},{"type":"element","tag":"a","props":{"href":"http://localhost/localweb/wordpress/?p=144","rel":["nofollow"],"title":"Introduction aux tests unitaires et aux bouchons en C#"},"children":[{"type":"text","value":"billet précédent"}]},{"type":"text","value":" qui constituait une introduction aux tests unitaires en C#, voici un autre billet orienté \"bonnes pratiques de codage\" toujours en C#."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Mais loin d'être cantonné au C#, les principes données dans ce billet sont facilement transposables dans d'autres langages. Après tout, il ne s'agit que de \"bonnes pratiques\"."}]},{"type":"element","tag":"h1","props":{"id":"les-principes-généraux"},"children":[{"type":"text","value":"Les principes généraux"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Les deux principes généraux pour une bonne testabilité :"}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"l'isolabilité"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"la simplicité"}]}]},{"type":"element","tag":"blockquote","props":{},"children":[{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"La perfection est atteinte non pas quand il n’y a plus rien à ajouter, mais quand il n’y a plus rien à retirer !"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Symptômes d'un code intestable :"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Symptômes d'un code testable :"}]},{"type":"element","tag":"h1","props":{"id":"constructeur-couteux"},"children":[{"type":"text","value":"Constructeur couteux"}]},{"type":"element","tag":"h2","props":{"id":"problématique"},"children":[{"type":"text","value":"Problématique"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Exemple de constructeur couteux :"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"public Dictionnaire ()\n{\nStreamReader monStreamReader = new StreamReader(\"francais.txt\");\nstring ligne = monStreamReader.ReadLine();"}]},{"type":"element","tag":"pre","props":{"code":"while (ligne != null)\n{\n    string\\[\\] words = ligne.Split(':');\n    definitions.Put(words \\[0\\],words \\[1\\]);\n    ligne = monStreamReader.ReadLine();\n}\nmonStreamReader.Close();\n"},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"while (ligne != null)\n{\n    string\\[\\] words = ligne.Split(':');\n    definitions.Put(words \\[0\\],words \\[1\\]);\n    ligne = monStreamReader.ReadLine();\n}\nmonStreamReader.Close();\n"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"}"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Problèmes :"}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"potentiellement couteux"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"dépendant d'une ressource externe (le fichier francais.txt)"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"création d'objet (présence de new)"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"l'initialisation peut échouer"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"=> "},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"Le test n'est pas isolé, il peut durer longtemps et son comportement ne peut pas être différent entre deux tests"}]}]},{"type":"element","tag":"h2","props":{"id":"solutions"},"children":[{"type":"text","value":"Solutions"}]},{"type":"element","tag":"h3","props":{"id":"méthodes-init-optionnelle"},"children":[{"type":"text","value":"méthodes init optionnelle"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"public Dictionnaire ()\n{\n}"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"private void Init ()\n{\nStreamReader monStreamReader = new StreamReader(\"francais.txt\");\nstring ligne = monStreamReader.ReadLine();"}]},{"type":"element","tag":"pre","props":{"code":"while (ligne != null)\n{\n    string\\[\\] words = ligne.Split(':');\n    definitions.Put(words \\[0\\],words \\[1\\]);\n    ligne = monStreamReader.ReadLine();\n}\nmonStreamReader.Close();\n"},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"while (ligne != null)\n{\n    string\\[\\] words = ligne.Split(':');\n    definitions.Put(words \\[0\\],words \\[1\\]);\n    ligne = monStreamReader.ReadLine();\n}\nmonStreamReader.Close();\n"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"}"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"=> pour du code existant, le risque c'est que les appelants n'appellent pas cette méthode"}]},{"type":"element","tag":"h3","props":{"id":"méthode-init-surchargeable"},"children":[{"type":"text","value":"méthode init surchargeable"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"protected void Init ()\n{\nStreamReader monStreamReader = new StreamReader(\"francais.txt\");\nstring ligne = monStreamReader.ReadLine();"}]},{"type":"element","tag":"pre","props":{"code":"while (ligne != null)\n{\n    string\\[\\] words = ligne.Split(':');\n    definitions.Put(words \\[0\\],words \\[1\\]);\n    ligne = monStreamReader.ReadLine();\n}\nmonStreamReader.Close();\n"},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"while (ligne != null)\n{\n    string\\[\\] words = ligne.Split(':');\n    definitions.Put(words \\[0\\],words \\[1\\]);\n    ligne = monStreamReader.ReadLine();\n}\nmonStreamReader.Close();\n"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"}"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"=> la méthode étant protected, on peut créer un objet DictionnaireTestable qui redéfinit la méthode Init"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"public class DictionnaireTestable ()\n{\nprotected void Init ()\n{\n// Do nothing\n}\n}"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"=> Obligé de créer une classe pour les tests"}]},{"type":"element","tag":"h3","props":{"id":"constructeur-différent-pour-les-tests"},"children":[{"type":"text","value":"constructeur différent pour les tests"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"public Dictionnaire (boolean ForTest)\n{\n// Do nothing\n}"}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"risque de confusion avec le constructeur existant"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"paramétre supplémentaire non utilisé"}]}]},{"type":"element","tag":"h3","props":{"id":"solution-optimale"},"children":[{"type":"text","value":"Solution optimale"}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"objets liés passés en paramètre"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"public Dictionnaire ()\n{\n// ancien code\n...\n}"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"public Dictionnaire (Dictionary definitions )\n{\nthis.definitions = definitions;\n}"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Les définitions sont initialisées dans une factory."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"public class DictionnaireFactory\n{\npublic static Dictionnaire buildFromTextFile ()\n{\nDictionary definitions = new Dictionnary();\nStreamReader monStreamReader = new StreamReader(\"francais.txt\");\nstring ligne = monStreamReader.ReadLine();"}]},{"type":"element","tag":"pre","props":{"code":"    while (ligne != null)\n    {\n        string\\[\\] words = ligne.Split(':');\n        definitions.Put(words \\[0\\],words \\[1\\]);\n        ligne = monStreamReader.ReadLine();\n    }\n    monStreamReader.Close();\n\n    return new Dictionnaire (definitions);\n}\n"},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"    while (ligne != null)\n    {\n        string\\[\\] words = ligne.Split(':');\n        definitions.Put(words \\[0\\],words \\[1\\]);\n        ligne = monStreamReader.ReadLine();\n    }\n    monStreamReader.Close();\n\n    return new Dictionnaire (definitions);\n}\n"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"}"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Ainsi, un test peut utiliser le constructeur avec un dictionnary par défaut. La lecture du fichier a été délocalisé hors de la classe."}]},{"type":"element","tag":"h3","props":{"id":"attention-à-lencapsulation"},"children":[{"type":"text","value":"Attention à l'encapsulation"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"La technique ci-dessus a cependant un risque important si on l'applique naivement, celui de briser l'encapsulation."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Exemple :"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"public class Car\n{\npublic Car (Engine engine);\n...\n}"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"En exposant les collaborateurs je donne des indications sur la façon dont fonctionne mon objet. Ici ma voiture est une voiture à moteur."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Si au final l'appelant doit instancier tout les objets nécessaires à ma voiture : le moteur, le frein, la boite de vitesse, je brise l'encapsulation et je rends l'utilisation de l'objet très difficile."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"D'où l'intérêt de manipuler des interfaces et d'utiliser des Factory."}]},{"type":"element","tag":"h1","props":{"id":"les-instanciations-directes"},"children":[{"type":"text","value":"Les instanciations directes"}]},{"type":"element","tag":"h2","props":{"id":"problématique-1"},"children":[{"type":"text","value":"Problématique"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Les instanciations (via l'opérateur new) comme dans l'exemple suivant peuvent être gênant pour les tests :"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Dictionnaire dico = new Dictionnaire ();\n..."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Ici on créé un couplage fort avec l'implémentation du dictionnaire."},{"type":"element","tag":"br","props":{},"children":[]},{"type":"text","value":"\nSi celui-ci établit une connexion à la base de données, le code devient intestable."}]},{"type":"element","tag":"h2","props":{"id":"solution"},"children":[{"type":"text","value":"Solution"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Plusieurs approches sont possibles, elles sont toutes basées sur l'utilisation d'une interface qui va définir le contrat du dictionnaire."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"public interface IDictionnaire\n{\n...\n}"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Le code appelant utilisera désormais l'interface qui ne déclare que son comportement métier."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"On pourra ensuite utiliser :"}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"une Factory"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"l'injection de dépendances via un framework spécialisé (Spring.Net, GenericFacade etc...)"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"// Ici la factory nous permet de rajouter un découplage entre celui qui utilise et l'implémentation.\nIDictionnaire dico = DictionnaireFactory.BuildDictionnaire ();\n..."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"ou avec Spring.Net"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"ApplicationContext ctx = ContextRegistry.GetContext();\nIDictionnaire dico= (IDictionnaire ) ctx.GetObject (\"MyDictionnaire\");"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"L'intérêt des Frameworks, entre autre, par rapport à une factory classique, c'est de pouvoir configurer l'implémentation renvoyé selon le contexte."}]},{"type":"element","tag":"h1","props":{"id":"les-blocs-statiques"},"children":[{"type":"text","value":"Les blocs statiques"}]},{"type":"element","tag":"h2","props":{"id":"problématique-2"},"children":[{"type":"text","value":"Problématique"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"L'utilisation de bloc statique est impossible en C# donc ce paragraphe n'est pas applicable."},{"type":"element","tag":"br","props":{},"children":[]},{"type":"text","value":"\nCependant en C# on peut avoir des constructeurs statiques."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"class SimpleClass\n{\n// Static constructor\nstatic SimpleClass()\n{\n//...\n}\n}"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Le défaut des constructeurs statiques étant qu'ils créent un état permanent. Tester une classe avec état peut être très difficile a cause des effets de bord :"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"class SimpleClass\n{\nprivate static int compteur;"}]},{"type":"element","tag":"pre","props":{"code":"// Static constructor\nstatic SimpleClass()\n{\n    compteur = 0;\n}\n\npublic static int AddValueToCompteur (int value)\n{\n    compteur +=value;\n    return compteur;\n}\n"},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"// Static constructor\nstatic SimpleClass()\n{\n    compteur = 0;\n}\n\npublic static int AddValueToCompteur (int value)\n{\n    compteur +=value;\n    return compteur;\n}\n"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"}"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Les tests suivants échoueront aléatoirement => l'ordre des tests n'est pas garanti par les frameworks de tests. "},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"On ne doit pas se reposer sur l'ordre d'écriture des tests pour présumer du résultat"}]},{"type":"text","value":"."}]},{"type":"element","tag":"pre","props":{"code":"\\[Test\\]\npublic void TestAddNegativeValue()\n{\n    Assert.AreEquals(-2, SimpleClass.AddValueToCompteur(-2));\n\n}\n\\[Test\\]\npublic void TestAddPositiveValue()\n{\n    Assert.AreEquals(0, SimpleClass.AddValueToCompteur(2));\n}\n"},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"\\[Test\\]\npublic void TestAddNegativeValue()\n{\n    Assert.AreEquals(-2, SimpleClass.AddValueToCompteur(-2));\n\n}\n\\[Test\\]\npublic void TestAddPositiveValue()\n{\n    Assert.AreEquals(0, SimpleClass.AddValueToCompteur(2));\n}\n"}]}]},{"type":"element","tag":"h2","props":{"id":"suppression-des-constructeurs-statiques"},"children":[{"type":"text","value":"Suppression des constructeurs statiques"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"class SimpleClass\n{\nprivate int compteur;"}]},{"type":"element","tag":"pre","props":{"code":"public SimpleClass()\n{\n    compteur = 0;\n}\n\npublic int AddValueToCompteur (int value)\n{\n    compteur +=value;\n    return compteur;\n}\n"},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"public SimpleClass()\n{\n    compteur = 0;\n}\n\npublic int AddValueToCompteur (int value)\n{\n    compteur +=value;\n    return compteur;\n}\n"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"}"}]},{"type":"element","tag":"h1","props":{"id":"dynastie-de-classes"},"children":[{"type":"text","value":"Dynastie de classes"}]},{"type":"element","tag":"h2","props":{"id":"introduction"},"children":[{"type":"text","value":"Introduction"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"L'utilisation de l'héritage n'est pas toujours idéale :"}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"duplication de code"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"fragilité du modèle"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"non réutilisabilité"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"En fait, bien souvent : "},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"Il faut privilégier la composition à l'héritage"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Nous n'allons pas redémontrer ce point ici, mais si vous voulez plus de sources à ce sujet :"}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"a","props":{"href":"http://berniesumption.com/software/inheritance-is-evil-and-must-be-destroyed/","rel":["nofollow"]},"children":[{"type":"text","value":"Inhéritance is evil and must be destroyed"},{"type":"element","tag":"img","props":{"alt":"","src":"/images/linkext7.gif"},"children":[]}]}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"a","props":{"href":"http://www.siteduzero.com/tutoriel-3-65563-les-limites-de-l-heritage-le-pattern-strategy.html","rel":["nofollow"]},"children":[{"type":"text","value":"Les limites de l'héritage (le pattern strategy)"},{"type":"element","tag":"img","props":{"alt":"","src":"/images/linkext7.gif"},"children":[]}]}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"a","props":{"href":"http://blogs.developpeur.org/tja/archive/2009/06/28/design-patterns-privil-giez-la-composition-l-h-ritage-strat-gie.aspx","rel":["nofollow"]},"children":[{"type":"text","value":"Le design pattern Stratégy en .Net"},{"type":"element","tag":"img","props":{"alt":"","src":"/images/linkext7.gif"},"children":[]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"En fait, selon le principe de Liskov :"}]},{"type":"element","tag":"blockquote","props":{},"children":[{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"\"une relation d'héritage est bien employée s'il est possible de substituer n'importe quel instance d'une super-classe, par n'importe quel instance d'une de ses sous-classes, sans que la sémantique d'un programme écrit dans les termes de la super-classe n'en soit affectée.\""}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"(Cf. "},{"type":"element","tag":"a","props":{"href":"http://fr.wikipedia.org/wiki/Principe_de_substitution_de_Liskov","rel":["nofollow"]},"children":[{"type":"text","value":"Le principe de Liskov, à la base de la conception par contrat"},{"type":"element","tag":"img","props":{"alt":"","src":"/images/linkext7.gif"},"children":[]}]},{"type":"text","value":")"}]},{"type":"element","tag":"h2","props":{"id":"exemple"},"children":[{"type":"text","value":"Exemple"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Ci-dessous un hiérarchie de classe :"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Un compte peut être spécialisé en compte courant ou compte epargne. Un compte hérite des méthodes liées aux objets sécurisées et sauvegardable."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Outre les problèmes inhérents à cette modélisation :"}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"duplication de code au niveau des comptes (sans doute des override pour redéfinir des comportements)"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"réutilisation des comptes en dehors du contexte de notre modèle de données impossible"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"fragilité du modèle (rajouter des types de comptes, spécialiser la sécurité par type d'objet ou la sauvegarde, tout cela est dangereux pour ce modèle legacy)"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"scalabilité faible (que va-t-il se passer avec 32 types de comptes différents)"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"Il se pose aussi des problèmes de testabilité !"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Exemple :"}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Pour tester un compte, je dois configurer une connexion à la base de données car EntiteSauvegardable s'initialise à partir d'une connexion"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"La sécurisation nécessite l'accès à une ressource Active Directory"},{"type":"element","tag":"br","props":{},"children":[]},{"type":"text","value":"\netc..."}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"En instanciant un objet Compte, je suis fortement couplé avec les objets dont il hérite."}]}]},{"type":"element","tag":"h2","props":{"id":"solution-1"},"children":[{"type":"text","value":"Solution"}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"le design pattern strategy (voir article plus haut)"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"la composition (un compte n'est pas une entité sécurisé mais "},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"utilise"}]},{"type":"text","value":" une entité sécurisé)"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"la séparation des responsabilités (séparation DAO (accès aux données), entités (objets simples), services (comportement métier)"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Toutes ces solutions reposent sur la programmation par contrat (l'utilisation d'interface pour définir le contrat d'un objet) et peuvent s'appuyer sur l'injection de dépendances pour injecter les implémentations correspondantes au comportement voulu."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"Et surtout, c'est testable !"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"public class Compte\n{\nprivate string titulaire;\nprivate float amount;\nprivate ISecureEntity;\n....\n}"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"En injectant un bouchon pour ISecureEntity, mon Compte est testable en isolation."}]},{"type":"element","tag":"table","props":{},"children":[{"type":"element","tag":"colgroup","props":{},"children":[{"type":"element","tag":"col","props":{"width":24},"children":[]},{"type":"text","value":" "},{"type":"element","tag":"col","props":{},"children":[]},{"type":"text","value":" "}]},{"type":"element","tag":"tbody","props":{},"children":[{"type":"element","tag":"tr","props":{},"children":[{"type":"element","tag":"td","props":{"vAlign":"top"},"children":[{"type":"element","tag":"img","props":{"src":"/images/information.gif","alt":"","width":16,"height":16,"align":"absmiddle","border":0},"children":[]}]},{"type":"element","tag":"td","props":{},"children":[{"type":"text","value":"L'exemple ci-dessus bénéficierait sans doute encore plus d'une véritable séparation des responsabilités. Le compte ne devrait pas être responsable de la façon dont il est sauvé, ou sécurisé."}]}]}]}]},{"type":"element","tag":"h1","props":{"id":"des-états-globaux"},"children":[{"type":"text","value":"Des états globaux"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Un état global est en général contenu par une variable globale :"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"public static string maValeur ;"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Les différents problèmes que posent les variables globales :"}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"La variable globale persiste d'un test à l'autre et créé de la confusion"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Un test peut fonctionner seul mais pas quand il est joué avec les autres"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Les tests peuvent échouer ensemble mais marcher individuellement"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"L'ordre des tests influe sur le résultat"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"L'exemple plus haut avec un compteur dans un bloc statique illustre bien ces problèmes."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"class SimpleClass\n{\nprivate static int compteur = 0 ;"}]},{"type":"element","tag":"pre","props":{"code":"public static int AddValueToCompteur (int value)\n{\ncompteur +=value;\nreturn compteur;\n}\n"},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"public static int AddValueToCompteur (int value)\n{\ncompteur +=value;\nreturn compteur;\n}\n"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"}"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Les tests suivants échoueront aléatoirement => l'ordre des tests n'est pas garanti par les frameworks de tests. "},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"On ne doit pas se reposer sur l'ordre d'écriture des tests pour présumer du résultat"}]},{"type":"text","value":"."}]},{"type":"element","tag":"pre","props":{"code":"\\[Test\\]\npublic void TestAddNegativeValue()\n{\n    Assert.AreEquals(-2, SimpleClass.AddValueToCompteur(-2));\n}\n\\[Test\\]\npublic void TestAddPositiveValue()\n{\n    Assert.AreEquals(0, SimpleClass.AddValueToCompteur(2));\n}\n"},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"\\[Test\\]\npublic void TestAddNegativeValue()\n{\n    Assert.AreEquals(-2, SimpleClass.AddValueToCompteur(-2));\n}\n\\[Test\\]\npublic void TestAddPositiveValue()\n{\n    Assert.AreEquals(0, SimpleClass.AddValueToCompteur(2));\n}\n"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Il existe un pattern pour remplacer cette variable globale : le singleton ("},{"type":"element","tag":"em","props":{},"children":[{"type":"text","value":"mais injecté !"}]},{"type":"text","value":")"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"public class Compteur\n{\nprivate int myCompteur ;\npublic int MyCompteur\n{\nget {return myCompteur} ;\nset {myCompteur = value}\n}"}]},{"type":"element","tag":"pre","props":{"code":"public int AddValueToCompteur (int value)\n{\n    myCompteur += value\n    return myCompteur;\n}\n"},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"public int AddValueToCompteur (int value)\n{\n    myCompteur += value\n    return myCompteur;\n}\n"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"}"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Vous avez encapsulé le comportement de votre compteur dans un objet compteur, lui-même pourra être injecté dans les classes qui l'utilisent."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Ainsi, dans un contexte de production vous utiliserez un singleton et garantirez donc que votre état reste global à l'application."},{"type":"element","tag":"br","props":{},"children":[]},{"type":"text","value":"\nSi par exemple vous utilisez spring.Net, vous utiliserez des singletons :"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Et dans un contexte de production, vous pourrez injecter une nouvelle instance de compteur pour chaque test."}]},{"type":"element","tag":"h1","props":{"id":"annuaire-de-service"},"children":[{"type":"text","value":"Annuaire de service"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Si l'utilisation d'annuaire est récurrente, son usage doit être bien contrôlé pour favoriser une bonne testabilité."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Prenons les exemples suivant :"}]},{"type":"element","tag":"pre","props":{"code":"XmlApplicationContext context = new XmlApplicationContext(\"assembly://MySolution/Namespace/spring.xml\");\nMySuperObject configuration = (MySuperObject )context.GetObject(\"MySuperObject\");\n\nMySuperObject.DoSomething();\n\n....\n\nMyService service = Locator.findService (\"Service\");\nservice.DoSomething();\n\n....\n\npublic MonObjet (Context context)\n{\n    MyProperty1 = context.getProperty1();\n    MyProperty2 = context.getProperty2();\n    MyProperty3 = context.getProperty3();\n}\n"},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"XmlApplicationContext context = new XmlApplicationContext(\"assembly://MySolution/Namespace/spring.xml\");\nMySuperObject configuration = (MySuperObject )context.GetObject(\"MySuperObject\");\n\nMySuperObject.DoSomething();\n\n....\n\nMyService service = Locator.findService (\"Service\");\nservice.DoSomething();\n\n....\n\npublic MonObjet (Context context)\n{\n    MyProperty1 = context.getProperty1();\n    MyProperty2 = context.getProperty2();\n    MyProperty3 = context.getProperty3();\n}\n"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Ces bouts de code ont un impact sur la testabilité :"}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"méthodes statiques (voir plus haut)"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"liaison avec l'implémentation du XmlApplicationContext basé sur un fichier xml dans le premier exemple"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"dépendances cachées entre objet"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Solution"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"De façon générale, l'injection de dépendance permet d'éviter l'utilisation des annuaires."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Cependant si l'utilisation d'un annuaire est nécessaire, l'injection de l'annuaire est préférable à l'instanciation directe."},{"type":"element","tag":"br","props":{},"children":[]},{"type":"text","value":"\nDans le premier exemple, se faire injecter un IApplicationContext permet d'être indépendant de l'implémentation et donc de fournir à l'annuaire nos propres services."}]},{"type":"element","tag":"h1","props":{"id":"trop-dintermédiaire"},"children":[{"type":"text","value":"Trop d'intermédiaire"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Exemple :"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"public void facturer (Commande commande, Client client)\n{\nbanqueService.prelever (client.getCompteBancaire(),commande.getTotal());\nemailService.notifierPrelevement(client.getEmail());\n}"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Les défauts :"}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"manque de lisibilité, la facturation nécessite bien plus que Commande et Client"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"initialisation du test complexe"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"couplage avec les objets intermédiaires"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"La solution :"}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"appliquer le principe de "},{"type":"element","tag":"a","props":{"href":"http://fr.wikipedia.org/wiki/Loi_de_D%C3%A9m%C3%A9ter","rel":["nofollow"]},"children":[{"type":"text","value":"Demeter"},{"type":"element","tag":"img","props":{"alt":"","src":"/images/linkext7.gif"},"children":[]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Exemple de test avant :"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Commande commande = new Commande();commande.setTotal(20.0);"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Client client = new Client();\nCompte compte = new Compte();\nclient.setCompte  (compte);"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"string email= \""},{"type":"element","tag":"a","props":{"href":"mailto:toto@free.fr"},"children":[{"type":"text","value":"toto@free.fr"}]},{"type":"text","value":"\";\nclient.setEmail(email);"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"manager.facturer (commande,client);"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Après :"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Compte compte = new Compte();\nstring email= \""},{"type":"element","tag":"a","props":{"href":"mailto:toto@free.fr"},"children":[{"type":"text","value":"toto@free.fr"}]},{"type":"text","value":"\";\ndouble total = 20.0;"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"manager.facturer (compte,total,email);"}]},{"type":"element","tag":"h1","props":{"id":"méthodes-trop-chargées"},"children":[{"type":"text","value":"Méthodes trop chargées"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Une méthode est trop chargé :"}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"s'il y a trop de if else, for, while imbriqué"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"s'il y a beaucoup de conditions"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"=> on utilise souvent l'indicateur de complexité cyclomatique pour le mesurer."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Comment faire baisser la complexité :"}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"déléguer dans d'autres méthodes"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"extraire d'autres classes et déléguer"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"utiliser le polymorphisme"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"retourner des objets vides plutot que null"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"donner des valeurs par défaut (pour éviter les else)"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Quel est le rapport avec la testabilité ?"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Plus il y a de routes différentes (les valeurs aux limites, les valeurs null), plus le test sera complexe à écrire."}]},{"type":"element","tag":"h2","props":{"id":"exemple1"},"children":[{"type":"text","value":"Exemple1"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"public boolean laisserPasser (Personne personne)\n{\nif (personne.getAge() > 12 && personne.getTaille() > 1.3 && personne.EstEnBonneSante())\n{\nif ((personne.getAge() < 18 && personne.EstAccompagne()) || personne.getAge()>=18)\n{\nfacturer(personne);\nreturn true;\n}\n}\nreturn false;\n}"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Exemple avec découpage des méthodes :"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"public boolean laisserPasser (Personne personne)\n{\nif (EstPhysiquementCompatibleJeuxIntense(personne))\n{\nif (EstLegalementCompatibleJeuxIntense(personne))\n{\nfacturer(personne);\nreturn true;\n}\n}\nreturn false;\n}"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Exemple avec délégation dans d'autres classes :"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"private PersonneChecker personneChecker;"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"public boolean laisserPasser (Personne personne)\n{\nif (personneChecker.PhysiqueMinimum(personne) && personneChecker.EstMajeur(personne))\n{\nfacturer(personne);\nreturn true;\n}\nreturn false;\n}"}]},{"type":"element","tag":"h2","props":{"id":"exemple-2"},"children":[{"type":"text","value":"Exemple 2"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"public void TraiterListeCommande()\n{\nList commandes = RecupererCommandes();"}]},{"type":"element","tag":"pre","props":{"code":"if (commandes != null)\n{\n    foreach (Commande commande in commandes)\n    {\n        // do something\n    }\n}\n"},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"if (commandes != null)\n{\n    foreach (Commande commande in commandes)\n    {\n        // do something\n    }\n}\n"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"}"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"si le Dao est fait de facon à toujours renvoyer une liste, même vide (c'est ce que fait NHibernate par exemple)"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"public void TraiterListeCommande()\n{\nList commandes = RecupererCommandes();"}]},{"type":"element","tag":"pre","props":{"code":"foreach (Commande commande in commandes)\n{\n    // do something\n}\n"},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"foreach (Commande commande in commandes)\n{\n    // do something\n}\n"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"}"}]},{"type":"element","tag":"h1","props":{"id":"conclusion"},"children":[{"type":"text","value":"Conclusion"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Comme vu ci-dessus, la testabilité va souvent de pair avec une bonne conception objet."},{"type":"element","tag":"br","props":{},"children":[]},{"type":"text","value":"\nUne bonne conception permet une bonne modularité et une grande souplesse, tout ce qui est nécessaire à la testabilité."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"C'est d'ailleurs parce que la testabilité impose une programmation plus rigoureuse que certaines méthodes de développement impose d'écrire les tests en premiers (Voir "},{"type":"element","tag":"a","props":{"href":"http://fr.wikipedia.org/wiki/Test_Driven_Development","rel":["nofollow"]},"children":[{"type":"text","value":"TDD"},{"type":"element","tag":"img","props":{"alt":"","src":"/images/linkext7.gif"},"children":[]}]},{"type":"text","value":")"}]},{"type":"element","tag":"table","props":{"width":36},"children":[{"type":"element","tag":"tbody","props":{},"children":[{"type":"element","tag":"tr","props":{},"children":[{"type":"element","tag":"td","props":{"vAlign":"top"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"td","props":{},"children":[{"type":"text","value":" "}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Sur un code ancien n'ayant pas été conçu pour être testable, l'application des solutions ci-dessus permet de rendre progressivement testable le logiciel."}]},{"type":"element","tag":"h1","props":{"id":"sources"},"children":[{"type":"text","value":"Sources"}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"a","props":{"href":"http://blog.o2sources.com/2009/03/23/celui-qui-voulait-ecrire-du-code-testable.html","rel":["nofollow"]},"children":[{"type":"text","value":"http://blog.o2sources.com/2009/03/23/celui-qui-voulait-ecrire-du-code-testable.html"},{"type":"element","tag":"img","props":{"alt":"","src":"/images/linkext7.gif"},"children":[]}]}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"a","props":{"href":"http://misko.hevery.com/code-reviewers-guide/","rel":["nofollow"]},"children":[{"type":"text","value":"http://misko.hevery.com/code-reviewers-guide/"},{"type":"element","tag":"img","props":{"alt":"","src":"/images/linkext7.gif"},"children":[]}]}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"a","props":{"href":"http://googletesting.blogspot.com/2008/08/by-miko-hevery-so-you-decided-to.html","rel":["nofollow"]},"children":[{"type":"text","value":"http://googletesting.blogspot.com/2008/08/by-miko-hevery-so-you-decided-to.html"},{"type":"element","tag":"img","props":{"alt":"","src":"/images/linkext7.gif"},"children":[]}]}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"a","props":{"href":"http://www.slideshare.net/foucha/comment-crire-du-code-testable","rel":["nofollow"]},"children":[{"type":"text","value":"http://www.slideshare.net/foucha/comment-crire-du-code-testable"},{"type":"element","tag":"img","props":{"alt":"","src":"/images/linkext7.gif"},"children":[]}]}]}]}],"toc":{"title":"","searchDepth":2,"depth":2,"links":[{"id":"problématique","depth":2,"text":"Problématique"},{"id":"solutions","depth":2,"text":"Solutions","children":[{"id":"méthodes-init-optionnelle","depth":3,"text":"méthodes init optionnelle"},{"id":"méthode-init-surchargeable","depth":3,"text":"méthode init surchargeable"},{"id":"constructeur-différent-pour-les-tests","depth":3,"text":"constructeur différent pour les tests"},{"id":"solution-optimale","depth":3,"text":"Solution optimale"},{"id":"attention-à-lencapsulation","depth":3,"text":"Attention à l'encapsulation"}]},{"id":"problématique-1","depth":2,"text":"Problématique"},{"id":"solution","depth":2,"text":"Solution"},{"id":"problématique-2","depth":2,"text":"Problématique"},{"id":"suppression-des-constructeurs-statiques","depth":2,"text":"Suppression des constructeurs statiques"},{"id":"introduction","depth":2,"text":"Introduction"},{"id":"exemple","depth":2,"text":"Exemple"},{"id":"solution-1","depth":2,"text":"Solution"},{"id":"exemple1","depth":2,"text":"Exemple1"},{"id":"exemple-2","depth":2,"text":"Exemple 2"}]}},"_type":"markdown","_id":"content:articles:2010:11:28:bonnes-pratique-de-codage-en-c-2.md","_source":"content","_file":"articles/2010/11/28/bonnes-pratique-de-codage-en-c-2.md","_extension":"md"}