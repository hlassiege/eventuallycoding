<!DOCTYPE html>
<html lang="fr">
<head><meta charset="utf-8">
<title>Introduction aux tests unitaires et aux bouchons en C# | EventuallyCoding</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="https://digianalytics.fr/js/script.js" data-host="https://digianalytics.fr" id="ZwSg9rf6GA" async="" defer="" type="text/javascript"></script>
<meta name="description" content="Par définition (Cf. [Wikipédia](http://fr.wikipedia.org/wiki/Test_unitaire) ) un test unitaire est un procédé permettant de s'assurer du fonctionnemen...">
<meta name="og:description" content="Par définition (Cf. [Wikipédia](http://fr.wikipedia.org/wiki/Test_unitaire) ) un test unitaire est un procédé permettant de s'assurer du fonctionnemen...">
<meta name="og:type" content="article">
<meta name="og:title" content="Introduction aux tests unitaires et aux bouchons en C#">
<meta name="og:url" content="https://eventuallycoding.com/2010/11/28/introduction-aux-tests-unitaires-et-aux-bouchons-en-c-2">
<meta name="og:image" content="https://eventuallycoding.com/images/covers/cover5.jpg">
<meta name="og:image:alt" content="Introduction aux tests unitaires et aux bouchons en C#">
<meta name="twitter:text:title" content="Introduction aux tests unitaires et aux bouchons en C#">
<meta name="twitter:image" content="https://eventuallycoding.com/images/covers/cover5.jpg">
<meta name="twitter:card" content="summary">
<meta name="article:published_time" content="2010-11-28T00:00:00.000Z">
<meta name="article:article:modified_time" content="2010-11-28T00:00:00.000Z">
<meta name="article:article:tag" content="csharp,testunitaire">
<link rel="canonical" href="https://eventuallycoding.com/2010/11/28/introduction-aux-tests-unitaires-et-aux-bouchons-en-c-2">
<link rel="alternate" href="https://eventuallycoding.com/2010/11/28/introduction-aux-tests-unitaires-et-aux-bouchons-en-c-2" hreflang="fr"><link rel="modulepreload" href="/2010/11/28/introduction-aux-tests-unitaires-et-aux-bouchons-en-c-2/_payload.js"><link rel="modulepreload" as="script" crossorigin href="/_nuxt/entry.57db4985.js"><link rel="preload" as="style" href="/_nuxt/entry.874fac0a.css"><link rel="modulepreload" as="script" crossorigin href="/_nuxt/default.285d1574.js"><link rel="preload" as="style" href="/_nuxt/TheHeader.e21518f4.css"><link rel="modulepreload" as="script" crossorigin href="/_nuxt/nuxt-link.743ad1fd.js"><link rel="modulepreload" as="script" crossorigin href="/_nuxt/siteMetaData.b74feb44.js"><link rel="modulepreload" as="script" crossorigin href="/_nuxt/_id_.75770b07.js"><link rel="modulepreload" as="script" crossorigin href="/_nuxt/Dropdown.a930c6c4.js"><link rel="modulepreload" as="script" crossorigin href="/_nuxt/_commonjsHelpers.28e086c5.js"><link rel="modulepreload" as="script" crossorigin href="/_nuxt/ContentRenderer.c10275bd.js"><link rel="modulepreload" as="script" crossorigin href="/_nuxt/ContentRendererMarkdown.672d9d78.js"><link rel="modulepreload" as="script" crossorigin href="/_nuxt/index.a6ef77ff.js"><link rel="modulepreload" as="script" crossorigin href="/_nuxt/query.6b89fc18.js"><link rel="modulepreload" as="script" crossorigin href="/_nuxt/index.61d74bb5.js"><link rel="modulepreload" as="script" crossorigin href="/_nuxt/utils.46020ec7.js"><link rel="modulepreload" as="script" crossorigin href="/_nuxt/composables.368ff18d.js"><link rel="modulepreload" as="script" crossorigin href="/_nuxt/ProseP.c97a0062.js"><link rel="modulepreload" as="script" crossorigin href="/_nuxt/ProseA.c10a5829.js"><link rel="modulepreload" as="script" crossorigin href="/_nuxt/ProseStrong.3e82dd1e.js"><link rel="modulepreload" as="script" crossorigin href="/_nuxt/ProseH2.0653e762.js"><link rel="modulepreload" as="script" crossorigin href="/_nuxt/ProseEm.9e0a0fe1.js"><link rel="modulepreload" as="script" crossorigin href="/_nuxt/ProseCode.38d2ebe8.js"><link rel="modulepreload" as="script" crossorigin href="/_nuxt/ProseUl.00d948c2.js"><link rel="modulepreload" as="script" crossorigin href="/_nuxt/ProseLi.d16b62bb.js"><link rel="modulepreload" as="script" crossorigin href="/_nuxt/ProseH3.b000bcbd.js"><link rel="modulepreload" as="script" crossorigin href="/_nuxt/ProseH1.1729e458.js"><link rel="prefetch" as="script" crossorigin href="/_nuxt/error-component.f01931c4.js"><link rel="prefetch" as="image" type="image/svg+xml" href="/_nuxt/github_new.4e3fe23c.svg"><link rel="prefetch" as="image" type="image/svg+xml" href="/_nuxt/rss.9e0b880c.svg"><link rel="prefetch" as="image" type="image/svg+xml" href="/_nuxt/mastodon.f0ecdde8.svg"><link rel="prefetch" as="image" type="image/svg+xml" href="/_nuxt/linkeding.34c3bc6d.svg"><link rel="prefetch" as="image" type="image/svg+xml" href="/_nuxt/twitter.457cff27.svg"><link rel="stylesheet" href="/_nuxt/entry.874fac0a.css"><link rel="stylesheet" href="/_nuxt/TheHeader.e21518f4.css"><style>.inverted[data-v-a060ef80]{--tw-bg-opacity:1;background-color:rgb(248 250 252/var(--tw-bg-opacity))}.inverted .font-to-invert-to-pink[data-v-a060ef80]{color:rgb(236 72 153/var(--tw-text-opacity))}.inverted .font-to-invert-to-black[data-v-a060ef80],.inverted .font-to-invert-to-pink[data-v-a060ef80]{--tw-text-opacity:1;transition-duration:.15s;transition-property:all;transition-timing-function:cubic-bezier(.4,0,.2,1)}.inverted .font-to-invert-to-black[data-v-a060ef80]{color:rgb(51 65 85/var(--tw-text-opacity))}.inverted .font-to-invert-to-black[data-v-a060ef80]:hover{--tw-text-opacity:1;color:rgb(255 255 255/var(--tw-text-opacity))}.link[data-v-a060ef80]{display:block;font-size:1rem;font-weight:500;line-height:1.5rem;overflow:hidden;padding-left:.75rem;padding-right:.75rem;position:relative;text-decoration:none}.link.NuxtLink-exact-active[data-v-a060ef80]:after{bottom:-2px;height:100%;left:0;width:100%}.link[data-v-a060ef80]:after{background:rgba(236,64,122,.25);bottom:-6px;content:"";height:calc(100% - 8px);left:18px;position:absolute;transition:.35s cubic-bezier(.25,.1,0,2.05);width:calc(100% - 8px);z-index:-1}.link[data-v-a060ef80]:hover:after{bottom:-2px;height:100%;left:0;width:100%}</style><style>.nuxt-content h2{font-size:28px;font-weight:700}.nuxt-content h3{font-size:22px;font-weight:700}.nuxt-content p{margin-bottom:20px}</style><style>pre code .line{display:block;min-height:1rem}</style></head>
<body ><div id="__nuxt"><!--[--><section class="w-full pb-12 antialiased"><div class="mx-auto max-w-8xl"><div data-v-a060ef80><nav id="header-menu" class="transition-colors fixed w-full z-10 top-0 inverted" data-v-a060ef80><div class="max-w-7xl mx-auto px-2 sm:px-6 lg:px-8" data-v-a060ef80><div class="relative flex items-center justify-between h-16" data-v-a060ef80><div class="absolute inset-y-0 left-0 flex items-center sm:hidden" data-v-a060ef80><button type="button" class="inline-flex items-center justify-center p-2 rounded-md text-gray-400 hover:text-white hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-inset focus:ring-white" aria-controls="mobile-menu" aria-expanded="false" data-v-a060ef80><span class="sr-only" data-v-a060ef80>Open main menu</span><svg class="block h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" aria-hidden="true" data-v-a060ef80><path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 12h16M4 18h16" data-v-a060ef80></path></svg><svg class="hidden h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" aria-hidden="true" data-v-a060ef80><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" data-v-a060ef80></path></svg></button></div><div class="flex-1 flex items-center justify-center sm:items-stretch sm:justify-start" data-v-a060ef80><div class="flex-shrink-0 flex items-center" data-v-a060ef80><span class="text-white text-base font-medium font-bruno text-2xl font-to-invert-to-pink" data-v-a060ef80><a href="/" class="" data-v-a060ef80>EventuallyCoding.com</a></span></div><div class="hidden sm:block sm:ml-6 absolute right-0 font-mark" data-v-a060ef80><div class="flex space-x-4" data-v-a060ef80><!--[--><a href="/speaking" class="link text-white font-to-invert-to-black" data-v-a060ef80>Speaking</a><a href="/blog" class="link text-white font-to-invert-to-black" data-v-a060ef80>Writing</a><a href="/resources" class="link text-white font-to-invert-to-black" data-v-a060ef80>Resources</a><a href="/about" class="link text-white font-to-invert-to-black" data-v-a060ef80>About</a><!--]--></div></div></div></div></div><div class="hidden" data-v-a060ef80><div class="px-2 pt-2 pb-3 space-y-1" data-v-a060ef80><!--[--><a href="/speaking" class="text-white hover:bg-gray-700 hover:text-white block px-3 py-2 rounded-md text-base font-medium font-to-invert-to-black" data-v-a060ef80>Speaking</a><a href="/blog" class="text-white hover:bg-gray-700 hover:text-white block px-3 py-2 rounded-md text-base font-medium font-to-invert-to-black" data-v-a060ef80>Writing</a><a href="/resources" class="text-white hover:bg-gray-700 hover:text-white block px-3 py-2 rounded-md text-base font-medium font-to-invert-to-black" data-v-a060ef80>Resources</a><a href="/about" class="text-white hover:bg-gray-700 hover:text-white block px-3 py-2 rounded-md text-base font-medium font-to-invert-to-black" data-v-a060ef80>About</a><!--]--></div></div></nav></div><!--[--><!--[--><div><div class="flex justify-center mt-24"><img src="/images/covers/cover5.jpg" alt="Introduction aux tests unitaires et aux bouchons en C#" class="object-cover w-96"></div><div class="px-4 mx-auto sm:px-6 xl:max-w-7xl xl:px-0 mt-10"><div><h1 class="text-4xl text-gray-700 font-extrabold text-center mb-3">Introduction aux tests unitaires et aux bouchons en C#</h1><p class="text-slate-400 text-center mb-1"><!----></p><div class="grid grid-cols-3 text-center sm:w-full md:w-1/2 mx-auto"><div><p class="text-center font-bold my-4 text-slate-400 text-xs"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 inline-block" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg> November 28, 2010</p></div><div><p class="text-center font-bold my-4 text-slate-400 text-xs"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 inline-block" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg> 8 min read</p></div><div class="flex items-center font-medium sm:mx-3 justify-center"><img src="/hugo-nb.jpg" loading="lazy" alt="" class="mr-3 w-10 h-10 rounded-full bg-slate-50 dark:bg-slate-800"><div><div class="font-bold text-slate-400 text-xs">Hugo Lassiège</div><a target="_blank" href="https://twitter.com/hugolassiege" class="font-bold text-sky-400 text-xs hover:text-sky-600"> @hugolassiege</a></div></div></div></div><div class="text-left mx-auto"><div class="flex flex-wrap lg:flex-row-reverse py-12"><div class="w-full lg:w-1/4 px-5"><div class="lg:sticky top-0 pt-5 -mt-5 font-proxima"><div class="toc hidden lg:block"><p class="border-b-4 pb-3 mb-3 border-gray-200 text-xl"> On this page </p><ul class="pl-0"><!--[--><li class="py-1"><a class="hover:text-smalt-blue-700" href="#écriture-dun-premier-test">Écriture d&#39;un premier test</a></li><li class="py-1"><a class="hover:text-smalt-blue-700" href="#différentes-assertions">Différentes assertions</a></li><li class="py-1"><a class="hover:text-smalt-blue-700" href="#setupteardown">Setup/TearDown</a></li><li class="py-1"><a class="hover:text-smalt-blue-700" href="#la-couverture-de-code">La couverture de code</a></li><li class="py-1"><a class="hover:text-smalt-blue-700" href="#test-paramétré">Test paramétré</a></li><li class="py-1"><a class="hover:text-smalt-blue-700" href="#le-bouchonnage">Le bouchonnage</a></li><li class="py-1"><a class="hover:text-smalt-blue-700" href="#mocks-pour-tester-létat-des-objets">Mocks pour tester l&#39;état des objets</a></li><li class="py-1"><a class="hover:text-smalt-blue-700" href="#préciser-le-comportement-du-mock">Préciser le comportement du mock</a></li><li class="py-1"><a class="hover:text-smalt-blue-700" href="#mock-pour-tester-le-comportement-des-objets">Mock pour tester le comportement des objets</a></li><!--]--></ul></div><div class="text-right mb-12"><div class="relative inline-block text-left ml-2 block lg:hidden"><div><span class="rounded-md shadow-sm"><button type="button" class="inline-flex justify-center w-full rounded-md border border-gray-300 px-4 py-2 bg-white text-sm leading-5 font-medium text-black hover:text-white hover:bg-smalt-blue-500 focus:outline-none transition ease-in-out duration-150" aria-haspopup="true" aria-expanded="true"><!--[-->On this page<!--]--><svg class="-mr-1 ml-2 h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"></path></svg></button></span></div><!----></div></div></div></div><div class="lg:w-3/4 w-full px-5 max-w-none centered-image"><div id="nuxtContent" class="prose font-proxima text-sm md:text-xl font-medium min-w-full md:p-10 mx-auto"><p><!--[-->Par définition (Cf. <a href="http://fr.wikipedia.org/wiki/Test_unitaire" rel="nofollow"><!--[-->Wikipédia<!--]--></a> ) un test unitaire est un procédé permettant de s&#39;assurer du fonctionnement correct d&#39;une partie déterminée d&#39;un logiciel ou d&#39;une portion d&#39;un programme (appelée « unité » ou « module »).<!--]--></p><p><!--[-->Un test est dit <strong><!--[-->unitaire<!--]--></strong> s&#39;il ne fait pas appel à d&#39;autres ressources que la classe testé. Un test unitaire n&#39;utilise donc pas de base de données, de socket, MQ series etc... à l&#39;inverse d&#39;un test d&#39;intégration.<!--]--></p><p><!--[-->Un test d&#39;<strong><!--[-->intégration<!--]--></strong> est donc par extension un test qui peut utiliser des ressources externes : bases de données par exemple.<!--]--></p><p><!--[-->Voyons ce que ça donne en C#.<!--]--></p><h2 id="écriture-dun-premier-test"><a href="#écriture-dun-premier-test"><!--[-->Écriture d&#39;un premier test<!--]--></a></h2><p><!--[-->Par convention, une classe de test correspond généralement aux tests d&#39;une classe de votre code.<!--]--></p><p><!--[--><strong><!--[-->Exemple<!--]--></strong> :<!--]--></p><p><!--[-->votre classe : <em><!--[-->EmailAdressValidator<!--]--></em><!--]--></p><p><!--[-->Exemple :<!--]--></p><p><!--[-->public class  EmailAddressValidator
{
private DomainValidator domainValidator;<!--]--></p><!--[--><pre><code>public EmailAddressValidator()
{
    DomainValidator domainValidator = new DomainValidator();
}

public bool CheckEmailAddressSyntax(string emailAddress)
{
    if(emailAddress == null )
    {
        throw new NullReferenceException();
    }
        return Regex.IsMatch(emailAddress, @&quot;^\[w.-\]+@\[a-zA-Z0-9-\]+(.\[a-zA-Z0-9-\]{1,})\*(.\[a-zA-Z\]{2,3}){1,2}$&quot;);
}
    ...
public bool CheckDomainExists(string domain)
{
        return  domainValidator.Exists(domain);
}
...
</code></pre><!--]--><p><!--[-->}<!--]--></p><p><!--[-->la classe de test : <em><!--[-->EmailAdressValidatorTest<!--]--></em><!--]--></p><p><!--[-->Une classe de test comporte un stéréotype TestFixture, les méthodes de test ont un stéréotype Test.<!--]--></p><p><!--[-->Exemple :<!--]--></p><p><!--[-->[TestFixture]
public class EmailValidatorTest
{
EmailAddressValidator EAV;<!--]--></p><!--[--><pre><code>\[SetUp\]
public void SetUp()
{
    EAV = new EmailAddressValidator ();
}

\[TearDown\]
public void TearDown()
{
    EVA.Clean();
}
</code></pre><!--]--><p><!--[-->[Test]
public void TestEmailSyntaxArobas()
{
Assert.IsTrue(EAV.CheckEmailAddressSyntax (&quot;<a href="mailto:Nom@entreprise.com" rel="noopener noreferrer"><!--[-->Nom@entreprise.com<!--]--></a>&quot;));
Assert.IsFalse(EAV.CheckEmailAddressSyntax (&quot;Nom@@entreprise.com&quot;));
Assert.IsFalse(EAV.CheckEmailAddressSyntax (&quot;Nomentreprise.com&quot;));
Assert.IsFalse(EAV.CheckEmailAddressSyntax (&quot;@entreprise.com&quot;));
Assert.IsFalse(EAV.CheckEmailAddressSyntax (&quot;Nom@&quot;));
}
}<!--]--></p><h2 id="différentes-assertions"><a href="#différentes-assertions"><!--[-->Différentes assertions<!--]--></a></h2><p><!--[-->Dans un test, on cherche toujours à vérifier un comportement. On utilise donc des assertions, ces assertions définissent le comportement attendu.<!--]--></p><p><!--[-->En francais, une assertion est un énoncé considéré comme vrai.<!--]--></p><p><!--[-->Pour un test unitaire, il s&#39;agit d&#39;une expression qui doit être vrai pour que le test réussisse.<!--]--></p><p><!--[-->NUnit et MBunit utilise une classe statique <a href="http://gallio.org/api/html/AllMembers_T_MbUnit_Framework_Assert.htm" rel="nofollow"><!--[-->Assert<!--]--></a> pour les assertions :<!--]--></p><p><!--[-->Cette classe <a href="http://gallio.org/api/html/AllMembers_T_MbUnit_Framework_Assert.htm" rel="nofollow"><!--[-->Assert<!--]--></a> va nous permettre de tester entre autre :<!--]--></p><ul><!--[--><li><!--[-->l&#39;égalité : Assert.Equals<!--]--></li><li><!--[-->le non null : Assert.IsNotNull<!--]--></li><li><!--[-->une condition Assert.IsTrue<br>
mais aussi, la présence dans une plage de valeur, une égalité approximative, l&#39;égalité des références etc...<!--]--></li><!--]--></ul><p><!--[-->Un test comporte toujours des assertions.<!--]--></p><p><!--[-->Exemple :<!--]--></p><p><!--[-->// CheckEmailAdressSyntax doit renvoyer true avec le paramètre &quot;<a href="mailto:Nom@entreprise.com" rel="noopener noreferrer"><!--[-->Nom@entreprise.com<!--]--></a>&quot;
Assert.IsTrue(EAV.CheckEmailAddressSyntax (&quot;<a href="mailto:Nom@entreprise.com" rel="noopener noreferrer"><!--[-->Nom@entreprise.com<!--]--></a>&quot;));<!--]--></p><h2 id="setupteardown"><a href="#setupteardown"><!--[-->Setup/TearDown<!--]--></a></h2><p><!--[-->Il est parfois nécessaire d&#39;effectuer des opérations avant et après chaque test. Une classe peut donc définir des méthodes appelées avant et après chaque test avec les stéréotypes Setup et Teardown.<!--]--></p><p><!--[-->Exemple :<!--]--></p><p><!--[-->// toujours exécuté avant les tests
[SetUp]
public void SetUp()
{
EAV = new EmailAddressValidator ();
}<!--]--></p><p><!--[-->// toujours exécuté après les tests
[TearDown]
public void TearDown()
{
EVA.Clean();
}<!--]--></p><h2 id="la-couverture-de-code"><a href="#la-couverture-de-code"><!--[-->La couverture de code<!--]--></a></h2><p><!--[-->La <strong><!--[-->couverture de code<!--]--></strong> est une métrique utilisée en génie logiciel pour décrire le taux de code source <a href="http://fr.wikipedia.org/wiki/Code_source" rel="nofollow"><!--[-->http://fr.wikipedia.org/wiki/Code_source<!--]--></a> testé d&#39;un programme. Ceci permet de mesurer la qualité des tests effectués.<!--]--></p><p><!--[-->En .NET on utilise <a href="http://www.ncover.com/" rel="nofollow"><!--[-->NCover<!--]--></a> pour mesurer cette couverture de code. <a href="http://www.ncover.com/" rel="nofollow"><!--[-->NCover<!--]--></a> va calculer à partir des tests joués et du code initial l&#39;ensemble des chemins qui ont été parcourus et fournir un pourcentage du code parcouru par rapport au code non parcouru.<!--]--></p><p><!--[-->Ci-dessous, un exemple des rapports proposés par NCover :<!--]--></p><p><!--[-->XXXX<!--]--></p><p><!--[-->Dans les tests précédents, NCover remarque que l&#39;on ne passe pas par <strong><!--[-->CheckDomainExists<!--]--></strong> que l&#39;on verra plus bas sur cette page. De plus le test sur la nullité de la chaine entrée n&#39;est jamais évalué à true :<!--]--></p><p><!--[-->if(emailAddress == null )
{
throw new NullReferenceException();
}<!--]--></p><p><!--[-->Un test avec une chaine null ferait remonter la couverture de code.<!--]--></p><h2 id="test-paramétré"><a href="#test-paramétré"><!--[-->Test paramétré<!--]--></a></h2><p><!--[-->Dans le test précédent, on réécrit x fois la même ligne pour tester avec des paramètres différents :<!--]--></p><!--[--><pre><code>  Assert.IsFalse(EAV.CheckEmailAddressSyntax (&quot;Nom@@entreprise.com&quot;));
  Assert.IsFalse(EAV.CheckEmailAddressSyntax (&quot;Nomentreprise.com&quot;));
  Assert.IsFalse(EAV.CheckEmailAddressSyntax (&quot;@entreprise.com&quot;));
  Assert.IsFalse(EAV.CheckEmailAddressSyntax (&quot;Nom@&quot;));
</code></pre><!--]--><p><!--[-->Premier défaut à cette méthode :<!--]--></p><ul><!--[--><li><!--[-->il est conseillé d&#39;avoir une assertion par méthode de test, ca permet d&#39;être sur que tout les cas de test sont joués (sinon la première erreur empêche l&#39;execution des autres tests).<!--]--></li><!--]--></ul><p><!--[-->Exemple :<!--]--></p><!--[--><pre><code>\[Test\]
public void TestInvalidEmailSyntaxWithTwoArobas()
{
    Assert.IsFalse(EAV.CheckEmailAddressSyntax (&quot;Nom@@entreprise.com&quot;));
}

\[Test\]
public void TestInvalidEmailSyntaxWithoutName()
{
    Assert.IsFalse(EAV.CheckEmailAddressSyntax (&quot;@entreprise.com&quot;));
}
</code></pre><!--]--><p><!--[-->Second défaut, on duplique le code testé. Cela aurait été plus gênant avec un code sur plusieurs lignes.<!--]--></p><p><!--[-->Solution :<br>
Pour éviter de réécrire x fois le même test avec des paramètres différents, on va utiliser des tests paramétrés :<!--]--></p><!--[--><pre><code>\[Test\]
\[Row(&quot;Nom@@entreprise.com&quot;)\]
\[Row(&quot;Nomentreprise.com&quot;)\]
\[Row(&quot;@entreprise.com&quot;)\]
\[Row(&quot;Nom@&quot;)\]
public void TestEmailSyntaxArobas(string name)
{
    Assert.IsFalse(EAV.CheckEmailAddressSyntax (name));
}
</code></pre><!--]--><p><!--[-->Le même test est joué 4 fois pour chaque valeur de paramètre. L&#39;attribut Row est utilisé pour chaque paramétre et celui-ci est passé en paramètre de la méthode.<!--]--></p><p><!--[-->Autre exemple avec un code plus complexe :<!--]--></p><!--[--><pre><code>\[Test\]
\[Row(&quot;Milou&quot;)\]
\[Row(&quot;Idefix&quot;)\]
public void TestWithFakeAndRowTest(string name)
{
    // &quot;Setup&quot; (initialisation des objets pour le test)
    OrderWriter orderWriter = new OrderWriter(new FakeWriter());
    Order order = new Order() { OrderId = 7001, Pet = new Dog(name) };

    // &quot;Execute&quot; (Exécution du test : écriture de l&#39;ordre sur le système)
    orderWriter.WriteOrder(order);

    // &quot;State verification&quot; (vérification de l&#39;état de l&#39;objet par des assertions)
    Assert.AreEqual(name, order.Pet.Name);
    Assert.IsTrue(order.IsFilled);
}
</code></pre><!--]--><h2 id="le-bouchonnage"><a href="#le-bouchonnage"><!--[-->Le bouchonnage<!--]--></a></h2><h3 id="problématique"><a href="#problématique"><!--[-->Problématique<!--]--></a></h3><p><!--[-->Comme dit plus haut, un test unitaire doit être indépendant des ressources externes : base de données, file de message etc...<!--]--></p><p><!--[-->Mais il arrive souvent que l&#39;on utilise ces ressources dans les classes testées.<!--]--></p><p><!--[-->Exemple :<!--]--></p><p><!--[-->public class  EmailAddressValidator
{
DomainValidator domainValidator;<!--]--></p><!--[--><pre><code>public EmailAddressValidator()
{
    DomainValidator domainValidator = new DomainValidator();
}

public bool CheckEmailAddressSyntax(string emailAddress)
{
    if(emailAddress == null )
    {
        throw new NullReferenceException();
    }
    return Regex.IsMatch(emailAddress, @&quot;^\[w.-\]+@\[a-zA-Z0-9-\]+(.\[a-zA-Z0-9-\]{1,})\*(.\[a-zA-Z\]{2,3}){1,2}$&quot;);
}
...
public bool CheckDomainExists(string domain)
{
    return  domainValidator.Exists(domain);
}...
</code></pre><!--]--><p><!--[-->}<!--]--></p><p><!--[-->Ici le DomainValidator fait appel à un service web pour vérifier l&#39;existence d&#39;un nom de domaine. Le test unitaire de la méthode CheckDomainExists pose donc problème.<!--]--></p><h3 id="solution"><a href="#solution"><!--[-->Solution<!--]--></a></h3><p><!--[-->La solution consiste à utiliser un bouchon à la place du DomainValidator.<!--]--></p><p><!--[-->Pour cela, un peu de remaniement de code est nécessaire (<em><!--[-->refactoring<!--]--></em>) :<!--]--></p><ul><!--[--><li><!--[-->l&#39;objet DomainValidator n&#39;est plus instancié dans le constructeur mais injecté par constructeur ou par mutateur (propriété)<!--]--></li><li><!--[-->On utilise une interface à la place de l&#39;objet réel pour &quot;inverser la dépendance&quot; de la classe EmailAdressValidator non plus sur la classe &quot;DomainValidator&quot; mais sur une interface &quot;IDomainValidator&quot;<!--]--></li><!--]--></ul><p><!--[-->Exemple avec injection par constructeur :<!--]--></p><p><!--[-->// Interface IDomainValidator
public interface IDomainValidator
{
bool Exists(string sDomain);
}<!--]--></p><p><!--[-->// Classe à tester
class  EmailAddressValidator
{
// Interface
private readonly IDomainValidator domainValidator;<!--]--></p><!--[--><pre><code>public EmailAddressValidator(IDomainValidator domainValidator)
{
    this.domainValidator = domainValidator;
}

public bool CheckEmailAddressSyntax(string emailAddress)
{
    if(sEmailAddress == null )
    {
        throw new NullReferenceException();
    }
    return Regex.IsMatch(emailAddress, @&quot;^\[w.-\]+@\[a-zA-Z0-9-\]+(.\[a-zA-Z0-9-\]{1,})\*(.\[a-zA-Z\]{2,3}){1,2}$&quot;);
}
...
public bool CheckDomainExists(string domain)
{
    return  domainValidator.Exists(domain);
}
...
</code></pre><!--]--><p><!--[-->}<!--]--></p><p><!--[-->Exemple avec injection par mutatteur (propriété getter/setter) :<!--]--></p><p><!--[-->// Classe à tester
class  EmailAddressValidator
{
// Interface
public IDomainValidator domainValidator { get; set; }<!--]--></p><p><!--[-->public EmailAddressValidator()
{
}
....<!--]--></p><p><!--[-->A partir de là, il faut écrire une implémentation de IDomainValidator valable uniquement pour le test.<!--]--></p><p><!--[-->class FakeDomainValidator : IDomainValidator
{
public bool Exists(string sDomain)
{
return true;
}
}<!--]--></p><p><!--[--><strong><!--[-->Les tests de EmailAddressValidator pourront donc être indépendants de l&#39;implémentation de IDomainValidator.<!--]--></strong><!--]--></p><h3 id="limitations"><a href="#limitations"><!--[-->Limitations<!--]--></a></h3><p><!--[-->Si vous souhaitez tester le comportement de EmailAddressValidator dans le cas d&#39;un retour true et false, il faut écrire deux bouchons.<br>
Si l&#39;objet est complexe et contient plus de 3 méthodes, l&#39;écriture des bouchons est rapidement fastidieuse.<!--]--></p><p><!--[-->Pour cela, il faut utiliser des outils qui génèrent les bouchons dynamiquement. Voir partie suivante sur les mocks.<!--]--></p><h1 id="présentation-des-mocks"><!--[-->Présentation des Mocks<!--]--></h1><p><!--[-->Les Mocks permettent de s&#39;affranchir de l&#39;écriture des bouchons cités plus haut. Deux lignes de code suffisent pour créer une implémentation vide d&#39;une interface :<!--]--></p><!--[--><pre><code>  var mock = new Mock();
  IDomainValidator domainValidatorMock = mock.Object;
</code></pre><!--]--><h2 id="mocks-pour-tester-létat-des-objets"><a href="#mocks-pour-tester-létat-des-objets"><!--[-->Mocks pour tester l&#39;état des objets<!--]--></a></h2><p><!--[-->On peut désormais écrire :<!--]--></p><p><!--[-->EAV = new EmailAddressValidator ();
EAV.domainValidator = domainValidatorMock;
EAV.CheckDomainExists(&quot;domaine.fr&quot;);<!--]--></p><p><!--[-->Par défaut, nous n&#39;avons pas défini ce que devait renvoyer Exists de domainValidatorMock, donc la méthode va renvoyer false (la valeur d&#39;un bool par défaut).<!--]--></p><p><!--[--><strong><!--[-->Ici, on va donc tester la méthode CheckDomainExists de EmailAddressValidator sans faire d&#39;appel à un web service.<!--]--></strong><!--]--></p><h2 id="préciser-le-comportement-du-mock"><a href="#préciser-le-comportement-du-mock"><!--[-->Préciser le comportement du mock<!--]--></a></h2><p><!--[-->Dans l&#39;exemple précédent, on va coder deux tests, un ou le résultat du IDomainValidator est false, l&#39;autre ou c&#39;est true. Pour cela, on va initialiser le mock avec la méthode Setup :<!--]--></p><!--[--><pre><code>    \[Test\]
    public void TestDomainExist()
    {
        EAV = new EmailAddressValidator ();
        EAV.domainValidator = domainValidatorMock;
        mock.Setup(foo =&gt; foo.Exists(It.IsAny())).Returns(true);
        Assert.IsTrue(EAV.CheckDomainExists(&quot;domaine.fr&quot;));
    }

    \[Test\]
    public void TestDomainNotExist()
    {
        EAV = new EmailAddressValidator ();
        EAV.domainValidator = domainValidatorMock;
        mock.Setup(foo =&gt; foo.Exists(It.IsAny())).Returns(false);
        Assert.IsTrue(EAV.CheckDomainExists(&quot;domaine.fr&quot;));
    }
</code></pre><!--]--><p><!--[-->La méthode Setup prend une lambda expression indiquant le comportement attendu de la méthode Exists sur l&#39;objet.<!--]--></p><p><!--[-->On remarque l&#39;utilisation de It.IsAny<string>() qui indique que l&#39;appel de Exists avec n&#39;importe quel string renverra true.</string><!--]--></p><p><!--[-->Tout le comportement de la méthode bouchonnée peut être précisé comme cela.<br>
Par exemple si la méthode doit renvoyer une exception :<!--]--></p><p><!--[-->mock.Setup(foo =&gt; foo.Exists(It.IsAny())).Returns(false).Throws(new ArgumentException(&quot;invalid argument&quot;));<!--]--></p><p><!--[-->On peut indiquer que l&#39;appel de la méthode doit ensuite déclencher une fonction de rappel :<!--]--></p><p><!--[-->mock.Setup(foo =&gt; foo.Exists(It.IsAny())).Returns(false).Callback(() =&gt; MethodToCall());<!--]--></p><h2 id="mock-pour-tester-le-comportement-des-objets"><a href="#mock-pour-tester-le-comportement-des-objets"><!--[-->Mock pour tester le comportement des objets<!--]--></a></h2><p><!--[-->En réalité il existe deux types de tests à faire :<!--]--></p><ul><!--[--><li><!--[-->tester que EmailAdressValidator se comporte bien<!--]--></li><li><!--[-->tester que DomainValidator est correctement appelé par EmailAdressValidator<!--]--></li><!--]--></ul><p><!--[-->pour le deuxième type de test, le mock peut ajouter des attentes (ou <strong><!--[-->expectations<!--]--></strong>) :<!--]--></p><!--[--><pre><code>        // &quot;Behavior verification&quot; (vérifications du comportement de l&#39;objet par des attentes)
        mock.Verify(foo =&gt; foo.Exists(It.IsAny())).Returns(false), Times.AtMostOnce(),
        &quot;Fail message: method IDomainValidator.Existsshould be called and called only once&quot;);
</code></pre><!--]--><p><!--[-->Ici par exemple on vérifie que la méthode Exists ne peut être appelé qu&#39;une seule fois.<!--]--></p></div></div></div></div><div class="mt-10 text-slate-600 font-extrabold text-sm font-medium min-w-full mx-auto mb-2"><a href="https://github.com/hlassiege/eventuallycoding/blob/master/content/articles/2010/11/28/introduction-aux-tests-unitaires-et-aux-bouchons-en-c-2.md" rel="noopener noreferrer" target="_blank">Edit on Github <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 inline-block text-slate-600 -mt-1" viewBox="0 0 512 512"><path d="M320 0c-17.7 0-32 14.3-32 32s14.3 32 32 32h82.7L201.4 265.4c-12.5 12.5-12.5 32.8 0 45.3s32.8 12.5 45.3 0L448 109.3V192c0 17.7 14.3 32 32 32s32-14.3 32-32V32c0-17.7-14.3-32-32-32H320zM80 32C35.8 32 0 67.8 0 112V432c0 44.2 35.8 80 80 80H400c44.2 0 80-35.8 80-80V320c0-17.7-14.3-32-32-32s-32 14.3-32 32V432c0 8.8-7.2 16-16 16H80c-8.8 0-16-7.2-16-16V112c0-8.8 7.2-16 16-16H192c17.7 0 32-14.3 32-32s-14.3-32-32-32H80z"></path></svg></a></div><hr class="mb-8"><div><span class="font-proxima text-sm md:text-xl font-medium"> Did you like this blog post? </span><div class="mt-4 flex flex-row"><div><a href="https://facebook.com/sharer/sharer.php?u=https://eventuallycoding.com/2010/11/28/introduction-aux-tests-unitaires-et-aux-bouchons-en-c-2" target="_blank" rel="noopener" aria-label="Share on Facebook"><button aria-label="Share on Facebook" type="button" class="text-white bg-[#3b5998] hover:bg-[#3b5998]/90 focus:ring-4 focus:outline-none focus:ring-[#3b5998]/50 font-medium rounded-lg text-sm px-3 py-3 text-center inline-flex items-center dark:focus:ring-[#3b5998]/55 mr-2 mb-2"><svg class="w-6 h-6" aria-hidden="true" focusable="false" data-prefix="fab" data-icon="facebook-f" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><path fill="currentColor" d="M279.1 288l14.22-92.66h-88.91v-60.13c0-25.35 12.42-50.06 52.24-50.06h40.42V6.26S260.4 0 225.4 0c-73.22 0-121.1 44.38-121.1 124.7v70.62H22.89V288h81.39v224h100.2V288z"></path></svg></button></a></div><div><a href="https://twitter.com/share?url=https://eventuallycoding.com/2010/11/28/introduction-aux-tests-unitaires-et-aux-bouchons-en-c-2&amp;text=Introduction aux tests unitaires et aux bouchons en C#&amp;via=hugolassiege" target="_blank" title="Share on Twitter" rel="noopener noreferrer" aria-label="Share on Twitter"><button aria-label="Share on Twitter" type="button" class="text-white bg-[#1da1f2] hover:bg-[#1da1f2]/90 focus:ring-4 focus:outline-none focus:ring-[#1da1f2]/50 font-medium rounded-lg text-sm px-3 py-3 text-center inline-flex items-center dark:focus:ring-[#1da1f2]/55 mr-2 mb-2"><svg class="w-6 h-6" aria-hidden="true" focusable="false" data-prefix="fab" data-icon="twitter" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M459.4 151.7c.325 4.548 .325 9.097 .325 13.65 0 138.7-105.6 298.6-298.6 298.6-59.45 0-114.7-17.22-161.1-47.11 8.447 .974 16.57 1.299 25.34 1.299 49.06 0 94.21-16.57 130.3-44.83-46.13-.975-84.79-31.19-98.11-72.77 6.498 .974 12.99 1.624 19.82 1.624 9.421 0 18.84-1.3 27.61-3.573-48.08-9.747-84.14-51.98-84.14-102.1v-1.299c13.97 7.797 30.21 12.67 47.43 13.32-28.26-18.84-46.78-51.01-46.78-87.39 0-19.49 5.197-37.36 14.29-52.95 51.65 63.67 129.3 105.3 216.4 109.8-1.624-7.797-2.599-15.92-2.599-24.04 0-57.83 46.78-104.9 104.9-104.9 30.21 0 57.5 12.67 76.67 33.14 23.72-4.548 46.46-13.32 66.6-25.34-7.798 24.37-24.37 44.83-46.13 57.83 21.12-2.273 41.58-8.122 60.43-16.24-14.29 20.79-32.16 39.31-52.63 54.25z"></path></svg></button></a></div><div class=""><a href="https://www.buymeacoffee.com/hlassiege" target="_blank"><img src="https://cdn.buymeacoffee.com/buttons/v2/default-red.png" alt="Buy Me A Coffee" style="height:48px !important;width:209px !important;"></a></div></div></div><div id="hyvor-talk-view"></div></div></div><!--]--><!--]--><footer class="lg:mt-40 border-t border-t-2"><div class="flex flex-col items-center mt-16"><div class="flex mb-3 space-x-4"><a aria-label="Open RSS feed" target="_self" href="/rss.xml" class="text-sm text-gray-500 transition hover:text-gray-600"><img alt="RSS" class="transition-transform hover:scale-110 w-8 h-8" src="/_nuxt/rss.9e0b880c.svg"></a><a aria-label="Open Mastodon profile" class="text-sm text-gray-500 transition hover:text-gray-600" target="_blank" rel="me" href="https://piaille.fr/@hugolassiege"><span class="sr-only">Mastodon</span><img alt="Mastodon" class="transition-transform hover:scale-110 w-8 h-8" src="/_nuxt/mastodon.f0ecdde8.svg"></a><a aria-label="Open github profile" class="text-sm text-gray-500 transition hover:text-gray-600" target="_blank" rel="nofollow noopener noreferrer" href="https://github.com/hlassiege"><span class="sr-only">github</span><img alt="github" class="transition-transform hover:scale-110 w-8 h-8" src="/_nuxt/github_new.4e3fe23c.svg"></a><a aria-label="Open linkedin profile" class="text-sm text-gray-500 transition hover:text-gray-600" target="_blank" rel="noopener noreferrer" href="https://www.linkedin.com/in/hugolassiege/"><span class="sr-only">Linkedin</span><img alt="Linkedin" class="transition-transform hover:scale-110 w-8 h-8" src="/_nuxt/linkeding.34c3bc6d.svg"></a><a aria-label="Open twitter profile" target="_blank" rel="nofollow noopener noreferrer" href="https://twitter.com/hugolassiege" class="text-sm text-gray-500 transition hover:text-gray-600"><img alt="Twitter" class="transition-transform hover:scale-110 w-8 h-8" src="/_nuxt/twitter.457cff27.svg"></a></div><div class="flex mb-2 space-x-2 text-sm text-gray-500 dark:text-gray-400"><div>Copyright © 2023</div><div>•</div> EventuallyCoding - A la fin de l&#39;envoi, je code !</div><div class="text-sm text-gray-500"> Credits to www.freepik.com - <a href="https://www.freepik.com/vectors/citizen">Citizen vector created by freepik - </a><a href="https://www.freepik.com/vectors/css">Css vector created by vectorjuice</a></div></div></footer></div></section><!--]--></div><script type="module">import p from "/2010/11/28/introduction-aux-tests-unitaires-et-aux-bouchons-en-c-2/_payload.js";window.__NUXT__={...p,...((function(a,b){return {state:{},_errors:{},serverRendered:true,config:{public:{content:{locales:[],defaultLocale:b,integrity:1677657007747,experimental:{stripQueryParameters:a,clientDB:a},api:{baseURL:"\u002Fapi\u002F_content"},navigation:{fields:[]},tags:{p:"prose-p",a:"prose-a",blockquote:"prose-blockquote","code-inline":"prose-code-inline",code:"prose-code",em:"prose-em",h1:"prose-h1",h2:"prose-h2",h3:"prose-h3",h4:"prose-h4",h5:"prose-h5",h6:"prose-h6",hr:"prose-hr",img:"prose-img",ul:"prose-ul",ol:"prose-ol",li:"prose-li",strong:"prose-strong",table:"prose-table",thead:"prose-thead",tbody:"prose-tbody",td:"prose-td",th:"prose-th",tr:"prose-tr"},highlight:a,wsUrl:b,documentDriven:a,host:b,trailingSlash:a,anchorLinks:{depth:4,exclude:[1]}}},app:{baseURL:"\u002F",buildAssetsDir:"\u002F_nuxt\u002F",cdnURL:b}},prerenderedAt:1677657047197}}(false,"")))}</script><script type="module" src="/_nuxt/entry.57db4985.js" crossorigin></script><script type="module" src="/_nuxt/default.285d1574.js" crossorigin></script><script type="module" src="/_nuxt/_id_.75770b07.js" crossorigin></script><script type="module" src="/_nuxt/ContentRenderer.c10275bd.js" crossorigin></script><script type="module" src="/_nuxt/ContentRendererMarkdown.672d9d78.js" crossorigin></script><script type="module" src="/_nuxt/ProseP.c97a0062.js" crossorigin></script><script type="module" src="/_nuxt/ProseA.c10a5829.js" crossorigin></script><script type="module" src="/_nuxt/ProseStrong.3e82dd1e.js" crossorigin></script><script type="module" src="/_nuxt/ProseH2.0653e762.js" crossorigin></script><script type="module" src="/_nuxt/ProseEm.9e0a0fe1.js" crossorigin></script><script type="module" src="/_nuxt/ProseCode.38d2ebe8.js" crossorigin></script><script type="module" src="/_nuxt/ProseUl.00d948c2.js" crossorigin></script><script type="module" src="/_nuxt/ProseLi.d16b62bb.js" crossorigin></script><script type="module" src="/_nuxt/ProseH3.b000bcbd.js" crossorigin></script><script type="module" src="/_nuxt/ProseH1.1729e458.js" crossorigin></script></body>
</html>